<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Profile</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans&display=swap" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-icons.css" rel="stylesheet">
  <link href="css/templatemo-topic-listing.css" rel="stylesheet">

  <style>
    :root {
      --input-focus: #2d8cf0;
      --font-color: #323232;
      --font-color-sub: #666;
      --bg-color: #f7f9fc;
      --main-color: black;
      --accent-color: #ff6b6b;
      --secondary-color: #feca57;
      --tertiary-color: #1dd1a1;
      --light-blue: #54a0ff;
      --pink: #ff9ff3;
      --purple: #5f27cd;
    }

    body {
      font-family: 'Fira Code', monospace;
      background-color: var(--bg-color);
      color: var(--font-color);
      margin: 0;
      padding: 0;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Navbar */
    .navbar {
      background-color: yellow;
      border-bottom: 2px solid var(--main-color);
      box-shadow: 4px 4px var(--main-color);
      margin-bottom: 10px;
    }

    .navbar-brand {
      color: var(--accent-color);
      font-weight: 700;
      font-size: 1.5rem;
      transition: transform 0.3s ease;
    }
    
    .navbar-brand:hover {
      transform: scale(1.05);
    }

    .navbar-nav .nav-link {
      color: var(--font-color);
      font-weight: 600;
      border-radius: 5px;
      padding: 8px 15px;
      margin: 0 5px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .navbar-nav .nav-link:hover {
      color: var(--input-focus);
      border: 2px solid var(--input-focus);
      box-shadow: 3px 3px var(--main-color);
      transform: translateY(-2px);
    }

    /* Profile Section Styling */
    .profile-section {
      background: white;
      padding: 60px 0;
      border-bottom: 2px solid var(--main-color);
      box-shadow: 0 4px 0 var(--main-color);
      margin-bottom: 35px;
      text-align: center;
    }

    .profile-container {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      box-shadow: 4px 4px var(--main-color);
      padding: 30px;
      margin: 20px auto;
      max-width: 800px;
      transition: all 0.3s ease;
    }

    .profile-container:hover {
      transform: translateY(-5px);
      box-shadow: 6px 6px var(--main-color);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--main-color);
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: var(--accent-color);
      color: white;
      font-size: 60px;
      border: 3px solid var(--main-color);
      box-shadow: 4px 4px var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .profile-avatar:hover {
      transform: rotate(5deg);
      box-shadow: 6px 6px var(--main-color);
    }

    .profile-info {
      flex-grow: 1;
      text-align: left;
    }

    .profile-info h2 {
      font-weight: 700;
      color: var(--font-color);
      margin-bottom: 10px;
      position: relative;
      display: inline-block;
    }
    
    .profile-info h2:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--accent-color);
      transition: width 0.3s ease;
    }
    
    .profile-info h2:hover:after {
      width: 100%;
    }

    .profile-info p {
      margin: 5px 0;
      font-weight: 600;
      color: var(--font-color-sub);
    }

    #level {
      display: inline-block;
      background-color: var(--secondary-color);
      color: var(--font-color);
      font-weight: 700;
      padding: 5px 15px;
      border-radius: 20px;
      border: 2px solid var(--main-color);
      box-shadow: 3px 3px var(--main-color);
      transition: all 0.3s ease;
    }

    #level:hover {
      transform: translateY(-3px);
      box-shadow: 5px 5px var(--main-color);
    }
    
    .section-title {
      margin: 40px 0 20px 0;
      position: relative;
    }
    
    .section-title h3 {
      color: var(--font-color);
      font-weight: 700;
      font-size: 1.5rem;
      display: inline-block;
      position: relative;
      margin-bottom: 0;
      padding-bottom: 8px;
    }
    
    .section-title h3:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--tertiary-color);
      transition: width 0.3s ease;
    }
    
    .section-title h3:hover:after {
      width: 100%;
    }

    .progress-container {
      margin: 25px 0;
      background-color: white;
      padding: 20px;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .progress-container:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .module-title {
      font-weight: 700;
      color: var(--font-color);
    }

    .progress {
      height: 20px;
      background-color: var(--bg-color);
      border-radius: 10px;
      border: 2px solid var(--main-color);
      overflow: hidden;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 5px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--light-blue));
      border-radius: 8px;
      transition: width 1s ease;
    }
    
    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--font-color-sub);
      font-style: italic;
      background-color: var(--bg-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }
    
    .empty-state:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .topic-suggestions {
      margin: 25px 0;
    }

    .topic-suggestion-item {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .topic-suggestion-item:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .topic-suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .topic-suggestion-title {
      font-weight: 700;
      color: var(--font-color);
      font-size: 1.1rem;
    }

    .topic-suggestion-difficulty {
      background-color: var(--secondary-color);
      color: var(--font-color);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: help;
      transition: all 0.3s ease;
      position: relative;
    }

    .topic-suggestion-difficulty:hover {
      background-color: var(--tertiary-color);
      color: white;
      transform: scale(1.05);
    }

    .topic-suggestion-difficulty[title]:hover::after {
      content: attr(title);
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--main-color);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-top: 5px;
    }

    .topic-suggestion-difficulty.novice-rec {
      background-color: var(--tertiary-color);
      color: white;
    }

    .topic-suggestion-difficulty.intermediate-rec {
      background-color: var(--secondary-color);
      color: var(--font-color);
    }

    .topic-suggestion-difficulty.advanced-rec {
      background-color: var(--accent-color);
      color: white;
    }

    .topic-suggestion-difficulty.novice-rec:hover {
      background-color: #17a2b8;
    }

    .topic-suggestion-difficulty.intermediate-rec:hover {
      background-color: #e0a800;
    }

    .topic-suggestion-difficulty.advanced-rec:hover {
      background-color: #dc3545;
    }

    .topic-suggestion-content {
      color: var(--font-color-sub);
      margin-bottom: 15px;
    }

    .topic-suggestion-actions {
      display: flex;
      gap: 10px;
    }

    .topic-suggestion-btn {
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .topic-suggestion-btn:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
    }

    .button-container {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .button {
      background-color: white;
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 12px 25px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .button:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--accent-color);
      transition: all 0.4s ease;
      z-index: -1;
    }

    .button:hover:before {
      left: 0;
    }

    .button:hover {
      color: white;
      transform: translateY(-5px);
      box-shadow: 6px 6px var(--main-color);
    }

    .button:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px var(--main-color);
    }

    .button.primary {
      background-color: var(--accent-color);
      color: white;
    }

    .button.primary:before {
      background: var(--light-blue);
    }

    /* Footer */
    footer {
      background-color: white;
      color: var(--font-color);
      text-align: center;
      padding: 40px 0;
      border-top: 2px solid var(--main-color);
      margin-top: 40px;
    }

    footer .navbar-brand {
      color: var(--accent-color);
      font-weight: 700;
      transition: all 0.3s ease;
    }
    
    footer .navbar-brand:hover {
      transform: scale(1.1);
    }

    footer a {
      color: var(--input-focus);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    footer a:hover {
      color: var(--accent-color);
      text-decoration: underline;
    }

    .site-footer-title {
      color: var(--font-color);
      font-weight: 700;
      margin-bottom: 15px;
      position: relative;
      display: inline-block;
    }
    
    .site-footer-title:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--secondary-color);
      transition: width 0.3s ease;
    }
    
    .site-footer-title:hover:after {
      width: 100%;
    }

    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }

      .profile-info {
        text-align: center;
      }
      
      .profile-info h2:after {
        left: 25%;
        width: 50%;
      }
      
      .profile-info h2:hover:after {
        width: 80%;
        left: 10%;
      }
      
      .section-title h3 {
        text-align: center;
        display: block;
      }
      
      .section-title h3:after {
        left: 25%;
        width: 50%;
      }
      
      .section-title h3:hover:after {
        width: 50%;
      }

      .button-container {
        flex-direction: column;
      }
    }

    /* Learning Mastery styles */
    .mastery-container {
      margin: 25px 0;
    }

    .mastery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .mastery-section-title {
      font-weight: 700;
      color: var(--font-color);
      margin: 0;
    }

    .refresh-btn {
      background-color: var(--bg-color);
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 5px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .refresh-btn i {
      font-size: 16px;
    }

    .refresh-btn:hover {
      background-color: var(--light-blue);
      color: white;
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }
    
    .mastery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .mastery-item {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .mastery-item:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .mastery-title {
      font-weight: 700;
      color: var(--font-color);
      margin-bottom: 10px;
    }

    .mastery-bar-container {
      height: 15px;
      background-color: var(--bg-color);
      border-radius: 7px;
      border: 1px solid var(--main-color);
      margin-bottom: 5px;
      overflow: hidden;
    }

    .mastery-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--tertiary-color), var(--light-blue));
      border-radius: 7px;
      transition: width 0.5s ease;
    }

    .mastery-percentage {
      font-size: 14px;
      font-weight: 600;
      color: var(--font-color);
      text-align: right;
    }

    .mastery-description {
      font-size: 12px;
      color: var(--font-color-sub);
      margin-bottom: 8px;
      line-height: 1.3;
      height: 32px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .topic-practice-btn {
      background-color: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 4px 10px;
      margin-top: 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
    }

    .topic-practice-btn:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }

    .mastery-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      border: 2px solid var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 2px 2px var(--main-color);
      transform: rotate(15deg);
    }

    /* Learning Path styles */
    .learning-path-container {
      margin: 25px 0;
    }

    .learning-path {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .learning-path:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .path-steps {
      position: relative;
      padding-left: 30px;
    }

    .path-steps:before {
      content: '';
      position: absolute;
      top: 0;
      left: 15px;
      height: 100%;
      width: 2px;
      background-color: var(--accent-color);
    }

    .path-step {
      position: relative;
      margin-bottom: 30px;
    }

    .path-step:last-child {
      margin-bottom: 0;
    }

    .path-step:before {
      content: '';
      position: absolute;
      top: 5px;
      left: -30px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: white;
      border: 2px solid var(--accent-color);
      z-index: 1;
    }

    .path-step.completed:before {
      background-color: var(--tertiary-color);
      border-color: var(--main-color);
    }

    .path-step.current:before {
      background-color: var(--secondary-color);
      border-color: var(--main-color);
      animation: pulse 1.5s infinite;
    }

    .path-step-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .path-step-title {
      font-weight: 700;
      color: var(--font-color);
    }

    .path-step-status {
      font-size: 14px;
      font-weight: 600;
    }

    .path-step-content {
      color: var(--font-color-sub);
      margin-bottom: 10px;
    }

    .path-step-action {
      display: inline-block;
      background-color: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 5px 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
      font-size: 14px;
    }

    .path-step-action:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }

    /* Learning Path Progress and Completion Styles */
    .completion-tick {
      color: var(--tertiary-color);
      font-weight: 700;
      font-size: 16px;
      margin-left: 8px;
      animation: checkmark-appear 0.5s ease-in-out;
    }

    @keyframes checkmark-appear {
      0% {
        opacity: 0;
        transform: scale(0);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .path-step-progress {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .path-progress-bar-container {
      flex: 1;
      height: 12px;
      background-color: var(--bg-color);
      border-radius: 6px;
      border: 1px solid var(--main-color);
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .path-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--tertiary-color), var(--light-blue));
      border-radius: 6px;
      transition: width 0.5s ease;
      position: relative;
    }

    .path-progress-bar::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background-image: linear-gradient(
        -45deg,
        rgba(255, 255, 255, 0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 30px 30px;
      animation: progress-animation 2s linear infinite;
    }

    @keyframes progress-animation {
      0% {
        background-position: 0 0;
      }
      100% {
        background-position: 30px 30px;
      }
    }

    .path-progress-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--font-color);
      min-width: 35px;
      text-align: right;
    }

    /* Enhanced completed step styling */
    .path-step.completed .path-step-title {
      color: var(--tertiary-color);
    }

    .path-step.completed .path-progress-bar {
      background: var(--tertiary-color);
    }

    /* Achievements styles */
    .achievements-container {
      margin: 25px 0;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
    }

    .achievement {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .achievement:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .achievement.locked {
      filter: grayscale(1);
      opacity: 0.7;
    }

    .achievement-icon {
      width: 50px;
      height: 50px;
      background-color: var(--bg-color);
      border-radius: 50%;
      border: 2px solid var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      font-size: 24px;
    }

    .achievement-title {
      font-weight: 700;
      color: var(--font-color);
      font-size: 14px;
      margin-bottom: 5px;
    }

    .achievement-description {
      font-size: 12px;
      color: var(--font-color-sub);
    }

    /* Toast Notification */
    .toast-notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: flex;
      align-items: center;
      background-color: white;
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.5s ease;
    }

    .toast-notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-icon {
      font-size: 24px;
      margin-right: 15px;
      animation: pulse 1.5s infinite;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--accent-color);
    }

    .toast-message {
      font-size: 14px;
      color: var(--font-color-sub);
    }

    /* Module Dropdown Styles */
    .module-dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-toggle {
      position: relative;
    }

    .module-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 8px;
      box-shadow: 4px 4px var(--main-color);
      z-index: 1000;
      display: none;
      min-width: 280px;
    }

    .module-options.show {
      display: block;
    }

    .module-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      text-decoration: none;
      color: var(--font-color);
      border-bottom: 1px solid var(--bg-color);
      transition: all 0.3s ease;
      position: relative;
    }

    .module-option:last-child {
      border-bottom: none;
    }

    .module-option:hover {
      background-color: var(--bg-color);
      color: var(--font-color);
      text-decoration: none;
    }

    .module-option-content {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .level-badge {
      min-width: 60px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-align: center;
      text-transform: uppercase;
      border: 1px solid var(--main-color);
    }

    .level-badge.novice {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .level-badge.intermediate {
      background: linear-gradient(135deg, #ffc107, #fd7e14);
      color: white;
    }

    .level-badge.advanced {
      background: linear-gradient(135deg, #dc3545, #fd7e14);
      color: white;
    }

    .module-option-text {
      flex: 1;
    }

    .module-option-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .module-option-desc {
      font-size: 12px;
      color: var(--font-color-sub);
      line-height: 1.3;
    }

    .module-option.suggested {
      background-color: #e8f5e8;
      border-left: 4px solid var(--tertiary-color);
    }

    .module-option.suggested::after {
      content: "Recommended";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: var(--tertiary-color);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    .module-option.completed {
      background-color: #f8f9fa;
      color: var(--font-color-sub);
    }

    .module-option.completed::after {
      content: "âœ“ Completed";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: var(--tertiary-color);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    /* Enhanced completion indicator styles with glitter effects */
    .completion-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 8px 12px;
      background: linear-gradient(135deg, #28a745, #20c997, #17a2b8, #28a745);
      background-size: 400% 400%;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: glitterPulse 2s infinite, glitterShine 3s infinite;
      border: 2px solid transparent;
      background-clip: padding-box;
      position: relative;
    }

    .completion-indicator::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #00ff00, #00ffff, #ff00ff, #ffd700);
      background-size: 600% 600%;
      border-radius: 10px;
      z-index: -1;
      animation: glitterBorder 2s linear infinite;
    }

    @keyframes glitterBorder {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    @keyframes glitterPulse {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 10px rgba(255, 215, 0, 0.5);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3), 0 0 20px rgba(255, 215, 0, 0.8);
        transform: scale(1.05);
      }
    }

    @keyframes glitterShine {
      0% {
        background-position: 0% 50%;
      }
      100% {
        background-position: 400% 50%;
      }
    }

    .completion-checkmark {
      font-size: 20px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 215, 0, 0.5);
      margin-bottom: 2px;
      animation: checkmarkGlow 2s infinite;
    }

    @keyframes checkmarkGlow {
      0%, 100% {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 215, 0, 0.5);
      }
      50% {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 255, 255, 0.5);
      }
    }

    .completion-text {
      font-size: 10px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 5px rgba(255, 215, 0, 0.3);
    }

    /* Enhanced module option completed styling with glitter border */
    .module-option.completed {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border: 3px solid transparent;
      background-clip: padding-box;
      position: relative;
      overflow: visible;
      animation: completedModuleGlow 3s infinite;
    }

    .module-option.completed::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #28a745, #20c997, #17a2b8, #ffd700);
      background-size: 600% 600%;
      border-radius: 10px;
      z-index: -1;
      animation: glitterBorder 2s linear infinite;
    }

    @keyframes completedModuleGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3), 0 0 15px rgba(255, 215, 0, 0.4);
      }
    }

    .module-option.completed:hover {
      background: linear-gradient(135deg, #e9ecef, #dee2e6);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4), 0 0 25px rgba(255, 215, 0, 0.6);
    }

    /* Enhanced topic completion badge with glitter */
    .topic-completion-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 6px 10px;
      background: linear-gradient(135deg, #28a745, #20c997, #17a2b8, #28a745);
      background-size: 400% 400%;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: topicGlitterGlow 3s infinite, glitterShine 3s infinite;
      border: 2px solid transparent;
      background-clip: padding-box;
      position: relative;
    }

    .topic-completion-badge::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #00ff00, #00ffff, #ff00ff, #ffd700);
      background-size: 500% 500%;
      border-radius: 8px;
      z-index: -1;
      animation: glitterBorder 2.5s linear infinite;
    }

    @keyframes topicGlitterGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 8px rgba(255, 215, 0, 0.3);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4), 0 0 20px rgba(255, 215, 0, 0.7);
      }
    }

    /* Enhanced progress bar animations */
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--light-blue));
      border-radius: 8px;
      transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: progressShine 2s infinite;
    }

    @keyframes progressShine {
      0% {
        left: -100%;
      }
      100% {
        left: 100%;
      }
    }

    /* Enhanced difficulty level progress bars with animations */
    .novice-progress {
      background: linear-gradient(90deg, #28a745, #20c997, #17a2b8);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    .intermediate-progress {
      background: linear-gradient(90deg, #ffc107, #fd7e14, #ff6b6b);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    .advanced-progress {
      background: linear-gradient(90deg, #dc3545, #ff6b6b, #fd7e14);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    @keyframes progressFlow {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    .module-option.locked {
      background-color: #f8f9fa;
      color: #adb5bd;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .module-option.locked::after {
      content: "ðŸ”’ Locked";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: #6c757d;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    .module-option.locked:hover {
      background-color: #f8f9fa;
      color: #adb5bd;
    }

    .module-option.locked .module-option-desc {
      color: #adb5bd;
    }

    .module-option-desc {
      font-size: 12px;
      color: var(--font-color-sub);
      line-height: 1.3;
    }

    .module-option-desc::after {
      content: "";
      display: block;
      margin-top: 2px;
    }

    .module-option.suggested .module-option-desc {
      color: #155724;
      font-weight: 500;
    }

    .module-option.completed .module-option-desc {
      color: #6c757d;
      font-style: italic;
    }

    /* Tooltip for additional information */
    .module-option:hover .module-option-desc {
      font-weight: 600;
    }

    .module-option.suggested:hover {
      background-color: #d4edda;
    }

    .module-option.completed:hover {
      background-color: #e2e3e5;
    }

    .novice-progress {
      background: linear-gradient(90deg, #28a745, #20c997);
    }

    .intermediate-progress {
      background: linear-gradient(90deg, #ffc107, #fd7e14);
    }

    .advanced-progress {
      background: linear-gradient(90deg, #dc3545, #ff6b6b);
    }

    .progress-details {
      text-align: right;
      font-size: 12px;
      color: var(--font-color-sub);
    }

    /* Topic completion badge styles */
    .topic-completion-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 6px 10px;
      background: linear-gradient(135deg, #28a745, #20c997);
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: topicCompletionGlow 3s infinite;
    }

    .topic-checkmark {
      font-size: 16px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      margin-bottom: 1px;
    }

    .topic-completion-count {
      font-size: 9px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.3px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    @keyframes topicCompletionGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      }
    }

    .topic-suggestion-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .topic-suggestion-title {
      flex: 1;
      font-weight: 700;
      color: var(--font-color);
      font-size: 18px;
    }

    .topic-suggestion-difficulty {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      border: 1px solid var(--main-color);
    }

    .module-option.completed .level-badge {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: 2px solid white;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .module-option.completed .module-option-title {
      color: #28a745;
      font-weight: 700;
      text-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
    }

    /* Override the ::after pseudo-element for completed modules since we now have custom indicator */
    .module-option.completed::after {
      display: none;
    }

    /* Glitter effect for completed topic suggestion items */
    .topic-suggestion-item.has-completed {
      border: 3px solid transparent;
      background-clip: padding-box;
      position: relative;
      animation: topicCardGlow 4s infinite;
    }

    .topic-suggestion-item.has-completed::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #28a745, #20c997, #17a2b8, #ffd700);
      background-size: 500% 500%;
      border-radius: 13px;
      z-index: -1;
      animation: glitterBorder 3s linear infinite;
    }

    @keyframes topicCardGlow {
      0%, 100% {
        box-shadow: 4px 4px var(--main-color);
      }
      50% {
        box-shadow: 6px 6px var(--main-color), 0 0 20px rgba(255, 215, 0, 0.5);
      }
    }

    /* Lock indicator styles */
    .lock-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 8px 12px;
      background: linear-gradient(135deg, #6c757d, #495057);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      opacity: 0.8;
    }

    .lock-icon {
      font-size: 16px;
      color: white;
      margin-bottom: 2px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .lock-text {
      font-size: 9px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Enhanced locked module styling */
    .module-option.locked {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
      border: 2px solid #dee2e6;
    }

    .module-option.locked:hover {
      background-color: #f8f9fa;
      color: #6c757d;
      transform: none;
      box-shadow: none;
    }

    .module-option.locked .level-badge {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      opacity: 0.7;
    }

    .module-option.locked .module-option-title {
      color: #6c757d;
    }

    .module-option.locked .module-option-desc {
      color: #adb5bd;
      font-style: italic;
    }

    /* Custom alert dialog styles */
    .custom-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      animation: alertFadeIn 0.3s ease-out;
    }

    .alert-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .alert-content {
      background: white;
      border: 3px solid var(--main-color);
      border-radius: 15px;
      box-shadow: 8px 8px var(--main-color);
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: alertSlideIn 0.3s ease-out;
    }

    .alert-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px;
      border-bottom: 2px solid var(--main-color);
      background: linear-gradient(135deg, #ffebee, #fff3e0);
    }

    .alert-icon {
      font-size: 24px;
    }

    .alert-header h3 {
      flex: 1;
      margin: 0;
      color: var(--font-color);
      font-weight: 700;
    }

    .alert-close {
      background: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .alert-close:hover {
      background: var(--light-blue);
      transform: scale(1.1);
    }

    .alert-body {
      padding: 20px;
    }

    .alert-body p {
      margin: 10px 0;
      line-height: 1.6;
    }

    .alert-details p {
      margin: 5px 0;
      font-size: 14px;
    }

    .alert-footer {
      display: flex;
      gap: 10px;
      padding: 20px;
      border-top: 2px solid var(--main-color);
      background: var(--bg-color);
      justify-content: flex-end;
    }

    .alert-btn {
      padding: 10px 20px;
      border: 2px solid var(--main-color);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 3px 3px var(--main-color);
    }

    .quiz-btn {
      background: var(--tertiary-color);
      color: white;
    }

    .quiz-btn:hover {
      background: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 5px 5px var(--main-color);
    }

    .close-btn {
      background: white;
      color: var(--font-color);
    }

    .close-btn:hover {
      background: var(--bg-color);
      transform: translateY(-2px);
      box-shadow: 5px 5px var(--main-color);
    }

    @keyframes alertFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes alertSlideIn {
      from {
        transform: translateY(-50px) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand" href="home.html">
      <i class="bi-back"></i>
      <span>MathAnywhere</span>
    </a>

    <div class="d-lg-none ms-auto me-4">
      <a href="#top" class="navbar-icon bi-person smoothscroll"></a>
    </div>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-lg-5 me-lg-auto">
        <li class="nav-item">
          <a class="nav-link" href="home.html">Home</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="index.html#section_2">Lessons & Exercises</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="index.html#section_3">Journey</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="deri_graph.html">Derivative calc & graphing</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<section class="profile-section">
  <div class="container">
    <h1 class="mb-4">User Profile</h1>
  </div>
</section>

<div class="container">
  <div class="profile-container">
    <div class="profile-header">
      <div class="profile-avatar" id="avatar">
        <!-- Avatar will be set by JavaScript -->
      </div>
      <div class="profile-info">
        <h2 id="username">Username: Guest</h2>
        <p id="level">Level: Beginner</p>
      </div>
    </div>

    <div class="section-title">
      <h3>Overall Progress</h3>
    </div>
    <div class="progress-container">
      <div class="progress-label">
        <span>Completion</span>
        <span id="progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
    </div>

    <!-- Welcome section for beginners who haven't taken the quiz -->
    <div class="section-title" id="beginner-welcome-section" style="display: none;">
      <h3>ðŸŽ¯ Welcome to Your Learning Journey!</h3>
    </div>
    <div class="empty-state" id="beginner-welcome-container" style="display: none; margin: 20px 0; padding: 30px;">
      <h4 style="color: var(--accent-color); margin-bottom: 20px;">Ready to discover your calculus path?</h4>
      <p style="font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
        Take our <strong>"Where do I start?"</strong> assessment quiz to:
      </p>
      <div style="text-align: left; max-width: 400px; margin: 0 auto 25px auto;">
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Discover your current skill level</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Get personalized topic recommendations</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Unlock your learning mastery dashboard</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Access your personalized learning path</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Track achievements and milestones</p>
      </div>
      <button class="button primary" onclick="window.location.href='quiz.html'" style="margin: 10px; font-size: 18px; padding: 15px 30px;">
        <i class="bi bi-play-circle-fill"></i> Take Assessment Quiz
      </button>
      <br>
      <button class="button" onclick="window.location.href='home.html'" style="margin: 10px;">
        <i class="bi bi-book"></i> Browse Topics First
      </button>
    </div>

    <div class="section-title" id="suggested-topics-section" style="display: none;">
      <h3>Suggested Topics to Focus On</h3>
    </div>
    <div class="topic-suggestions" id="topic-suggestions" style="display: none;">
      <!-- Topic suggestions will be added here -->
      <div class="empty-state">
        Take the assessment quiz to get personalized topic suggestions.
      </div>
    </div>

    <!-- Learning Mastery Progress -->
    <div class="section-title" id="learning-mastery-section" style="display: none;">
      <h3>Learning Mastery</h3>
    </div>
    <div class="mastery-container" id="mastery-container" style="display: none;">
      <div class="empty-state">
        Complete the quiz to see your concept mastery breakdown.
      </div>
    </div>

    <!-- Gap Analysis and Adaptive Learning -->
    <div class="section-title" id="learning-path-section" style="display: none;">
      <h3>Learning Path</h3>
    </div>
    <div class="learning-path-container" id="learning-path-container" style="display: none;">
      <div class="empty-state">
        Your personalized learning journey will appear here after taking the quiz.
      </div>
    </div>

    <!-- Achievements and Milestones -->
    <div class="section-title" id="achievements-section" style="display: none;">
      <h3>Achievements</h3>
    </div>
    <div class="achievements-container" id="achievements-container" style="display: none;">
      <div class="empty-state">
        Start learning to unlock achievements!
      </div>
    </div>

    <div class="section-title">
      <h3>Actions</h3>
    </div>
    
    <!-- System Notice -->
    <div style="background-color: #e8f5e8; border: 2px solid var(--tertiary-color); border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
      <p style="margin: 0; color: var(--font-color); font-weight: 600;">
        <i class="bi bi-info-circle" style="color: var(--tertiary-color);"></i> 
        System automatically handles progress tracking, mastery updates, and correct-answers-only mode
      </p>
      <p style="margin: 10px 0 0 0; font-size: 14px; color: var(--font-color-sub);">
        ðŸ“ˆ Each correct answer in practice/quiz increases topic mastery by 5%<br>
        ðŸ’¾ Progress automatically saves and persists after logout<br>
        ðŸŽ¯ Use "Demo" button to test the system
      </p>
    </div>
    
    <div class="button-container">
      <button class="button" onclick="window.location.href='modules.html'">
        <i class="bi bi-grid-3x3-gap"></i> View All Modules
      </button>
      <button class="button" onclick="window.location.href='home.html'">
        <i class="bi bi-house"></i> Home
      </button>
      <button class="button" onclick="testCorrectAnswerDemo()">
        <i class="bi bi-check-circle"></i> Demo: Answer Question Correctly
      </button>
      <button class="button" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>

    <div class="section-title">
      <h3>Learning Progress by Difficulty Level</h3>
    </div>
    
    <!-- Novice Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>ðŸŸ¢ Novice Level</span>
        <span id="novice-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar novice-progress" id="novice-progress-bar" style="background: linear-gradient(90deg, #28a745, #20c997);"></div>
      </div>
      <div class="progress-details">
        <small id="novice-details">0 of 7 modules completed</small>
      </div>
    </div>

    <!-- Intermediate Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>ðŸŸ¡ Intermediate Level</span>
        <span id="intermediate-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar intermediate-progress" id="intermediate-progress-bar" style="background: linear-gradient(90deg, #ffc107, #fd7e14);"></div>
      </div>
      <div class="progress-details">
        <small id="intermediate-details">0 of 7 modules completed</small>
      </div>
    </div>

    <!-- Advanced Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>ðŸ”´ Advanced Level</span>
        <span id="advanced-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar advanced-progress" id="advanced-progress-bar" style="background: linear-gradient(90deg, #dc3545, #ff6b6b);"></div>
      </div>
      <div class="progress-details">
        <small id="advanced-details">0 of 7 modules completed</small>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer section-padding">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-12 mb-4 pb-2">
        <a class="navbar-brand mb-2" href="home.html">
          <i class="bi-back"></i>
          <span>MathAnywhere</span>
        </a>
      </div>

      <div class="col-lg-3 col-md-4 col-6 mb-4 mb-lg-0">
        <h6 class="site-footer-title mb-3">Information</h6>
        <p class="text-white d-flex mb-1">
          <a href="tel: 305-240-9671" class="site-footer-link">
            013-3321094
          </a>
        </p>
        <p class="text-white d-flex">
          <a href="mailto:info@company.com" class="site-footer-link">
            2022841556@student.uitm.edu.my
          </a>
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/jquery.sticky.js"></script>

<script type="module">
  // âœ… Import Firebase Modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  // âœ… Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBUfSOSpmCdWUGTVbSQsMCH-JVmrjpfdPY",
    authDomain: "fyp-lutfi-naim.firebaseapp.com",
    projectId: "fyp-lutfi-naim",
    storageBucket: "fyp-lutfi-naim.firebasestorage.app",
    messagingSenderId: "231274529807",
    appId: "1:231274529807:web:c4ea279f9e7581bd674f7a",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);


  function updateUI(username, level, moduleProgress, overallProgress) {
    // Update avatar with first letter of username
    const avatar = document.getElementById('avatar');
    avatar.textContent = username.charAt(0).toUpperCase();

    document.getElementById('username').textContent = username;
    document.getElementById('level').textContent = `Level: ${level}`;
    
    // Calculate progress for each difficulty level
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    
    // Calculate progress for each difficulty level
    difficultyLevels.forEach(difficulty => {
      let completedModules = 0;
      let totalProgress = 0;
      
      browseTopics.forEach(topic => {
        const moduleKey = `${topic} - ${difficulty}`;
        const progress = moduleProgress[moduleKey] || 0;
        totalProgress += progress;
        if (progress >= 80) {
          completedModules++;
        }
      });
      
      const averageProgress = Math.round(totalProgress / browseTopics.length);
      const difficultyLower = difficulty.toLowerCase();
      
      // Update progress bar
      document.getElementById(`${difficultyLower}-progress-bar`).style.width = `${averageProgress}%`;
      document.getElementById(`${difficultyLower}-progress-percentage`).textContent = `${averageProgress}%`;
      document.getElementById(`${difficultyLower}-details`).textContent = `${completedModules} of ${browseTopics.length} modules completed`;
    });

    // Update topic suggestions
    const topicSuggestionsContainer = document.getElementById('topic-suggestions');
    topicSuggestionsContainer.innerHTML = '';

    // Get weak topics and recommendations from session storage
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const recommendations = JSON.parse(sessionStorage.getItem('recommendations') || '[]');

    if (weakTopics.length > 0) {
      // Hide the empty state if we have suggestions
      const emptyState = topicSuggestionsContainer.querySelector('.empty-state');
      if (emptyState) {
        emptyState.style.display = 'none';
      }

      // Create topic suggestions based on weak topics
      weakTopics.forEach((topic, index) => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'topic-suggestion-item';
        
        // Determine recommended level based on user's current level and progress
        const userLevel = level || 'Beginner';
        const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
        let recommendedLevel = 'Novice'; // default recommendation
        let recommendationReason = '';
        
        // Smart recommendation logic based on user level and progress
        if (userLevel === 'Beginner' || userLevel === 'Novice') {
          recommendedLevel = 'Novice';
          recommendationReason = 'Start with fundamentals';
        } else if (userLevel === 'Intermediate') {
          // Check if user has completed novice level for this topic
          const noviceKey = `${topic} - Novice`;
          const noviceProgress = moduleProgress[noviceKey] || 0;
          
          if (noviceProgress >= 80) {
            recommendedLevel = 'Intermediate';
            recommendationReason = 'Ready for next level';
          } else {
            recommendedLevel = 'Novice';
            recommendationReason = 'Review basics first';
          }
        } else if (userLevel === 'Advanced') {
          // Check progress to recommend appropriate level
          const noviceKey = `${topic} - Novice`;
          const intermediateKey = `${topic} - Intermediate`;
          const noviceProgress = moduleProgress[noviceKey] || 0;
          const intermediateProgress = moduleProgress[intermediateKey] || 0;
          
          if (intermediateProgress >= 80) {
            recommendedLevel = 'Advanced';
            recommendationReason = 'Challenge yourself';
          } else if (noviceProgress >= 80) {
            recommendedLevel = 'Intermediate';
            recommendationReason = 'Build on basics';
          } else {
            recommendedLevel = 'Novice';
            recommendationReason = 'Strengthen foundation';
          }
        }

        // Map topics to their specific HTML pages (use recommended level)
        let topicPage = '';
        switch(topic) {
          case "Introduction to derivatives":
            topicPage = "Introduction_to_derivatives.html";
            break;
          case "The definition of Derivative":
            topicPage = "The_definition_of_derivative.html";
            break;
          case "Rules of Differentiation":
            topicPage = "rule.html";
            break;
          case "Equation of Tangent":
            topicPage = "Equation-of-tangent.html";
            break;
          case "Second Derivative":
            topicPage = "Second-derivative.html";
            break;
          case "Implicit Differentiations":
            topicPage = "Implicit-differentiation.html";
            break;
          case "Linear Approximation & Differentials":
            topicPage = "linear-approx-differentials.html";
            break;
          default:
            // If no specific page is found, use the recommended level page
            topicPage = `${recommendedLevel.toLowerCase()}.html`;
        }

        // Check if topic has any completed modules
        const currentModuleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
        const noviceKey = `${topic} - Novice`;
        const intermediateKey = `${topic} - Intermediate`;
        const advancedKey = `${topic} - Advanced`;
        const noviceProgress = currentModuleProgress[noviceKey] || 0;
        const intermediateProgress = currentModuleProgress[intermediateKey] || 0;
        const advancedProgress = currentModuleProgress[advancedKey] || 0;
        
        const hasCompletedModules = noviceProgress >= 80 || intermediateProgress >= 80 || advancedProgress >= 80;
        const totalCompletedModules = (noviceProgress >= 80 ? 1 : 0) + (intermediateProgress >= 80 ? 1 : 0) + (advancedProgress >= 80 ? 1 : 0);
        
        const topicCompletionBadge = hasCompletedModules ? 
          `<div class="topic-completion-badge">
            <span class="topic-checkmark">âœ“</span>
            <span class="topic-completion-count">${totalCompletedModules}/3</span>
           </div>` : '';

        // Add glitter class if modules are completed
        const completedClass = hasCompletedModules ? ' has-completed' : '';
        suggestionDiv.className = `topic-suggestion-item${completedClass}`;

        suggestionDiv.innerHTML = `
          <div class="topic-suggestion-header">
            <span class="topic-suggestion-title">${topic}</span>
            <span class="topic-suggestion-difficulty ${getRecommendationClass(recommendedLevel)}" title="${recommendationReason}">Recommended: ${recommendedLevel}</span>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Profile</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans&display=swap" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-icons.css" rel="stylesheet">
  <link href="css/templatemo-topic-listing.css" rel="stylesheet">

  <style>
    :root {
      --input-focus: #2d8cf0;
      --font-color: #323232;
      --font-color-sub: #666;
      --bg-color: #f7f9fc;
      --main-color: black;
      --accent-color: #ff6b6b;
      --secondary-color: #feca57;
      --tertiary-color: #1dd1a1;
      --light-blue: #54a0ff;
      --pink: #ff9ff3;
      --purple: #5f27cd;
    }

    body {
      font-family: 'Fira Code', monospace;
      background-color: var(--bg-color);
      color: var(--font-color);
      margin: 0;
      padding: 0;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Navbar */
    .navbar {
      background-color: yellow;
      border-bottom: 2px solid var(--main-color);
      box-shadow: 4px 4px var(--main-color);
      margin-bottom: 10px;
    }

    .navbar-brand {
      color: var(--accent-color);
      font-weight: 700;
      font-size: 1.5rem;
      transition: transform 0.3s ease;
    }
    
    .navbar-brand:hover {
      transform: scale(1.05);
    }

    .navbar-nav .nav-link {
      color: var(--font-color);
      font-weight: 600;
      border-radius: 5px;
      padding: 8px 15px;
      margin: 0 5px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .navbar-nav .nav-link:hover {
      color: var(--input-focus);
      border: 2px solid var(--input-focus);
      box-shadow: 3px 3px var(--main-color);
      transform: translateY(-2px);
    }

    /* Profile Section Styling */
    .profile-section {
      background: white;
      padding: 60px 0;
      border-bottom: 2px solid var(--main-color);
      box-shadow: 0 4px 0 var(--main-color);
      margin-bottom: 35px;
      text-align: center;
    }

    .profile-container {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      box-shadow: 4px 4px var(--main-color);
      padding: 30px;
      margin: 20px auto;
      max-width: 800px;
      transition: all 0.3s ease;
    }

    .profile-container:hover {
      transform: translateY(-5px);
      box-shadow: 6px 6px var(--main-color);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--main-color);
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: var(--accent-color);
      color: white;
      font-size: 60px;
      border: 3px solid var(--main-color);
      box-shadow: 4px 4px var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .profile-avatar:hover {
      transform: rotate(5deg);
      box-shadow: 6px 6px var(--main-color);
    }

    .profile-info {
      flex-grow: 1;
      text-align: left;
    }

    .profile-info h2 {
      font-weight: 700;
      color: var(--font-color);
      margin-bottom: 10px;
      position: relative;
      display: inline-block;
    }
    
    .profile-info h2:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--accent-color);
      transition: width 0.3s ease;
    }
    
    .profile-info h2:hover:after {
      width: 100%;
    }

    .profile-info p {
      margin: 5px 0;
      font-weight: 600;
      color: var(--font-color-sub);
    }

    #level {
      display: inline-block;
      background-color: var(--secondary-color);
      color: var(--font-color);
      font-weight: 700;
      padding: 5px 15px;
      border-radius: 20px;
      border: 2px solid var(--main-color);
      box-shadow: 3px 3px var(--main-color);
      transition: all 0.3s ease;
    }

    #level:hover {
      transform: translateY(-3px);
      box-shadow: 5px 5px var(--main-color);
    }
    
    .section-title {
      margin: 40px 0 20px 0;
      position: relative;
    }
    
    .section-title h3 {
      color: var(--font-color);
      font-weight: 700;
      font-size: 1.5rem;
      display: inline-block;
      position: relative;
      margin-bottom: 0;
      padding-bottom: 8px;
    }
    
    .section-title h3:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--tertiary-color);
      transition: width 0.3s ease;
    }
    
    .section-title h3:hover:after {
      width: 100%;
    }

    .progress-container {
      margin: 25px 0;
      background-color: white;
      padding: 20px;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .progress-container:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .module-title {
      font-weight: 700;
      color: var(--font-color);
    }

    .progress {
      height: 20px;
      background-color: var(--bg-color);
      border-radius: 10px;
      border: 2px solid var(--main-color);
      overflow: hidden;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 5px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--light-blue));
      border-radius: 8px;
      transition: width 1s ease;
    }
    
    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--font-color-sub);
      font-style: italic;
      background-color: var(--bg-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }
    
    .empty-state:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .topic-suggestions {
      margin: 25px 0;
    }

    .topic-suggestion-item {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .topic-suggestion-item:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .topic-suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .topic-suggestion-title {
      font-weight: 700;
      color: var(--font-color);
      font-size: 1.1rem;
    }

    .topic-suggestion-difficulty {
      background-color: var(--secondary-color);
      color: var(--font-color);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: help;
      transition: all 0.3s ease;
      position: relative;
    }

    .topic-suggestion-difficulty:hover {
      background-color: var(--tertiary-color);
      color: white;
      transform: scale(1.05);
    }

    .topic-suggestion-difficulty[title]:hover::after {
      content: attr(title);
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--main-color);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-top: 5px;
    }

    .topic-suggestion-difficulty.novice-rec {
      background-color: var(--tertiary-color);
      color: white;
    }

    .topic-suggestion-difficulty.intermediate-rec {
      background-color: var(--secondary-color);
      color: var(--font-color);
    }

    .topic-suggestion-difficulty.advanced-rec {
      background-color: var(--accent-color);
      color: white;
    }

    .topic-suggestion-difficulty.novice-rec:hover {
      background-color: #17a2b8;
    }

    .topic-suggestion-difficulty.intermediate-rec:hover {
      background-color: #e0a800;
    }

    .topic-suggestion-difficulty.advanced-rec:hover {
      background-color: #dc3545;
    }

    .topic-suggestion-content {
      color: var(--font-color-sub);
      margin-bottom: 15px;
    }

    .topic-suggestion-actions {
      display: flex;
      gap: 10px;
    }

    .topic-suggestion-btn {
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .topic-suggestion-btn:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
    }

    .button-container {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .button {
      background-color: white;
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 12px 25px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .button:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--accent-color);
      transition: all 0.4s ease;
      z-index: -1;
    }

    .button:hover:before {
      left: 0;
    }

    .button:hover {
      color: white;
      transform: translateY(-5px);
      box-shadow: 6px 6px var(--main-color);
    }

    .button:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px var(--main-color);
    }

    .button.primary {
      background-color: var(--accent-color);
      color: white;
    }

    .button.primary:before {
      background: var(--light-blue);
    }

    /* Footer */
    footer {
      background-color: white;
      color: var(--font-color);
      text-align: center;
      padding: 40px 0;
      border-top: 2px solid var(--main-color);
      margin-top: 40px;
    }

    footer .navbar-brand {
      color: var(--accent-color);
      font-weight: 700;
      transition: all 0.3s ease;
    }
    
    footer .navbar-brand:hover {
      transform: scale(1.1);
    }

    footer a {
      color: var(--input-focus);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    footer a:hover {
      color: var(--accent-color);
      text-decoration: underline;
    }

    .site-footer-title {
      color: var(--font-color);
      font-weight: 700;
      margin-bottom: 15px;
      position: relative;
      display: inline-block;
    }
    
    .site-footer-title:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--secondary-color);
      transition: width 0.3s ease;
    }
    
    .site-footer-title:hover:after {
      width: 100%;
    }

    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }

      .profile-info {
        text-align: center;
      }
      
      .profile-info h2:after {
        left: 25%;
        width: 50%;
      }
      
      .profile-info h2:hover:after {
        width: 80%;
        left: 10%;
      }
      
      .section-title h3 {
        text-align: center;
        display: block;
      }
      
      .section-title h3:after {
        left: 25%;
        width: 50%;
      }
      
      .section-title h3:hover:after {
        width: 50%;
      }

      .button-container {
        flex-direction: column;
      }
    }

    /* Learning Mastery styles */
    .mastery-container {
      margin: 25px 0;
    }

    .mastery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .mastery-section-title {
      font-weight: 700;
      color: var(--font-color);
      margin: 0;
    }

    .refresh-btn {
      background-color: var(--bg-color);
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 5px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .refresh-btn i {
      font-size: 16px;
    }

    .refresh-btn:hover {
      background-color: var(--light-blue);
      color: white;
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }
    
    .mastery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .mastery-item {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .mastery-item:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .mastery-title {
      font-weight: 700;
      color: var(--font-color);
      margin-bottom: 10px;
    }

    .mastery-bar-container {
      height: 15px;
      background-color: var(--bg-color);
      border-radius: 7px;
      border: 1px solid var(--main-color);
      margin-bottom: 5px;
      overflow: hidden;
    }

    .mastery-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--tertiary-color), var(--light-blue));
      border-radius: 7px;
      transition: width 0.5s ease;
    }

    .mastery-percentage {
      font-size: 14px;
      font-weight: 600;
      color: var(--font-color);
      text-align: right;
    }

    .mastery-description {
      font-size: 12px;
      color: var(--font-color-sub);
      margin-bottom: 8px;
      line-height: 1.3;
      height: 32px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .topic-practice-btn {
      background-color: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 4px 10px;
      margin-top: 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
    }

    .topic-practice-btn:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }

    .mastery-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      border: 2px solid var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 2px 2px var(--main-color);
      transform: rotate(15deg);
    }

    /* Learning Path styles */
    .learning-path-container {
      margin: 25px 0;
    }

    .learning-path {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .learning-path:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .path-steps {
      position: relative;
      padding-left: 30px;
    }

    .path-steps:before {
      content: '';
      position: absolute;
      top: 0;
      left: 15px;
      height: 100%;
      width: 2px;
      background-color: var(--accent-color);
    }

    .path-step {
      position: relative;
      margin-bottom: 30px;
    }

    .path-step:last-child {
      margin-bottom: 0;
    }

    .path-step:before {
      content: '';
      position: absolute;
      top: 5px;
      left: -30px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: white;
      border: 2px solid var(--accent-color);
      z-index: 1;
    }

    .path-step.completed:before {
      background-color: var(--tertiary-color);
      border-color: var(--main-color);
    }

    .path-step.current:before {
      background-color: var(--secondary-color);
      border-color: var(--main-color);
      animation: pulse 1.5s infinite;
    }

    .path-step-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .path-step-title {
      font-weight: 700;
      color: var(--font-color);
    }

    .path-step-status {
      font-size: 14px;
      font-weight: 600;
    }

    .path-step-content {
      color: var(--font-color-sub);
      margin-bottom: 10px;
    }

    .path-step-action {
      display: inline-block;
      background-color: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 5px 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
      font-size: 14px;
    }

    .path-step-action:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }

    /* Learning Path Progress and Completion Styles */
    .completion-tick {
      color: var(--tertiary-color);
      font-weight: 700;
      font-size: 16px;
      margin-left: 8px;
      animation: checkmark-appear 0.5s ease-in-out;
    }

    @keyframes checkmark-appear {
      0% {
        opacity: 0;
        transform: scale(0);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .path-step-progress {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .path-progress-bar-container {
      flex: 1;
      height: 12px;
      background-color: var(--bg-color);
      border-radius: 6px;
      border: 1px solid var(--main-color);
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .path-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--tertiary-color), var(--light-blue));
      border-radius: 6px;
      transition: width 0.5s ease;
      position: relative;
    }

    .path-progress-bar::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background-image: linear-gradient(
        -45deg,
        rgba(255, 255, 255, 0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 30px 30px;
      animation: progress-animation 2s linear infinite;
    }

    @keyframes progress-animation {
      0% {
        background-position: 0 0;
      }
      100% {
        background-position: 30px 30px;
      }
    }

    .path-progress-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--font-color);
      min-width: 35px;
      text-align: right;
    }

    /* Enhanced completed step styling */
    .path-step.completed .path-step-title {
      color: var(--tertiary-color);
    }

    .path-step.completed .path-progress-bar {
      background: var(--tertiary-color);
    }

    /* Achievements styles */
    .achievements-container {
      margin: 25px 0;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
    }

    .achievement {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .achievement:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .achievement.locked {
      filter: grayscale(1);
      opacity: 0.7;
    }

    .achievement-icon {
      width: 50px;
      height: 50px;
      background-color: var(--bg-color);
      border-radius: 50%;
      border: 2px solid var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      font-size: 24px;
    }

    .achievement-title {
      font-weight: 700;
      color: var(--font-color);
      font-size: 14px;
      margin-bottom: 5px;
    }

    .achievement-description {
      font-size: 12px;
      color: var(--font-color-sub);
    }

    /* Toast Notification */
    .toast-notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: flex;
      align-items: center;
      background-color: white;
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.5s ease;
    }

    .toast-notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-icon {
      font-size: 24px;
      margin-right: 15px;
      animation: pulse 1.5s infinite;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--accent-color);
    }

    .toast-message {
      font-size: 14px;
      color: var(--font-color-sub);
    }

    /* Module Dropdown Styles */
    .module-dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-toggle {
      position: relative;
    }

    .module-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 8px;
      box-shadow: 4px 4px var(--main-color);
      z-index: 1000;
      display: none;
      min-width: 280px;
    }

    .module-options.show {
      display: block;
    }

    .module-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      text-decoration: none;
      color: var(--font-color);
      border-bottom: 1px solid var(--bg-color);
      transition: all 0.3s ease;
      position: relative;
    }

    .module-option:last-child {
      border-bottom: none;
    }

    .module-option:hover {
      background-color: var(--bg-color);
      color: var(--font-color);
      text-decoration: none;
    }

    .module-option-content {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .level-badge {
      min-width: 60px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-align: center;
      text-transform: uppercase;
      border: 1px solid var(--main-color);
    }

    .level-badge.novice {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .level-badge.intermediate {
      background: linear-gradient(135deg, #ffc107, #fd7e14);
      color: white;
    }

    .level-badge.advanced {
      background: linear-gradient(135deg, #dc3545, #fd7e14);
      color: white;
    }

    .module-option-text {
      flex: 1;
    }

    .module-option-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .module-option-desc {
      font-size: 12px;
      color: var(--font-color-sub);
      line-height: 1.3;
    }

    .module-option.suggested {
      background-color: #e8f5e8;
      border-left: 4px solid var(--tertiary-color);
    }

    .module-option.suggested::after {
      content: "Recommended";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: var(--tertiary-color);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    .module-option.completed {
      background-color: #f8f9fa;
      color: var(--font-color-sub);
    }

    .module-option.completed::after {
      content: "âœ“ Completed";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: var(--tertiary-color);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    /* Enhanced completion indicator styles with glitter effects */
    .completion-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 8px 12px;
      background: linear-gradient(135deg, #28a745, #20c997, #17a2b8, #28a745);
      background-size: 400% 400%;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: glitterPulse 2s infinite, glitterShine 3s infinite;
      border: 2px solid transparent;
      background-clip: padding-box;
      position: relative;
    }

    .completion-indicator::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #00ff00, #00ffff, #ff00ff, #ffd700);
      background-size: 600% 600%;
      border-radius: 10px;
      z-index: -1;
      animation: glitterBorder 2s linear infinite;
    }

    @keyframes glitterBorder {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    @keyframes glitterPulse {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 10px rgba(255, 215, 0, 0.5);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3), 0 0 20px rgba(255, 215, 0, 0.8);
        transform: scale(1.05);
      }
    }

    @keyframes glitterShine {
      0% {
        background-position: 0% 50%;
      }
      100% {
        background-position: 400% 50%;
      }
    }

    .completion-checkmark {
      font-size: 20px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 215, 0, 0.5);
      margin-bottom: 2px;
      animation: checkmarkGlow 2s infinite;
    }

    @keyframes checkmarkGlow {
      0%, 100% {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 215, 0, 0.5);
      }
      50% {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 255, 255, 0.5);
      }
    }

    .completion-text {
      font-size: 10px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 5px rgba(255, 215, 0, 0.3);
    }

    /* Enhanced module option completed styling with glitter border */
    .module-option.completed {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border: 3px solid transparent;
      background-clip: padding-box;
      position: relative;
      overflow: visible;
      animation: completedModuleGlow 3s infinite;
    }

    .module-option.completed::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #28a745, #20c997, #17a2b8, #ffd700);
      background-size: 600% 600%;
      border-radius: 10px;
      z-index: -1;
      animation: glitterBorder 2s linear infinite;
    }

    @keyframes completedModuleGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3), 0 0 15px rgba(255, 215, 0, 0.4);
      }
    }

    .module-option.completed:hover {
      background: linear-gradient(135deg, #e9ecef, #dee2e6);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4), 0 0 25px rgba(255, 215, 0, 0.6);
    }

    /* Enhanced topic completion badge with glitter */
    .topic-completion-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 6px 10px;
      background: linear-gradient(135deg, #28a745, #20c997, #17a2b8, #28a745);
      background-size: 400% 400%;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: topicGlitterGlow 3s infinite, glitterShine 3s infinite;
      border: 2px solid transparent;
      background-clip: padding-box;
      position: relative;
    }

    .topic-completion-badge::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #00ff00, #00ffff, #ff00ff, #ffd700);
      background-size: 500% 500%;
      border-radius: 8px;
      z-index: -1;
      animation: glitterBorder 2.5s linear infinite;
    }

    @keyframes topicGlitterGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 8px rgba(255, 215, 0, 0.3);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4), 0 0 20px rgba(255, 215, 0, 0.7);
      }
    }

    /* Enhanced progress bar animations */
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--light-blue));
      border-radius: 8px;
      transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: progressShine 2s infinite;
    }

    @keyframes progressShine {
      0% {
        left: -100%;
      }
      100% {
        left: 100%;
      }
    }

    /* Enhanced difficulty level progress bars with animations */
    .novice-progress {
      background: linear-gradient(90deg, #28a745, #20c997, #17a2b8);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    .intermediate-progress {
      background: linear-gradient(90deg, #ffc107, #fd7e14, #ff6b6b);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    .advanced-progress {
      background: linear-gradient(90deg, #dc3545, #ff6b6b, #fd7e14);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    @keyframes progressFlow {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    .module-option.locked {
      background-color: #f8f9fa;
      color: #adb5bd;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .module-option.locked::after {
      content: "ðŸ”’ Locked";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: #6c757d;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    .module-option.locked:hover {
      background-color: #f8f9fa;
      color: #adb5bd;
    }

    .module-option.locked .module-option-desc {
      color: #adb5bd;
    }

    .module-option-desc {
      font-size: 12px;
      color: var(--font-color-sub);
      line-height: 1.3;
    }

    .module-option-desc::after {
      content: "";
      display: block;
      margin-top: 2px;
    }

    .module-option.suggested .module-option-desc {
      color: #155724;
      font-weight: 500;
    }

    .module-option.completed .module-option-desc {
      color: #6c757d;
      font-style: italic;
    }

    /* Tooltip for additional information */
    .module-option:hover .module-option-desc {
      font-weight: 600;
    }

    .module-option.suggested:hover {
      background-color: #d4edda;
    }

    .module-option.completed:hover {
      background-color: #e2e3e5;
    }

    .novice-progress {
      background: linear-gradient(90deg, #28a745, #20c997);
    }

    .intermediate-progress {
      background: linear-gradient(90deg, #ffc107, #fd7e14);
    }

    .advanced-progress {
      background: linear-gradient(90deg, #dc3545, #ff6b6b);
    }

    .progress-details {
      text-align: right;
      font-size: 12px;
      color: var(--font-color-sub);
    }

    /* Topic completion badge styles */
    .topic-completion-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 6px 10px;
      background: linear-gradient(135deg, #28a745, #20c997);
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: topicCompletionGlow 3s infinite;
    }

    .topic-checkmark {
      font-size: 16px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      margin-bottom: 1px;
    }

    .topic-completion-count {
      font-size: 9px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.3px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    @keyframes topicCompletionGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      }
    }

    .topic-suggestion-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .topic-suggestion-title {
      flex: 1;
      font-weight: 700;
      color: var(--font-color);
      font-size: 18px;
    }

    .topic-suggestion-difficulty {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      border: 1px solid var(--main-color);
    }

    .module-option.completed .level-badge {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: 2px solid white;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .module-option.completed .module-option-title {
      color: #28a745;
      font-weight: 700;
      text-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
    }

    /* Override the ::after pseudo-element for completed modules since we now have custom indicator */
    .module-option.completed::after {
      display: none;
    }

    /* Glitter effect for completed topic suggestion items */
    .topic-suggestion-item.has-completed {
      border: 3px solid transparent;
      background-clip: padding-box;
      position: relative;
      animation: topicCardGlow 4s infinite;
    }

    .topic-suggestion-item.has-completed::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #28a745, #20c997, #17a2b8, #ffd700);
      background-size: 500% 500%;
      border-radius: 13px;
      z-index: -1;
      animation: glitterBorder 3s linear infinite;
    }

    @keyframes topicCardGlow {
      0%, 100% {
        box-shadow: 4px 4px var(--main-color);
      }
      50% {
        box-shadow: 6px 6px var(--main-color), 0 0 20px rgba(255, 215, 0, 0.5);
      }
    }

    /* Lock indicator styles */
    .lock-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 8px 12px;
      background: linear-gradient(135deg, #6c757d, #495057);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      opacity: 0.8;
    }

    .lock-icon {
      font-size: 16px;
      color: white;
      margin-bottom: 2px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .lock-text {
      font-size: 9px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Enhanced locked module styling */
    .module-option.locked {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
      border: 2px solid #dee2e6;
    }

    .module-option.locked:hover {
      background-color: #f8f9fa;
      color: #6c757d;
      transform: none;
      box-shadow: none;
    }

    .module-option.locked .level-badge {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      opacity: 0.7;
    }

    .module-option.locked .module-option-title {
      color: #6c757d;
    }

    .module-option.locked .module-option-desc {
      color: #adb5bd;
      font-style: italic;
    }

    /* Custom alert dialog styles */
    .custom-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      animation: alertFadeIn 0.3s ease-out;
    }

    .alert-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .alert-content {
      background: white;
      border: 3px solid var(--main-color);
      border-radius: 15px;
      box-shadow: 8px 8px var(--main-color);
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: alertSlideIn 0.3s ease-out;
    }

    .alert-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px;
      border-bottom: 2px solid var(--main-color);
      background: linear-gradient(135deg, #ffebee, #fff3e0);
    }

    .alert-icon {
      font-size: 24px;
    }

    .alert-header h3 {
      flex: 1;
      margin: 0;
      color: var(--font-color);
      font-weight: 700;
    }

    .alert-close {
      background: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .alert-close:hover {
      background: var(--light-blue);
      transform: scale(1.1);
    }

    .alert-body {
      padding: 20px;
    }

    .alert-body p {
      margin: 10px 0;
      line-height: 1.6;
    }

    .alert-details p {
      margin: 5px 0;
      font-size: 14px;
    }

    .alert-footer {
      display: flex;
      gap: 10px;
      padding: 20px;
      border-top: 2px solid var(--main-color);
      background: var(--bg-color);
      justify-content: flex-end;
    }

    .alert-btn {
      padding: 10px 20px;
      border: 2px solid var(--main-color);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 3px 3px var(--main-color);
    }

    .quiz-btn {
      background: var(--tertiary-color);
      color: white;
    }

    .quiz-btn:hover {
      background: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 5px 5px var(--main-color);
    }

    .close-btn {
      background: white;
      color: var(--font-color);
    }

    .close-btn:hover {
      background: var(--bg-color);
      transform: translateY(-2px);
      box-shadow: 5px 5px var(--main-color);
    }

    @keyframes alertFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes alertSlideIn {
      from {
        transform: translateY(-50px) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand" href="home.html">
      <i class="bi-back"></i>
      <span>MathAnywhere</span>
    </a>

    <div class="d-lg-none ms-auto me-4">
      <a href="#top" class="navbar-icon bi-person smoothscroll"></a>
    </div>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-lg-5 me-lg-auto">
        <li class="nav-item">
          <a class="nav-link" href="home.html">Home</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="index.html#section_2">Lessons & Exercises</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="index.html#section_3">Journey</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="deri_graph.html">Derivative calc & graphing</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<section class="profile-section">
  <div class="container">
    <h1 class="mb-4">User Profile</h1>
  </div>
</section>

<div class="container">
  <div class="profile-container">
    <div class="profile-header">
      <div class="profile-avatar" id="avatar">
        <!-- Avatar will be set by JavaScript -->
      </div>
      <div class="profile-info">
        <h2 id="username">Username: Guest</h2>
        <p id="level">Level: Beginner</p>
      </div>
    </div>

    <div class="section-title">
      <h3>Overall Progress</h3>
    </div>
    <div class="progress-container">
      <div class="progress-label">
        <span>Completion</span>
        <span id="progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
    </div>

    <!-- Welcome section for beginners who haven't taken the quiz -->
    <div class="section-title" id="beginner-welcome-section" style="display: none;">
      <h3>ðŸŽ¯ Welcome to Your Learning Journey!</h3>
    </div>
    <div class="empty-state" id="beginner-welcome-container" style="display: none; margin: 20px 0; padding: 30px;">
      <h4 style="color: var(--accent-color); margin-bottom: 20px;">Ready to discover your calculus path?</h4>
      <p style="font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
        Take our <strong>"Where do I start?"</strong> assessment quiz to:
      </p>
      <div style="text-align: left; max-width: 400px; margin: 0 auto 25px auto;">
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Discover your current skill level</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Get personalized topic recommendations</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Unlock your learning mastery dashboard</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Access your personalized learning path</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Track achievements and milestones</p>
      </div>
      <button class="button primary" onclick="window.location.href='quiz.html'" style="margin: 10px; font-size: 18px; padding: 15px 30px;">
        <i class="bi bi-play-circle-fill"></i> Take Assessment Quiz
      </button>
      <br>
      <button class="button" onclick="window.location.href='home.html'" style="margin: 10px;">
        <i class="bi bi-book"></i> Browse Topics First
      </button>
    </div>

    <div class="section-title" id="suggested-topics-section" style="display: none;">
      <h3>Suggested Topics to Focus On</h3>
    </div>
    <div class="topic-suggestions" id="topic-suggestions" style="display: none;">
      <!-- Topic suggestions will be added here -->
      <div class="empty-state">
        Take the assessment quiz to get personalized topic suggestions.
      </div>
    </div>

    <!-- Learning Mastery Progress -->
    <div class="section-title" id="learning-mastery-section" style="display: none;">
      <h3>Learning Mastery</h3>
    </div>
    <div class="mastery-container" id="mastery-container" style="display: none;">
      <div class="empty-state">
        Complete the quiz to see your concept mastery breakdown.
      </div>
    </div>

    <!-- Gap Analysis and Adaptive Learning -->
    <div class="section-title" id="learning-path-section" style="display: none;">
      <h3>Learning Path</h3>
    </div>
    <div class="learning-path-container" id="learning-path-container" style="display: none;">
      <div class="empty-state">
        Your personalized learning journey will appear here after taking the quiz.
      </div>
    </div>

    <!-- Achievements and Milestones -->
    <div class="section-title" id="achievements-section" style="display: none;">
      <h3>Achievements</h3>
    </div>
    <div class="achievements-container" id="achievements-container" style="display: none;">
      <div class="empty-state">
        Start learning to unlock achievements!
      </div>
    </div>

    <div class="section-title">
      <h3>Actions</h3>
    </div>
    
    <!-- System Notice -->
    <div style="background-color: #e8f5e8; border: 2px solid var(--tertiary-color); border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
      <p style="margin: 0; color: var(--font-color); font-weight: 600;">
        <i class="bi bi-info-circle" style="color: var(--tertiary-color);"></i> 
        System automatically handles progress tracking, mastery updates, and correct-answers-only mode
      </p>
      <p style="margin: 10px 0 0 0; font-size: 14px; color: var(--font-color-sub);">
        ðŸ“ˆ Each correct answer in practice/quiz increases topic mastery by 5%<br>
        ðŸ’¾ Progress automatically saves and persists after logout<br>
        ðŸŽ¯ Use "Demo" button to test the system
      </p>
    </div>
    
    <div class="button-container">
      <button class="button" onclick="window.location.href='modules.html'">
        <i class="bi bi-grid-3x3-gap"></i> View All Modules
      </button>
      <button class="button" onclick="window.location.href='home.html'">
        <i class="bi bi-house"></i> Home
      </button>
      <button class="button" onclick="testCorrectAnswerDemo()">
        <i class="bi bi-check-circle"></i> Demo: Answer Question Correctly
      </button>
      <button class="button" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>

    <div class="section-title">
      <h3>Learning Progress by Difficulty Level</h3>
    </div>
    
    <!-- Novice Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>ðŸŸ¢ Novice Level</span>
        <span id="novice-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar novice-progress" id="novice-progress-bar" style="background: linear-gradient(90deg, #28a745, #20c997);"></div>
      </div>
      <div class="progress-details">
        <small id="novice-details">0 of 7 modules completed</small>
      </div>
    </div>

    <!-- Intermediate Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>ðŸŸ¡ Intermediate Level</span>
        <span id="intermediate-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar intermediate-progress" id="intermediate-progress-bar" style="background: linear-gradient(90deg, #ffc107, #fd7e14);"></div>
      </div>
      <div class="progress-details">
        <small id="intermediate-details">0 of 7 modules completed</small>
      </div>
    </div>

    <!-- Advanced Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>ðŸ”´ Advanced Level</span>
        <span id="advanced-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar advanced-progress" id="advanced-progress-bar" style="background: linear-gradient(90deg, #dc3545, #ff6b6b);"></div>
      </div>
      <div class="progress-details">
        <small id="advanced-details">0 of 7 modules completed</small>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer section-padding">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-12 mb-4 pb-2">
        <a class="navbar-brand mb-2" href="home.html">
          <i class="bi-back"></i>
          <span>MathAnywhere</span>
        </a>
      </div>

      <div class="col-lg-3 col-md-4 col-6 mb-4 mb-lg-0">
        <h6 class="site-footer-title mb-3">Information</h6>
        <p class="text-white d-flex mb-1">
          <a href="tel: 305-240-9671" class="site-footer-link">
            013-3321094
          </a>
        </p>
        <p class="text-white d-flex">
          <a href="mailto:info@company.com" class="site-footer-link">
            2022841556@student.uitm.edu.my
          </a>
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/jquery.sticky.js"></script>

<script type="module">
  // âœ… Import Firebase Modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  // âœ… Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBUfSOSpmCdWUGTVbSQsMCH-JVmrjpfdPY",
    authDomain: "fyp-lutfi-naim.firebaseapp.com",
    projectId: "fyp-lutfi-naim",
    storageBucket: "fyp-lutfi-naim.firebasestorage.app",
    messagingSenderId: "231274529807",
    appId: "1:231274529807:web:c4ea279f9e7581bd674f7a",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);


  function updateUI(username, level, moduleProgress, overallProgress) {
    // Update avatar with first letter of username
    const avatar = document.getElementById('avatar');
    avatar.textContent = username.charAt(0).toUpperCase();

    document.getElementById('username').textContent = username;
    document.getElementById('level').textContent = `Level: ${level}`;
    
    // Calculate progress for each difficulty level
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    
    // Calculate progress for each difficulty level
    difficultyLevels.forEach(difficulty => {
      let completedModules = 0;
      let totalProgress = 0;
      
      browseTopics.forEach(topic => {
        const moduleKey = `${topic} - ${difficulty}`;
        const progress = moduleProgress[moduleKey] || 0;
        totalProgress += progress;
        if (progress >= 80) {
          completedModules++;
        }
      });
      
      const averageProgress = Math.round(totalProgress / browseTopics.length);
      const difficultyLower = difficulty.toLowerCase();
      
      // Update progress bar
      document.getElementById(`${difficultyLower}-progress-bar`).style.width = `${averageProgress}%`;
      document.getElementById(`${difficultyLower}-progress-percentage`).textContent = `${averageProgress}%`;
      document.getElementById(`${difficultyLower}-details`).textContent = `${completedModules} of ${browseTopics.length} modules completed`;
    });

    // Update topic suggestions
    const topicSuggestionsContainer = document.getElementById('topic-suggestions');
    topicSuggestionsContainer.innerHTML = '';

    // Get weak topics and recommendations from session storage
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const recommendations = JSON.parse(sessionStorage.getItem('recommendations') || '[]');

    if (weakTopics.length > 0) {
      // Hide the empty state if we have suggestions
      const emptyState = topicSuggestionsContainer.querySelector('.empty-state');
      if (emptyState) {
        emptyState.style.display = 'none';
      }

      // Create topic suggestions based on weak topics
      weakTopics.forEach((topic, index) => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'topic-suggestion-item';
        
        // Determine recommended level based on user's current level and progress
        const userLevel = level || 'Beginner';
        const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
        let recommendedLevel = 'Novice'; // default recommendation
        let recommendationReason = '';
        
        // Smart recommendation logic based on user level and progress
        if (userLevel === 'Beginner' || userLevel === 'Novice') {
          recommendedLevel = 'Novice';
          recommendationReason = 'Start with fundamentals';
        } else if (userLevel === 'Intermediate') {
          // Check if user has completed novice level for this topic
          const noviceKey = `${topic} - Novice`;
          const noviceProgress = moduleProgress[noviceKey] || 0;
          
          if (noviceProgress >= 80) {
            recommendedLevel = 'Intermediate';
            recommendationReason = 'Ready for next level';
          } else {
            recommendedLevel = 'Novice';
            recommendationReason = 'Review basics first';
          }
        } else if (userLevel === 'Advanced') {
          // Check progress to recommend appropriate level
          const noviceKey = `${topic} - Novice`;
          const intermediateKey = `${topic} - Intermediate`;
          const noviceProgress = moduleProgress[noviceKey] || 0;
          const intermediateProgress = moduleProgress[intermediateKey] || 0;
          
          if (intermediateProgress >= 80) {
            recommendedLevel = 'Advanced';
            recommendationReason = 'Challenge yourself';
          } else if (noviceProgress >= 80) {
            recommendedLevel = 'Intermediate';
            recommendationReason = 'Build on basics';
          } else {
            recommendedLevel = 'Novice';
            recommendationReason = 'Strengthen foundation';
          }
        }

        // Map topics to their specific HTML pages (use recommended level)
        let topicPage = '';
        switch(topic) {
          case "Introduction to derivatives":
            topicPage = "Introduction_to_derivatives.html";
            break;
          case "The definition of Derivative":
            topicPage = "The_definition_of_derivative.html";
            break;
          case "Rules of Differentiation":
            topicPage = "rule.html";
            break;
          case "Equation of Tangent":
            topicPage = "Equation-of-tangent.html";
            break;
          case "Second Derivative":
            topicPage = "Second-derivative.html";
            break;
          case "Implicit Differentiations":
            topicPage = "Implicit-differentiation.html";
            break;
          case "Linear Approximation & Differentials":
            topicPage = "linear-approx-differentials.html";
            break;
          default:
            // If no specific page is found, use the recommended level page
            topicPage = `${recommendedLevel.toLowerCase()}.html`;
        }

        // Check if topic has any completed modules
        const currentModuleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
        const noviceKey = `${topic} - Novice`;
        const intermediateKey = `${topic} - Intermediate`;
        const advancedKey = `${topic} - Advanced`;
        const noviceProgress = currentModuleProgress[noviceKey] || 0;
        const intermediateProgress = currentModuleProgress[intermediateKey] || 0;
        const advancedProgress = currentModuleProgress[advancedKey] || 0;
        
        const hasCompletedModules = noviceProgress >= 80 || intermediateProgress >= 80 || advancedProgress >= 80;
        const totalCompletedModules = (noviceProgress >= 80 ? 1 : 0) + (intermediateProgress >= 80 ? 1 : 0) + (advancedProgress >= 80 ? 1 : 0);
        
        const topicCompletionBadge = hasCompletedModules ? 
          `<div class="topic-completion-badge">
            <span class="topic-checkmark">âœ“</span>
            <span class="topic-completion-count">${totalCompletedModules}/3</span>
           </div>` : '';

        // Add glitter class if modules are completed
        const completedClass = hasCompletedModules ? ' has-completed' : '';
        suggestionDiv.className = `topic-suggestion-item${completedClass}`;

        suggestionDiv.innerHTML = `
          <div class="topic-suggestion-header">
            <span class="topic-suggestion-title">${topic}</span>
            <span class="topic-suggestion-difficulty ${getRecommendationClass(recommendedLevel)}" title="${recommendationReason}">Recommended: ${recommendedLevel}</span>
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Profile</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans&display=swap" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-icons.css" rel="stylesheet">
  <link href="css/templatemo-topic-listing.css" rel="stylesheet">

  <style>
    :root {
      --input-focus: #2d8cf0;
      --font-color: #323232;
      --font-color-sub: #666;
      --bg-color: #f7f9fc;
      --main-color: black;
      --accent-color: #ff6b6b;
      --secondary-color: #feca57;
      --tertiary-color: #1dd1a1;
      --light-blue: #54a0ff;
      --pink: #ff9ff3;
      --purple: #5f27cd;
    }

    body {
      font-family: 'Fira Code', monospace;
      background-color: var(--bg-color);
      color: var(--font-color);
      margin: 0;
      padding: 0;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Navbar */
    .navbar {
      background-color: yellow;
      border-bottom: 2px solid var(--main-color);
      box-shadow: 4px 4px var(--main-color);
      margin-bottom: 10px;
    }

    .navbar-brand {
      color: var(--accent-color);
      font-weight: 700;
      font-size: 1.5rem;
      transition: transform 0.3s ease;
    }
    
    .navbar-brand:hover {
      transform: scale(1.05);
    }

    .navbar-nav .nav-link {
      color: var(--font-color);
      font-weight: 600;
      border-radius: 5px;
      padding: 8px 15px;
      margin: 0 5px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .navbar-nav .nav-link:hover {
      color: var(--input-focus);
      border: 2px solid var(--input-focus);
      box-shadow: 3px 3px var(--main-color);
      transform: translateY(-2px);
    }

    /* Profile Section Styling */
    .profile-section {
      background: white;
      padding: 60px 0;
      border-bottom: 2px solid var(--main-color);
      box-shadow: 0 4px 0 var(--main-color);
      margin-bottom: 35px;
      text-align: center;
    }

    .profile-container {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      box-shadow: 4px 4px var(--main-color);
      padding: 30px;
      margin: 20px auto;
      max-width: 800px;
      transition: all 0.3s ease;
    }

    .profile-container:hover {
      transform: translateY(-5px);
      box-shadow: 6px 6px var(--main-color);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--main-color);
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: var(--accent-color);
      color: white;
      font-size: 60px;
      border: 3px solid var(--main-color);
      box-shadow: 4px 4px var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .profile-avatar:hover {
      transform: rotate(5deg);
      box-shadow: 6px 6px var(--main-color);
    }

    .profile-info {
      flex-grow: 1;
      text-align: left;
    }

    .profile-info h2 {
      font-weight: 700;
      color: var(--font-color);
      margin-bottom: 10px;
      position: relative;
      display: inline-block;
    }
    
    .profile-info h2:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--accent-color);
      transition: width 0.3s ease;
    }
    
    .profile-info h2:hover:after {
      width: 100%;
    }

    .profile-info p {
      margin: 5px 0;
      font-weight: 600;
      color: var(--font-color-sub);
    }

    #level {
      display: inline-block;
      background-color: var(--secondary-color);
      color: var(--font-color);
      font-weight: 700;
      padding: 5px 15px;
      border-radius: 20px;
      border: 2px solid var(--main-color);
      box-shadow: 3px 3px var(--main-color);
      transition: all 0.3s ease;
    }

    #level:hover {
      transform: translateY(-3px);
      box-shadow: 5px 5px var(--main-color);
    }
    
    .section-title {
      margin: 40px 0 20px 0;
      position: relative;
    }
    
    .section-title h3 {
      color: var(--font-color);
      font-weight: 700;
      font-size: 1.5rem;
      display: inline-block;
      position: relative;
      margin-bottom: 0;
      padding-bottom: 8px;
    }
    
    .section-title h3:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--tertiary-color);
      transition: width 0.3s ease;
    }
    
    .section-title h3:hover:after {
      width: 100%;
    }

    .progress-container {
      margin: 25px 0;
      background-color: white;
      padding: 20px;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .progress-container:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .module-title {
      font-weight: 700;
      color: var(--font-color);
    }

    .progress {
      height: 20px;
      background-color: var(--bg-color);
      border-radius: 10px;
      border: 2px solid var(--main-color);
      overflow: hidden;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 5px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--light-blue));
      border-radius: 8px;
      transition: width 1s ease;
    }
    
    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--font-color-sub);
      font-style: italic;
      background-color: var(--bg-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }
    
    .empty-state:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .topic-suggestions {
      margin: 25px 0;
    }

    .topic-suggestion-item {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .topic-suggestion-item:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .topic-suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .topic-suggestion-title {
      font-weight: 700;
      color: var(--font-color);
      font-size: 1.1rem;
    }

    .topic-suggestion-difficulty {
      background-color: var(--secondary-color);
      color: var(--font-color);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: help;
      transition: all 0.3s ease;
      position: relative;
    }

    .topic-suggestion-difficulty:hover {
      background-color: var(--tertiary-color);
      color: white;
      transform: scale(1.05);
    }

    .topic-suggestion-difficulty[title]:hover::after {
      content: attr(title);
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--main-color);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-top: 5px;
    }

    .topic-suggestion-difficulty.novice-rec {
      background-color: var(--tertiary-color);
      color: white;
    }

    .topic-suggestion-difficulty.intermediate-rec {
      background-color: var(--secondary-color);
      color: var(--font-color);
    }

    .topic-suggestion-difficulty.advanced-rec {
      background-color: var(--accent-color);
      color: white;
    }

    .topic-suggestion-difficulty.novice-rec:hover {
      background-color: #17a2b8;
    }

    .topic-suggestion-difficulty.intermediate-rec:hover {
      background-color: #e0a800;
    }

    .topic-suggestion-difficulty.advanced-rec:hover {
      background-color: #dc3545;
    }

    .topic-suggestion-content {
      color: var(--font-color-sub);
      margin-bottom: 15px;
    }

    .topic-suggestion-actions {
      display: flex;
      gap: 10px;
    }

    .topic-suggestion-btn {
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .topic-suggestion-btn:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
    }

    .button-container {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .button {
      background-color: white;
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 12px 25px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .button:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--accent-color);
      transition: all 0.4s ease;
      z-index: -1;
    }

    .button:hover:before {
      left: 0;
    }

    .button:hover {
      color: white;
      transform: translateY(-5px);
      box-shadow: 6px 6px var(--main-color);
    }

    .button:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px var(--main-color);
    }

    .button.primary {
      background-color: var(--accent-color);
      color: white;
    }

    .button.primary:before {
      background: var(--light-blue);
    }

    /* Footer */
    footer {
      background-color: white;
      color: var(--font-color);
      text-align: center;
      padding: 40px 0;
      border-top: 2px solid var(--main-color);
      margin-top: 40px;
    }

    footer .navbar-brand {
      color: var(--accent-color);
      font-weight: 700;
      transition: all 0.3s ease;
    }
    
    footer .navbar-brand:hover {
      transform: scale(1.1);
    }

    footer a {
      color: var(--input-focus);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    footer a:hover {
      color: var(--accent-color);
      text-decoration: underline;
    }

    .site-footer-title {
      color: var(--font-color);
      font-weight: 700;
      margin-bottom: 15px;
      position: relative;
      display: inline-block;
    }
    
    .site-footer-title:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--secondary-color);
      transition: width 0.3s ease;
    }
    
    .site-footer-title:hover:after {
      width: 100%;
    }

    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }

      .profile-info {
        text-align: center;
      }
      
      .profile-info h2:after {
        left: 25%;
        width: 50%;
      }
      
      .profile-info h2:hover:after {
        width: 80%;
        left: 10%;
      }
      
      .section-title h3 {
        text-align: center;
        display: block;
      }
      
      .section-title h3:after {
        left: 25%;
        width: 50%;
      }
      
      .section-title h3:hover:after {
        width: 50%;
      }

      .button-container {
        flex-direction: column;
      }
    }

    /* Learning Mastery styles */
    .mastery-container {
      margin: 25px 0;
    }

    .mastery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .mastery-section-title {
      font-weight: 700;
      color: var(--font-color);
      margin: 0;
    }

    .refresh-btn {
      background-color: var(--bg-color);
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 5px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .refresh-btn i {
      font-size: 16px;
    }

    .refresh-btn:hover {
      background-color: var(--light-blue);
      color: white;
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }
    
    .mastery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .mastery-item {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .mastery-item:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .mastery-title {
      font-weight: 700;
      color: var(--font-color);
      margin-bottom: 10px;
    }

    .mastery-bar-container {
      height: 15px;
      background-color: var(--bg-color);
      border-radius: 7px;
      border: 1px solid var(--main-color);
      margin-bottom: 5px;
      overflow: hidden;
    }

    .mastery-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--tertiary-color), var(--light-blue));
      border-radius: 7px;
      transition: width 0.5s ease;
    }

    .mastery-percentage {
      font-size: 14px;
      font-weight: 600;
      color: var(--font-color);
      text-align: right;
    }

    .mastery-description {
      font-size: 12px;
      color: var(--font-color-sub);
      margin-bottom: 8px;
      line-height: 1.3;
      height: 32px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .topic-practice-btn {
      background-color: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 4px 10px;
      margin-top: 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
    }

    .topic-practice-btn:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }

    .mastery-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      border: 2px solid var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 2px 2px var(--main-color);
      transform: rotate(15deg);
    }

    /* Learning Path styles */
    .learning-path-container {
      margin: 25px 0;
    }

    .learning-path {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .learning-path:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .path-steps {
      position: relative;
      padding-left: 30px;
    }

    .path-steps:before {
      content: '';
      position: absolute;
      top: 0;
      left: 15px;
      height: 100%;
      width: 2px;
      background-color: var(--accent-color);
    }

    .path-step {
      position: relative;
      margin-bottom: 30px;
    }

    .path-step:last-child {
      margin-bottom: 0;
    }

    .path-step:before {
      content: '';
      position: absolute;
      top: 5px;
      left: -30px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: white;
      border: 2px solid var(--accent-color);
      z-index: 1;
    }

    .path-step.completed:before {
      background-color: var(--tertiary-color);
      border-color: var(--main-color);
    }

    .path-step.current:before {
      background-color: var(--secondary-color);
      border-color: var(--main-color);
      animation: pulse 1.5s infinite;
    }

    .path-step-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .path-step-title {
      font-weight: 700;
      color: var(--font-color);
    }

    .path-step-status {
      font-size: 14px;
      font-weight: 600;
    }

    .path-step-content {
      color: var(--font-color-sub);
      margin-bottom: 10px;
    }

    .path-step-action {
      display: inline-block;
      background-color: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 5px 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
      font-size: 14px;
    }

    .path-step-action:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }

    /* Learning Path Progress and Completion Styles */
    .completion-tick {
      color: var(--tertiary-color);
      font-weight: 700;
      font-size: 16px;
      margin-left: 8px;
      animation: checkmark-appear 0.5s ease-in-out;
    }

    @keyframes checkmark-appear {
      0% {
        opacity: 0;
        transform: scale(0);
      }
      50% {
        opacity: 1;
        transform: scale(1.2);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    .path-step-progress {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .path-progress-bar-container {
      flex: 1;
      height: 12px;
      background-color: var(--bg-color);
      border-radius: 6px;
      border: 1px solid var(--main-color);
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .path-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--tertiary-color), var(--light-blue));
      border-radius: 6px;
      transition: width 0.5s ease;
      position: relative;
    }

    .path-progress-bar::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background-image: linear-gradient(
        -45deg,
        rgba(255, 255, 255, 0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 30px 30px;
      animation: progress-animation 2s linear infinite;
    }

    @keyframes progress-animation {
      0% {
        background-position: 0 0;
      }
      100% {
        background-position: 30px 30px;
      }
    }

    .path-progress-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--font-color);
      min-width: 35px;
      text-align: right;
    }

    /* Enhanced completed step styling */
    .path-step.completed .path-step-title {
      color: var(--tertiary-color);
    }

    .path-step.completed .path-progress-bar {
      background: var(--tertiary-color);
    }

    /* Achievements styles */
    .achievements-container {
      margin: 25px 0;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
    }

    .achievement {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .achievement:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .achievement.locked {
      filter: grayscale(1);
      opacity: 0.7;
    }

    .achievement-icon {
      width: 50px;
      height: 50px;
      background-color: var(--bg-color);
      border-radius: 50%;
      border: 2px solid var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      font-size: 24px;
    }

    .achievement-title {
      font-weight: 700;
      color: var(--font-color);
      font-size: 14px;
      margin-bottom: 5px;
    }

    .achievement-description {
      font-size: 12px;
      color: var(--font-color-sub);
    }

    /* Toast Notification */
    .toast-notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: flex;
      align-items: center;
      background-color: white;
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.5s ease;
    }

    .toast-notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-icon {
      font-size: 24px;
      margin-right: 15px;
      animation: pulse 1.5s infinite;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--accent-color);
    }

    .toast-message {
      font-size: 14px;
      color: var(--font-color-sub);
    }

    /* Module Dropdown Styles */
    .module-dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-toggle {
      position: relative;
    }

    .module-options {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 8px;
      box-shadow: 4px 4px var(--main-color);
      z-index: 1000;
      display: none;
      min-width: 280px;
    }

    .module-options.show {
      display: block;
    }

    .module-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      text-decoration: none;
      color: var(--font-color);
      border-bottom: 1px solid var(--bg-color);
      transition: all 0.3s ease;
      position: relative;
    }

    .module-option:last-child {
      border-bottom: none;
    }

    .module-option:hover {
      background-color: var(--bg-color);
      color: var(--font-color);
      text-decoration: none;
    }

    .module-option-content {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .level-badge {
      min-width: 60px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-align: center;
      text-transform: uppercase;
      border: 1px solid var(--main-color);
    }

    .level-badge.novice {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .level-badge.intermediate {
      background: linear-gradient(135deg, #ffc107, #fd7e14);
      color: white;
    }

    .level-badge.advanced {
      background: linear-gradient(135deg, #dc3545, #fd7e14);
      color: white;
    }

    .module-option-text {
      flex: 1;
    }

    .module-option-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .module-option-desc {
      font-size: 12px;
      color: var(--font-color-sub);
      line-height: 1.3;
    }

    .module-option.suggested {
      background-color: #e8f5e8;
      border-left: 4px solid var(--tertiary-color);
    }

    .module-option.suggested::after {
      content: "Recommended";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: var(--tertiary-color);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    .module-option.completed {
      background-color: #f8f9fa;
      color: var(--font-color-sub);
    }

    .module-option.completed::after {
      content: "âœ“ Completed";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: var(--tertiary-color);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    /* Enhanced completion indicator styles with glitter effects */
    .completion-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 8px 12px;
      background: linear-gradient(135deg, #28a745, #20c997, #17a2b8, #28a745);
      background-size: 400% 400%;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: glitterPulse 2s infinite, glitterShine 3s infinite;
      border: 2px solid transparent;
      background-clip: padding-box;
      position: relative;
    }

    .completion-indicator::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #00ff00, #00ffff, #ff00ff, #ffd700);
      background-size: 600% 600%;
      border-radius: 10px;
      z-index: -1;
      animation: glitterBorder 2s linear infinite;
    }

    @keyframes glitterBorder {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    @keyframes glitterPulse {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 10px rgba(255, 215, 0, 0.5);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3), 0 0 20px rgba(255, 215, 0, 0.8);
        transform: scale(1.05);
      }
    }

    @keyframes glitterShine {
      0% {
        background-position: 0% 50%;
      }
      100% {
        background-position: 400% 50%;
      }
    }

    .completion-checkmark {
      font-size: 20px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 215, 0, 0.5);
      margin-bottom: 2px;
      animation: checkmarkGlow 2s infinite;
    }

    @keyframes checkmarkGlow {
      0%, 100% {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 215, 0, 0.5);
      }
      50% {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 255, 255, 0.5);
      }
    }

    .completion-text {
      font-size: 10px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 5px rgba(255, 215, 0, 0.3);
    }

    /* Enhanced module option completed styling with glitter border */
    .module-option.completed {
      background: linear-gradient(135deg, #f8f9fa, #e9ecef);
      border: 3px solid transparent;
      background-clip: padding-box;
      position: relative;
      overflow: visible;
      animation: completedModuleGlow 3s infinite;
    }

    .module-option.completed::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #28a745, #20c997, #17a2b8, #ffd700);
      background-size: 600% 600%;
      border-radius: 10px;
      z-index: -1;
      animation: glitterBorder 2s linear infinite;
    }

    @keyframes completedModuleGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3), 0 0 15px rgba(255, 215, 0, 0.4);
      }
    }

    .module-option.completed:hover {
      background: linear-gradient(135deg, #e9ecef, #dee2e6);
      transform: translateY(-2px);
      box-shadow: 0 6px 15px rgba(40, 167, 69, 0.4), 0 0 25px rgba(255, 215, 0, 0.6);
    }

    /* Enhanced topic completion badge with glitter */
    .topic-completion-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 6px 10px;
      background: linear-gradient(135deg, #28a745, #20c997, #17a2b8, #28a745);
      background-size: 400% 400%;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: topicGlitterGlow 3s infinite, glitterShine 3s infinite;
      border: 2px solid transparent;
      background-clip: padding-box;
      position: relative;
    }

    .topic-completion-badge::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #00ff00, #00ffff, #ff00ff, #ffd700);
      background-size: 500% 500%;
      border-radius: 8px;
      z-index: -1;
      animation: glitterBorder 2.5s linear infinite;
    }

    @keyframes topicGlitterGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 8px rgba(255, 215, 0, 0.3);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4), 0 0 20px rgba(255, 215, 0, 0.7);
      }
    }

    /* Enhanced progress bar animations */
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--light-blue));
      border-radius: 8px;
      transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: progressShine 2s infinite;
    }

    @keyframes progressShine {
      0% {
        left: -100%;
      }
      100% {
        left: 100%;
      }
    }

    /* Enhanced difficulty level progress bars with animations */
    .novice-progress {
      background: linear-gradient(90deg, #28a745, #20c997, #17a2b8);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    .intermediate-progress {
      background: linear-gradient(90deg, #ffc107, #fd7e14, #ff6b6b);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    .advanced-progress {
      background: linear-gradient(90deg, #dc3545, #ff6b6b, #fd7e14);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    @keyframes progressFlow {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    .module-option.locked {
      background-color: #f8f9fa;
      color: #adb5bd;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .module-option.locked::after {
      content: "ðŸ”’ Locked";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: #6c757d;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    .module-option.locked:hover {
      background-color: #f8f9fa;
      color: #adb5bd;
    }

    .module-option.locked .module-option-desc {
      color: #adb5bd;
    }

    .module-option-desc {
      font-size: 12px;
      color: var(--font-color-sub);
      line-height: 1.3;
    }

    .module-option-desc::after {
      content: "";
      display: block;
      margin-top: 2px;
    }

    .module-option.suggested .module-option-desc {
      color: #155724;
      font-weight: 500;
    }

    .module-option.completed .module-option-desc {
      color: #6c757d;
      font-style: italic;
    }

    /* Tooltip for additional information */
    .module-option:hover .module-option-desc {
      font-weight: 600;
    }

    .module-option.suggested:hover {
      background-color: #d4edda;
    }

    .module-option.completed:hover {
      background-color: #e2e3e5;
    }

    .novice-progress {
      background: linear-gradient(90deg, #28a745, #20c997);
    }

    .intermediate-progress {
      background: linear-gradient(90deg, #ffc107, #fd7e14);
    }

    .advanced-progress {
      background: linear-gradient(90deg, #dc3545, #ff6b6b);
    }

    .progress-details {
      text-align: right;
      font-size: 12px;
      color: var(--font-color-sub);
    }

    /* Topic completion badge styles */
    .topic-completion-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 6px 10px;
      background: linear-gradient(135deg, #28a745, #20c997);
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: topicCompletionGlow 3s infinite;
    }

    .topic-checkmark {
      font-size: 16px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      margin-bottom: 1px;
    }

    .topic-completion-count {
      font-size: 9px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.3px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    @keyframes topicCompletionGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      }
    }

    .topic-suggestion-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .topic-suggestion-title {
      flex: 1;
      font-weight: 700;
      color: var(--font-color);
      font-size: 18px;
    }

    .topic-suggestion-difficulty {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      border: 1px solid var(--main-color);
    }

    .module-option.completed .level-badge {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: 2px solid white;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .module-option.completed .module-option-title {
      color: #28a745;
      font-weight: 700;
      text-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
    }

    /* Override the ::after pseudo-element for completed modules since we now have custom indicator */
    .module-option.completed::after {
      display: none;
    }

    /* Glitter effect for completed topic suggestion items */
    .topic-suggestion-item.has-completed {
      border: 3px solid transparent;
      background-clip: padding-box;
      position: relative;
      animation: topicCardGlow 4s infinite;
    }

    .topic-suggestion-item.has-completed::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #28a745, #20c997, #17a2b8, #ffd700);
      background-size: 500% 500%;
      border-radius: 13px;
      z-index: -1;
      animation: glitterBorder 3s linear infinite;
    }

    @keyframes topicCardGlow {
      0%, 100% {
        box-shadow: 4px 4px var(--main-color);
      }
      50% {
        box-shadow: 6px 6px var(--main-color), 0 0 20px rgba(255, 215, 0, 0.5);
      }
    }

    /* Lock indicator styles */
    .lock-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 8px 12px;
      background: linear-gradient(135deg, #6c757d, #495057);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      opacity: 0.8;
    }

    .lock-icon {
      font-size: 16px;
      color: white;
      margin-bottom: 2px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .lock-text {
      font-size: 9px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Enhanced locked module styling */
    .module-option.locked {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
      border: 2px solid #dee2e6;
    }

    .module-option.locked:hover {
      background-color: #f8f9fa;
      color: #6c757d;
      transform: none;
      box-shadow: none;
    }

    .module-option.locked .level-badge {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      opacity: 0.7;
    }

    .module-option.locked .module-option-title {
      color: #6c757d;
    }

    .module-option.locked .module-option-desc {
      color: #adb5bd;
      font-style: italic;
    }

    /* Custom alert dialog styles */
    .custom-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      animation: alertFadeIn 0.3s ease-out;
    }

    .alert-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .alert-content {
      background: white;
      border: 3px solid var(--main-color);
      border-radius: 15px;
      box-shadow: 8px 8px var(--main-color);
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: alertSlideIn 0.3s ease-out;
    }

    .alert-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px;
      border-bottom: 2px solid var(--main-color);
      background: linear-gradient(135deg, #ffebee, #fff3e0);
    }

    .alert-icon {
      font-size: 24px;
    }

    .alert-header h3 {
      flex: 1;
      margin: 0;
      color: var(--font-color);
      font-weight: 700;
    }

    .alert-close {
      background: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .alert-close:hover {
      background: var(--light-blue);
      transform: scale(1.1);
    }

    .alert-body {
      padding: 20px;
    }

    .alert-body p {
      margin: 10px 0;
      line-height: 1.6;
    }

    .alert-details p {
      margin: 5px 0;
      font-size: 14px;
    }

    .alert-footer {
      display: flex;
      gap: 10px;
      padding: 20px;
      border-top: 2px solid var(--main-color);
      background: var(--bg-color);
      justify-content: flex-end;
    }

    .alert-btn {
      padding: 10px 20px;
      border: 2px solid var(--main-color);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 3px 3px var(--main-color);
    }

    .quiz-btn {
      background: var(--tertiary-color);
      color: white;
    }

    .quiz-btn:hover {
      background: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 5px 5px var(--main-color);
    }

    .close-btn {
      background: white;
      color: var(--font-color);
    }

    .close-btn:hover {
      background: var(--bg-color);
      transform: translateY(-2px);
      box-shadow: 5px 5px var(--main-color);
    }

    @keyframes alertFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes alertSlideIn {
      from {
        transform: translateY(-50px) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand" href="home.html">
      <i class="bi-back"></i>
      <span>MathAnywhere</span>
    </a>

    <div class="d-lg-none ms-auto me-4">
      <a href="#top" class="navbar-icon bi-person smoothscroll"></a>
    </div>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-lg-5 me-lg-auto">
        <li class="nav-item">
          <a class="nav-link" href="home.html">Home</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="index.html#section_2">Lessons & Exercises</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="index.html#section_3">Journey</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="deri_graph.html">Derivative calc & graphing</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<section class="profile-section">
  <div class="container">
    <h1 class="mb-4">User Profile</h1>
  </div>
</section>

<div class="container">
  <div class="profile-container">
    <div class="profile-header">
      <div class="profile-avatar" id="avatar">
        <!-- Avatar will be set by JavaScript -->
      </div>
      <div class="profile-info">
        <h2 id="username">Username: Guest</h2>
        <p id="level">Level: Beginner</p>
      </div>
    </div>

    <div class="section-title">
      <h3>Overall Progress</h3>
    </div>
    <div class="progress-container">
      <div class="progress-label">
        <span>Completion</span>
        <span id="progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
    </div>

    <!-- Welcome section for beginners who haven't taken the quiz -->
    <div class="section-title" id="beginner-welcome-section" style="display: none;">
      <h3>ðŸŽ¯ Welcome to Your Learning Journey!</h3>
    </div>
    <div class="empty-state" id="beginner-welcome-container" style="display: none; margin: 20px 0; padding: 30px;">
      <h4 style="color: var(--accent-color); margin-bottom: 20px;">Ready to discover your calculus path?</h4>
      <p style="font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
        Take our <strong>"Where do I start?"</strong> assessment quiz to:
      </p>
      <div style="text-align: left; max-width: 400px; margin: 0 auto 25px auto;">
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Discover your current skill level</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Get personalized topic recommendations</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Unlock your learning mastery dashboard</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Access your personalized learning path</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Track achievements and milestones</p>
      </div>
      <button class="button primary" onclick="window.location.href='quiz.html'" style="margin: 10px; font-size: 18px; padding: 15px 30px;">
        <i class="bi bi-play-circle-fill"></i> Take Assessment Quiz
      </button>
      <br>
      <button class="button" onclick="window.location.href='home.html'" style="margin: 10px;">
        <i class="bi bi-book"></i> Browse Topics First
      </button>
    </div>

    <div class="section-title" id="suggested-topics-section" style="display: none;">
      <h3>Suggested Topics to Focus On</h3>
    </div>
    <div class="topic-suggestions" id="topic-suggestions" style="display: none;">
      <!-- Topic suggestions will be added here -->
      <div class="empty-state">
        Take the assessment quiz to get personalized topic suggestions.
      </div>
    </div>

    <!-- Learning Mastery Progress -->
    <div class="section-title" id="learning-mastery-section" style="display: none;">
      <h3>Learning Mastery</h3>
    </div>
    <div class="mastery-container" id="mastery-container" style="display: none;">
      <div class="empty-state">
        Complete the quiz to see your concept mastery breakdown.
      </div>
    </div>

    <!-- Gap Analysis and Adaptive Learning -->
    <div class="section-title" id="learning-path-section" style="display: none;">
      <h3>Learning Path</h3>
    </div>
    <div class="learning-path-container" id="learning-path-container" style="display: none;">
      <div class="empty-state">
        Your personalized learning journey will appear here after taking the quiz.
      </div>
    </div>

    <!-- Achievements and Milestones -->
    <div class="section-title" id="achievements-section" style="display: none;">
      <h3>Achievements</h3>
    </div>
    <div class="achievements-container" id="achievements-container" style="display: none;">
      <div class="empty-state">
        Start learning to unlock achievements!
      </div>
    </div>

    <div class="section-title">
      <h3>Actions</h3>
    </div>
    
    <!-- System Notice -->
    <div style="background-color: #e8f5e8; border: 2px solid var(--tertiary-color); border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center;">
      <p style="margin: 0; color: var(--font-color); font-weight: 600;">
        <i class="bi bi-info-circle" style="color: var(--tertiary-color);"></i> 
        System automatically handles progress tracking, mastery updates, and correct-answers-only mode
      </p>
      <p style="margin: 10px 0 0 0; font-size: 14px; color: var(--font-color-sub);">
        ðŸ“ˆ Each correct answer in practice/quiz increases topic mastery by 5%<br>
        ðŸ’¾ Progress automatically saves and persists after logout<br>
        ðŸŽ¯ Use "Demo" button to test the system
      </p>
    </div>
    
    <div class="button-container">
      <button class="button" onclick="window.location.href='modules.html'">
        <i class="bi bi-grid-3x3-gap"></i> View All Modules
      </button>
      <button class="button" onclick="window.location.href='home.html'">
        <i class="bi bi-house"></i> Home
      </button>
      <button class="button" onclick="testCorrectAnswerDemo()">
        <i class="bi bi-check-circle"></i> Demo: Answer Question Correctly
      </button>
      <button class="button" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>

    <div class="section-title">
      <h3>Learning Progress by Difficulty Level</h3>
    </div>
    
    <!-- Novice Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>ðŸŸ¢ Novice Level</span>
        <span id="novice-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar novice-progress" id="novice-progress-bar" style="background: linear-gradient(90deg, #28a745, #20c997);"></div>
      </div>
      <div class="progress-details">
        <small id="novice-details">0 of 7 modules completed</small>
      </div>
    </div>

    <!-- Intermediate Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>ðŸŸ¡ Intermediate Level</span>
        <span id="intermediate-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar intermediate-progress" id="intermediate-progress-bar" style="background: linear-gradient(90deg, #ffc107, #fd7e14);"></div>
      </div>
      <div class="progress-details">
        <small id="intermediate-details">0 of 7 modules completed</small>
      </div>
    </div>

    <!-- Advanced Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>ðŸ”´ Advanced Level</span>
        <span id="advanced-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar advanced-progress" id="advanced-progress-bar" style="background: linear-gradient(90deg, #dc3545, #ff6b6b);"></div>
      </div>
      <div class="progress-details">
        <small id="advanced-details">0 of 7 modules completed</small>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer section-padding">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-12 mb-4 pb-2">
        <a class="navbar-brand mb-2" href="home.html">
          <i class="bi-back"></i>
          <span>MathAnywhere</span>
        </a>
      </div>

      <div class="col-lg-3 col-md-4 col-6 mb-4 mb-lg-0">
        <h6 class="site-footer-title mb-3">Information</h6>
        <p class="text-white d-flex mb-1">
          <a href="tel: 305-240-9671" class="site-footer-link">
            013-3321094
          </a>
        </p>
        <p class="text-white d-flex">
          <a href="mailto:info@company.com" class="site-footer-link">
            2022841556@student.uitm.edu.my
          </a>
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/jquery.sticky.js"></script>

<script type="module">
  // âœ… Import Firebase Modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  // âœ… Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBUfSOSpmCdWUGTVbSQsMCH-JVmrjpfdPY",
    authDomain: "fyp-lutfi-naim.firebaseapp.com",
    projectId: "fyp-lutfi-naim",
    storageBucket: "fyp-lutfi-naim.firebasestorage.app",
    messagingSenderId: "231274529807",
    appId: "1:231274529807:web:c4ea279f9e7581bd674f7a",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);


  function updateUI(username, level, moduleProgress, overallProgress) {
    // Update avatar with first letter of username
    const avatar = document.getElementById('avatar');
    avatar.textContent = username.charAt(0).toUpperCase();

    document.getElementById('username').textContent = username;
    document.getElementById('level').textContent = `Level: ${level}`;
    
    // Calculate progress for each difficulty level
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    
    // Calculate progress for each difficulty level
    difficultyLevels.forEach(difficulty => {
      let completedModules = 0;
      let totalProgress = 0;
      
      browseTopics.forEach(topic => {
        const moduleKey = `${topic} - ${difficulty}`;
        const progress = moduleProgress[moduleKey] || 0;
        totalProgress += progress;
        if (progress >= 80) {
          completedModules++;
        }
      });
      
      const averageProgress = Math.round(totalProgress / browseTopics.length);
      const difficultyLower = difficulty.toLowerCase();
      
      // Update progress bar
      document.getElementById(`${difficultyLower}-progress-bar`).style.width = `${averageProgress}%`;
      document.getElementById(`${difficultyLower}-progress-percentage`).textContent = `${averageProgress}%`;
      document.getElementById(`${difficultyLower}-details`).textContent = `${completedModules} of ${browseTopics.length} modules completed`;
    });

    // Update topic suggestions
    const topicSuggestionsContainer = document.getElementById('topic-suggestions');
    topicSuggestionsContainer.innerHTML = '';

    // Get weak topics and recommendations from session storage
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const recommendations = JSON.parse(sessionStorage.getItem('recommendations') || '[]');

    if (weakTopics.length > 0) {
      // Hide the empty state if we have suggestions
      const emptyState = topicSuggestionsContainer.querySelector('.empty-state');
      if (emptyState) {
        emptyState.style.display = 'none';
      }

      // Create topic suggestions based on weak topics
      weakTopics.forEach((topic, index) => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'topic-suggestion-item';
        
        // Determine recommended level based on user's current level and progress
        const userLevel = level || 'Beginner';
        const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
        let recommendedLevel = 'Novice'; // default recommendation
        let recommendationReason = '';
        
        // Smart recommendation logic based on user level and progress
        if (userLevel === 'Beginner' || userLevel === 'Novice') {
          recommendedLevel = 'Novice';
          recommendationReason = 'Start with fundamentals';
        } else if (userLevel === 'Intermediate') {
          // Check if user has completed novice level for this topic
          const noviceKey = `${topic} - Novice`;
          const noviceProgress = moduleProgress[noviceKey] || 0;
          
          if (noviceProgress >= 80) {
            recommendedLevel = 'Intermediate';
            recommendationReason = 'Ready for next level';
          } else {
            recommendedLevel = 'Novice';
            recommendationReason = 'Review basics first';
          }
        } else if (userLevel === 'Advanced') {
          // Check progress to recommend appropriate level
          const noviceKey = `${topic} - Novice`;
          const intermediateKey = `${topic} - Intermediate`;
          const noviceProgress = moduleProgress[noviceKey] || 0;
          const intermediateProgress = moduleProgress[intermediateKey] || 0;
          
          if (intermediateProgress >= 80) {
            recommendedLevel = 'Advanced';
            recommendationReason = 'Challenge yourself';
          } else if (noviceProgress >= 80) {
            recommendedLevel = 'Intermediate';
            recommendationReason = 'Build on basics';
          } else {
            recommendedLevel = 'Novice';
            recommendationReason = 'Strengthen foundation';
          }
        }

        // Map topics to their specific HTML pages (use recommended level)
        let topicPage = '';
        switch(topic) {
          case "Introduction to derivatives":
            topicPage = "Introduction_to_derivatives.html";
            break;
          case "The definition of Derivative":
            topicPage = "The_definition_of_derivative.html";
            break;
          case "Rules of Differentiation":
            topicPage = "rule.html";
            break;
          case "Equation of Tangent":
            topicPage = "Equation-of-tangent.html";
            break;
          case "Second Derivative":
            topicPage = "Second-derivative.html";
            break;
          case "Implicit Differentiations":
            topicPage = "Implicit-differentiation.html";
            break;
          case "Linear Approximation & Differentials":
            topicPage = "linear-approx-differentials.html";
            break;
          default:
            // If no specific page is found, use the recommended level page
            topicPage = `${recommendedLevel.toLowerCase()}.html`;
        }

        // Check if topic has any completed modules
        const currentModuleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
        const noviceKey = `${topic} - Novice`;
        const intermediateKey = `${topic} - Intermediate`;
        const advancedKey = `${topic} - Advanced`;
        const noviceProgress = currentModuleProgress[noviceKey] || 0;
        const intermediateProgress = currentModuleProgress[intermediateKey] || 0;
        const advancedProgress = currentModuleProgress[advancedKey] || 0;
        
        const hasCompletedModules = noviceProgress >= 80 || intermediateProgress >= 80 || advancedProgress >= 80;
        const totalCompletedModules = (noviceProgress >= 80 ? 1 : 0) + (intermediateProgress >= 80 ? 1 : 0) + (advancedProgress >= 80 ? 1 : 0);
        
        const topicCompletionBadge = hasCompletedModules ? 
          `<div class="topic-completion-badge">
            <span class="topic-checkmark">âœ“</span>
            <span class="topic-completion-count">${totalCompletedModules}/3</span>
           </div>` : '';

        // Add glitter class if modules are completed
        const completedClass = hasCompletedModules ? ' has-completed' : '';
        suggestionDiv.className = `topic-suggestion-item${completedClass}`;

        suggestionDiv.innerHTML = `
          <div class="topic-suggestion-header">
            <span class="topic-suggestion-title">${topic}</span>
            <span class="topic-suggestion-difficulty ${getRecommendationClass(recommendedLevel)}" title="${recommendationReason}">Recommended: ${recommendedLevel}</span>
            ${topicCompletionBadge}
          </div>
          <div class="topic-suggestion-content">
            ${recommendations[index] || `Focus on improving your understanding of this topic. ${recommendationReason}.`}
          </div>
          <div class="topic-suggestion-actions">
            <button class="topic-suggestion-btn" onclick="window.location.href='${topicPage}'">
              Start Learning
            </button>
            <div class="module-dropdown">
              <button class="topic-suggestion-btn dropdown-toggle" onclick="toggleModuleDropdown(this)">
                Take Module â–¼
              </button>
              <div class="module-options">
                ${generateModuleOptions(topic, sessionStorage.getItem('level') || 'Beginner', JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'))}
              </div>
            </div>
          </div>
        `;
        
        topicSuggestionsContainer.appendChild(suggestionDiv);
      });
    } else {
      // Show default topic suggestions for new users
      const defaultTopics = [
        {
          topic: "Introduction to derivatives",
          recommendation: "Start your calculus journey with the fundamentals. Learn what derivatives are and why they're important in mathematics and science.",
          level: "Novice"
        },
        {
          topic: "Rules of Differentiation", 
          recommendation: "Master the essential rules for finding derivatives. These are the building blocks for all advanced calculus concepts.",
          level: "Novice"
        },
        {
          topic: "Equation of Tangent",
          recommendation: "Apply your derivative knowledge to find tangent lines. This connects theory with practical applications.",
          level: "Novice"
        }
      ];

      defaultTopics.forEach(item => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'topic-suggestion-item';
        
        let topicPage = '';
        switch(item.topic) {
          case "Introduction to derivatives":
            topicPage = "Introduction_to_derivatives.html";
            break;
          case "Rules of Differentiation":
            topicPage = "rule.html";
            break;
          case "Equation of Tangent":
            topicPage = "Equation-of-tangent.html";
            break;
        }

        suggestionDiv.innerHTML = `
          <div class="topic-suggestion-header">
            <span class="topic-suggestion-title">${item.topic}</span>
            <span class="topic-suggestion-difficulty novice-rec">Recommended: ${item.level}</span>
          </div>
          <div class="topic-suggestion-content">
            ${item.recommendation}
          </div>
          <div class="topic-suggestion-actions">
            <button class="topic-suggestion-btn" onclick="window.location.href='${topicPage}'">
              Start Learning
            </button>
            <button class="topic-suggestion-btn" onclick="window.location.href='quiz.html'">
              Take Assessment First
            </button>
          </div>
        `;
        
        topicSuggestionsContainer.appendChild(suggestionDiv);
      });
    }

    // Conditional display logic for beginner users
    const userWeakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const userRecommendations = JSON.parse(sessionStorage.getItem('recommendations') || '[]');
    const hasQuizData = userWeakTopics.length > 0 || userRecommendations.length > 0;
    const isBeginner = level === 'Beginner';
    
    // Show sections only if user is not a beginner OR has taken the quiz
    const shouldShowSections = !isBeginner || hasQuizData;
    
    // Control visibility of sections
    const sectionsToToggle = [
      'suggested-topics-section',
      'topic-suggestions',
      'learning-mastery-section', 
      'mastery-container',
      'learning-path-section',
      'learning-path-container',
      'achievements-section',
      'achievements-container'
    ];
    
    sectionsToToggle.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = shouldShowSections ? 'block' : 'none';
      }
    });
    
    // Control beginner welcome section (opposite of other sections)
    const beginnerWelcomeSection = document.getElementById('beginner-welcome-section');
    const beginnerWelcomeContainer = document.getElementById('beginner-welcome-container');
    if (beginnerWelcomeSection && beginnerWelcomeContainer) {
      beginnerWelcomeSection.style.display = !shouldShowSections ? 'block' : 'none';
      beginnerWelcomeContainer.style.display = !shouldShowSections ? 'block' : 'none';
    }
    
    console.log("UI updated with username:", username, "and level:", level);
    console.log("Sections visible:", shouldShowSections, "| Is Beginner:", isBeginner, "| Has Quiz Data:", hasQuizData);
  }


  function syncUserData(userData) {
    // Ensure each module reaches 100% when completed
    const updatedModuleProgress = {};
    for (const [module, progress] of Object.entries(userData.moduleProgress || {})) {
      // This ensures any module progress above 80% is considered 100% complete
      updatedModuleProgress[module] = progress >= 80 ? 100 : progress;
    }

    sessionStorage.setItem('username', userData.username);
    sessionStorage.setItem('level', userData.level);
    sessionStorage.setItem('moduleProgress', JSON.stringify(updatedModuleProgress));

    // Load learning analytics data if available
    const masteryData = userData.masteryData || generateMasteryData(userData);
    const learningPath = userData.learningPath || generateLearningPath(userData);
    const achievements = userData.achievements || generateAchievements(userData);
    
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));

    updateUI(userData.username, userData.level, updatedModuleProgress, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
  }

  // Generate mastery data based on quiz results and user progress
  function generateMasteryData(userData) {
    // Use the actual topics from the quiz directly
    const masteryData = [
      { topic: 'Introduction to derivatives', mastery: 0, badge: null, description: 'Understanding what derivatives represent and their basic applications' },
      { topic: 'The definition of Derivative', mastery: 0, badge: null, description: 'Formal limit definition and identifying non-differentiable points' },
      { topic: 'Rules of Differentiation', mastery: 0, badge: null, description: 'Power rule, product rule, quotient rule, and other differentiation techniques' },
      { topic: 'Equation of Tangent', mastery: 0, badge: null, description: 'Finding and interpreting tangent lines to curves' },
      { topic: 'Second Derivative', mastery: 0, badge: null, description: 'Measuring rates of change of rates of change and analyzing concavity' },
      { topic: 'Implicit Differentiations', mastery: 0, badge: null, description: 'Differentiating equations where y is not isolated' },
      { topic: 'Linear Approximation & Differentials', mastery: 0, badge: null, description: 'Using derivatives to approximate function values' }
    ];
    
    // Check if user has weak topics from quiz results
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const hasQuizData = weakTopics.length > 0;
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    
    // Check if user is truly new (no data at all)
    const hasAnyModuleProgress = Object.keys(moduleProgress).length > 0 && Object.values(moduleProgress).some(progress => progress > 0);
    const hasAnyPracticeAttempts = Object.keys(practiceAttempts).length > 0 && Object.values(practiceAttempts).some(attempts => attempts > 0);
    const hasAnyCorrectAnswers = Object.keys(JSON.parse(sessionStorage.getItem('correctAnswers') || '{}')).length > 0;
    const isTrulyNewUser = !hasQuizData && !hasAnyModuleProgress && !hasAnyPracticeAttempts && !hasAnyCorrectAnswers;
    
    // For truly new users, return 0% mastery for all topics
    if (isTrulyNewUser) {
      console.log('=== NEW USER DETECTED ===');
      console.log('No quiz data, no module progress, no practice attempts, no correct answers');
      console.log('All mastery starting at 0% for all topics');
      masteryData.forEach(item => {
        item.mastery = 0;
        item.badge = null;
      });
      return masteryData;
    }
    
    // For beginners specifically, also check if they should start fresh
    const userLevel = userData.level || 'Beginner';
    if (userLevel === 'Beginner' && !hasQuizData && !hasAnyCorrectAnswers) {
      console.log('=== BEGINNER USER WITHOUT QUIZ/CORRECT ANSWERS ===');
      console.log('Forcing 0% mastery for all topics');
      masteryData.forEach(item => {
        item.mastery = 0;
        item.badge = null;
      });
      return masteryData;
    }
    
    // ALL users start at 0% mastery - mastery only increases from actual progress
    masteryData.forEach(item => {
      // Special debugging for Linear Approximation topic
      const isLinearApprox = item.topic === 'Linear Approximation & Differentials';
      if (isLinearApprox) {
        console.log('=== LINEAR APPROXIMATION MASTERY DEBUG ===');
        console.log('User Level:', userData.level);
        console.log('Has Quiz Data:', hasQuizData);
        console.log('Has Any Module Progress:', hasAnyModuleProgress);
        console.log('Has Any Practice Attempts:', hasAnyPracticeAttempts);
        console.log('Has Any Correct Answers:', hasAnyCorrectAnswers);
        console.log('Is Truly New User:', isTrulyNewUser);
        console.log('Weak Topics:', weakTopics);
        console.log('Is in weak topics:', weakTopics.includes(item.topic));
      }
      
      // Start at 0% for everyone
      item.mastery = 0;
      
      // ONLY increase mastery from correct answers in practice/quiz
      // Check for correct answers in practice sessions
      const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
      const topicCorrectAnswers = correctAnswers[item.topic] || 0;
      
      if (topicCorrectAnswers > 0) {
        // Each correct answer gives +5% mastery (up to 75% from practice)
        const practiceBoost = Math.min(topicCorrectAnswers * 5, 75);
        item.mastery = Math.min(item.mastery + practiceBoost, 75);
        
        if (isLinearApprox) {
          console.log('Correct answers found:', topicCorrectAnswers);
          console.log('Practice boost from correct answers:', practiceBoost, '% - mastery now', item.mastery);
        }
      }
      
      // If user has taken the quiz, only adjust mastery for strong performance
      if (hasQuizData) {
        if (!weakTopics.includes(item.topic)) {
          // For strong topics (not in weak topics), add quiz mastery bonus
          const quizBoost = userData.level === 'Advanced' ? 25 : userData.level === 'Intermediate' ? 20 : 15;
          const oldMastery = item.mastery;
          item.mastery = Math.min(item.mastery + quizBoost, 100);
          
          if (isLinearApprox) {
            console.log('Strong topic quiz boost:', quizBoost, '% - increased from', oldMastery, 'to', item.mastery);
          }
        }
        // Note: We don't penalize for weak topics, mastery stays at correct-answer level
      }
      
      // Practice attempts can also increase mastery
      const attempts = practiceAttempts[item.topic] || 0;
      if (attempts > 0) {
        // DISABLED: Practice attempts should NOT increase mastery - only correct answers should
        const practiceBoost = 0; // Math.min(attempts * 3, 15);
        const oldMastery = item.mastery;
        // item.mastery = Math.min(item.mastery + practiceBoost, 100);
        
        if (isLinearApprox) {
          console.log('Practice attempts found but DISABLED - no mastery boost applied');
          console.log('Attempts:', attempts, '- mastery remains:', item.mastery);
        }
      }
      
      if (isLinearApprox) {
        console.log('FINAL Linear Approximation mastery:', item.mastery + '%');
        console.log('=== END LINEAR APPROXIMATION DEBUG ===');
      }
      
      // Assign badges based on final mastery level
      if (item.mastery >= 80) {
        item.badge = 'M';  // Master
      } else if (item.mastery >= 60) {
        item.badge = 'P';  // Proficient
      } else if (item.mastery >= 30) {
        item.badge = 'L';  // Learning
      } else if (item.mastery > 0) {
        item.badge = 'B';  // Beginner with some progress
        } else {
        item.badge = null; // No badge for 0% mastery
      }
    });
    
    return masteryData;
  }
  
  // Helper function to get module progress for a specific topic
  function getTopicModuleProgress(topicName, moduleProgress) {
    const noviceKey = `${topicName} - Novice`;
    const intermediateKey = `${topicName} - Intermediate`;
    const advancedKey = `${topicName} - Advanced`;
    
    const noviceProgress = moduleProgress[noviceKey] || 0;
    const intermediateProgress = moduleProgress[intermediateKey] || 0;
    const advancedProgress = moduleProgress[advancedKey] || 0;
    
    const hasAnyProgress = noviceProgress > 0 || intermediateProgress > 0 || advancedProgress > 0;
    const averageProgress = hasAnyProgress ? Math.round((noviceProgress + intermediateProgress + advancedProgress) / 3) : 0;
    const maxProgress = Math.max(noviceProgress, intermediateProgress, advancedProgress);
    
    return {
      hasAnyProgress,
      averageProgress,
      maxProgress,
      novice: noviceProgress,
      intermediate: intermediateProgress,
      advanced: advancedProgress
    };
  }
  
  // Generate personalized learning path based on user data
  function generateLearningPath(userData) {
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const level = userData.level || 'Beginner';
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    
    let pathSteps = [];
    
    // Define the browse topics exactly as they appear in the homepage browse section
    const browseTopics = [
      // Chapter 1
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      // Chapter 2
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      // Chapter 3
      'Linear Approximation & Differentials'
    ];
    
    // Helper function to get topic progress and completion status
    function getTopicProgress(topicName) {
      // Map topic names to their module progress keys
      const topicToModuleMap = {
        'Introduction to derivatives': 'Introduction to derivatives',
        'The definition of Derivative': 'The definition of Derivative', 
        'Rules of Differentiation': 'Rules of Differentiation',
        'Equation of Tangent': 'Equation of Tangent',
        'Second Derivative': 'Second Derivative',
        'Implicit Differentiations': 'Implicit Differentiations',
        'Linear Approximation & Differentials': 'Linear Approximation & Differentials'
      };
      
      const mappedTopic = topicToModuleMap[topicName] || topicName;
      
      // Get progress for each difficulty level
      const noviceProgress = moduleProgress[`${mappedTopic} - Novice`] || 0;
      const intermediateProgress = moduleProgress[`${mappedTopic} - Intermediate`] || 0;
      const advancedProgress = moduleProgress[`${mappedTopic} - Advanced`] || 0;
      
      // Calculate overall topic progress (average of all levels)
      const overallProgress = Math.round((noviceProgress + intermediateProgress + advancedProgress) / 3);
      
      // Check if user has visited the theory page for this topic
      const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
      const topicVisits = practiceAttempts[mappedTopic] || 0;
      
      // A topic is considered completed when the user has visited the theory page
      const isCompleted = topicVisits > 0;
      const hasProgress = noviceProgress > 0 || intermediateProgress > 0 || advancedProgress > 0 || topicVisits > 0;
      
      return {
        progress: overallProgress,
        isCompleted: isCompleted,
        hasProgress: hasProgress,
        novice: noviceProgress,
        intermediate: intermediateProgress,
        advanced: advancedProgress
      };
    }
    
    // Add specific topics based on weak areas (only if they're in browse topics)
    if (weakTopics.length > 0) {
    weakTopics.forEach(topic => {
        // Only include if it's in the browse topics
        if (browseTopics.includes(topic)) {
      let link = '';
      switch(topic) {
        case "Introduction to derivatives":
          link = "Introduction_to_derivatives.html";
          break;
        case "The definition of Derivative":
          link = "The_definition_of_derivative.html";
          break;
        case "Rules of Differentiation":
          link = "rule.html";
          break;
        case "Equation of Tangent":
          link = "Equation-of-tangent.html";
          break;
        case "Second Derivative":
          link = "Second-derivative.html";
          break;
        case "Implicit Differentiations":
          link = "Implicit-differentiation.html";
          break;
        case "Linear Approximation & Differentials":
          link = "linear-approx-differentials.html";
          break;
      }
      
          const topicProgress = getTopicProgress(topic);
      pathSteps.push({
        title: topic,
        content: 'Focus on improving your understanding of this topic',
            status: topicProgress.isCompleted ? 'completed' : 'current',
            action: topicProgress.isCompleted ? 'Review' : 'Study',
            link: link,
            progress: topicProgress.progress,
            isCompleted: topicProgress.isCompleted
          });
        }
      });
    } else {
      // For new users without quiz data, provide a standard learning path from browse topics
      const standardTopics = [
        {
          title: 'Introduction to derivatives',
          content: 'Learn what derivatives are and why they matter',
          link: 'Introduction_to_derivatives.html'
        },
        {
          title: 'Rules of Differentiation',
          content: 'Master the fundamental rules of differentiation',
          link: 'rule.html'
        },
        {
          title: 'Equation of Tangent',
          content: 'See how derivatives are used to find tangent lines',
          link: 'Equation-of-tangent.html'
        }
      ];
      
      standardTopics.forEach((topic, index) => {
        const topicProgress = getTopicProgress(topic.title);
      pathSteps.push({
          title: topic.title,
          content: topic.content,
          status: topicProgress.isCompleted ? 'completed' : (index === 0 ? 'current' : 'upcoming'),
          action: topicProgress.isCompleted ? 'Review' : (index === 0 ? 'Start' : 'Next'),
          link: topic.link,
          progress: topicProgress.progress,
          isCompleted: topicProgress.isCompleted
        });
      });
    }
    
    // Add assessment step
    pathSteps.push({
      title: 'Take Assessment Quiz',
      content: 'Evaluate your understanding and get personalized recommendations',
      status: weakTopics.length === 0 ? 'current' : 'completed',
      action: weakTopics.length === 0 ? 'Take Quiz' : 'Retake',
      link: 'quiz.html',
      progress: weakTopics.length > 0 ? 100 : 0,
      isCompleted: weakTopics.length > 0
    });
    
    return pathSteps;
  }
  
  // Generate achievements based on user progress
  function generateAchievements(userData) {
    const level = userData.level || 'Beginner';
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    
    // Count completed modules (80% or higher)
    let completedModules = 0;
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    
    browseTopics.forEach(topic => {
      difficultyLevels.forEach(level => {
        const moduleKey = `${topic} - ${level}`;
        const progress = moduleProgress[moduleKey] || 0;
        if (progress >= 80) {
          completedModules++;
        }
      });
    });
    
    // Define all possible achievements
    const achievements = [
      {
        icon: 'ðŸš€',
        title: 'Getting Started',
        description: 'Welcome to your calculus journey!',
        unlocked: true // Always unlocked for new users
      },
      {
        icon: 'ðŸ“š',
        title: 'Novice Calculus',
        description: 'Reach Novice level',
        unlocked: ['Novice', 'Intermediate', 'Advanced'].includes(level)
      },
      {
        icon: 'ðŸŽ¯',
        title: 'Assessment Taker',
        description: 'Complete the assessment quiz',
        unlocked: weakTopics.length > 0
      },
      {
        icon: 'ðŸ',
        title: 'First Steps',
        description: 'Complete your first module',
        unlocked: completedModules >= 1
      },
      {
        icon: 'ðŸ“ˆ',
        title: 'Making Progress',
        description: 'Complete 5 modules',
        unlocked: completedModules >= 5
      },
      {
        icon: 'ðŸ”¥',
        title: 'On Fire',
        description: 'Complete 10 modules',
        unlocked: completedModules >= 10
      },
      {
        icon: 'ðŸŽ“',
        title: 'Scholar',
        description: 'Complete 15 modules',
        unlocked: completedModules >= 15
      },
      {
        icon: 'ðŸ†',
        title: 'Calculus Master',
        description: 'Complete all 21 modules',
        unlocked: completedModules >= 21
      },
      {
        icon: 'ðŸŸ¢',
        title: 'Novice Master',
        description: 'Complete all Novice level modules',
        unlocked: browseTopics.every(topic => (moduleProgress[`${topic} - Novice`] || 0) >= 80)
      },
      {
        icon: 'ðŸŸ¡',
        title: 'Intermediate Master',
        description: 'Complete all Intermediate level modules',
        unlocked: browseTopics.every(topic => (moduleProgress[`${topic} - Intermediate`] || 0) >= 80)
      },
      {
        icon: 'ðŸ”´',
        title: 'Advanced Master',
        description: 'Complete all Advanced level modules',
        unlocked: browseTopics.every(topic => (moduleProgress[`${topic} - Advanced`] || 0) >= 80)
      },
      {
        icon: 'ðŸ”',
        title: 'Slope Seeker',
        description: 'Master derivatives',
        unlocked: level === 'Intermediate' || level === 'Advanced'
      },
      {
        icon: 'â±ï¸',
        title: 'Speed Solver',
        description: 'Complete quiz in under 5 minutes',
        unlocked: false
      },
      {
        icon: 'ðŸ§©',
        title: 'Concept Connector',
        description: 'Study multiple calculus topics',
        unlocked: level !== 'Beginner'
      },
      {
        icon: 'ðŸ’¯',
        title: 'Perfectionist',
        description: 'Achieve 100% on any module',
        unlocked: Object.values(moduleProgress).some(progress => progress >= 100)
      }
    ];
    
    return achievements;
  }
  
  // Update the UI with learning analytics data
  function updateLearningAnalytics(masteryData, learningPath, achievements) {
    // Check if sections should be visible (for beginners who haven't taken quiz)
    const userLevel = sessionStorage.getItem('level');
    const userWeakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const userRecommendations = JSON.parse(sessionStorage.getItem('recommendations') || '[]');
    const hasQuizData = userWeakTopics.length > 0 || userRecommendations.length > 0;
    const isBeginner = userLevel === 'Beginner';
    const shouldShowSections = !isBeginner || hasQuizData;
    
    // Only update sections if they should be visible
    if (!shouldShowSections) {
      console.log('Skipping learning analytics update - sections hidden for beginner user without quiz data');
      return;
    }
    
    // Update Mastery section
    const masteryContainer = document.getElementById('mastery-container');
    if (masteryData && masteryData.length > 0) {
      masteryContainer.innerHTML = '';
      
      // Add just the title (no refresh button)
      const masteryHeader = document.createElement('div');
      masteryHeader.className = 'mastery-header';
      masteryHeader.innerHTML = `
        <h4 class="mastery-section-title">Topic Mastery</h4>
      `;
      masteryContainer.appendChild(masteryHeader);
      
      const masteryGrid = document.createElement('div');
      masteryGrid.className = 'mastery-grid';
      
      masteryData.forEach(item => {
        const masteryItem = document.createElement('div');
        masteryItem.className = 'mastery-item';
        
        let badgeHTML = '';
        if (item.badge) {
          badgeHTML = `<div class="mastery-badge">${item.badge}</div>`;
        }
        
        // Use topic name directly instead of concept
        masteryItem.innerHTML = `
          ${badgeHTML}
          <div class="mastery-title">${item.topic || 'Unknown Topic'}</div>
          <div class="mastery-description">${item.description || ''}</div>
          <div class="mastery-bar-container">
            <div class="mastery-bar" style="width: ${item.mastery}%;"></div>
          </div>
          <div class="mastery-percentage">${item.mastery}%</div>
          <button class="topic-practice-btn" onclick="practiceTopic('${item.topic}')">Practice</button>
        `;
        
        masteryGrid.appendChild(masteryItem);
      });
      
      masteryContainer.appendChild(masteryGrid);
    }
    
    // Update Learning Path section
    const learningPathContainer = document.getElementById('learning-path-container');
    if (learningPath && learningPath.length > 0) {
      learningPathContainer.innerHTML = '';
      
      const learningPathDiv = document.createElement('div');
      learningPathDiv.className = 'learning-path';
      
      const pathSteps = document.createElement('div');
      pathSteps.className = 'path-steps';
      
      learningPath.forEach(step => {
        const pathStep = document.createElement('div');
        pathStep.className = `path-step ${step.status}`;
        
        // Create completion tick if the step is completed
        const completionTick = step.isCompleted ? '<span class="completion-tick">âœ“</span>' : '';
        
        // Create progress bar if progress data is available
        let progressBarHTML = '';
        if (step.progress !== undefined) {
          progressBarHTML = `
            <div class="path-step-progress">
              <div class="path-progress-bar-container">
                <div class="path-progress-bar" style="width: ${step.progress}%;"></div>
              </div>
              <span class="path-progress-text">${step.progress}%</span>
            </div>
          `;
        }
        
        pathStep.innerHTML = `
          <div class="path-step-header">
            <span class="path-step-title">
              ${step.title} ${completionTick}
            </span>
            <span class="path-step-status">${step.status === 'completed' ? 'Completed' : step.status === 'current' ? 'In Progress' : 'Coming Soon'}</span>
          </div>
          <div class="path-step-content">${step.content}</div>
          ${progressBarHTML}
          <button class="path-step-action" onclick="window.location.href='${step.link}'">${step.action}</button>
        `;
        
        pathSteps.appendChild(pathStep);
      });
      
      learningPathDiv.appendChild(pathSteps);
      learningPathContainer.appendChild(learningPathDiv);
    }
    
    // Update Achievements section
    const achievementsContainer = document.getElementById('achievements-container');
    if (achievements && achievements.length > 0) {
      achievementsContainer.innerHTML = '';
      
      const achievementsGrid = document.createElement('div');
      achievementsGrid.className = 'achievements-grid';
      
      achievements.forEach(achievement => {
        const achievementDiv = document.createElement('div');
        achievementDiv.className = `achievement ${achievement.unlocked ? '' : 'locked'}`;
        
        achievementDiv.innerHTML = `
          <div class="achievement-icon">${achievement.icon}</div>
          <div class="achievement-title">${achievement.title}</div>
          <div class="achievement-description">${achievement.description}</div>
        `;
        
        achievementsGrid.appendChild(achievementDiv);
      });
      
      achievementsContainer.appendChild(achievementsGrid);
    }
  }
  
  // Function to refresh mastery data
  window.refreshMasteryData = function() {
    // Get current data
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    // Regenerate mastery data
    const masteryData = generateMasteryData(userData);
    
    // Update session storage
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI
    updateLearningAnalytics(
      masteryData,
      JSON.parse(sessionStorage.getItem('learningPath') || '[]'),
      JSON.parse(sessionStorage.getItem('achievements') || '[]')
    );
    
    // Show toast notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">Data Refreshed</div>
        <div class="toast-message">Your mastery data has been updated.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate the toast in
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    // Animate the toast out after 3 seconds
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 500);
    }, 3000);
    
    // Save to Firebase if user is logged in
    const user = auth.currentUser;
    if (user) {
      saveUserData(user).then(() => {
        console.log("Refreshed mastery data saved to Firebase");
      }).catch(error => {
        console.error("Error saving refreshed mastery data:", error);
      });
    }
  };

  // Function to reset mastery data for beginners (testing purposes)
  // REMOVED: resetBeginnerMastery function - replaced with resetAllMastery

  // Debug function to show module progress breakdown
  window.showModuleProgressDebug = function() {
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    let totalProgress = 0;
    let completedModules = 0;
    let debugInfo = 'MODULE PROGRESS BREAKDOWN:\n\n';
    
    browseTopics.forEach((topic, topicIndex) => {
      debugInfo += `${topicIndex + 1}. ${topic}:\n`;
      difficultyLevels.forEach(level => {
        const moduleKey = `${topic} - ${level}`;
        const progress = moduleProgress[moduleKey] || 0;
        totalProgress += progress;
        if (progress >= 80) completedModules++;
        
        debugInfo += `   ${level}: ${progress}% ${progress >= 80 ? 'âœ“' : ''}\n`;
      });
      debugInfo += '\n';
    });
    
    // Calculate progress for each difficulty level
    debugInfo += `DIFFICULTY LEVEL PROGRESS:\n\n`;
    difficultyLevels.forEach(difficulty => {
      let levelProgress = 0;
      let levelCompleted = 0;
      
      browseTopics.forEach(topic => {
        const moduleKey = `${topic} - ${difficulty}`;
        const progress = moduleProgress[moduleKey] || 0;
        levelProgress += progress;
        if (progress >= 80) levelCompleted++;
      });
      
      const averageProgress = Math.round(levelProgress / browseTopics.length);
      debugInfo += `${difficulty}: ${averageProgress}% (${levelCompleted}/${browseTopics.length} completed)\n`;
    });
    
    debugInfo += `\nSUMMARY:\n`;
    debugInfo += `Total Modules: ${browseTopics.length * difficultyLevels.length}\n`;
    debugInfo += `Completed Modules (â‰¥80%): ${completedModules}\n`;
    
    console.log(debugInfo);
    alert(debugInfo);
  };

  // Function to recalculate difficulty level progress with animation
  window.recalculateOverallProgress = function() {
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    
    console.log('=== RECALCULATING PROGRESS ===');
    console.log('Module Progress Data:', moduleProgress);
    
    // Calculate progress for each difficulty level
    difficultyLevels.forEach(difficulty => {
      let completedModules = 0;
      let totalProgress = 0;
      
      browseTopics.forEach(topic => {
        const moduleKey = `${topic} - ${difficulty}`;
        const progress = moduleProgress[moduleKey] || 0;
        totalProgress += progress;
        if (progress >= 80) {
          completedModules++;
        }
        console.log(`${moduleKey}: ${progress}%`);
      });
      
      const averageProgress = Math.round(totalProgress / browseTopics.length);
      const difficultyLower = difficulty.toLowerCase();
      
      console.log(`${difficulty} Level: ${averageProgress}% (${completedModules}/${browseTopics.length} completed)`);
      
      // Animate progress bar from 0 to target value
      const progressBar = document.getElementById(`${difficultyLower}-progress-bar`);
      const progressPercentage = document.getElementById(`${difficultyLower}-progress-percentage`);
      const progressDetails = document.getElementById(`${difficultyLower}-details`);
      
      if (progressBar && progressPercentage && progressDetails) {
        // Start from 0 and animate to target
        progressBar.style.width = '0%';
        progressPercentage.textContent = '0%';
        
        // Use timeout to trigger animation
        setTimeout(() => {
          progressBar.style.width = `${averageProgress}%`;
          
          // Animate the percentage text
          let currentPercent = 0;
          const targetPercent = averageProgress;
          const increment = targetPercent / 50; // 50 steps for smooth animation
          
          const percentInterval = setInterval(() => {
            currentPercent += increment;
            if (currentPercent >= targetPercent) {
              currentPercent = targetPercent;
              clearInterval(percentInterval);
            }
            progressPercentage.textContent = `${Math.round(currentPercent)}%`;
          }, 40); // 40ms intervals for smooth animation
          
        }, 200); // Small delay to ensure DOM is ready
        
        progressDetails.textContent = `${completedModules} of ${browseTopics.length} modules completed`;
      }
    });
    
    return true;
  };

  // Function to generate module URLs based on topic and level
  window.getModuleUrl = function(topic, level) {
    // Map topics to their exact file names as they exist in the project
    let baseUrl = '';
    
    switch(topic) {
      case 'Introduction to derivatives':
        baseUrl = 'introduction-to-derivatives';
        break;
      case 'The definition of Derivative':
        baseUrl = 'the-definition-of-derivative';
        break;
      case 'Rules of Differentiation':
        baseUrl = 'rules-of-differentiation';
        break;
      case 'Equation of Tangent':
        baseUrl = 'equation-of-tangent';
        break;
      case 'Second Derivative':
        baseUrl = 'second-derivative';
        break;
      case 'Implicit Differentiations':
        baseUrl = 'implicit-differentiations';
        break;
      case 'Linear Approximation & Differentials':
        baseUrl = 'linear-approximation-and-differentials';
        break;
      default:
        // Fallback: convert topic name to URL-friendly format
        baseUrl = topic.toLowerCase()
      .replace(/\s+/g, '-')
      .replace(/&/g, 'and')
      .replace(/[^a-z0-9-]/g, '');
    }
    
    const levelSlug = level.toLowerCase();
    
    // Create the full module URL exactly as the files are named
    // Use enhanced versions for Introduction to Derivatives
    if (topic === 'Introduction to derivatives') {
      return `${baseUrl}-${levelSlug}-enhanced.html`;
    }
    
    return `${baseUrl}-${levelSlug}.html`;
  };

  // Function to test if all module URLs are working
  window.testAllModuleUrls = function() {
    const topic = 'Linear Approximation & Differentials';
    const levels = ['Novice', 'Intermediate', 'Advanced'];
    let testResults = `TESTING LINEAR APPROXIMATION & DIFFERENTIALS MODULES:\n\n`;
    
    levels.forEach(level => {
      const moduleUrl = getModuleUrl(topic, level);
      testResults += `${level}: ${moduleUrl}\n`;
      
      // Test the actual navigation
      try {
        // Create a test link to see if it would work
        const testLink = document.createElement('a');
        testLink.href = moduleUrl;
        testResults += `  Full URL: ${window.location.origin}/${moduleUrl}\n`;
        testResults += `  Status: Ready to test âœ…\n\n`;
      } catch (error) {
        testResults += `  Error: ${error.message} âŒ\n\n`;
      }
    });
    
    console.log(testResults);
    alert(testResults);
  };

  // Specific test for Linear Approximation & Differentials
  window.testLinearApproxModules = function() {
    const topic = 'Linear Approximation & Differentials';
    const levels = ['Novice', 'Intermediate', 'Advanced'];
    let testResults = `TESTING LINEAR APPROXIMATION & DIFFERENTIALS MODULES:\n\n`;
    
    levels.forEach(level => {
      const moduleUrl = getModuleUrl(topic, level);
      testResults += `${level}: ${moduleUrl}\n`;
      
      // Test the actual navigation
      try {
        // Create a test link to see if it would work
        const testLink = document.createElement('a');
        testLink.href = moduleUrl;
        testResults += `  Full URL: ${window.location.origin}/${moduleUrl}\n`;
        testResults += `  Status: Ready to test âœ…\n\n`;
      } catch (error) {
        testResults += `  Error: ${error.message} âŒ\n\n`;
      }
    });
    
    console.log(testResults);
    alert(testResults);
  };

  // Enhanced function to handle module access with error handling
  window.navigateToModule = function(topic, level) {
    const moduleUrl = getModuleUrl(topic, level);
    
    // Special debug logging for Linear Approximation modules
    if (topic === 'Linear Approximation & Differentials') {
      console.log('Linear Approximation Module Debug:');
      console.log('Topic:', topic);
      console.log('Level:', level);
      console.log('Generated URL:', moduleUrl);
      console.log('Full URL would be:', window.location.origin + '/' + moduleUrl);
    }
    
    // Show loading message
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">Loading Module</div>
        <div class="toast-message">Opening ${topic} - ${level} level...</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate the toast in
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    // Try to navigate to the module
    try {
      // Add a small delay to show the loading message
      setTimeout(() => {
        window.location.href = moduleUrl;
      }, 500);
    } catch (error) {
      // Remove loading toast
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 500);
      }, 1000);
      
      // Show error message
      setTimeout(() => {
        const errorToast = document.createElement('div');
        errorToast.className = 'toast-notification';
        errorToast.innerHTML = `
          <div class="toast-icon">âŒ</div>
          <div class="toast-content">
            <div class="toast-title">Module Not Found</div>
            <div class="toast-message">The ${topic} - ${level} module is not available yet.<br>URL: ${moduleUrl}</div>
          </div>
        `;
        
        document.body.appendChild(errorToast);
        
        setTimeout(() => {
          errorToast.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          errorToast.classList.remove('show');
          setTimeout(() => {
            if (document.body.contains(errorToast)) {
              document.body.removeChild(errorToast);
            }
          }, 500);
        }, 5000); // Show error longer for debugging
      }, 1500);
      
      console.error("Error navigating to module:", error);
      console.error("Attempted URL:", moduleUrl);
    }
  };

  // Direct navigation function for Linear Approximation modules (for testing)
  window.directNavigateLinearApprox = function(level) {
    const urls = {
      'Novice': 'linear-approximation-and-differentials-novice.html',
      'Intermediate': 'linear-approximation-and-differentials-intermediate.html',
      'Advanced': 'linear-approximation-and-differentials-advanced.html'
    };
    
    const url = urls[level];
    if (url) {
      console.log(`Direct navigation to: ${url}`);
      window.location.href = url;
    } else {
      alert(`No URL found for level: ${level}`);
    }
  };

  // Function to toggle module dropdown
  window.toggleModuleDropdown = function(button) {
    // Close all other dropdowns first
    document.querySelectorAll('.module-options.show').forEach(dropdown => {
      if (dropdown !== button.nextElementSibling) {
        dropdown.classList.remove('show');
      }
    });
    
    // Toggle the clicked dropdown
    const dropdown = button.nextElementSibling;
    dropdown.classList.toggle('show');
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function closeDropdown(e) {
      if (!button.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.classList.remove('show');
        document.removeEventListener('click', closeDropdown);
      }
    });
  };

  async function fetchUserData(user) {
    try {
      console.log("Fetching user data for:", user.uid);
      const userDocRef = doc(db, 'users', user.uid);
      const userDocSnap = await getDoc(userDocRef);

      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        console.log("User data from Firebase:", userData);
        
        // Make a username from email if username is missing or "Guest"
        let displayName = userData.username;
        if (!displayName || displayName === 'Guest') {
          // Extract username from email (remove @domain.com)
          displayName = user.email ? user.email.split('@')[0] : 'Guest';
          // Capitalize first letter
          displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
          
          // Save this username back to Firebase
          await updateDoc(userDocRef, {
            username: displayName
          });
        }
        
        // Update session storage
        sessionStorage.setItem('username', displayName);
        sessionStorage.setItem('userName', displayName);
        sessionStorage.setItem('userEmail', user.email || '');
        sessionStorage.setItem('level', userData.level || 'Beginner');
        
        // Restore weakTopics and recommendations if they exist
        if (userData.weakTopics) {
          sessionStorage.setItem('weakTopics', JSON.stringify(userData.weakTopics));
        }
        if (userData.recommendations) {
          sessionStorage.setItem('recommendations', JSON.stringify(userData.recommendations));
        }
        
        // Load or generate learning analytics data
        let masteryData = userData.masteryData;
        let learningPath = userData.learningPath;
        let achievements = userData.achievements;
        let practiceAttempts = userData.practiceAttempts || {};
        let correctAnswers = userData.correctAnswers || {};
        
        if (!masteryData) {
          masteryData = generateMasteryData({
            username: displayName,
            level: userData.level || 'Beginner'
          });
        }
        
        if (!learningPath) {
          learningPath = generateLearningPath({
            username: displayName,
            level: userData.level || 'Beginner'
          });
        }
        
        if (!achievements) {
          achievements = generateAchievements({
            username: displayName,
            level: userData.level || 'Beginner'
          });
        }
        
        // Store learning analytics data in session storage
        sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
        sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
        sessionStorage.setItem('achievements', JSON.stringify(achievements));
        sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
        sessionStorage.setItem('correctAnswers', JSON.stringify(correctAnswers));
        
        // Sync the data to UI
        syncUserData({
          username: displayName,
          level: userData.level || 'Beginner',
          moduleProgress: userData.moduleProgress || {},
          overallProgress: userData.overallProgress || 0,
          masteryData: masteryData,
          learningPath: learningPath,
          achievements: achievements,
          practiceAttempts: practiceAttempts,
          correctAnswers: correctAnswers
        });
      } else {
        console.log("No user document found, creating new one");
        // Create a new user document
        let displayName = user.email ? user.email.split('@')[0] : 'Guest';
        displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
        
        // Generate initial learning analytics data
        const masteryData = generateMasteryData({
          username: displayName,
          level: 'Beginner'
        });
        
        const learningPath = generateLearningPath({
          username: displayName,
          level: 'Beginner'
        });
        
        const achievements = generateAchievements({
          username: displayName,
          level: 'Beginner'
        });
        
        const practiceAttempts = {};
        
        const newUserData = {
          username: displayName,
          level: 'Beginner',
          moduleProgress: {},
          overallProgress: 0,
          email: user.email,
          createdAt: new Date().toISOString(),
          weakTopics: [],
          recommendations: [],
          masteryData: masteryData,
          learningPath: learningPath,
          achievements: achievements,
          practiceAttempts: practiceAttempts,
          correctAnswers: {}
        };
        
        // Save the new user data
        await setDoc(userDocRef, newUserData);
        
        // Update session storage
        sessionStorage.setItem('username', displayName);
        sessionStorage.setItem('userName', displayName);
        sessionStorage.setItem('userEmail', user.email || '');
        sessionStorage.setItem('level', 'Beginner');
        sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
        sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
        sessionStorage.setItem('achievements', JSON.stringify(achievements));
        sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
        sessionStorage.setItem('correctAnswers', JSON.stringify({}));
        
        syncUserData(newUserData);
      }
    } catch (error) {
      console.error("Error fetching user data:", error);
      alert("Error loading profile. Please try again.");
    }
  }

  // âœ… Save User Data before Logout
  async function saveUserData(user) {
    const userDocRef = doc(db, 'users', user.uid);
    await setDoc(userDocRef, {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level'),
      moduleProgress: JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'),
      weakTopics: JSON.parse(sessionStorage.getItem('weakTopics') || '[]'),
      recommendations: JSON.parse(sessionStorage.getItem('recommendations') || '[]'),
      masteryData: JSON.parse(sessionStorage.getItem('masteryData') || 'null'),
      learningPath: JSON.parse(sessionStorage.getItem('learningPath') || 'null'),
      achievements: JSON.parse(sessionStorage.getItem('achievements') || 'null'),
      practiceAttempts: JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}'),
      correctAnswers: JSON.parse(sessionStorage.getItem('correctAnswers') || '{}'),
      lastUpdated: new Date().toISOString()
    });
  }

  // âœ… Authentication State Listener
  document.addEventListener('DOMContentLoaded', function() {
    const storedUsername = sessionStorage.getItem('username');
    const storedLevel = sessionStorage.getItem('level');
    const storedModuleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    
    // Debug: Log current progress data
    console.log('Profile loaded - Current progress data:');
    console.log('Username:', storedUsername);
    console.log('Level:', storedLevel);
    console.log('Module Progress:', storedModuleProgress);
    
    // Load learning analytics data from session storage if available
    const storedMasteryData = JSON.parse(sessionStorage.getItem('masteryData') || 'null');
    const storedLearningPath = JSON.parse(sessionStorage.getItem('learningPath') || 'null');  
    const storedAchievements = JSON.parse(sessionStorage.getItem('achievements') || 'null');

    if (storedUsername && storedLevel) {
      updateUI(storedUsername, storedLevel, storedModuleProgress, 0);
      
      // Update learning analytics if data is available
      if (storedMasteryData && storedLearningPath && storedAchievements) {
        updateLearningAnalytics(storedMasteryData, storedLearningPath, storedAchievements);
      }

      // Force progress bar updates with a longer delay to ensure DOM is ready
      setTimeout(() => {
        console.log('Forcing progress bar recalculation...');
        recalculateOverallProgress();
      }, 1000);
      
      // Also force a UI refresh after another delay
      setTimeout(() => {
        console.log('Forcing UI refresh...');
        updateUI(storedUsername, storedLevel, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
      }, 1500);
      
      // Auto-detect completed modules and update progress automatically
      setTimeout(() => {
        console.log('Auto-detecting module completions...');
        autoDetectModuleCompletions();
      }, 2500);
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }
      await fetchUserData(user);
      
      // Force another progress update after Firebase data is loaded
      setTimeout(() => {
        console.log('Post-Firebase progress update...');
        recalculateOverallProgress();
      }, 2000);
      
      // Auto-detect completed modules after Firebase data is loaded
      setTimeout(() => {
        console.log('Auto-detecting module completions from Firebase data...');
        autoDetectModuleCompletions();
      }, 3000);
      
      // Auto-refresh mastery data to ensure it's up to date
      setTimeout(() => {
        console.log('Auto-refreshing mastery data...');
        autoRefreshMasteryData();
      }, 3500);
      
      // Automatically enable correct answers only mode for all users
      setTimeout(() => {
        console.log('Auto-enabling correct answers only mode...');
        autoEnableCorrectAnswersOnlyMode();
      }, 4000);
      
      // Auto-detect completed modules and update progress
      setTimeout(() => {
        console.log('Auto-detecting and updating progress...');
        autoDetectModuleCompletions();
        recalculateOverallProgress();
      }, 4500);
      
      // Set up periodic auto-refresh every 2 minutes
      setInterval(() => {
        autoRefreshMasteryData();
      }, 120000);
      
      // Check if this page load is from practicing a topic
      checkTopicVisit();
    });
  });

  // âœ… Navigation Functions
  // goToModules function removed - View Modules button no longer needed

  // Practice Topic Function
  window.practiceTopic = function(topic) {
    let pageUrl = '';
    
    // Map topics to their specific practice HTML pages
    switch(topic) {
      case "Introduction to derivatives":
        pageUrl = "practice-intro-derivatives.html";
        break;
      case "The definition of Derivative":
        pageUrl = "practice-definition-derivative.html";
        break;
      case "Rules of Differentiation":
        pageUrl = "practice-rules-differentiation.html";
        break;
      case "Equation of Tangent":
        pageUrl = "practice-equation-tangent.html";
        break;
      case "Second Derivative":
        pageUrl = "practice-second-derivative.html";
        break;
      case "Implicit Differentiations":
        pageUrl = "practice-implicit-differentiation.html";
        break;
      case "Linear Approximation & Differentials":
        pageUrl = "practice-linear-approx-differentials.html";
        break;
      default:
        // Default to quiz if specific page isn't found
        pageUrl = "quiz.html";
    }
    
    // Track practice attempt in session storage (for learning path tracking only)
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    practiceAttempts[topic] = (practiceAttempts[topic] || 0) + 1;
    sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
    
    // NOTE: Mastery is no longer updated here - only correct answers will increase mastery
    // Navigate to the practice page
    window.location.href = pageUrl;
  };

  // New function to update mastery based on correct answers
  window.updateMasteryFromCorrectAnswer = function(topic, correctAnswersCount = 1) {
    // Update correct answers count
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    correctAnswers[topic] = (correctAnswers[topic] || 0) + correctAnswersCount;
    sessionStorage.setItem('correctAnswers', JSON.stringify(correctAnswers));
    
    console.log(`âœ… Correct answer recorded for "${topic}"! Total correct answers: ${correctAnswers[topic]}`);
    
    // Regenerate mastery data to reflect the new correct answers
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI if we're on the profile page
    if (window.location.pathname.includes('profile.html')) {
      const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
      const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
      updateLearningAnalytics(masteryData, learningPath, achievements);
    }
    
    // Show notification
    const topicMastery = masteryData.find(item => item.topic === topic);
    const currentMastery = topicMastery ? topicMastery.mastery : 0;
    
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸŽ¯</div>
      <div class="toast-content">
        <div class="toast-title">Correct Answer!</div>
        <div class="toast-message">${topic}: Mastery is now ${currentMastery}%</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 3000);
    
    // Save to Firebase if user is logged in
    const user = auth.currentUser;
    if (user) {
      saveUserData(user).then(() => {
        console.log("Correct answer mastery data saved to Firebase");
      }).catch(error => {
        console.error("Error saving correct answer mastery data:", error);
      });
    }
    
    console.log(`Mastery updated for ${topic}: ${correctAnswers[topic]} correct answers, ${currentMastery}% mastery`);
    return currentMastery; // Return the new mastery percentage
  };

  // Global function that can be called from any page to record a correct answer
  window.recordCorrectAnswer = function(topicName) {
    // This is the main function other pages should call
    return window.updateMasteryFromCorrectAnswer(topicName, 1);
  };

  // âœ… Logout Function
  window.logout = async function() {
    try {
      const user = auth.currentUser;
      if (user) await saveUserData(user);
      await signOut(auth);
      sessionStorage.clear();
      // Navigate in the same tab
      window.location.href = "index.html";
    } catch (error) {
      console.error("Error signing out:", error);
    }
  };

  // Function to check if we're visiting from a practice link and update mastery
  function checkTopicVisit() {
    // Get the previous page URL
    const referrer = document.referrer;
    if (!referrer) return;
    
    // Extract the filename from the referrer
    const filename = referrer.substring(referrer.lastIndexOf('/') + 1);
    
    // Map filenames to topics
    const filenameToTopic = {
      'Introduction_to_derivatives.html': 'Introduction to derivatives',
      'The_definition_of_derivative.html': 'The definition of Derivative',
      'rule.html': 'Rules of Differentiation',
      'Equation-of-tangent.html': 'Equation of Tangent',
      'Second-derivative.html': 'Second Derivative',
      'Implicit-differentiation.html': 'Implicit Differentiations',
      'linear-approx-differentials.html': 'Linear Approximation & Differentials'
    };
    
    const topic = filenameToTopic[filename];
    
    // If we came from a topic page, update the mastery data
    if (topic) {
      // Update practice attempts (this tracks theory page visits)
      const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
      practiceAttempts[topic] = (practiceAttempts[topic] || 0) + 1;
      sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
      
      // Update mastery data
      const masteryData = JSON.parse(sessionStorage.getItem('masteryData') || '[]');
      let dataUpdated = false;
      
      masteryData.forEach(item => {
        if (item.topic === topic) {
          // Increase mastery based on visits (up to +5% per visit, max 100%)
          const increase = Math.min(5, 100 - item.mastery);
          item.mastery += increase;
          dataUpdated = true;
          
          // Update badge if mastery level crossed threshold
          if (item.mastery >= 80) {
            item.badge = 'M';  // Master
          } else if (item.mastery >= 50) {
            item.badge = 'P';  // Proficient
          } else if (item.mastery >= 20) {
            item.badge = 'L';  // Learning
          }
        }
      });
      
      if (dataUpdated) {
        sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
        
        // Regenerate learning path to reflect the completion status change
        const userData = {
          username: sessionStorage.getItem('username'),
          level: sessionStorage.getItem('level')
        };
        const updatedLearningPath = generateLearningPath(userData);
        sessionStorage.setItem('learningPath', JSON.stringify(updatedLearningPath));
        
        // Update the UI with the new data
        updateLearningAnalytics(
          masteryData,
          updatedLearningPath,
          JSON.parse(sessionStorage.getItem('achievements') || '[]')
        );
        
        // Also save to Firebase if user is logged in
        const user = auth.currentUser;
        if (user) {
          saveUserData(user);
        }
      }
    }
  }

  // Function to generate module options based on user level and progress
  window.generateModuleOptions = function(topic, userLevel, moduleProgress) {
    const levels = ['Novice', 'Intermediate', 'Advanced'];
    const options = [];
    
    levels.forEach(level => {
      const moduleKey = `${topic} - ${level}`;
      const progress = moduleProgress[moduleKey] || 0;
      const isCompleted = progress >= 80;
      
      // Determine if this level is accessible based on user's current level
      let isAccessible = false;
      let isLocked = false;
      let suggestionReason = '';
      let isSuggested = false;
      
      // Level-based access control
      if (userLevel === 'Beginner' || userLevel === 'Novice') {
        if (level === 'Novice') {
          isAccessible = true;
          isSuggested = true;
          suggestionReason = 'Perfect for your current level';
        } else if (level === 'Intermediate') {
          isAccessible = false;
          isLocked = true;
          suggestionReason = 'Advance to Intermediate level first';
        } else if (level === 'Advanced') {
          isAccessible = false;
          isLocked = true;
          suggestionReason = 'Advance to Advanced level first';
        }
      } else if (userLevel === 'Intermediate') {
        if (level === 'Novice') {
          isAccessible = true;
          suggestionReason = 'Review fundamentals';
        } else if (level === 'Intermediate') {
          isAccessible = true;
          isSuggested = true;
          suggestionReason = 'Matches your level perfectly';
        } else if (level === 'Advanced') {
          isAccessible = false;
          isLocked = true;
          suggestionReason = 'Advance to Advanced level first';
        }
      } else if (userLevel === 'Advanced') {
        // Advanced users can access all levels
        isAccessible = true;
        if (level === 'Advanced') {
          isSuggested = true;
          suggestionReason = 'Perfect for your expertise';
        } else if (level === 'Intermediate') {
          suggestionReason = 'Good practice';
        } else if (level === 'Novice') {
          suggestionReason = 'Quick review';
        }
      }
      
      // Completed modules are always accessible regardless of user level
      if (isCompleted) {
        isAccessible = true;
        isLocked = false;
        suggestionReason = `Completed with ${progress}%`;
      }
      
      // Determine CSS classes
      let cssClasses = level.toLowerCase();
      if (isCompleted) {
        cssClasses += ' completed';
      } else if (isLocked) {
        cssClasses += ' locked';
      } else if (isSuggested) {
        cssClasses += ' suggested';
      }
      
      // Generate description based on level and accessibility
      let description = '';
      switch(level) {
        case 'Novice':
          description = 'Basic concepts and fundamentals';
          break;
        case 'Intermediate':
          description = 'Advanced understanding and applications';
          break;
        case 'Advanced':
          description = 'Complex problems and mastery';
          break;
      }
      
      // Add suggestion reason to description
      if (suggestionReason) {
        description = `${description} â€¢ ${suggestionReason}`;
      }
      
      const moduleUrl = getModuleUrl(topic, level);
      const clickHandler = isLocked ? 
        `onclick="event.preventDefault(); showLockedMessage('${level}', '${userLevel}');"` : 
        `onclick="event.preventDefault(); navigateToModule('${topic}', '${level}');"`;
      
      // Add completion indicator for completed modules
      const completionIndicator = isCompleted ? 
        `<div class="completion-indicator">
          <span class="completion-checkmark">âœ“</span>
          <span class="completion-text">COMPLETED</span>
         </div>` : '';
      
      // Add lock indicator for locked modules
      const lockIndicator = isLocked ? 
        `<div class="lock-indicator">
          <span class="lock-icon">ðŸ”’</span>
          <span class="lock-text">LOCKED</span>
         </div>` : '';
      
      options.push(`
        <a href="${moduleUrl}" class="module-option ${cssClasses}" ${clickHandler}>
          <div class="module-option-content">
            <span class="level-badge ${level.toLowerCase()}">${level}</span>
            <div class="module-option-text">
              <div class="module-option-title">${level} Level</div>
              <div class="module-option-desc">${description}</div>
            </div>
            ${completionIndicator}
            ${lockIndicator}
          </div>
        </a>
      `);
    });
    
    return options.join('');
  };

  // Function to show locked message with specific details
  window.showLockedMessage = function(lockedLevel, userLevel) {
    let message = `ðŸ”’ ${lockedLevel} Level Module is Locked\n\n`;
    
    if (userLevel === 'Beginner' || userLevel === 'Novice') {
      if (lockedLevel === 'Intermediate') {
        message += "To unlock Intermediate modules:\n\n";
        message += "ðŸ“š Complete the assessment quiz to advance to Intermediate level\n";
        message += "ðŸ“ˆ Or complete several Novice level modules to demonstrate readiness\n\n";
        message += "ðŸ’¡ Focus on mastering Novice level concepts first!";
      } else if (lockedLevel === 'Advanced') {
        message += "To unlock Advanced modules:\n\n";
        message += "ðŸŽ¯ First advance to Intermediate level\n";
        message += "ðŸ“š Complete the assessment quiz to jump levels\n";
        message += "ðŸ† Or progressively complete Novice â†’ Intermediate â†’ Advanced\n\n";
        message += "ðŸš€ Advanced modules require strong foundation in calculus!";
      }
    } else if (userLevel === 'Intermediate') {
      if (lockedLevel === 'Advanced') {
        message += "To unlock Advanced modules:\n\n";
        message += "ðŸŽ“ Complete the assessment quiz to advance to Advanced level\n";
        message += "âœ… Or complete several Intermediate level modules\n";
        message += "ðŸ§  Demonstrate mastery of intermediate concepts\n\n";
        message += "ðŸŒŸ Advanced modules contain university-level challenges!";
      }
    }
    
    message += "\n\n" + "Current Level: " + userLevel;
    message += "\n" + "Trying to Access: " + lockedLevel + " Level";
    
    // Show custom styled alert
    const alertDiv = document.createElement('div');
    alertDiv.className = 'custom-alert';
    alertDiv.innerHTML = `
      <div class="alert-overlay">
        <div class="alert-content">
          <div class="alert-header">
            <span class="alert-icon">ðŸ”’</span>
            <h3>Module Locked</h3>
            <button class="alert-close" onclick="this.parentElement.parentElement.parentElement.remove()">Ã—</button>
          </div>
          <div class="alert-body">
            <p><strong>${lockedLevel} Level Module is Locked</strong></p>
            <div class="alert-details">
              ${message.split('\n').map(line => line ? `<p>${line}</p>` : '<br>').join('')}
            </div>
          </div>
          <div class="alert-footer">
            <button class="alert-btn quiz-btn" onclick="window.location.href='quiz.html'; this.parentElement.parentElement.parentElement.remove();">Take Assessment Quiz</button>
            <button class="alert-btn close-btn" onclick="this.parentElement.parentElement.parentElement.remove();">Close</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Also show in console for debugging
    console.log(message);
  };

  // Helper function to get recommendation class based on level
  window.getRecommendationClass = function(level) {
    switch(level) {
      case 'Novice':
        return 'novice-rec';
      case 'Intermediate':
        return 'intermediate-rec';
      case 'Advanced':
        return 'advanced-rec';
      default:
        return 'novice-rec';
    }
  };

  // Function to force progress refresh
  window.forceProgressRefresh = function() {
    console.log('=== FORCING PROGRESS REFRESH ===');
    
    // Get current data from sessionStorage
    const username = sessionStorage.getItem('username');
    const level = sessionStorage.getItem('level');
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    
    console.log('Current username:', username);
    console.log('Current level:', level);
    console.log('Current moduleProgress:', moduleProgress);
    
    // Force update the UI with current data
    updateUI(username, level, moduleProgress, 0);
    
    // Force recalculate progress bars
    setTimeout(() => {
      console.log('Recalculating progress bars...');
      recalculateOverallProgress();
    }, 500);
    
    // Force regenerate learning analytics
    setTimeout(() => {
      console.log('Regenerating learning analytics...');
      const userData = { username, level };
      const masteryData = generateMasteryData(userData);
      const learningPath = generateLearningPath(userData);
      const achievements = generateAchievements(userData);
      
      sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
      sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
      sessionStorage.setItem('achievements', JSON.stringify(achievements));
      
      updateLearningAnalytics(masteryData, learningPath, achievements);
    }, 1000);
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">Progress Refreshed</div>
        <div class="toast-message">All progress data has been updated and refreshed.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 3000);
  };

  // Function to check module completion status
  window.checkModuleCompletionStatus = function() {
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    let statusInfo = 'MODULE COMPLETION STATUS:\n\n';
    
    // Check Introduction to Derivatives specifically
    const introNovice = moduleProgress['Introduction to derivatives - Novice'] || 0;
    const introIntermediate = moduleProgress['Introduction to derivatives - Intermediate'] || 0;
    const introAdvanced = moduleProgress['Introduction to derivatives - Advanced'] || 0;
    
    statusInfo += `INTRODUCTION TO DERIVATIVES:\n`;
    statusInfo += `  Novice: ${introNovice}% ${introNovice >= 80 ? 'âœ… COMPLETED' : 'âŒ Not Complete'}\n`;
    statusInfo += `  Intermediate: ${introIntermediate}% ${introIntermediate >= 80 ? 'âœ… COMPLETED' : 'âŒ Not Complete'}\n`;
    statusInfo += `  Advanced: ${introAdvanced}% ${introAdvanced >= 80 ? 'âœ… COMPLETED' : 'âŒ Not Complete'}\n\n`;
    
    // Check all other modules
    const browseTopics = [
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    browseTopics.forEach(topic => {
      const novice = moduleProgress[`${topic} - Novice`] || 0;
      const intermediate = moduleProgress[`${topic} - Intermediate`] || 0;
      const advanced = moduleProgress[`${topic} - Advanced`] || 0;
      
      statusInfo += `${topic.toUpperCase()}:\n`;
      statusInfo += `  Novice: ${novice}% ${novice >= 80 ? 'âœ…' : 'âŒ'}\n`;
      statusInfo += `  Intermediate: ${intermediate}% ${intermediate >= 80 ? 'âœ…' : 'âŒ'}\n`;
      statusInfo += `  Advanced: ${advanced}% ${advanced >= 80 ? 'âœ…' : 'âŒ'}\n\n`;
    });
    
    console.log(statusInfo);
    alert(statusInfo);
    
    // Force a UI update after showing status
    setTimeout(() => {
      console.log('Forcing UI refresh after status check...');
      updateUI(
        sessionStorage.getItem('username'), 
        sessionStorage.getItem('level'), 
        moduleProgress, 
        0
      );
      recalculateOverallProgress();
    }, 500);
  };

  // Function to test level restrictions
  window.testLevelRestrictions = function() {
    // Simulate temporarily changing the user's level
    const currentLevel = sessionStorage.getItem('level');
    const newLevel = currentLevel === 'Novice' ? 'Intermediate' : currentLevel === 'Intermediate' ? 'Advanced' : 'Novice';
    sessionStorage.setItem('level', newLevel);
    
    // Update UI to reflect the new level
    updateUI(sessionStorage.getItem('username'), newLevel, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
    
    // Show a notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">Level Restrictions Tested</div>
        <div class="toast-message">Temporarily changed to ${newLevel} level.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate the toast in
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    // Animate the toast out after 3 seconds
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 500);
    }, 3000);
  };

  // Function to automatically detect module completions and update progress
  function autoDetectModuleCompletions() {
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    let totalCompletedModules = 0;
    let hasNewCompletions = false;
    
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    
    console.log('Auto-detecting module completions...');
    console.log('Current module progress:', moduleProgress);
    
    // Check for completed modules (80% or higher)
    browseTopics.forEach(topic => {
      difficultyLevels.forEach(level => {
        const moduleKey = `${topic} - ${level}`;
        const progress = moduleProgress[moduleKey] || 0;
        
        if (progress >= 80) {
          totalCompletedModules++;
          console.log(`âœ… Detected completed module: ${moduleKey} (${progress}%)`);
          
          // Mark as completed if not already 100%
          if (progress < 100) {
            moduleProgress[moduleKey] = 100;
            hasNewCompletions = true;
          }
        }
      });
    });
    
    // Update session storage if there are new completions
    if (hasNewCompletions) {
      console.log('Updating module progress with new completions...');
      sessionStorage.setItem('moduleProgress', JSON.stringify(moduleProgress));
    }
    
    console.log(`Total completed modules detected: ${totalCompletedModules}`);
    
    // Force UI update to show completed modules with glitter effects
    const username = sessionStorage.getItem('username');
    const level = sessionStorage.getItem('level');
    
    if (username && level) {
      updateUI(username, level, moduleProgress, 0);
      
      // Animate progress bars
      setTimeout(() => {
        recalculateOverallProgress();
      }, 500);
      
      // Show completion notification if modules were detected
      if (totalCompletedModules > 0) {
        const toast = document.createElement('div');
        toast.className = 'toast-notification';
        toast.innerHTML = `
          <div class="toast-icon">âœ¨</div>
          <div class="toast-content">
            <div class="toast-title">Progress Detected!</div>
            <div class="toast-message">${totalCompletedModules} completed modules found with glitter effects!</div>
          </div>
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
          toast.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          toast.classList.remove('show');
          setTimeout(() => {
            if (document.body.contains(toast)) {
              document.body.removeChild(toast);
            }
          }, 500);
        }, 4000);
      }
    }
  }

  // Welcome section for beginners who haven't taken the quiz
  window.showBeginnerWelcome = function() {
    const beginnerWelcomeSection = document.getElementById('beginner-welcome-section');
    const beginnerWelcomeContainer = document.getElementById('beginner-welcome-container');
    beginnerWelcomeSection.style.display = 'block';
    beginnerWelcomeContainer.style.display = 'block';
  };

  // Function to reset mastery data for all users (testing purposes)
  window.resetAllMastery = function() {
    const currentLevel = sessionStorage.getItem('level');
    
    // Clear quiz data to simulate starting fresh
    sessionStorage.removeItem('weakTopics');
    sessionStorage.removeItem('recommendations');
    sessionStorage.setItem('weakTopics', '[]');
    sessionStorage.setItem('recommendations', '[]');
    
    // Clear module progress to simulate fresh start
    const resetProgress = {};
    sessionStorage.setItem('moduleProgress', JSON.stringify(resetProgress));
    
    // Clear practice attempts
    sessionStorage.setItem('practiceAttempts', '{}');
    
    // Regenerate mastery data (should be 0% for all topics)
    const userData = {
      username: sessionStorage.getItem('username'),
      level: currentLevel
    };
    
    const masteryData = generateMasteryData(userData);
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI
    updateUI(userData.username, userData.level, resetProgress, 0);
    recalculateOverallProgress();
    
    // For beginners, show welcome section and hide other sections
    if (currentLevel === 'Beginner') {
      const beginnerWelcomeSection = document.getElementById('beginner-welcome-section');
      const beginnerWelcomeContainer = document.getElementById('beginner-welcome-container');
      const sectionsToHide = ['suggested-topics-section', 'topic-suggestions', 'learning-mastery-section', 'mastery-container', 'learning-path-section', 'learning-path-container', 'achievements-section', 'achievements-container'];
      
      sectionsToHide.forEach(sectionId => {
        const section = document.getElementById(sectionId);
        if (section) {
          section.style.display = 'none';
        }
      });
      
      if (beginnerWelcomeSection && beginnerWelcomeContainer) {
        beginnerWelcomeSection.style.display = 'block';
        beginnerWelcomeContainer.style.display = 'block';
      }
    } else {
      // For non-beginners, refresh the learning analytics with reset data
      const learningPath = generateLearningPath(userData);
      const achievements = generateAchievements(userData);
      sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
      sessionStorage.setItem('achievements', JSON.stringify(achievements));
      updateLearningAnalytics(masteryData, learningPath, achievements);
    }
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">All Mastery Reset</div>
        <div class="toast-message">All mastery data reset to 0% for ${currentLevel} level user. Progress now reflects only actual completion.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 5000);
    
    console.log('All mastery data reset for', currentLevel, 'level user:', masteryData);
  };

  // Function to test mastery generation for all user levels
  window.testMasteryGeneration = function() {
    const levels = ['Beginner', 'Novice', 'Intermediate', 'Advanced'];
    let testResults = 'MASTERY GENERATION TEST:\n\n';
    
    levels.forEach(level => {
      testResults += `=== ${level.toUpperCase()} LEVEL ===\n`;
      
      // Clear all data to simulate fresh user
      sessionStorage.setItem('weakTopics', '[]');
      sessionStorage.setItem('recommendations', '[]');
      sessionStorage.setItem('moduleProgress', '{}');
      sessionStorage.setItem('practiceAttempts', '{}');
      
      // Generate mastery data for this level
      const userData = {
        username: 'TestUser',
        level: level
      };
      
      const masteryData = generateMasteryData(userData);
      
      // Check if all topics start at 0%
      let allZero = true;
      masteryData.forEach(item => {
        testResults += `${item.topic}: ${item.mastery}% ${item.badge || 'No Badge'}\n`;
        if (item.mastery !== 0) {
          allZero = false;
        }
      });
      
      testResults += `All topics start at 0%: ${allZero ? 'âœ… YES' : 'âŒ NO'}\n\n`;
    });
    
    console.log(testResults);
    alert(testResults);
  };

  // Function to debug Linear Approximation & Differentials specifically
  window.debugLinearApproxMastery = function() {
    const topicName = 'Linear Approximation & Differentials';
    let debugInfo = `=== DEBUGGING ${topicName.toUpperCase()} ===\n\n`;
    
    // Check session storage data
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    const masteryData = JSON.parse(sessionStorage.getItem('masteryData') || '[]');
    const userLevel = sessionStorage.getItem('level');
    
    debugInfo += `Current User Level: ${userLevel}\n`;
    debugInfo += `Has Quiz Data: ${weakTopics.length > 0 ? 'YES' : 'NO'}\n`;
    debugInfo += `Is Weak Topic: ${weakTopics.includes(topicName) ? 'YES' : 'NO'}\n\n`;
    
    debugInfo += `MODULE PROGRESS:\n`;
    const levels = ['Novice', 'Intermediate', 'Advanced'];
    levels.forEach(level => {
      const moduleKey = `${topicName} - ${level}`;
      const progress = moduleProgress[moduleKey] || 0;
      debugInfo += `  ${level}: ${progress}%\n`;
    });
    
    debugInfo += `\nPRACTICE ATTEMPTS: ${practiceAttempts[topicName] || 0}\n\n`;
    
    // Find this topic in mastery data
    const topicMastery = masteryData.find(item => item.topic === topicName);
    if (topicMastery) {
      debugInfo += `CURRENT MASTERY:\n`;
      debugInfo += `  Mastery: ${topicMastery.mastery}%\n`;
      debugInfo += `  Badge: ${topicMastery.badge || 'None'}\n`;
      debugInfo += `  Description: ${topicMastery.description}\n\n`;
    } else {
      debugInfo += `MASTERY DATA: NOT FOUND!\n\n`;
    }
    
    // Test generating fresh mastery for this topic
    debugInfo += `FRESH MASTERY GENERATION TEST:\n`;
    
    // Temporarily clear all data
    const originalWeak = sessionStorage.getItem('weakTopics');
    const originalModule = sessionStorage.getItem('moduleProgress');
    const originalPractice = sessionStorage.getItem('practiceAttempts');
    
    sessionStorage.setItem('weakTopics', '[]');
    sessionStorage.setItem('moduleProgress', '{}');
    sessionStorage.setItem('practiceAttempts', '{}');
    
    const testUserData = { username: 'TestUser', level: userLevel };
    const testMasteryData = generateMasteryData(testUserData);
    const testTopicMastery = testMasteryData.find(item => item.topic === topicName);
    
    if (testTopicMastery) {
      debugInfo += `  Fresh Generation: ${testTopicMastery.mastery}% (should be 0%)\n`;
      debugInfo += `  Status: ${testTopicMastery.mastery === 0 ? 'âœ… CORRECT' : 'âŒ PROBLEM!'}\n`;
    }
    
    // Restore original data
    sessionStorage.setItem('weakTopics', originalWeak);
    sessionStorage.setItem('moduleProgress', originalModule);
    sessionStorage.setItem('practiceAttempts', originalPractice);
    
    console.log(debugInfo);
    alert(debugInfo);
  };

  // Function to specifically reset Linear Approximation & Differentials topic
  window.resetLinearApproxTopic = function() {
    const topicName = 'Linear Approximation & Differentials';
    
    // Remove from weak topics
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const updatedWeakTopics = weakTopics.filter(topic => topic !== topicName);
    sessionStorage.setItem('weakTopics', JSON.stringify(updatedWeakTopics));
    
    // Clear module progress for this topic
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const levels = ['Novice', 'Intermediate', 'Advanced'];
    levels.forEach(level => {
      const moduleKey = `${topicName} - ${level}`;
      delete moduleProgress[moduleKey];
    });
    sessionStorage.setItem('moduleProgress', JSON.stringify(moduleProgress));
    
    // Clear practice attempts for this topic
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    delete practiceAttempts[topicName];
    sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
    
    // Regenerate mastery data
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    updateUI(userData.username, userData.level, moduleProgress, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Find the specific topic mastery
    const topicMastery = masteryData.find(item => item.topic === topicName);
    const masteryValue = topicMastery ? topicMastery.mastery : 'Unknown';
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”§</div>
      <div class="toast-content">
        <div class="toast-title">Linear Approximation Topic Reset</div>
        <div class="toast-message">Linear Approximation & Differentials reset to ${masteryValue}% mastery.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 4000);
    
    console.log(`${topicName} reset complete. New mastery:`, masteryValue + '%');
  };

  // Function to fix Linear Approximation mastery to 0%
  window.forceFixLinearApproxMastery = function() {
    const topicName = 'Linear Approximation & Differentials';
    
    // Get current mastery data
    const masteryData = JSON.parse(sessionStorage.getItem('masteryData') || '[]');
    const topicMastery = masteryData.find(item => item.topic === topicName);
    
    if (topicMastery) {
      topicMastery.mastery = 0;
      topicMastery.badge = null;
      
      // Update session storage
      sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
      
      // Update UI
      const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
      const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
      updateLearningAnalytics(masteryData, learningPath, achievements);
      
      // Show notification
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.innerHTML = `
        <div class="toast-icon">ðŸ”§</div>
        <div class="toast-content">
          <div class="toast-title">Linear Approximation Fixed</div>
          <div class="toast-message">Mastery reset to 0% successfully!</div>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 500);
      }, 3000);
      
      console.log('Linear Approximation mastery fixed to 0%');
    }
  };

  // Function to auto-refresh mastery data without notifications
  function autoRefreshMasteryData() {
    // Get current data
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    // Skip if no user data
    if (!userData.username || !userData.level) {
      console.log('Skipping auto-refresh - no user data');
      return;
    }
    
    // Regenerate mastery data
    const masteryData = generateMasteryData(userData);
    
    // Update session storage
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI quietly
    const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
    const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
    
    updateLearningAnalytics(masteryData, learningPath, achievements);
    
    console.log('Mastery data auto-refreshed successfully');
    
    // Save to Firebase if user is logged in (silently)
    const user = auth.currentUser;
    if (user) {
      saveUserData(user).then(() => {
        console.log("Auto-refreshed mastery data saved to Firebase");
      }).catch(error => {
        console.error("Error saving auto-refreshed mastery data:", error);
      });
    }
  }

  // Function to automatically enable correct answers only mode (silent)
  function autoEnableCorrectAnswersOnlyMode() {
    // Check if already enabled
    if (sessionStorage.getItem('correctAnswersOnlyMode') === 'true') {
      console.log('Correct answers only mode already enabled');
      return;
    }
    
    // Clear all existing mastery data silently
    const masteryData = [
      { topic: 'Introduction to derivatives', mastery: 0, badge: null, description: 'Understanding what derivatives represent and their basic applications' },
      { topic: 'The definition of Derivative', mastery: 0, badge: null, description: 'Formal limit definition and identifying non-differentiable points' },
      { topic: 'Rules of Differentiation', mastery: 0, badge: null, description: 'Power rule, product rule, quotient rule, and other differentiation techniques' },
      { topic: 'Equation of Tangent', mastery: 0, badge: null, description: 'Finding and interpreting tangent lines to curves' },
      { topic: 'Second Derivative', mastery: 0, badge: null, description: 'Measuring rates of change of rates of change and analyzing concavity' },
      { topic: 'Implicit Differentiations', mastery: 0, badge: null, description: 'Differentiating equations where y is not isolated' },
      { topic: 'Linear Approximation & Differentials', mastery: 0, badge: null, description: 'Using derivatives to approximate function values' }
    ];
    
    // Reset mastery data
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('correctAnswersOnlyMode', 'true');
    
    // Initialize correct answers if not exists
    if (!sessionStorage.getItem('correctAnswers')) {
      sessionStorage.setItem('correctAnswers', '{}');
    }
    
    console.log('Correct answers only mode auto-enabled - all mastery set to 0%');
  }

  // Function to test the correct answer system
  window.testCorrectAnswerSystem = function() {
    // Simulate a correct answer for Linear Approximation
    updateMasteryFromCorrectAnswer('Linear Approximation & Differentials', 1);
    
    console.log('Test: Added 1 correct answer for Linear Approximation & Differentials');
  };

  // Function to force reset to new user (0%)
  window.forceResetToNewUser = function() {
    // Clear all existing data that could affect mastery
    sessionStorage.removeItem('weakTopics');
    sessionStorage.removeItem('recommendations');
    sessionStorage.removeItem('moduleProgress');
    sessionStorage.removeItem('practiceAttempts');
    sessionStorage.removeItem('correctAnswers');
    sessionStorage.removeItem('masteryData');
    sessionStorage.removeItem('learningPath');
    sessionStorage.removeItem('achievements');
    
    // Set empty data
    sessionStorage.setItem('weakTopics', '[]');
    sessionStorage.setItem('recommendations', '[]');
    sessionStorage.setItem('moduleProgress', '{}');
    sessionStorage.setItem('practiceAttempts', '{}');
    sessionStorage.setItem('correctAnswers', '{}');
    
    // Keep user info but reset to beginner if needed
    const currentUsername = sessionStorage.getItem('username') || 'Guest';
    sessionStorage.setItem('level', 'Beginner');
    
    // Generate fresh mastery data (should be all 0%)
    const userData = {
      username: currentUsername,
      level: 'Beginner'
    };
    
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Update UI
    updateUI(currentUsername, 'Beginner', {}, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Debug: Show what mastery was generated
    console.log('=== FORCE RESET DEBUG ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">Reset to New User Complete</div>
        <div class="toast-message">All mastery reset to 0%. All topics should now show 0% mastery.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 5000);
    
    console.log('=== USER DATA RESET TO NEW USER STATE ===');
    console.log('All mastery should now be 0%');
  };

  // Function to clear all practice attempts
  window.clearAllPracticeAttempts = function() {
    // Clear all practice attempts
    sessionStorage.setItem('practiceAttempts', '{}');
    
    // Regenerate mastery data without practice attempts
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI with fresh data
    const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
    const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
    updateLearningAnalytics(masteryData, learningPath, achievements);
    updateUI(userData.username, userData.level, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
    
    // Debug output
    console.log('=== PRACTICE ATTEMPTS CLEARED ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ—‘ï¸</div>
      <div class="toast-content">
        <div class="toast-title">Practice Attempts Cleared</div>
        <div class="toast-message">All practice attempts cleared. Mastery regenerated from correct answers only.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 4000);
  };

  // Function to test the correct answer system
  window.testCorrectAnswerSystem = function() {
    // Simulate a correct answer for Linear Approximation
    updateMasteryFromCorrectAnswer('Linear Approximation & Differentials', 1);
    
    console.log('Test: Added 1 correct answer for Linear Approximation & Differentials');
  };

  // Function to force reset to new user (0%)
  window.forceResetToNewUser = function() {
    // Clear all existing data that could affect mastery
    sessionStorage.removeItem('weakTopics');
    sessionStorage.removeItem('recommendations');
    sessionStorage.removeItem('moduleProgress');
    sessionStorage.removeItem('practiceAttempts');
    sessionStorage.removeItem('correctAnswers');
    sessionStorage.removeItem('masteryData');
    sessionStorage.removeItem('learningPath');
    sessionStorage.removeItem('achievements');
    
    // Set empty data
    sessionStorage.setItem('weakTopics', '[]');
    sessionStorage.setItem('recommendations', '[]');
    sessionStorage.setItem('moduleProgress', '{}');
    sessionStorage.setItem('practiceAttempts', '{}');
    sessionStorage.setItem('correctAnswers', '{}');
    
    // Keep user info but reset to beginner if needed
    const currentUsername = sessionStorage.getItem('username') || 'Guest';
    sessionStorage.setItem('level', 'Beginner');
    
    // Generate fresh mastery data (should be all 0%)
    const userData = {
      username: currentUsername,
      level: 'Beginner'
    };
    
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Update UI
    updateUI(currentUsername, 'Beginner', {}, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Debug: Show what mastery was generated
    console.log('=== FORCE RESET DEBUG ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">Reset to New User Complete</div>
        <div class="toast-message">All mastery reset to 0%. All topics should now show 0% mastery.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 5000);
    
    console.log('=== USER DATA RESET TO NEW USER STATE ===');
    console.log('All mastery should now be 0%');
  };

  // Function to clear all practice attempts
  window.clearAllPracticeAttempts = function() {
    // Clear all practice attempts
    sessionStorage.setItem('practiceAttempts', '{}');
    
    // Regenerate mastery data without practice attempts
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI with fresh data
    const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
    const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
    updateLearningAnalytics(masteryData, learningPath, achievements);
    updateUI(userData.username, userData.level, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
    
    // Debug output
    console.log('=== PRACTICE ATTEMPTS CLEARED ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ—‘ï¸</div>
      <div class="toast-content">
        <div class="toast-title">Practice Attempts Cleared</div>
        <div class="toast-message">All practice attempts cleared. Mastery regenerated from correct answers only.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 4000);
  };

  // Function to test the correct answer system
  window.testCorrectAnswerSystem = function() {
    // Simulate a correct answer for Linear Approximation
    updateMasteryFromCorrectAnswer('Linear Approximation & Differentials', 1);
    
    console.log('Test: Added 1 correct answer for Linear Approximation & Differentials');
  };

  // Function to force reset to new user (0%)
  window.forceResetToNewUser = function() {
    // Clear all existing data that could affect mastery
    sessionStorage.removeItem('weakTopics');
    sessionStorage.removeItem('recommendations');
    sessionStorage.removeItem('moduleProgress');
    sessionStorage.removeItem('practiceAttempts');
    sessionStorage.removeItem('correctAnswers');
    sessionStorage.removeItem('masteryData');
    sessionStorage.removeItem('learningPath');
    sessionStorage.removeItem('achievements');
    
    // Set empty data
    sessionStorage.setItem('weakTopics', '[]');
    sessionStorage.setItem('recommendations', '[]');
    sessionStorage.setItem('moduleProgress', '{}');
    sessionStorage.setItem('practiceAttempts', '{}');
    sessionStorage.setItem('correctAnswers', '{}');
    
    // Keep user info but reset to beginner if needed
    const currentUsername = sessionStorage.getItem('username') || 'Guest';
    sessionStorage.setItem('level', 'Beginner');
    
    // Generate fresh mastery data (should be all 0%)
    const userData = {
      username: currentUsername,
      level: 'Beginner'
    };
    
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Update UI
    updateUI(currentUsername, 'Beginner', {}, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Debug: Show what mastery was generated
    console.log('=== FORCE RESET DEBUG ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">Reset to New User Complete</div>
        <div class="toast-message">All mastery reset to 0%. All topics should now show 0% mastery.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 5000);
    
    console.log('=== USER DATA RESET TO NEW USER STATE ===');
    console.log('All mastery should now be 0%');
  };

  // Function to clear all practice attempts
  window.clearAllPracticeAttempts = function() {
    // Clear all practice attempts
    sessionStorage.setItem('practiceAttempts', '{}');
    
    // Regenerate mastery data without practice attempts
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI with fresh data
    const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
    const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
    updateLearningAnalytics(masteryData, learningPath, achievements);
    updateUI(userData.username, userData.level, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
    
    // Debug output
    console.log('=== PRACTICE ATTEMPTS CLEARED ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ—‘ï¸</div>
      <div class="toast-content">
        <div class="toast-title">Practice Attempts Cleared</div>
        <div class="toast-message">All practice attempts cleared. Mastery regenerated from correct answers only.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 4000);
  };

  // Function to test the correct answer system
  window.testCorrectAnswerSystem = function() {
    // Simulate a correct answer for Linear Approximation
    updateMasteryFromCorrectAnswer('Linear Approximation & Differentials', 1);
    
    console.log('Test: Added 1 correct answer for Linear Approximation & Differentials');
  };

  // Function to force reset to new user (0%)
  window.forceResetToNewUser = function() {
    // Clear all existing data that could affect mastery
    sessionStorage.removeItem('weakTopics');
    sessionStorage.removeItem('recommendations');
    sessionStorage.removeItem('moduleProgress');
    sessionStorage.removeItem('practiceAttempts');
    sessionStorage.removeItem('correctAnswers');
    sessionStorage.removeItem('masteryData');
    sessionStorage.removeItem('learningPath');
    sessionStorage.removeItem('achievements');
    
    // Set empty data
    sessionStorage.setItem('weakTopics', '[]');
    sessionStorage.setItem('recommendations', '[]');
    sessionStorage.setItem('moduleProgress', '{}');
    sessionStorage.setItem('practiceAttempts', '{}');
    sessionStorage.setItem('correctAnswers', '{}');
    
    // Keep user info but reset to beginner if needed
    const currentUsername = sessionStorage.getItem('username') || 'Guest';
    sessionStorage.setItem('level', 'Beginner');
    
    // Generate fresh mastery data (should be all 0%)
    const userData = {
      username: currentUsername,
      level: 'Beginner'
    };
    
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Update UI
    updateUI(currentUsername, 'Beginner', {}, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Debug: Show what mastery was generated
    console.log('=== FORCE RESET DEBUG ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">Reset to New User Complete</div>
        <div class="toast-message">All mastery reset to 0%. All topics should now show 0% mastery.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 5000);
    
    console.log('=== USER DATA RESET TO NEW USER STATE ===');
    console.log('All mastery should now be 0%');
  };

  // Function to clear all practice attempts
  window.clearAllPracticeAttempts = function() {
    // Clear all practice attempts
    sessionStorage.setItem('practiceAttempts', '{}');
    
    // Regenerate mastery data without practice attempts
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI with fresh data
    const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
    const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
    updateLearningAnalytics(masteryData, learningPath, achievements);
    updateUI(userData.username, userData.level, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
    
    // Debug output
    console.log('=== PRACTICE ATTEMPTS CLEARED ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ—‘ï¸</div>
      <div class="toast-content">
        <div class="toast-title">Practice Attempts Cleared</div>
        <div class="toast-message">All practice attempts cleared. Mastery regenerated from correct answers only.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 4000);
  };

  // Function to test the correct answer system
  window.testCorrectAnswerSystem = function() {
    // Simulate a correct answer for Linear Approximation
    updateMasteryFromCorrectAnswer('Linear Approximation & Differentials', 1);
    
    console.log('Test: Added 1 correct answer for Linear Approximation & Differentials');
  };

  // Function to force reset to new user (0%)
  window.forceResetToNewUser = function() {
    // Clear all existing data that could affect mastery
    sessionStorage.removeItem('weakTopics');
    sessionStorage.removeItem('recommendations');
    sessionStorage.removeItem('moduleProgress');
    sessionStorage.removeItem('practiceAttempts');
    sessionStorage.removeItem('correctAnswers');
    sessionStorage.removeItem('masteryData');
    sessionStorage.removeItem('learningPath');
    sessionStorage.removeItem('achievements');
    
    // Set empty data
    sessionStorage.setItem('weakTopics', '[]');
    sessionStorage.setItem('recommendations', '[]');
    sessionStorage.setItem('moduleProgress', '{}');
    sessionStorage.setItem('practiceAttempts', '{}');
    sessionStorage.setItem('correctAnswers', '{}');
    
    // Keep user info but reset to beginner if needed
    const currentUsername = sessionStorage.getItem('username') || 'Guest';
    sessionStorage.setItem('level', 'Beginner');
    
    // Generate fresh mastery data (should be all 0%)
    const userData = {
      username: currentUsername,
      level: 'Beginner'
    };
    
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Update UI
    updateUI(currentUsername, 'Beginner', {}, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Debug: Show what mastery was generated
    console.log('=== FORCE RESET DEBUG ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">Reset to New User Complete</div>
        <div class="toast-message">All mastery reset to 0%. All topics should now show 0% mastery.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 5000);
    
    console.log('=== USER DATA RESET TO NEW USER STATE ===');
    console.log('All mastery should now be 0%');
  };

  // Function to clear all practice attempts
  window.clearAllPracticeAttempts = function() {
    // Clear all practice attempts
    sessionStorage.setItem('practiceAttempts', '{}');
    
    // Regenerate mastery data without practice attempts
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI with fresh data
    const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
    const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
    updateLearningAnalytics(masteryData, learningPath, achievements);
    updateUI(userData.username, userData.level, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
    
    // Debug output
    console.log('=== PRACTICE ATTEMPTS CLEARED ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ—‘ï¸</div>
      <div class="toast-content">
        <div class="toast-title">Practice Attempts Cleared</div>
        <div class="toast-message">All practice attempts cleared. Mastery regenerated from correct answers only.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 4000);
  };

  // Function to test the correct answer system
  window.testCorrectAnswerSystem = function() {
    // Simulate a correct answer for Linear Approximation
    updateMasteryFromCorrectAnswer('Linear Approximation & Differentials', 1);
    
    console.log('Test: Added 1 correct answer for Linear Approximation & Differentials');
  };

  // Function to force reset to new user (0%)
  window.forceResetToNewUser = function() {
    // Clear all existing data that could affect mastery
    sessionStorage.removeItem('weakTopics');
    sessionStorage.removeItem('recommendations');
    sessionStorage.removeItem('moduleProgress');
    sessionStorage.removeItem('practiceAttempts');
    sessionStorage.removeItem('correctAnswers');
    sessionStorage.removeItem('masteryData');
    sessionStorage.removeItem('learningPath');
    sessionStorage.removeItem('achievements');
    
    // Set empty data
    sessionStorage.setItem('weakTopics', '[]');
    sessionStorage.setItem('recommendations', '[]');
    sessionStorage.setItem('moduleProgress', '{}');
    sessionStorage.setItem('practiceAttempts', '{}');
    sessionStorage.setItem('correctAnswers', '{}');
    
    // Keep user info but reset to beginner if needed
    const currentUsername = sessionStorage.getItem('username') || 'Guest';
    sessionStorage.setItem('level', 'Beginner');
    
    // Generate fresh mastery data (should be all 0%)
    const userData = {
      username: currentUsername,
      level: 'Beginner'
    };
    
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Update UI
    updateUI(currentUsername, 'Beginner', {}, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Debug: Show what mastery was generated
    console.log('=== FORCE RESET DEBUG ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">ðŸ”„</div>
      <div class="toast-content">
        <div class="toast-title">Reset to New User Complete</div>
        <div class="toast-message">All mastery reset to 0%. All topics should now show 0% mastery.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 5000);
    
    console.log('=== USER DATA RESET TO NEW USER STATE ===');
    console.log('All mastery should now be 0%');
  };

  // Demo function to test correct answer recording
  window.testCorrectAnswerDemo = function() {
    // Test with a specific topic
    const testTopic = 'Linear Approximation & Differentials';
    
    // Record a correct answer
    const newMastery = updateMasteryFromCorrectAnswer(testTopic, 1);
    
    console.log(`Demo: Recorded correct answer for "${testTopic}". New mastery: ${newMastery}%`);
  };
</script>
</body>
</html>







