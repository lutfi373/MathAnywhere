<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Profile</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@500;600;700&family=Open+Sans&display=swap" rel="stylesheet">
  <link href="css/bootstrap.min.css" rel="stylesheet">
  <link href="css/bootstrap-icons.css" rel="stylesheet">
  <link href="css/templatemo-topic-listing.css" rel="stylesheet">

  <style>
    :root {
      --input-focus: #2d8cf0;
      --font-color: #323232;
      --font-color-sub: #666;
      --bg-color: #f7f9fc;
      --main-color: black;
      --accent-color: #ff6b6b;
      --secondary-color: #feca57;
      --tertiary-color: #1dd1a1;
      --light-blue: #54a0ff;
      --pink: #ff9ff3;
      --purple: #5f27cd;
    }

    /* Loading Animation CSS */
    .loader {
      --ANIMATION-DELAY-MULTIPLIER: 70ms;
      padding: 0;
      margin: 0;
      display: flex;
      flex-direction: row;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }
    .loader span {
      padding: 0;
      margin: 0;
      letter-spacing: -5rem;
      animation-delay: 0s;
      transform: translateY(4rem);
      animation: hideAndSeek 1s alternate infinite cubic-bezier(0.86, 0, 0.07, 1);
    }
    .loader .l {
      animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 0);
    }
    .loader .o {
      animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 1);
    }
    .loader .a {
      animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 2);
    }
    .loader .d {
      animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 3);
    }
    .loader .ispan {
      animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 4);
    }
    .loader .n {
      animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 5);
    }
    .loader .g {
      animation-delay: calc(var(--ANIMATION-DELAY-MULTIPLIER) * 6);
    }
    .letter {
      width: fit-content;
      height: 3rem;
    }
    .i {
      margin-inline: 5px;
    }
    @keyframes hideAndSeek {
      0% {
        transform: translateY(4rem);
      }
      100% {
        transform: translateY(0rem);
      }
    }

    body {
      font-family: 'Fira Code', monospace;
      background-color: var(--bg-color);
      color: var(--font-color);
      margin: 0;
      padding: 0;
      line-height: 1.6;
      min-height: 100vh;
    }

    /* Navbar */
    .navbar {
      background-color: yellow;
      border-bottom: 2px solid var(--main-color);
      box-shadow: 4px 4px var(--main-color);
      margin-bottom: 10px;
    }

    .navbar-brand {
      color: var(--accent-color);
      font-weight: 700;
      font-size: 1.5rem;
      transition: transform 0.3s ease;
    }
    
    .navbar-brand:hover {
      transform: scale(1.05);
    }

    .navbar-nav .nav-link {
      color: var(--font-color);
      font-weight: 600;
      border-radius: 5px;
      padding: 8px 15px;
      margin: 0 5px;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .navbar-nav .nav-link:hover {
      color: var(--input-focus);
      border: 2px solid var(--input-focus);
      box-shadow: 3px 3px var(--main-color);
      transform: translateY(-2px);
    }

    /* Profile Section Styling */
    .profile-section {
      background: white;
      padding: 60px 0;
      border-bottom: 2px solid var(--main-color);
      box-shadow: 0 4px 0 var(--main-color);
      margin-bottom: 35px;
      text-align: center;
    }

    .profile-container {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      box-shadow: 4px 4px var(--main-color);
      padding: 30px;
      margin: 20px auto;
      max-width: 800px;
      transition: all 0.3s ease;
    }

    .profile-container:hover {
      transform: translateY(-5px);
      box-shadow: 6px 6px var(--main-color);
    }

    .profile-header {
      display: flex;
      align-items: center;
      gap: 30px;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 2px solid var(--main-color);
    }

    .profile-avatar {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background-color: var(--accent-color);
      color: white;
      font-size: 60px;
      border: 3px solid var(--main-color);
      box-shadow: 4px 4px var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
    }

    .profile-avatar:hover {
      transform: rotate(5deg);
      box-shadow: 6px 6px var(--main-color);
    }

    .profile-info {
      flex-grow: 1;
      text-align: left;
    }

    .profile-info h2 {
      font-weight: 700;
      color: var(--font-color);
      margin-bottom: 10px;
      position: relative;
      display: inline-block;
    }
    
    .profile-info h2:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--accent-color);
      transition: width 0.3s ease;
    }
    
    .profile-info h2:hover:after {
      width: 100%;
    }

    .profile-info p {
      margin: 5px 0;
      font-weight: 600;
      color: var(--font-color-sub);
    }

    #level {
      display: inline-block;
      background-color: var(--secondary-color);
      color: var(--font-color);
      font-weight: 700;
      padding: 5px 15px;
      border-radius: 20px;
      border: 2px solid var(--main-color);
      box-shadow: 3px 3px var(--main-color);
      transition: all 0.3s ease;
    }

    #level:hover {
      transform: translateY(-3px);
      box-shadow: 5px 5px var(--main-color);
    }
    
    .section-title {
      margin: 40px 0 20px 0;
      position: relative;
    }
    
    .section-title h3 {
      color: var(--font-color);
      font-weight: 700;
      font-size: 1.5rem;
      display: inline-block;
      position: relative;
      margin-bottom: 0;
      padding-bottom: 8px;
    }
    
    .section-title h3:after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--tertiary-color);
      transition: width 0.3s ease;
    }
    
    .section-title h3:hover:after {
      width: 100%;
    }

    .progress-container {
      margin: 25px 0;
      background-color: white;
      padding: 20px;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .progress-container:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .progress-label {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      font-weight: 600;
    }

    .module-title {
      font-weight: 700;
      color: var(--font-color);
    }

    .progress {
      height: 20px;
      background-color: var(--bg-color);
      border-radius: 10px;
      border: 2px solid var(--main-color);
      overflow: hidden;
      box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.1);
      margin-bottom: 5px;
    }

    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--light-blue));
      border-radius: 8px;
      transition: width 1s ease;
    }
    
    .empty-state {
      text-align: center;
      padding: 20px;
      color: var(--font-color-sub);
      font-style: italic;
      background-color: var(--bg-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      margin: 20px 0;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }
    
    .empty-state:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .topic-suggestions {
      margin: 25px 0;
    }

    .topic-suggestion-item {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: visible;
    }

    .topic-suggestion-item:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .topic-suggestion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .topic-suggestion-title {
      font-weight: 700;
      color: var(--font-color);
      font-size: 1.1rem;
    }

    .topic-suggestion-difficulty {
      background-color: var(--secondary-color);
      color: var(--font-color);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: help;
      transition: all 0.3s ease;
      position: relative;
    }

    .topic-suggestion-difficulty:hover {
      background-color: var(--tertiary-color);
      color: white;
      transform: scale(1.05);
    }

    .topic-suggestion-difficulty[title]:hover::after {
      content: attr(title);
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      background-color: var(--main-color);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 12px;
      white-space: nowrap;
      z-index: 1000;
      margin-top: 5px;
    }

    .topic-suggestion-difficulty.novice-rec {
      background-color: var(--tertiary-color);
      color: white;
    }

    .topic-suggestion-difficulty.intermediate-rec {
      background-color: var(--secondary-color);
      color: var(--font-color);
    }

    .topic-suggestion-difficulty.advanced-rec {
      background-color: var(--accent-color);
      color: white;
    }

    .topic-suggestion-difficulty.novice-rec:hover {
      background-color: #17a2b8;
    }

    .topic-suggestion-difficulty.intermediate-rec:hover {
      background-color: #e0a800;
    }

    .topic-suggestion-difficulty.advanced-rec:hover {
      background-color: #dc3545;
    }

    .topic-suggestion-content {
      color: var(--font-color-sub);
      margin-bottom: 15px;
    }

    .topic-suggestion-actions {
      display: flex;
      gap: 10px;
      position: relative;
      z-index: 1;
    }

    .topic-suggestion-btn {
      background-color: var(--accent-color);
      color: white;
      border: none;
      border-radius: 5px;
      padding: 8px 15px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .topic-suggestion-btn:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
    }

    .button-container {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      flex-wrap: wrap;
    }

    .button {
      background-color: white;
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 12px 25px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      z-index: 1;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .button:before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: var(--accent-color);
      transition: all 0.4s ease;
      z-index: -1;
    }

    .button:hover:before {
      left: 0;
    }

    .button:hover {
      color: white;
      transform: translateY(-5px);
      box-shadow: 6px 6px var(--main-color);
    }

    .button:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px var(--main-color);
    }

    .button.primary {
      background-color: var(--accent-color);
      color: white;
    }

    .button.primary:before {
      background: var(--light-blue);
    }

    /* Footer */
    footer {
      background-color: white;
      color: var(--font-color);
      text-align: center;
      padding: 40px 0;
      border-top: 2px solid var(--main-color);
      margin-top: 40px;
    }

    footer .navbar-brand {
      color: var(--accent-color);
      font-weight: 700;
      transition: all 0.3s ease;
    }
    
    footer .navbar-brand:hover {
      transform: scale(1.1);
    }

    footer a {
      color: var(--input-focus);
      text-decoration: none;
      transition: all 0.3s ease;
    }

    footer a:hover {
      color: var(--accent-color);
      text-decoration: underline;
    }

    .site-footer-title {
      color: var(--font-color);
      font-weight: 700;
      margin-bottom: 15px;
      position: relative;
      display: inline-block;
    }
    
    .site-footer-title:after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 50%;
      height: 3px;
      background-color: var(--secondary-color);
      transition: width 0.3s ease;
    }
    
    .site-footer-title:hover:after {
      width: 100%;
    }

    @media (max-width: 768px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
        gap: 15px;
      }

      .profile-info {
        text-align: center;
      }
      
      .profile-info h2:after {
        left: 25%;
        width: 50%;
      }
      
      .profile-info h2:hover:after {
        width: 80%;
        left: 10%;
      }
      
      .section-title h3 {
        text-align: center;
        display: block;
      }
      
      .section-title h3:after {
        left: 25%;
        width: 50%;
      }
      
      .section-title h3:hover:after {
        width: 50%;
      }

      .button-container {
        flex-direction: column;
      }
    }

    /* Learning Mastery styles */
    .mastery-container {
      margin: 25px 0;
    }

    .mastery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .mastery-section-title {
      font-weight: 700;
      color: var(--font-color);
      margin: 0;
    }

    .refresh-btn {
      background-color: var(--bg-color);
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 5px 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .refresh-btn i {
      font-size: 16px;
    }

    .refresh-btn:hover {
      background-color: var(--light-blue);
      color: white;
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }
    
    .mastery-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .mastery-item {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .mastery-item:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .mastery-title {
      font-weight: 700;
      color: var(--font-color);
      margin-bottom: 10px;
    }





    .mastery-description {
      font-size: 12px;
      color: var(--font-color-sub);
      margin-bottom: 8px;
      line-height: 1.3;
      height: 32px;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
    }

    .topic-practice-btn {
      background-color: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 4px 10px;
      margin-top: 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
    }

    .topic-practice-btn:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }

    .practice-analytics {
      background-color: var(--bg-color);
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 8px;
      margin: 8px 0;
      font-size: 11px;
    }

    .analytics-stat {
      display: flex;
      justify-content: space-between;
      margin-bottom: 3px;
    }

    .analytics-stat:last-child {
      margin-bottom: 0;
    }

    .stat-label {
      color: var(--font-color-sub);
      font-weight: 500;
    }

    .stat-value {
      color: var(--font-color);
      font-weight: 600;
    }

    .mastery-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    .mastery-buttons {
      display: flex;
      gap: 8px;
    }

    .reset-btn {
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .refresh-data-btn {
      background-color: var(--tertiary-color);
    }

    .debug-btn {
      background-color: var(--purple);
    }

    .test-btn {
      background-color: var(--secondary-color);
      color: var(--main-color);
    }

    .reset-btn {
      background-color: var(--accent-color);
    }

    .direct-update-btn {
      background-color: var(--light-blue);
    }



    .reset-btn:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }

    .reset-btn:active {
      transform: translateY(1px);
      box-shadow: 1px 1px var(--main-color);
    }

    .mastery-badge {
      position: absolute;
      top: -10px;
      right: -10px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background-color: var(--secondary-color);
      border: 2px solid var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 2px 2px var(--main-color);
      transform: rotate(15deg);
    }

    /* Learning Path styles */
    .learning-path-container {
      margin: 25px 0;
    }

    .learning-path {
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 20px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .learning-path:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .path-steps {
      position: relative;
      padding-left: 30px;
    }

    .path-steps:before {
      content: '';
      position: absolute;
      top: 0;
      left: 15px;
      height: 100%;
      width: 2px;
      background-color: var(--accent-color);
    }

    .path-step {
      position: relative;
      margin-bottom: 30px;
    }

    .path-step:last-child {
      margin-bottom: 0;
    }

    .path-step:before {
      content: '';
      position: absolute;
      top: 5px;
      left: -30px;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background-color: white;
      border: 2px solid var(--accent-color);
      z-index: 1;
    }

    .path-step.completed:before {
      background-color: var(--tertiary-color);
      border-color: var(--main-color);
    }

    .path-step.current:before {
      background-color: var(--secondary-color);
      border-color: var(--main-color);
      animation: pulse 1.5s infinite;
    }

    .path-step-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .path-step-title {
      font-weight: 700;
      color: var(--font-color);
    }

    .path-step-status {
      font-size: 14px;
      font-weight: 600;
    }

    .path-step-content {
      color: var(--font-color-sub);
      margin-bottom: 10px;
    }

    .path-step-action {
      display: inline-block;
      background-color: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 5px;
      padding: 5px 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 2px 2px var(--main-color);
      font-size: 14px;
    }

    .path-step-action:hover {
      background-color: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 3px 3px var(--main-color);
    }

    /* Learning Path Progress and Completion Styles */
    .completion-tick {
      color: var(--tertiary-color);
      font-weight: 700;
      font-size: 20px;
      margin-left: 12px;
      animation: checkmark-appear 0.5s ease-in-out, checkmark-glow 2s infinite;
      text-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
      filter: drop-shadow(2px 2px 4px rgba(40, 167, 69, 0.3));
    }

    @keyframes checkmark-appear {
      0% {
        opacity: 0;
        transform: scale(0);
      }
      50% {
        opacity: 1;
        transform: scale(1.3);
      }
      100% {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes checkmark-glow {
      0%, 100% {
        text-shadow: 0 0 10px rgba(40, 167, 69, 0.5);
      }
      50% {
        text-shadow: 0 0 20px rgba(40, 167, 69, 0.8), 0 0 30px rgba(40, 167, 69, 0.6);
      }
    }

    .path-step-progress {
      margin: 10px 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .path-progress-bar-container {
      flex: 1;
      height: 12px;
      background-color: var(--bg-color);
      border-radius: 6px;
      border: 1px solid var(--main-color);
      overflow: hidden;
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .path-progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--tertiary-color), var(--light-blue));
      border-radius: 6px;
      transition: width 0.5s ease;
      position: relative;
    }

    .path-progress-bar::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      bottom: 0;
      right: 0;
      background-image: linear-gradient(
        -45deg,
        rgba(255, 255, 255, 0.2) 25%,
        transparent 25%,
        transparent 50%,
        rgba(255, 255, 255, 0.2) 50%,
        rgba(255, 255, 255, 0.2) 75%,
        transparent 75%,
        transparent
      );
      background-size: 30px 30px;
      animation: progress-animation 2s linear infinite;
    }

    @keyframes progress-animation {
      0% {
        background-position: 0 0;
      }
      100% {
        background-position: 30px 30px;
      }
    }

    .path-progress-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--font-color);
      min-width: 35px;
      text-align: right;
    }

    /* Enhanced completed step styling */
    .path-step.completed {
      background: linear-gradient(135deg, #e8f5e8, #d4f0d4);
      border: 3px solid var(--tertiary-color);
      position: relative;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2), 0 0 20px rgba(40, 167, 69, 0.1);
      animation: completedGlow 3s infinite;
    }

    .path-step.completed::after {
      content: '✅ COMPLETED';
      position: absolute;
      top: -12px;
      right: 15px;
      background: var(--tertiary-color);
      color: white;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.5px;
      box-shadow: 2px 2px 8px rgba(40, 167, 69, 0.3);
      animation: completedBadgeGlow 2s infinite;
    }

    @keyframes completedGlow {
      0%, 100% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2), 0 0 20px rgba(40, 167, 69, 0.1);
      }
      50% {
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3), 0 0 30px rgba(40, 167, 69, 0.2);
      }
    }

    @keyframes completedBadgeGlow {
      0%, 100% {
        box-shadow: 2px 2px 8px rgba(40, 167, 69, 0.3);
      }
      50% {
        box-shadow: 2px 2px 12px rgba(40, 167, 69, 0.5), 0 0 15px rgba(40, 167, 69, 0.4);
      }
    }

    .path-step.completed:before {
      background-color: var(--tertiary-color);
      border-color: var(--tertiary-color);
      box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
      animation: completedDotPulse 2s infinite;
    }

    @keyframes completedDotPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
      }
      50% {
        transform: scale(1.2);
        box-shadow: 0 0 25px rgba(40, 167, 69, 0.8);
      }
    }

    .path-step.completed .path-step-title {
      color: var(--tertiary-color);
      font-weight: 700;
      text-shadow: 1px 1px 2px rgba(40, 167, 69, 0.1);
    }

    .path-step.completed .path-step-status {
      color: var(--tertiary-color);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .path-step.completed .path-progress-bar {
      background: linear-gradient(90deg, var(--tertiary-color), #20c997);
      animation: completedProgressGlow 2s infinite;
    }

    @keyframes completedProgressGlow {
      0%, 100% {
        box-shadow: 0 0 10px rgba(40, 167, 69, 0.3);
      }
      50% {
        box-shadow: 0 0 20px rgba(40, 167, 69, 0.6);
      }
    }

    .path-step.completed .path-step-action {
      background: var(--tertiary-color);
      color: white;
      border: 2px solid var(--tertiary-color);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
      position: relative;
      overflow: hidden;
    }

    .path-step.completed .path-step-action::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .path-step.completed .path-step-action:hover::before {
      left: 100%;
    }

    .path-step.completed .path-step-action:hover {
      background: #20c997;
      border-color: #20c997;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(40, 167, 69, 0.3);
    }

    /* Priority path step styling for weak topics */
    .path-step.priority-step {
      border-left: 4px solid var(--accent-color);
      background: linear-gradient(135deg, #fff5f5, #ffebee);
      position: relative;
      padding-left: 35px;
    }

    .path-step.priority-step::before {
      background-color: var(--accent-color);
      border-color: var(--accent-color);
      animation: pulse 1.5s infinite, priority-glow 2s infinite;
    }

    .path-step.priority-step .path-step-title {
      color: var(--accent-color);
      font-weight: 700;
    }

    .path-step.priority-step .path-step-status {
      color: var(--accent-color);
      font-weight: 700;
    }

    @keyframes priority-glow {
      0%, 100% {
        box-shadow: 0 0 5px var(--accent-color);
      }
      50% {
        box-shadow: 0 0 15px var(--accent-color), 0 0 25px var(--accent-color);
      }
    }

    /* Achievements styles */
    .achievements-container {
      margin: 25px 0;
    }

    .achievements-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
    }

    .achievement {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      transition: all 0.3s ease;
    }

    .achievement:hover {
      transform: translateY(-3px);
      box-shadow: 6px 6px var(--main-color);
    }

    .achievement.locked {
      filter: grayscale(1);
      opacity: 0.7;
    }

    .achievement-icon {
      width: 50px;
      height: 50px;
      background-color: var(--bg-color);
      border-radius: 50%;
      border: 2px solid var(--main-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 10px;
      font-size: 24px;
    }

    .achievement-title {
      font-weight: 700;
      color: var(--font-color);
      font-size: 14px;
      margin-bottom: 5px;
    }

    .achievement-description {
      font-size: 12px;
      color: var(--font-color-sub);
    }

    /* Toast Notification */
    .toast-notification {
      position: fixed;
      bottom: 30px;
      right: 30px;
      display: flex;
      align-items: center;
      background-color: white;
      color: var(--font-color);
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.5s ease;
    }

    .toast-notification.show {
      transform: translateY(0);
      opacity: 1;
    }

    .toast-icon {
      font-size: 24px;
      margin-right: 15px;
      animation: pulse 1.5s infinite;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 700;
      margin-bottom: 5px;
      color: var(--accent-color);
    }

    .toast-message {
      font-size: 14px;
      color: var(--font-color-sub);
    }

    /* Module Dropdown Styles */
    .module-dropdown {
      position: relative;
      display: inline-block;
      z-index: 9998;
      isolation: isolate;
    }

    .dropdown-toggle {
      position: relative;
      z-index: 9998;
    }

    .module-options {
      position: absolute;
      bottom: 100%;
      left: 0;
      right: 0;
      background-color: white;
      border: 2px solid var(--main-color);
      border-radius: 8px;
      box-shadow: 4px 4px var(--main-color);
      z-index: 10001;
      display: none;
      min-width: 280px;
      max-height: 400px;
      overflow-y: auto;
      margin-bottom: 5px;
    }

    .module-options.show {
      display: block;
      animation: dropdownSlideIn 0.2s ease-out;
    }

    @keyframes dropdownSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
        max-height: 0;
      }
      to {
        opacity: 1;
        transform: translateY(0);
        max-height: 400px;
      }
    }

    /* Ensure dropdowns don't interfere with each other */
    .topic-suggestion-item {
      contain: layout style;
    }

    .module-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 15px;
      text-decoration: none;
      color: var(--font-color);
      border-bottom: 1px solid var(--bg-color);
      transition: all 0.3s ease;
      position: relative;
    }

    .module-option:last-child {
      border-bottom: none;
    }

    .module-option:hover {
      background-color: var(--bg-color);
      color: var(--font-color);
      text-decoration: none;
    }

    .module-option-content {
      display: flex;
      align-items: center;
      gap: 12px;
      width: 100%;
    }

    .level-badge {
      min-width: 60px;
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 700;
      text-align: center;
      text-transform: uppercase;
      border: 1px solid var(--main-color);
    }

    .level-badge.novice {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
    }

    .level-badge.intermediate {
      background: linear-gradient(135deg, #ffc107, #fd7e14);
      color: white;
    }

    .level-badge.advanced {
      background: linear-gradient(135deg, #dc3545, #fd7e14);
      color: white;
    }

    .module-option-text {
      flex: 1;
    }

    .module-option-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 2px;
    }

    .module-option-desc {
      font-size: 12px;
      color: var(--font-color-sub);
      line-height: 1.3;
    }

    .module-option.suggested {
      background: linear-gradient(135deg, #e8f5e8, #f0fff0);
      border-left: 4px solid var(--tertiary-color);
      border: 2px solid var(--tertiary-color);
      box-shadow: 0 2px 8px rgba(29, 209, 161, 0.3);
      order: -1; /* Ensure suggested items appear first */
    }

    .module-option.suggested::after {
      content: "⭐ Priority";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background: linear-gradient(135deg, var(--tertiary-color), var(--light-blue));
      color: white;
      padding: 3px 8px;
      border-radius: 12px;
      font-weight: 700;
      animation: priorityPulse 2s infinite;
    }

    @keyframes priorityPulse {
      0%, 100% {
        transform: scale(1);
        box-shadow: 0 0 5px rgba(29, 209, 161, 0.5);
      }
      50% {
        transform: scale(1.05);
        box-shadow: 0 0 15px rgba(29, 209, 161, 0.8);
      }
    }

    .module-option.completed {
      background: linear-gradient(135deg, #d4edda, #c3e6cb, #b8dacc);
      color: #155724;
      border: 2px solid #28a745;
      box-shadow: 0 2px 8px rgba(40, 167, 69, 0.2);
    }

    .module-option.completed::after {
      content: "✓ Completed";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: var(--tertiary-color);
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    /* Enhanced completion indicator styles with glitter effects */
    .completion-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 8px 12px;
      background: linear-gradient(135deg, #28a745, #20c997, #17a2b8, #28a745);
      background-size: 400% 400%;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: glitterPulse 2s infinite, glitterShine 3s infinite;
      border: 2px solid transparent;
      background-clip: padding-box;
      position: relative;
    }

    .completion-indicator::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #00ff00, #00ffff, #ff00ff, #ffd700);
      background-size: 600% 600%;
      border-radius: 10px;
      z-index: -1;
      animation: glitterBorder 2s linear infinite;
    }

    @keyframes glitterBorder {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    @keyframes glitterPulse {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 10px rgba(255, 215, 0, 0.5);
        transform: scale(1);
      }
      50% {
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3), 0 0 20px rgba(255, 215, 0, 0.8);
        transform: scale(1.05);
      }
    }

    @keyframes glitterShine {
      0% {
        background-position: 0% 50%;
      }
      100% {
        background-position: 400% 50%;
      }
    }

    .completion-checkmark {
      font-size: 20px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 215, 0, 0.5);
      margin-bottom: 2px;
      animation: checkmarkGlow 2s infinite;
    }

    @keyframes checkmarkGlow {
      0%, 100% {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 10px rgba(255, 215, 0, 0.5);
      }
      50% {
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 20px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 255, 255, 0.5);
      }
    }

    .completion-text {
      font-size: 10px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3), 0 0 5px rgba(255, 215, 0, 0.3);
    }

    /* Enhanced module option completed styling with glitter border */
    .module-option.completed {
      background: linear-gradient(135deg, #d4edda, #c3e6cb, #b8dacc);
      border: 3px solid #28a745;
      background-clip: padding-box;
      position: relative;
      overflow: visible;
      animation: completedModuleGlow 3s infinite;
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2), inset 0 1px 3px rgba(255, 255, 255, 0.3);
    }

    .module-option.completed::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #28a745, #20c997, #17a2b8, #ffd700);
      background-size: 600% 600%;
      border-radius: 10px;
      z-index: -1;
      animation: glitterBorder 2s linear infinite;
    }

    @keyframes completedModuleGlow {
      0%, 100% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.2), inset 0 1px 3px rgba(255, 255, 255, 0.3);
      }
      50% {
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4), 0 0 25px rgba(40, 167, 69, 0.3), inset 0 1px 3px rgba(255, 255, 255, 0.4);
      }
    }

    .module-option.completed:hover {
      background: linear-gradient(135deg, #c3e6cb, #b8dacc, #a3d5a5);
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4), 0 0 30px rgba(40, 167, 69, 0.3);
      border-color: #20c997;
    }

    /* Enhanced topic completion badge with glitter */
    .topic-completion-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 6px 10px;
      background: linear-gradient(135deg, #28a745, #20c997, #17a2b8, #28a745);
      background-size: 400% 400%;
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: topicGlitterGlow 3s infinite, glitterShine 3s infinite;
      border: 2px solid transparent;
      background-clip: padding-box;
      position: relative;
    }

    .topic-completion-badge::before {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #00ff00, #00ffff, #ff00ff, #ffd700);
      background-size: 500% 500%;
      border-radius: 8px;
      z-index: -1;
      animation: glitterBorder 2.5s linear infinite;
    }

    @keyframes topicGlitterGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), 0 0 8px rgba(255, 215, 0, 0.3);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4), 0 0 20px rgba(255, 215, 0, 0.7);
      }
    }

    /* Enhanced progress bar animations */
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-color), var(--light-blue));
      border-radius: 8px;
      transition: width 2s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }

    .progress-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
      animation: progressShine 2s infinite;
    }

    @keyframes progressShine {
      0% {
        left: -100%;
      }
      100% {
        left: 100%;
      }
    }

    /* Enhanced difficulty level progress bars with animations */
    .novice-progress {
      background: linear-gradient(90deg, #28a745, #20c997, #17a2b8);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    .intermediate-progress {
      background: linear-gradient(90deg, #ffc107, #fd7e14, #ff6b6b);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    .advanced-progress {
      background: linear-gradient(90deg, #dc3545, #ff6b6b, #fd7e14);
      background-size: 200% 200%;
      animation: progressFlow 3s ease-in-out infinite;
    }

    @keyframes progressFlow {
      0%, 100% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
    }

    .module-option.locked {
      background-color: #f8f9fa;
      color: #adb5bd;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .module-option.locked::after {
      content: "🔒 Locked";
      position: absolute;
      right: 10px;
      font-size: 11px;
      background-color: #6c757d;
      color: white;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    .module-option.locked:hover {
      background-color: #f8f9fa;
      color: #adb5bd;
    }

    .module-option.locked .module-option-desc {
      color: #adb5bd;
    }

    .module-option-desc {
      font-size: 12px;
      color: var(--font-color-sub);
      line-height: 1.3;
    }

    .module-option-desc::after {
      content: "";
      display: block;
      margin-top: 2px;
    }

    .module-option.suggested .module-option-desc {
      color: #155724;
      font-weight: 500;
    }

    .module-option.completed .module-option-desc {
      color: #155724;
      font-style: italic;
      font-weight: 500;
    }

    /* Tooltip for additional information */
    .module-option:hover .module-option-desc {
      font-weight: 600;
    }

    .module-option.suggested:hover {
      background: linear-gradient(135deg, #d4edda, #e8f5e8);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(29, 209, 161, 0.4);
      border-color: var(--light-blue);
    }

    .module-option.completed:hover {
      background: linear-gradient(135deg, #c3e6cb, #b8dacc, #a3d5a5);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      border-color: #20c997;
    }

    .novice-progress {
      background: linear-gradient(90deg, #28a745, #20c997);
    }

    .intermediate-progress {
      background: linear-gradient(90deg, #ffc107, #fd7e14);
    }

    .advanced-progress {
      background: linear-gradient(90deg, #dc3545, #ff6b6b);
    }

    .progress-details {
      text-align: right;
      font-size: 12px;
      color: var(--font-color-sub);
    }

    /* Topic completion badge styles */
    .topic-completion-badge {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 6px 10px;
      background: linear-gradient(135deg, #28a745, #20c997);
      border-radius: 6px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      animation: topicCompletionGlow 3s infinite;
    }

    .topic-checkmark {
      font-size: 16px;
      color: white;
      font-weight: bold;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
      margin-bottom: 1px;
    }

    .topic-completion-count {
      font-size: 9px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.3px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
    }

    @keyframes topicCompletionGlow {
      0%, 100% {
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      50% {
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
      }
    }

    .topic-suggestion-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 15px;
    }

    .topic-suggestion-title {
      flex: 1;
      font-weight: 700;
      color: var(--font-color);
      font-size: 18px;
    }

    .topic-suggestion-difficulty {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      border: 1px solid var(--main-color);
    }

    .module-option.completed .level-badge {
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      border: 2px solid white;
      box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
    }

    .module-option.completed .module-option-title {
      color: #28a745;
      font-weight: 700;
      text-shadow: 0 0 5px rgba(40, 167, 69, 0.3);
    }

    /* Override the ::after pseudo-element for completed modules since we now have custom indicator */
    .module-option.completed::after {
      display: none;
    }

    /* IMPORTANT: Ensure completed modules are ALWAYS green, even if they're priority topics */
    .module-option.completed.priority-topic,
    .path-step.completed.priority-step,
    .topic-suggestion-item.completed.priority-topic {
      background: linear-gradient(135deg, #d4edda, #c3e6cb, #b8dacc) !important;
      border: 3px solid #28a745 !important;
      border-left: 3px solid #28a745 !important;
    }

    .module-option.completed.priority-topic .module-option-title,
    .path-step.completed.priority-step .path-step-title,
    .topic-suggestion-item.completed.priority-topic .topic-suggestion-title {
      color: #28a745 !important;
      font-weight: 700;
    }

    .module-option.completed.priority-topic .module-option-desc,
    .path-step.completed.priority-step .path-step-status {
      color: #155724 !important;
    }

    .module-option.completed.priority-topic::after,
    .topic-suggestion-item.completed.priority-topic::after {
      content: "✅ COMPLETED" !important;
      background: #28a745 !important;
      color: white !important;
    }

    /* Hover effects for completed priority topics */
    .module-option.completed.priority-topic:hover,
    .path-step.completed.priority-step:hover,
    .topic-suggestion-item.completed.priority-topic:hover {
      background: linear-gradient(135deg, #c3e6cb, #b8dacc, #a3d5a5) !important;
      border-color: #20c997 !important;
      border-left-color: #20c997 !important;
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4), 0 0 30px rgba(40, 167, 69, 0.3) !important;
    }

    /* CRITICAL FIX: Override red dots for completed priority items */
    .path-step.completed.priority-step::before,
    .module-option.completed.priority-topic::before,
    .topic-suggestion-item.completed.priority-topic::before {
      background-color: #28a745 !important;
      border-color: #28a745 !important;
      animation: completedDotPulse 2s infinite !important;
    }

    /* Green dot animation for completed items */
    @keyframes completedDotPulse {
      0%, 100% {
        box-shadow: 0 0 5px #28a745;
        background-color: #28a745;
      }
      50% {
        box-shadow: 0 0 15px #28a745, 0 0 25px rgba(40, 167, 69, 0.5);
        background-color: #20c997;
      }
    }

    /* Glitter effect for completed topic suggestion items */
    .topic-suggestion-item.has-completed {
      border: 3px solid transparent;
      background-clip: padding-box;
      position: relative;
      animation: topicCardGlow 4s infinite;
    }

    .topic-suggestion-item.has-completed::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(45deg, #ffd700, #ffff00, #28a745, #20c997, #17a2b8, #ffd700);
      background-size: 500% 500%;
      border-radius: 13px;
      z-index: -1;
      animation: glitterBorder 3s linear infinite;
    }

    @keyframes topicCardGlow {
      0%, 100% {
        box-shadow: 4px 4px var(--main-color);
      }
      50% {
        box-shadow: 6px 6px var(--main-color), 0 0 20px rgba(255, 215, 0, 0.5);
      }
    }

    /* Priority topic styling for weak areas */
    .topic-suggestion-item.priority-topic {
      border: 3px solid var(--accent-color);
      background: linear-gradient(135deg, #fff5f5, #ffebee);
      position: relative;
    }

    .topic-suggestion-item.priority-topic::after {
      content: "FOCUS AREA";
      position: absolute;
      top: -10px;
      left: 15px;
      background: var(--accent-color);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.5px;
      box-shadow: 2px 2px var(--main-color);
    }

    .topic-suggestion-item.priority-topic:hover {
      transform: translateY(-5px);
      box-shadow: 8px 8px var(--main-color);
      border-color: var(--light-blue);
    }

    /* Lock indicator styles */
    .lock-indicator {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin-left: auto;
      padding: 8px 12px;
      background: linear-gradient(135deg, #6c757d, #495057);
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      opacity: 0.8;
    }

    .lock-icon {
      font-size: 16px;
      color: white;
      margin-bottom: 2px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .lock-text {
      font-size: 9px;
      color: white;
      font-weight: 700;
      letter-spacing: 0.5px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    /* Enhanced locked module styling */
    .module-option.locked {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
      border: 2px solid #dee2e6;
    }

    .module-option.locked:hover {
      background-color: #f8f9fa;
      color: #6c757d;
      transform: none;
      box-shadow: none;
    }

    .module-option.locked .level-badge {
      background: linear-gradient(135deg, #6c757d, #495057);
      color: white;
      opacity: 0.7;
    }

    .module-option.locked .module-option-title {
      color: #6c757d;
    }

    .module-option.locked .module-option-desc {
      color: #adb5bd;
      font-style: italic;
    }

    /* Custom alert dialog styles */
    .custom-alert {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 10000;
      animation: alertFadeIn 0.3s ease-out;
    }

    .alert-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .alert-content {
      background: white;
      border: 3px solid var(--main-color);
      border-radius: 15px;
      box-shadow: 8px 8px var(--main-color);
      max-width: 500px;
      width: 100%;
      max-height: 80vh;
      overflow-y: auto;
      animation: alertSlideIn 0.3s ease-out;
    }

    .alert-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 20px;
      border-bottom: 2px solid var(--main-color);
      background: linear-gradient(135deg, #ffebee, #fff3e0);
    }

    .alert-icon {
      font-size: 24px;
    }

    .alert-header h3 {
      flex: 1;
      margin: 0;
      color: var(--font-color);
      font-weight: 700;
    }

    .alert-close {
      background: var(--accent-color);
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    .alert-close:hover {
      background: var(--light-blue);
      transform: scale(1.1);
    }

    .alert-body {
      padding: 20px;
    }

    .alert-body p {
      margin: 10px 0;
      line-height: 1.6;
    }

    .alert-details p {
      margin: 5px 0;
      font-size: 14px;
    }

    .alert-footer {
      display: flex;
      gap: 10px;
      padding: 20px;
      border-top: 2px solid var(--main-color);
      background: var(--bg-color);
      justify-content: flex-end;
    }

    .alert-btn {
      padding: 10px 20px;
      border: 2px solid var(--main-color);
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 3px 3px var(--main-color);
    }

    .quiz-btn {
      background: var(--tertiary-color);
      color: white;
    }

    .quiz-btn:hover {
      background: var(--light-blue);
      transform: translateY(-2px);
      box-shadow: 5px 5px var(--main-color);
    }

    .close-btn {
      background: white;
      color: var(--font-color);
    }

    .close-btn:hover {
      background: var(--bg-color);
      transform: translateY(-2px);
      box-shadow: 5px 5px var(--main-color);
    }

    @keyframes alertFadeIn {
      from {
        opacity: 0;
      }
      to {
        opacity: 1;
      }
    }

    @keyframes alertSlideIn {
      from {
        transform: translateY(-50px) scale(0.9);
        opacity: 0;
      }
      to {
        transform: translateY(0) scale(1);
        opacity: 1;
      }
    }

    /* Custom Block Styles for Learning Tools */
    .tools-container {
      margin: 25px 0;
    }

    .custom-block {
      border-radius: 15px;
      position: relative;
      overflow: hidden;
      padding: 30px;
      transition: all 0.3s ease;
      height: 100%;
      background: linear-gradient(135deg, var(--light-blue), var(--accent-color));
      border: 2px solid var(--main-color);
      box-shadow: 4px 4px var(--main-color);
    }

    .custom-block:hover {
      transform: translateY(-5px);
      box-shadow: 6px 6px var(--main-color);
    }

    .custom-block-overlay {
      height: 100%;
      min-height: 350px;
      padding: 0;
    }

    .custom-block-image {
      display: block;
      width: 100%;
      height: 200px;
      object-fit: cover;
      border-radius: 10px;
      margin-top: 0;
    }

    .custom-block-overlay-text {
      position: absolute;
      z-index: 2;
      top: 0;
      right: 0;
      left: 0;
      padding: 30px;
    }

    .social-share {
      position: absolute;
      bottom: 0;
      right: 0;
      left: 0;
      z-index: 2;
      padding: 20px 35px;
    }

    .social-icon {
      list-style: none;
      display: flex;
      gap: 10px;
      margin: 0;
      padding: 0;
    }

    .social-icon-item {
      list-style: none;
    }

    .social-icon-link {
      color: white;
      font-size: 18px;
      text-decoration: none;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
    }

    .social-icon-link:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
      color: white;
    }

    .custom-icon {
      color: white;
      font-size: 20px;
      text-decoration: none;
      transition: all 0.3s ease;
    }

    .custom-icon:hover {
      color: var(--secondary-color);
      transform: scale(1.1);
    }

    .custom-btn {
      background: linear-gradient(135deg, var(--secondary-color), var(--tertiary-color));
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: 600;
      text-decoration: none;
      transition: all 0.3s ease;
      display: inline-block;
      box-shadow: 3px 3px var(--main-color);
    }

    .custom-btn:hover {
      background: linear-gradient(135deg, var(--purple), var(--accent-color));
      transform: translateY(-2px);
      box-shadow: 4px 4px var(--main-color);
      color: white;
      text-decoration: none;
    }

    .section-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, rgba(84, 160, 255, 0.7), rgba(255, 107, 107, 0.7));
      z-index: 1;
    }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand" href="home.html">
      <i class="bi-back"></i>
      <span>MathAnywhere</span>
    </a>

    <div class="d-lg-none ms-auto me-4">
      <a href="#top" class="navbar-icon bi-person smoothscroll"></a>
    </div>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarNav">
      <ul class="navbar-nav ms-lg-5 me-lg-auto">
        <li class="nav-item">
          <a class="nav-link" href="home.html">Home</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="deri_graph.html">Derivative calc & graphing</a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<section class="profile-section d-flex align-items-center justify-content-center">
  <div class="container">
    <!-- Removed the User Profile title here -->
  </div>
</section>

<div class="container d-flex align-items-center justify-content-center" style="margin-top: 32px;">
  <div class="profile-container" style="margin: 0 auto;">
    <div class="profile-header">
      <div class="profile-avatar" id="avatar">
        <!-- Avatar will be set by JavaScript -->
      </div>
      <div class="profile-info">
        <h2 id="username">Username: Guest</h2>
        <p id="level">Level: Beginner</p>
      </div>
    </div>

    <div class="section-title">
      <h3>Overall Progress</h3>
    </div>
    <div class="progress-container">
      <div class="progress-label">
        <span>Completion</span>
        <span id="progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar" id="progress-bar"></div>
      </div>
    </div>

    <!-- Welcome section for beginners who haven't taken the quiz -->
    <div class="section-title" id="beginner-welcome-section" style="display: none;">
      <h3>🎯 Welcome to Your Learning Journey!</h3>
    </div>
    <div class="empty-state" id="beginner-welcome-container" style="display: none; margin: 20px 0; padding: 30px;">
      <h4 style="color: var(--accent-color); margin-bottom: 20px;">Ready to discover your calculus path?</h4>
      <p style="font-size: 16px; line-height: 1.6; margin-bottom: 25px;">
        Take our <strong>"Where do I start?"</strong> assessment quiz to:
      </p>
      <div style="text-align: left; max-width: 400px; margin: 0 auto 25px auto;">
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Discover your current skill level</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Get personalized topic recommendations</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Unlock your learning mastery dashboard</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Access your personalized learning path</p>
        <p style="margin: 10px 0;"><i class="bi bi-check-circle" style="color: var(--tertiary-color);"></i> Track achievements and milestones</p>
      </div>
      <button class="button primary" onclick="window.location.href='quiz.html'" style="margin: 10px; font-size: 18px; padding: 15px 30px;">
        <i class="bi bi-play-circle-fill"></i> Take Assessment Quiz
      </button>
      <br>
      <button class="button" onclick="window.location.href='home.html'" style="margin: 10px;">
        <i class="bi bi-book"></i> Browse Topics First
      </button>
    </div>

    <div class="section-title" id="suggested-topics-section" style="display: none;">
      <h3>Suggested Topics to Focus On</h3>
    </div>
    <div class="topic-suggestions" id="topic-suggestions" style="display: none;">
      <!-- Topic suggestions will be added here -->
      <div class="empty-state">
        Take the assessment quiz to get personalized topic suggestions.
      </div>
    </div>

    <!-- Learning Mastery Progress -->
    <div class="section-title" id="learning-mastery-section" style="display: none;">
      <h3>Learning Mastery</h3>
    </div>
    <div class="mastery-container" id="mastery-container" style="display: none;">
      <div class="empty-state">
        Complete the quiz to see your concept mastery breakdown.
      </div>
    </div>

    <!-- Gap Analysis and Adaptive Learning -->
    <div class="section-title" id="learning-path-section" style="display: none;">
      <h3>Learning Path</h3>
    </div>
    <div class="learning-path-container" id="learning-path-container" style="display: none;">
      <div class="empty-state">
        Your personalized learning journey will appear here after taking the quiz.
      </div>
    </div>

    <!-- Achievements and Milestones -->
    <div class="section-title" id="achievements-section" style="display: none;">
      <h3>Achievements</h3>
    </div>
    <div class="achievements-container" id="achievements-container" style="display: none;">
      <div class="empty-state">
        Start learning to unlock achievements!
      </div>
    </div>

    <div class="section-title">
      <h3>Actions</h3>
    </div>
    <div class="button-container">
      <button class="button" onclick="window.location.href='home.html'">
        <i class="bi bi-house"></i> Home
      </button>
      <button class="button" onclick="logout()">
        <i class="bi bi-box-arrow-right"></i> Logout
      </button>
    </div>



    <div class="section-title">
      <h3>Learning Progress by Difficulty Level</h3>
    </div>
    
    <!-- Novice Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>🟢 Novice Level</span>
        <span id="novice-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar novice-progress" id="novice-progress-bar" style="background: linear-gradient(90deg, #28a745, #20c997);"></div>
      </div>
      <div class="progress-details">
        <small id="novice-details">0 of 7 modules completed</small>
      </div>
    </div>

    <!-- Intermediate Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>🟡 Intermediate Level</span>
        <span id="intermediate-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar intermediate-progress" id="intermediate-progress-bar" style="background: linear-gradient(90deg, #ffc107, #fd7e14);"></div>
      </div>
      <div class="progress-details">
        <small id="intermediate-details">0 of 7 modules completed</small>
      </div>
    </div>

    <!-- Advanced Level Progress -->
    <div class="progress-container">
      <div class="progress-label">
        <span>🔴 Advanced Level</span>
        <span id="advanced-progress-percentage">0%</span>
      </div>
      <div class="progress">
        <div class="progress-bar advanced-progress" id="advanced-progress-bar" style="background: linear-gradient(90deg, #dc3545, #ff6b6b);"></div>
      </div>
      <div class="progress-details">
        <small id="advanced-details">0 of 7 modules completed</small>
      </div>
    </div>
  </div>
</div>

<footer class="site-footer section-padding">
  <div class="container">
    <div class="row">
      <div class="col-lg-3 col-12 mb-4 pb-2">
        <a class="navbar-brand mb-2" href="home.html">
          <i class="bi-back"></i>
          <span>MathAnywhere</span>
        </a>
      </div>

      <div class="col-lg-3 col-md-4 col-6 mb-4 mb-lg-0">
        <h6 class="site-footer-title mb-3">Information</h6>
        <p class="text-white d-flex mb-1">
          <a href="tel: 305-240-9671" class="site-footer-link">
            013-3321094
          </a>
        </p>
        <p class="text-white d-flex">
          <a href="mailto:info@company.com" class="site-footer-link">
            2022841556@student.uitm.edu.my
          </a>
        </p>
      </div>
    </div>
  </div>
</footer>

<script src="js/jquery.min.js"></script>
<script src="js/bootstrap.bundle.min.js"></script>
<script src="js/jquery.sticky.js"></script>

<script type="module">
  // ✅ Import Firebase Modules
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

  // ✅ Firebase Configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBUfSOSpmCdWUGTVbSQsMCH-JVmrjpfdPY",
    authDomain: "fyp-lutfi-naim.firebaseapp.com",
    projectId: "fyp-lutfi-naim",
    storageBucket: "fyp-lutfi-naim.firebasestorage.app",
    messagingSenderId: "231274529807",
    appId: "1:231274529807:web:c4ea279f9e7581bd674f7a",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);


  function updateUI(username, level, moduleProgress, overallProgress) {
    // Update avatar with first letter of username
    const avatar = document.getElementById('avatar');
    avatar.textContent = username.charAt(0).toUpperCase();

    document.getElementById('username').textContent = username;
    document.getElementById('level').textContent = `Level: ${level}`;
    
    // Calculate progress for each difficulty level
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    
    // Calculate progress for each difficulty level
    difficultyLevels.forEach(difficulty => {
      let completedModules = 0;
      let totalProgress = 0;
      
      browseTopics.forEach(topic => {
        const moduleKey = `${topic} - ${difficulty}`;
        const progress = moduleProgress[moduleKey] || 0;
        totalProgress += progress;
        if (progress >= 80) {
          completedModules++;
        }
      });
      
      const averageProgress = Math.round(totalProgress / browseTopics.length);
      const difficultyLower = difficulty.toLowerCase();
      
      // Update progress bar
      document.getElementById(`${difficultyLower}-progress-bar`).style.width = `${averageProgress}%`;
      document.getElementById(`${difficultyLower}-progress-percentage`).textContent = `${averageProgress}%`;
      document.getElementById(`${difficultyLower}-details`).textContent = `${completedModules} of ${browseTopics.length} modules completed`;
    });

    // Update topic suggestions
    const topicSuggestionsContainer = document.getElementById('topic-suggestions');
    topicSuggestionsContainer.innerHTML = '';

    // Define all available topics
    const allTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];

    // Get weak topics and recommendations from session storage
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const recommendations = JSON.parse(sessionStorage.getItem('recommendations') || '[]');

    // Generate suggestions for ALL topics
    allTopics.forEach((topic, index) => {
        const suggestionDiv = document.createElement('div');
        suggestionDiv.className = 'topic-suggestion-item';
        
        // Determine recommended level based on user's current level and progress
        const userLevel = level || 'Beginner';
        const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
        let recommendedLevel = 'Novice'; // default recommendation
        let recommendationReason = '';
        
        // Smart recommendation logic based on user level and progress
        if (userLevel === 'Beginner' || userLevel === 'Novice') {
          recommendedLevel = 'Novice';
          recommendationReason = 'Start with fundamentals';
        } else if (userLevel === 'Intermediate') {
          // Check if user has completed novice level for this topic
          const noviceKey = `${topic} - Novice`;
          const noviceProgress = moduleProgress[noviceKey] || 0;
          
          if (noviceProgress >= 80) {
            recommendedLevel = 'Intermediate';
            recommendationReason = 'Ready for next level';
          } else {
            recommendedLevel = 'Novice';
            recommendationReason = 'Review basics first';
          }
        } else if (userLevel === 'Advanced') {
          // Check progress to recommend appropriate level
          const noviceKey = `${topic} - Novice`;
          const intermediateKey = `${topic} - Intermediate`;
          const noviceProgress = moduleProgress[noviceKey] || 0;
          const intermediateProgress = moduleProgress[intermediateKey] || 0;
          
          if (intermediateProgress >= 80) {
            recommendedLevel = 'Advanced';
            recommendationReason = 'Challenge yourself';
          } else if (noviceProgress >= 80) {
            recommendedLevel = 'Intermediate';
            recommendationReason = 'Build on basics';
          } else {
            recommendedLevel = 'Novice';
            recommendationReason = 'Strengthen foundation';
          }
        }

      // Map topics to their specific HTML pages
        let topicPage = '';
        switch(topic) {
          case "Introduction to derivatives":
            topicPage = "Introduction_to_derivatives.html";
            break;
          case "The definition of Derivative":
            topicPage = "The_definition_of_derivative.html";
            break;
          case "Rules of Differentiation":
            topicPage = "rule.html";
            break;
          case "Equation of Tangent":
            topicPage = "Equation-of-tangent.html";
            break;
          case "Second Derivative":
            topicPage = "Second-derivative.html";
            break;
          case "Implicit Differentiations":
            topicPage = "Implicit-differentiation.html";
            break;
          case "Linear Approximation & Differentials":
            topicPage = "linear-approx-differentials.html";
            break;
          default:
            topicPage = `${recommendedLevel.toLowerCase()}.html`;
        }

      // Check if topic has any completed modules
      const currentModuleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
      const noviceKey = `${topic} - Novice`;
      const intermediateKey = `${topic} - Intermediate`;
      const advancedKey = `${topic} - Advanced`;
      const noviceProgress = currentModuleProgress[noviceKey] || 0;
      const intermediateProgress = currentModuleProgress[intermediateKey] || 0;
      const advancedProgress = currentModuleProgress[advancedKey] || 0;
      
      const hasCompletedModules = noviceProgress >= 80 || intermediateProgress >= 80 || advancedProgress >= 80;
      const totalCompletedModules = (noviceProgress >= 80 ? 1 : 0) + (intermediateProgress >= 80 ? 1 : 0) + (advancedProgress >= 80 ? 1 : 0);
      
      const topicCompletionBadge = hasCompletedModules ? 
        `<div class="topic-completion-badge">
          <span class="topic-checkmark">✓</span>
          <span class="topic-completion-count">${totalCompletedModules}/3</span>
         </div>` : '';

      // Add glitter class if modules are completed
      const completedClass = hasCompletedModules ? ' has-completed' : '';
      
      // Check if this topic is a weak topic from quiz
      const isWeakTopic = weakTopics.includes(topic);
      const priorityClass = isWeakTopic ? ' priority-topic' : '';
      
      suggestionDiv.className = `topic-suggestion-item${completedClass}${priorityClass}`;

      // Get appropriate recommendation text
      let recommendationText = '';
      if (isWeakTopic && recommendations[weakTopics.indexOf(topic)]) {
        recommendationText = recommendations[weakTopics.indexOf(topic)];
      } else {
        // Default recommendations for each topic
        const defaultRecommendations = {
          'Introduction to derivatives': 'Start your calculus journey with the fundamentals. Learn what derivatives are and why they\'re important in mathematics and science.',
          'The definition of Derivative': 'Understand the formal limit definition of derivatives and learn to identify where derivatives don\'t exist.',
          'Rules of Differentiation': 'Master the essential rules for finding derivatives. These are the building blocks for all advanced calculus concepts.',
          'Equation of Tangent': 'Apply your derivative knowledge to find tangent lines. This connects theory with practical applications.',
          'Second Derivative': 'Learn about the derivative of derivatives and how they reveal information about function behavior.',
          'Implicit Differentiations': 'Tackle more complex problems where y isn\'t isolated. Essential for advanced calculus applications.',
          'Linear Approximation & Differentials': 'Use derivatives to approximate function values and understand differential notation.'
        };
        recommendationText = defaultRecommendations[topic] || `Focus on improving your understanding of this topic. ${recommendationReason}.`;
      }

      // Add priority indicator for weak topics
      const priorityIndicator = isWeakTopic ? '<span style="color: var(--accent-color); font-weight: bold;">⚠️ Focus Area</span><br>' : '';

        suggestionDiv.innerHTML = `
          <div class="topic-suggestion-header">
            <span class="topic-suggestion-title">${topic}</span>
            <span class="topic-suggestion-difficulty ${getRecommendationClass(recommendedLevel)}" title="${recommendationReason}">Recommended: ${recommendedLevel}</span>
          ${topicCompletionBadge}
          </div>
          <div class="topic-suggestion-content">
          ${priorityIndicator}${recommendationText}
          </div>
          <div class="topic-suggestion-actions">
            <button class="topic-suggestion-btn" onclick="window.location.href='${topicPage}'">
              Start Learning
            </button>
            <div class="module-dropdown">
              <button class="topic-suggestion-btn dropdown-toggle" onclick="toggleModuleDropdown(this)">
                Take Module ▼
              </button>
              <div class="module-options">
                ${generateModuleOptions(topic, sessionStorage.getItem('level') || 'Beginner', JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'))}
              </div>
            </div>
          </div>
        `;
        
        topicSuggestionsContainer.appendChild(suggestionDiv);
      });

    // Conditional display logic for users
    const userWeakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const userRecommendations = JSON.parse(sessionStorage.getItem('recommendations') || '[]');
    const hasQuizData = userWeakTopics.length > 0 || userRecommendations.length > 0;
    const isBeginner = level === 'Beginner';
    
    // Show sections based on user status
    // For beginners without quiz data, hide the suggested topics section
    const shouldShowSections = !isBeginner || hasQuizData;
    const shouldShowTopicSuggestions = !isBeginner || hasQuizData;
    
    // Control visibility of sections
    const alwaysShowSections = [
      'learning-mastery-section', 
      'mastery-container',
      'learning-path-section',
      'learning-path-container',
      'achievements-section',
      'achievements-container'
    ];
    
    const topicSuggestionSections = [
      'suggested-topics-section',
      'topic-suggestions'
    ];
    
    // Always show these sections
    alwaysShowSections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = 'block';
      }
    });
    
    // Only show topic suggestions if user is not a beginner or has taken the quiz
    topicSuggestionSections.forEach(sectionId => {
      const section = document.getElementById(sectionId);
      if (section) {
        section.style.display = shouldShowTopicSuggestions ? 'block' : 'none';
      }
    });
    
    // Only show beginner welcome section for truly new users without any progress
    const hasAnyProgress = Object.keys(JSON.parse(sessionStorage.getItem('moduleProgress') || '{}')).length > 0 ||
                          Object.keys(JSON.parse(sessionStorage.getItem('correctAnswers') || '{}')).length > 0 ||
                          Object.keys(JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}')).length > 0;
    
    const showWelcomeSection = isBeginner && !hasQuizData && !hasAnyProgress;
    
    const beginnerWelcomeSection = document.getElementById('beginner-welcome-section');
    const beginnerWelcomeContainer = document.getElementById('beginner-welcome-container');
    if (beginnerWelcomeSection && beginnerWelcomeContainer) {
      beginnerWelcomeSection.style.display = showWelcomeSection ? 'block' : 'none';
      beginnerWelcomeContainer.style.display = showWelcomeSection ? 'block' : 'none';
    }
    
    console.log("UI updated with username:", username, "and level:", level);
    console.log("Sections visible:", shouldShowSections, "| Is Beginner:", isBeginner, "| Has Quiz Data:", hasQuizData, "| Show Welcome:", showWelcomeSection);
  }


  function syncUserData(userData) {
    // Ensure each module reaches 100% when completed
    const updatedModuleProgress = {};
    for (const [module, progress] of Object.entries(userData.moduleProgress || {})) {
      // This ensures any module progress above 80% is considered 100% complete
      updatedModuleProgress[module] = progress >= 80 ? 100 : progress;
    }

    sessionStorage.setItem('username', userData.username);
    sessionStorage.setItem('level', userData.level);
    sessionStorage.setItem('moduleProgress', JSON.stringify(updatedModuleProgress));

    // Restore all progress tracking data
    if (userData.practiceAttempts) {
      sessionStorage.setItem('practiceAttempts', JSON.stringify(userData.practiceAttempts));
    }
    if (userData.correctAnswers) {
      sessionStorage.setItem('correctAnswers', JSON.stringify(userData.correctAnswers));
    }

    // Load learning analytics data if available
    const masteryData = userData.masteryData || generateMasteryData(userData);
    const learningPath = userData.learningPath || generateLearningPath(userData);
    const achievements = userData.achievements || generateAchievements(userData);
    
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));

    updateUI(userData.username, userData.level, updatedModuleProgress, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
  }

  // Generate mastery data based on quiz results and user progress
  function generateMasteryData(userData) {
    // Use the actual topics from the quiz directly
    const masteryData = [
      { topic: 'Introduction to derivatives', mastery: 0, badge: null, description: 'Understanding what derivatives represent and their basic applications' },
      { topic: 'The definition of Derivative', mastery: 0, badge: null, description: 'Formal limit definition and identifying non-differentiable points' },
      { topic: 'Rules of Differentiation', mastery: 0, badge: null, description: 'Power rule, product rule, quotient rule, and other differentiation techniques' },
      { topic: 'Equation of Tangent', mastery: 0, badge: null, description: 'Finding and interpreting tangent lines to curves' },
      { topic: 'Second Derivative', mastery: 0, badge: null, description: 'Measuring rates of change of rates of change and analyzing concavity' },
      { topic: 'Implicit Differentiations', mastery: 0, badge: null, description: 'Differentiating equations where y is not isolated' },
      { topic: 'Linear Approximation & Differentials', mastery: 0, badge: null, description: 'Using derivatives to approximate function values' }
    ];
    
    // Check if user has weak topics from quiz results
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const hasQuizData = weakTopics.length > 0;
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    
    // Check if user is truly new (no data at all)
    const hasAnyModuleProgress = Object.keys(moduleProgress).length > 0 && Object.values(moduleProgress).some(progress => progress > 0);
    const hasAnyPracticeAttempts = Object.keys(practiceAttempts).length > 0 && Object.values(practiceAttempts).some(attempts => attempts > 0);
    const hasAnyCorrectAnswers = Object.keys(JSON.parse(sessionStorage.getItem('correctAnswers') || '{}')).length > 0;
    const isTrulyNewUser = !hasQuizData && !hasAnyModuleProgress && !hasAnyPracticeAttempts && !hasAnyCorrectAnswers;
    
    // For truly new users, return 0% mastery for all topics
    if (isTrulyNewUser) {
      console.log('=== NEW USER DETECTED ===');
      console.log('No quiz data, no module progress, no practice attempts, no correct answers');
      console.log('All mastery starting at 0% for all topics');
      masteryData.forEach(item => {
        item.mastery = 0;
        item.badge = null;
      });
      return masteryData;
    }
    
    // For beginners specifically, also check if they should start fresh
    const userLevel = userData.level || 'Beginner';
    if (userLevel === 'Beginner' && !hasQuizData && !hasAnyCorrectAnswers) {
      console.log('=== BEGINNER USER WITHOUT QUIZ/CORRECT ANSWERS ===');
      console.log('Forcing 0% mastery for all topics');
    masteryData.forEach(item => {
        item.mastery = 0;
        item.badge = null;
      });
      return masteryData;
    }
    
    // ALL users start at 0% mastery - mastery only increases from actual progress
    masteryData.forEach(item => {
      // Special debugging for Linear Approximation topic
      const isLinearApprox = item.topic === 'Linear Approximation & Differentials';
      if (isLinearApprox) {
        console.log('=== LINEAR APPROXIMATION MASTERY DEBUG ===');
        console.log('User Level:', userData.level);
        console.log('Has Quiz Data:', hasQuizData);
        console.log('Has Any Module Progress:', hasAnyModuleProgress);
        console.log('Has Any Practice Attempts:', hasAnyPracticeAttempts);
        console.log('Has Any Correct Answers:', hasAnyCorrectAnswers);
        console.log('Is Truly New User:', isTrulyNewUser);
        console.log('Weak Topics:', weakTopics);
        console.log('Is in weak topics:', weakTopics.includes(item.topic));
      }
      
      // Start at 0% for everyone
      item.mastery = 0;
      
      // ONLY increase mastery from correct answers in practice/quiz
      // Check for correct answers in practice sessions
      const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
      let topicCorrectAnswers = correctAnswers[item.topic] || 0;
      
      // ENHANCED: Also check for practice session data from enhanced practice files
      const sessionKey = `practice_session_${item.topic}`;
      const practiceSessionData = JSON.parse(sessionStorage.getItem(sessionKey) || '{}');
      const localPracticeSessionData = JSON.parse(localStorage.getItem(sessionKey) || '{}');
      
      // Use the most recent session data
      const useSessionStorage = !localPracticeSessionData.lastSaved || 
        (practiceSessionData.lastSaved && practiceSessionData.lastSaved > localPracticeSessionData.lastSaved);
      
      const sessionData = useSessionStorage ? practiceSessionData : localPracticeSessionData;
      
      // Get correct answers from enhanced practice session
      if (sessionData.correctAnswers) {
        topicCorrectAnswers = Math.max(topicCorrectAnswers, sessionData.correctAnswers);
        
        // Update the correctAnswers sessionStorage to keep it in sync
        correctAnswers[item.topic] = topicCorrectAnswers;
        sessionStorage.setItem('correctAnswers', JSON.stringify(correctAnswers));
      }
      
      if (topicCorrectAnswers > 0) {
        // Each correct answer gives +5% mastery (up to 75% from practice)
        const practiceBoost = Math.min(topicCorrectAnswers * 5, 75);
        item.mastery = Math.min(item.mastery + practiceBoost, 75);
        
        if (isLinearApprox) {
          console.log('Correct answers found (total):', topicCorrectAnswers);
          console.log('Practice session data:', sessionData);
          console.log('Practice boost from correct answers:', practiceBoost, '% - mastery now', item.mastery);
        }
      }
      
      // If user has taken the quiz, only adjust mastery for strong performance
      if (hasQuizData) {
        if (!weakTopics.includes(item.topic)) {
          // For strong topics (not in weak topics), add quiz mastery bonus
          const quizBoost = userData.level === 'Advanced' ? 25 : userData.level === 'Intermediate' ? 20 : 15;
          const oldMastery = item.mastery;
          item.mastery = Math.min(item.mastery + quizBoost, 100);
          
          if (isLinearApprox) {
            console.log('Strong topic quiz boost:', quizBoost, '% - increased from', oldMastery, 'to', item.mastery);
          }
        }
        // Note: We don't penalize for weak topics, mastery stays at correct-answer level
      }
      
      // Practice attempts can also increase mastery
      const attempts = practiceAttempts[item.topic] || 0;
      if (attempts > 0) {
        // DISABLED: Practice attempts should NOT increase mastery - only correct answers should
        const practiceBoost = 0; // Math.min(attempts * 3, 15);
        const oldMastery = item.mastery;
        // item.mastery = Math.min(item.mastery + practiceBoost, 100);
        
        if (isLinearApprox) {
          console.log('Practice attempts found but DISABLED - no mastery boost applied');
          console.log('Attempts:', attempts, '- mastery remains:', item.mastery);
        }
      }
      
      if (isLinearApprox) {
        console.log('FINAL Linear Approximation mastery:', item.mastery + '%');
        console.log('=== END LINEAR APPROXIMATION DEBUG ===');
      }
      
      // Assign badges based on final mastery level
      if (item.mastery >= 80) {
        item.badge = 'M';  // Master
      } else if (item.mastery >= 60) {
        item.badge = 'P';  // Proficient
      } else if (item.mastery >= 30) {
        item.badge = 'L';  // Learning
      } else if (item.mastery > 0) {
        item.badge = 'B';  // Beginner with some progress
        } else {
        item.badge = null; // No badge for 0% mastery
      }
    });
    
    return masteryData;
  }
  
  // Helper function to get module progress for a specific topic
  function getTopicModuleProgress(topicName, moduleProgress) {
    const noviceKey = `${topicName} - Novice`;
    const intermediateKey = `${topicName} - Intermediate`;
    const advancedKey = `${topicName} - Advanced`;
    
    const noviceProgress = moduleProgress[noviceKey] || 0;
    const intermediateProgress = moduleProgress[intermediateKey] || 0;
    const advancedProgress = moduleProgress[advancedKey] || 0;
    
    const hasAnyProgress = noviceProgress > 0 || intermediateProgress > 0 || advancedProgress > 0;
    const averageProgress = hasAnyProgress ? Math.round((noviceProgress + intermediateProgress + advancedProgress) / 3) : 0;
    const maxProgress = Math.max(noviceProgress, intermediateProgress, advancedProgress);
    
    return {
      hasAnyProgress,
      averageProgress,
      maxProgress,
      novice: noviceProgress,
      intermediate: intermediateProgress,
      advanced: advancedProgress
    };
  }
  
  // Generate personalized learning path based on user data
  function generateLearningPath(userData) {
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const level = userData.level || 'Beginner';
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    
    let pathSteps = [];
    
    // Define the browse topics exactly as they appear in the homepage browse section
    const browseTopics = [
      // Chapter 1
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      // Chapter 2
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      // Chapter 3
      'Linear Approximation & Differentials'
    ];
    
    // Helper function to get topic progress and completion status
    function getTopicProgress(topicName) {
      // Map topic names to their module progress keys
      const topicToModuleMap = {
        'Introduction to derivatives': 'Introduction to derivatives',
        'The definition of Derivative': 'The definition of Derivative', 
        'Rules of Differentiation': 'Rules of Differentiation',
        'Equation of Tangent': 'Equation of Tangent',
        'Second Derivative': 'Second Derivative',
        'Implicit Differentiations': 'Implicit Differentiations',
        'Linear Approximation & Differentials': 'Linear Approximation & Differentials'
      };
      
      const mappedTopic = topicToModuleMap[topicName] || topicName;
      
      // Get progress for each difficulty level
      const noviceProgress = moduleProgress[`${mappedTopic} - Novice`] || 0;
      const intermediateProgress = moduleProgress[`${mappedTopic} - Intermediate`] || 0;
      const advancedProgress = moduleProgress[`${mappedTopic} - Advanced`] || 0;
      
      // Calculate overall topic progress (average of all levels)
      const overallProgress = Math.round((noviceProgress + intermediateProgress + advancedProgress) / 3);
      
      // Check if user has visited the theory page for this topic
      const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
      const topicVisits = practiceAttempts[mappedTopic] || 0;
      
      // Enhanced completion detection: topic is completed if:
      // 1. User has visited the theory page (topicVisits > 0) OR
      // 2. User has completed any module for this topic (80%+ progress) OR
      // 3. User has correct answers for this topic
      const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
      const topicCorrectAnswers = correctAnswers[mappedTopic] || 0;
      const hasCompletedModule = noviceProgress >= 80 || intermediateProgress >= 80 || advancedProgress >= 80;
      
      const isCompleted = topicVisits > 0 || hasCompletedModule || topicCorrectAnswers > 0;
      const hasProgress = noviceProgress > 0 || intermediateProgress > 0 || advancedProgress > 0 || topicVisits > 0 || topicCorrectAnswers > 0;
      
      // If completed, ensure progress is at least 100%
      const finalProgress = isCompleted ? Math.max(overallProgress, 100) : overallProgress;
      
      return {
        progress: finalProgress,
        isCompleted: isCompleted,
        hasProgress: hasProgress,
        novice: noviceProgress,
        intermediate: intermediateProgress,
        advanced: advancedProgress,
        visits: topicVisits,
        correctAnswers: topicCorrectAnswers
      };
    }
    
    // Always add ALL topics to learning path (prioritize weak topics if quiz was taken)
    // weakTopics is already declared above in the function
    
    // Create learning path with ALL 7 topics
    browseTopics.forEach((topic, index) => {
      let link = '';
      let content = '';
      
      // Map each topic to its specific page and content
      switch(topic) {
        case "Introduction to derivatives":
          link = "Introduction_to_derivatives.html";
          content = "Start your calculus journey with the fundamentals. Learn what derivatives are and why they matter.";
          break;
        case "The definition of Derivative":
          link = "The_definition_of_derivative.html";
          content = "Understand the formal limit definition of derivatives and learn to identify where derivatives don't exist.";
          break;
        case "Rules of Differentiation":
          link = "rule.html";
          content = "Master the fundamental rules of differentiation - the building blocks for all advanced calculus.";
          break;
        case "Equation of Tangent":
          link = "Equation-of-tangent.html";
          content = "See how derivatives are used to find tangent lines and connect theory with practical applications.";
          break;
        case "Second Derivative":
          link = "Second-derivative.html";
          content = "Learn about the derivative of derivatives and how they reveal function behavior and concavity.";
          break;
        case "Implicit Differentiations":
          link = "Implicit-differentiation.html";
          content = "Tackle more complex problems where y isn't isolated - essential for advanced applications.";
          break;
        case "Linear Approximation & Differentials":
          link = "linear-approx-differentials.html";
          content = "Use derivatives to approximate function values and understand differential notation.";
          break;
      }
      
      const topicProgress = getTopicProgress(topic);
      const isWeakTopic = weakTopics.includes(topic);
      
      // Add priority indicator for weak topics from quiz
      if (isWeakTopic) {
        content = `⚠️ **FOCUS AREA**: ${content} (Identified as a weak area from your quiz results)`;
      }
      
      // Determine status based on completion and position
      let status = 'upcoming';
      if (topicProgress.isCompleted) {
        status = 'completed';
      } else if (index === 0 || isWeakTopic) {
        // First topic or weak topics are current
        status = 'current';
      } else {
        // Check if previous topics are completed to set current status
        let previousCompleted = true;
        for (let i = 0; i < index; i++) {
          const prevTopicProgress = getTopicProgress(browseTopics[i]);
          if (!prevTopicProgress.isCompleted) {
            previousCompleted = false;
            break;
          }
        }
        if (previousCompleted) {
          status = 'current';
        }
      }
      
      pathSteps.push({
        title: topic,
        content: content,
        status: status,
        action: topicProgress.isCompleted ? 'Review' : (status === 'current' ? 'Start' : 'Next'),
        link: link,
        progress: topicProgress.progress,
        isCompleted: topicProgress.isCompleted,
        isWeakTopic: isWeakTopic
      });
    });
    
    // Add assessment step
      pathSteps.push({
      title: 'Take Assessment Quiz',
      content: 'Evaluate your understanding and get personalized recommendations',
      status: weakTopics.length === 0 ? 'current' : 'completed',
      action: weakTopics.length === 0 ? 'Take Quiz' : 'Retake',
      link: 'quiz.html',
      progress: weakTopics.length > 0 ? 100 : 0,
      isCompleted: weakTopics.length > 0
    });
    
    return pathSteps;
  }
  
  // Generate achievements based on user progress
  function generateAchievements(userData) {
    const level = userData.level || 'Beginner';
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    
    // Count completed modules (80% or higher)
    let completedModules = 0;
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    
    browseTopics.forEach(topic => {
      difficultyLevels.forEach(level => {
        const moduleKey = `${topic} - ${level}`;
        const progress = moduleProgress[moduleKey] || 0;
        if (progress >= 80) {
          completedModules++;
        }
      });
    });
    
    // Define all possible achievements
    const achievements = [
      {
        icon: '🚀',
        title: 'Getting Started',
        description: 'Welcome to your calculus journey!',
        unlocked: true // Always unlocked for new users
      },
      {
        icon: '📚',
        title: 'Novice Calculus',
        description: 'Reach Novice level',
        unlocked: ['Novice', 'Intermediate', 'Advanced'].includes(level)
      },
      {
        icon: '🎯',
        title: 'Assessment Taker',
        description: 'Complete the assessment quiz',
        unlocked: weakTopics.length > 0
      },
      {
        icon: '🏁',
        title: 'First Steps',
        description: 'Complete your first module',
        unlocked: completedModules >= 1
      },
      {
        icon: '📈',
        title: 'Making Progress',
        description: 'Complete 5 modules',
        unlocked: completedModules >= 5
      },
      {
        icon: '🔥',
        title: 'On Fire',
        description: 'Complete 10 modules',
        unlocked: completedModules >= 10
      },
      {
        icon: '🎓',
        title: 'Scholar',
        description: 'Complete 15 modules',
        unlocked: completedModules >= 15
      },
      {
        icon: '🏆',
        title: 'Calculus Master',
        description: 'Complete all 21 modules',
        unlocked: completedModules >= 21
      },
      {
        icon: '🟢',
        title: 'Novice Master',
        description: 'Complete all Novice level modules',
        unlocked: (() => {
          // DEBUG: Log Novice Master achievement status
          console.log('=== DEBUGGING NOVICE MASTER ACHIEVEMENT ===');
          console.log('All browseTopics:', browseTopics);
          console.log('Current moduleProgress:', moduleProgress);
          
          const noviceProgress = {};
          browseTopics.forEach(topic => {
            const moduleKey = `${topic} - Novice`;
            const progress = moduleProgress[moduleKey] || 0;
            noviceProgress[moduleKey] = progress;
            console.log(`${moduleKey}: ${progress}% (≥80: ${progress >= 80})`);
          });
          
          const allComplete = browseTopics.every(topic => (moduleProgress[`${topic} - Novice`] || 0) >= 80);
          console.log('All Novice modules ≥80%:', allComplete);
          console.log('Novice Master should be unlocked:', allComplete);
          console.log('=== END NOVICE MASTER DEBUG ===');
          
          return allComplete;
        })()
      },
      {
        icon: '🟡',
        title: 'Intermediate Master',
        description: 'Complete all Intermediate level modules',
        unlocked: browseTopics.every(topic => (moduleProgress[`${topic} - Intermediate`] || 0) >= 80)
      },
      {
        icon: '🔴',
        title: 'Advanced Master',
        description: 'Complete all Advanced level modules',
        unlocked: browseTopics.every(topic => (moduleProgress[`${topic} - Advanced`] || 0) >= 80)
      },
      {
        icon: '🔍',
        title: 'Slope Seeker',
        description: 'Master derivatives',
        unlocked: level === 'Intermediate' || level === 'Advanced'
      },
      {
        icon: '⏱️',
        title: 'Speed Solver',
        description: 'Complete quiz in under 5 minutes',
        unlocked: false
      },
      {
        icon: '🧩',
        title: 'Concept Connector',
        description: 'Study multiple calculus topics',
        unlocked: level !== 'Beginner'
      },
      {
        icon: '💯',
        title: 'Perfectionist',
        description: 'Achieve 100% on any module',
        unlocked: Object.values(moduleProgress).some(progress => progress >= 100)
      }
    ];
    
    return achievements;
  }
  
  // Update the UI with learning analytics data
  function updateLearningAnalytics(masteryData, learningPath, achievements) {
    // Check if sections should be visible (for beginners who haven't taken quiz)
    const userLevel = sessionStorage.getItem('level');
    const userWeakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const userRecommendations = JSON.parse(sessionStorage.getItem('recommendations') || '[]');
    const hasQuizData = userWeakTopics.length > 0 || userRecommendations.length > 0;
    const isBeginner = userLevel === 'Beginner';
    const shouldShowSections = !isBeginner || hasQuizData;
    
    // Only update sections if they should be visible
    if (!shouldShowSections) {
      console.log('Skipping learning analytics update - sections hidden for beginner user without quiz data');
      return;
    }
    
    // Update Mastery section
    const masteryContainer = document.getElementById('mastery-container');
    if (masteryData && masteryData.length > 0) {
      masteryContainer.innerHTML = '';
      
      // Add the title without reset button
      const masteryHeader = document.createElement('div');
      masteryHeader.className = 'mastery-header';
              masteryHeader.innerHTML = `
          <h4 class="mastery-section-title">Topic Mastery</h4>
        `;
      masteryContainer.appendChild(masteryHeader);
      
      const masteryGrid = document.createElement('div');
      masteryGrid.className = 'mastery-grid';
      
      masteryData.forEach(item => {
        const masteryItem = document.createElement('div');
        masteryItem.className = 'mastery-item';
        
        let badgeHTML = '';
        if (item.badge) {
          badgeHTML = `<div class="mastery-badge">${item.badge}</div>`;
        }
        
        // Simple mastery display without detailed analytics
        
        // Use topic name directly instead of concept
        masteryItem.innerHTML = `
          ${badgeHTML}
          <div class="mastery-title">${item.topic || 'Unknown Topic'}</div>
          <div class="mastery-description">${item.description || ''}</div>
          <button class="topic-practice-btn" onclick="practiceTopic('${item.topic}')">Practice</button>
        `;
        
        masteryGrid.appendChild(masteryItem);
      });
      
      masteryContainer.appendChild(masteryGrid);
    }
    
    // Update Learning Path section
    const learningPathContainer = document.getElementById('learning-path-container');
    if (learningPath && learningPath.length > 0) {
      learningPathContainer.innerHTML = '';
      
      const learningPathDiv = document.createElement('div');
      learningPathDiv.className = 'learning-path';
      
      const pathSteps = document.createElement('div');
      pathSteps.className = 'path-steps';
      
      learningPath.forEach(step => {
        const pathStep = document.createElement('div');
        // Add priority-step class for weak topics
        const priorityClass = step.isWeakTopic ? ' priority-step' : '';
        pathStep.className = `path-step ${step.status}${priorityClass}`;
        
        // Create completion tick if the step is completed
        const completionTick = step.isCompleted ? '<span class="completion-tick">✓</span>' : '';
        
        // Create progress bar if progress data is available
        let progressBarHTML = '';
        if (step.progress !== undefined) {
          progressBarHTML = `
            <div class="path-step-progress">
              <div class="path-progress-bar-container">
                <div class="path-progress-bar" style="width: ${step.progress}%;"></div>
              </div>
              <span class="path-progress-text">${step.progress}%</span>
            </div>
          `;
        }
        
        pathStep.innerHTML = `
          <div class="path-step-header">
            <span class="path-step-title">
              ${step.title} ${completionTick}
            </span>
            <span class="path-step-status">${step.status === 'completed' ? 'Completed' : step.status === 'current' ? 'In Progress' : 'Coming Soon'}</span>
          </div>
          <div class="path-step-content">${step.content}</div>
          ${progressBarHTML}
          <button class="path-step-action" onclick="window.location.href='${step.link}'">${step.action}</button>
        `;
        
        pathSteps.appendChild(pathStep);
      });
      
      learningPathDiv.appendChild(pathSteps);
      learningPathContainer.appendChild(learningPathDiv);
    }
    
    // Update Achievements section
    const achievementsContainer = document.getElementById('achievements-container');
    if (achievements && achievements.length > 0) {
      achievementsContainer.innerHTML = '';
      
      const achievementsGrid = document.createElement('div');
      achievementsGrid.className = 'achievements-grid';
      
      achievements.forEach(achievement => {
        const achievementDiv = document.createElement('div');
        achievementDiv.className = `achievement ${achievement.unlocked ? '' : 'locked'}`;
        
        achievementDiv.innerHTML = `
          <div class="achievement-icon">${achievement.icon}</div>
          <div class="achievement-title">${achievement.title}</div>
          <div class="achievement-description">${achievement.description}</div>
        `;
        
        achievementsGrid.appendChild(achievementDiv);
      });
      
      achievementsContainer.appendChild(achievementsGrid);
    }
  }
  
  // Function to refresh mastery data
  window.refreshMasteryData = function() {
    // Get current data
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    // Regenerate mastery data
    const masteryData = generateMasteryData(userData);
    
    // Update session storage
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI
    updateLearningAnalytics(
      masteryData,
      JSON.parse(sessionStorage.getItem('learningPath') || '[]'),
      JSON.parse(sessionStorage.getItem('achievements') || '[]')
    );
    
    // Show toast notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">🔄</div>
      <div class="toast-content">
        <div class="toast-title">Data Refreshed</div>
        <div class="toast-message">Your mastery data has been updated.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate the toast in
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    // Animate the toast out after 3 seconds
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(toast);
      }, 500);
    }, 3000);
    
    // Auto-save to Firebase
    autoSaveUserData();
  };

  // Debug function to check practice session data
  window.debugPracticeData = function() {
    const topics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    console.log('=== PRACTICE SESSION DATA DEBUG ===');
    
    topics.forEach(topic => {
      const sessionKey = `practice_session_${topic}`;
      const sessionData = JSON.parse(sessionStorage.getItem(sessionKey) || '{}');
      const localData = JSON.parse(localStorage.getItem(sessionKey) || '{}');
      
      console.log(`\n📚 ${topic}:`);
      console.log('SessionStorage:', sessionData);
      console.log('LocalStorage:', localData);
      
      if (sessionData.correctAnswers || localData.correctAnswers) {
        console.log(`✅ Correct Answers: ${sessionData.correctAnswers || localData.correctAnswers || 0}`);
        console.log(`⏱️ Time Spent: ${Math.round((sessionData.timeSpent || localData.timeSpent || 0) / 1000)}s`);
        console.log(`📊 Total Questions: ${sessionData.totalQuestions || localData.totalQuestions || 0}`);
      } else {
        console.log('❌ No practice data found');
      }
    });
    
    console.log('\n=== CORRECT ANSWERS STORAGE ===');
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    console.log('correctAnswers storage:', correctAnswers);
    
    console.log('\n=== END DEBUG ===');
    
    // Show results in alert too
    let debugText = 'Practice Session Data:\n\n';
    topics.forEach(topic => {
      const sessionKey = `practice_session_${topic}`;
      const sessionData = JSON.parse(sessionStorage.getItem(sessionKey) || '{}');
      const localData = JSON.parse(localStorage.getItem(sessionKey) || '{}');
      
      const correctAnswers = sessionData.correctAnswers || localData.correctAnswers || 0;
      const timeSpent = Math.round((sessionData.timeSpent || localData.timeSpent || 0) / 1000);
      
      if (correctAnswers > 0 || timeSpent > 0) {
        debugText += `${topic}:\n`;
        debugText += `  Correct: ${correctAnswers}\n`;
        debugText += `  Time: ${timeSpent}s\n\n`;
      }
    });
    
    if (debugText === 'Practice Session Data:\n\n') {
      debugText += 'No practice data found. Try answering some questions first!';
    }
    
    alert(debugText);
  };

  // Function to clear old practice data and refresh
  window.clearOldPracticeData = function() {
    const topics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    console.log('Clearing old practice data...');
    
    // Clear old storage keys (wrong format)
    topics.forEach(topic => {
      const oldKey = `practice_${topic}`;
      const backupKey = `practice_backup_${topic}`;
      
      if (sessionStorage.getItem(oldKey)) {
        console.log(`Removing old sessionStorage key: ${oldKey}`);
        sessionStorage.removeItem(oldKey);
      }
      
      if (localStorage.getItem(oldKey)) {
        console.log(`Removing old localStorage key: ${oldKey}`);
        localStorage.removeItem(oldKey);
      }
      
      if (localStorage.getItem(backupKey)) {
        console.log(`Removing old backup key: ${backupKey}`);
        localStorage.removeItem(backupKey);
      }
    });
    
    // Refresh the page data
    refreshMasteryData();
    
    alert('Old practice data cleared! Please try practicing again and the analytics should update correctly.');
  };

  // Test function to simulate practice tracking
  window.testPracticeTracking = function() {
    const testTopic = 'Introduction to derivatives';
    
    // Create test session data
    const testSessionData = {
      startTime: Date.now() - 300000, // 5 minutes ago
      totalQuestions: 5,
      correctAnswers: 3,
      timeSpent: 300000, // 5 minutes
      sessionId: 'test_session_' + Date.now(),
      lastSaved: Date.now(),
      attempts: {
        0: { count: 1, correct: true, timeSpent: 45000 },
        1: { count: 2, correct: true, timeSpent: 60000 },
        2: { count: 1, correct: false, timeSpent: 30000 },
        3: { count: 1, correct: true, timeSpent: 90000 },
        4: { count: 3, correct: false, timeSpent: 75000 }
      }
    };
    
    // Save test data
    const sessionKey = `practice_session_${testTopic}`;
    sessionStorage.setItem(sessionKey, JSON.stringify(testSessionData));
    localStorage.setItem(sessionKey, JSON.stringify(testSessionData));
    
    // Update correctAnswers tracking
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    correctAnswers[testTopic] = 3;
    sessionStorage.setItem('correctAnswers', JSON.stringify(correctAnswers));
    
    // Refresh the display
    refreshPracticeSessionData();
    
    alert(`Test data created for "${testTopic}":\n- 3/5 questions correct (60% accuracy)\n- 5 minutes total time\n\nCheck the analytics display!`);
  };

  // Function to reset mastery data for beginners (testing purposes)
  // REMOVED: resetBeginnerMastery function - replaced with resetAllMastery

  // Debug function to show module progress breakdown
  window.showModuleProgressDebug = function() {
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    let totalProgress = 0;
    let completedModules = 0;
    let debugInfo = 'MODULE PROGRESS BREAKDOWN:\n\n';
    
    browseTopics.forEach((topic, topicIndex) => {
      debugInfo += `${topicIndex + 1}. ${topic}:\n`;
      difficultyLevels.forEach(level => {
        const moduleKey = `${topic} - ${level}`;
        const progress = moduleProgress[moduleKey] || 0;
        totalProgress += progress;
        if (progress >= 80) completedModules++;
        
        debugInfo += `   ${level}: ${progress}% ${progress >= 80 ? '✓' : ''}\n`;
      });
      debugInfo += '\n';
    });
    
    // Calculate progress for each difficulty level
    debugInfo += `DIFFICULTY LEVEL PROGRESS:\n\n`;
    difficultyLevels.forEach(difficulty => {
      let levelProgress = 0;
      let levelCompleted = 0;
      
      browseTopics.forEach(topic => {
        const moduleKey = `${topic} - ${difficulty}`;
        const progress = moduleProgress[moduleKey] || 0;
        levelProgress += progress;
        if (progress >= 80) levelCompleted++;
      });
      
      const averageProgress = Math.round(levelProgress / browseTopics.length);
      debugInfo += `${difficulty}: ${averageProgress}% (${levelCompleted}/${browseTopics.length} completed)\n`;
    });
    
    debugInfo += `\nSUMMARY:\n`;
    debugInfo += `Total Modules: ${browseTopics.length * difficultyLevels.length}\n`;
    debugInfo += `Completed Modules (≥80%): ${completedModules}\n`;
    
    console.log(debugInfo);
    alert(debugInfo);
  };

  // Function to recalculate difficulty level progress with animation
  window.recalculateOverallProgress = function() {
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const difficultyLevels = ['Novice', 'Intermediate', 'Advanced'];
    
    console.log('=== RECALCULATING PROGRESS ===');
    console.log('Module Progress Data:', moduleProgress);
    
    // Calculate progress for each difficulty level and store their averages
    const levelAverages = [];
    
    difficultyLevels.forEach(difficulty => {
      let completedModules = 0;
      let totalProgress = 0;
      
      browseTopics.forEach(topic => {
        const moduleKey = `${topic} - ${difficulty}`;
        const progress = moduleProgress[moduleKey] || 0;
        totalProgress += progress;
        if (progress >= 80) {
          completedModules++;
        }
        console.log(`${moduleKey}: ${progress}%`);
      });
      
      const averageProgress = Math.round(totalProgress / browseTopics.length);
      levelAverages.push(averageProgress);
      const difficultyLower = difficulty.toLowerCase();
      
      console.log(`${difficulty} Level: ${averageProgress}% (${completedModules}/${browseTopics.length} completed)`);
      
      // Animate progress bar from 0 to target value
      const progressBar = document.getElementById(`${difficultyLower}-progress-bar`);
      const progressPercentage = document.getElementById(`${difficultyLower}-progress-percentage`);
      const progressDetails = document.getElementById(`${difficultyLower}-details`);
      
      if (progressBar && progressPercentage && progressDetails) {
        // Start from 0 and animate to target
        progressBar.style.width = '0%';
        progressPercentage.textContent = '0%';
        
        // Use timeout to trigger animation
        setTimeout(() => {
          progressBar.style.width = `${averageProgress}%`;
          
          // Animate the percentage text
          let currentPercent = 0;
          const targetPercent = averageProgress;
          const increment = targetPercent / 50; // 50 steps for smooth animation
          
          const percentInterval = setInterval(() => {
            currentPercent += increment;
            if (currentPercent >= targetPercent) {
              currentPercent = targetPercent;
              clearInterval(percentInterval);
            }
            progressPercentage.textContent = `${Math.round(currentPercent)}%`;
          }, 40); // 40ms intervals for smooth animation
          
        }, 200); // Small delay to ensure DOM is ready
        
        progressDetails.textContent = `${completedModules} of ${browseTopics.length} modules completed`;
      }
    });
    
    // Calculate overall progress based on all three levels
    const overallProgress = Math.round((levelAverages[0] + levelAverages[1] + levelAverages[2]) / 3);
    
    console.log(`Overall Progress: ${overallProgress}% (Novice: ${levelAverages[0]}%, Intermediate: ${levelAverages[1]}%, Advanced: ${levelAverages[2]}%)`);
    
    // Update the overall progress bar
    const overallProgressBar = document.getElementById('progress-bar');
    const overallProgressPercentage = document.getElementById('progress-percentage');
    
    if (overallProgressBar && overallProgressPercentage) {
      // Start from 0 and animate to target value
      overallProgressBar.style.width = '0%';
      overallProgressPercentage.textContent = '0%';
      
      // Use timeout to trigger animation
      setTimeout(() => {
        overallProgressBar.style.width = `${overallProgress}%`;
        
        // Animate the percentage text
        let currentPercent = 0;
        const targetPercent = overallProgress;
        const increment = targetPercent / 50; // 50 steps for smooth animation
        
        const percentInterval = setInterval(() => {
          currentPercent += increment;
          if (currentPercent >= targetPercent) {
            currentPercent = targetPercent;
            clearInterval(percentInterval);
          }
          overallProgressPercentage.textContent = `${Math.round(currentPercent)}%`;
        }, 40); // 40ms intervals for smooth animation
        
      }, 300); // Slightly longer delay to start after level progress bars
    }
    
    return overallProgress;
  };

  // Function to generate module URLs based on topic and level
  window.getModuleUrl = function(topic, level) {
    // Map topics to their exact file names as they exist in the project
    let baseUrl = '';
    
    switch(topic) {
      case 'Introduction to derivatives':
        baseUrl = 'introduction-to-derivatives';
        break;
      case 'The definition of Derivative':
        baseUrl = 'the-definition-of-derivative';
        break;
      case 'Rules of Differentiation':
        baseUrl = 'rules-of-differentiation';
        break;
      case 'Equation of Tangent':
        baseUrl = 'equation-of-tangent';
        break;
      case 'Second Derivative':
        baseUrl = 'second-derivative';
        break;
      case 'Implicit Differentiations':
        baseUrl = 'implicit-differentiations';
        break;
      case 'Linear Approximation & Differentials':
        baseUrl = 'linear-approximation-and-differentials';
        break;
      default:
        // Fallback: convert topic name to URL-friendly format
        baseUrl = topic.toLowerCase()
      .replace(/\s+/g, '-')
      .replace(/&/g, 'and')
      .replace(/[^a-z0-9-]/g, '');
    }
    
    const levelSlug = level.toLowerCase();
    
    // Create the full module URL exactly as the files are named
    // Use enhanced versions for Introduction to Derivatives
    if (topic === 'Introduction to derivatives') {
      return `${baseUrl}-${levelSlug}-enhanced.html`;
    }
    
    return `${baseUrl}-${levelSlug}.html`;
  };

  // Function to test if all module URLs are working
  window.testAllModuleUrls = function() {
    const topic = 'Linear Approximation & Differentials';
    const levels = ['Novice', 'Intermediate', 'Advanced'];
    let testResults = `TESTING LINEAR APPROXIMATION & DIFFERENTIALS MODULES:\n\n`;
    
    levels.forEach(level => {
      const moduleUrl = getModuleUrl(topic, level);
      testResults += `${level}: ${moduleUrl}\n`;
      
      // Test the actual navigation
      try {
        // Create a test link to see if it would work
        const testLink = document.createElement('a');
        testLink.href = moduleUrl;
        testResults += `  Full URL: ${window.location.origin}/${moduleUrl}\n`;
        testResults += `  Status: Ready to test ✅\n\n`;
      } catch (error) {
        testResults += `  Error: ${error.message} ❌\n\n`;
      }
    });
    
    console.log(testResults);
    alert(testResults);
  };

  // Specific test for Linear Approximation & Differentials
  window.testLinearApproxModules = function() {
    const topic = 'Linear Approximation & Differentials';
    const levels = ['Novice', 'Intermediate', 'Advanced'];
    let testResults = `TESTING LINEAR APPROXIMATION & DIFFERENTIALS MODULES:\n\n`;
    
    levels.forEach(level => {
      const moduleUrl = getModuleUrl(topic, level);
      testResults += `${level}: ${moduleUrl}\n`;
      
      // Test the actual navigation
      try {
        // Create a test link to see if it would work
        const testLink = document.createElement('a');
        testLink.href = moduleUrl;
        testResults += `  Full URL: ${window.location.origin}/${moduleUrl}\n`;
        testResults += `  Status: Ready to test ✅\n\n`;
      } catch (error) {
        testResults += `  Error: ${error.message} ❌\n\n`;
      }
    });
    
    console.log(testResults);
    alert(testResults);
  };

  // Enhanced function to handle module access with error handling
  window.navigateToModule = function(topic, level) {
    const moduleUrl = getModuleUrl(topic, level);
    
    // Special debug logging for Linear Approximation modules
    if (topic === 'Linear Approximation & Differentials') {
      console.log('Linear Approximation Module Debug:');
      console.log('Topic:', topic);
      console.log('Level:', level);
      console.log('Generated URL:', moduleUrl);
      console.log('Full URL would be:', window.location.origin + '/' + moduleUrl);
    }
    
    // Show loading message
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">🔄</div>
      <div class="toast-content">
        <div class="toast-title">Loading Module</div>
        <div class="toast-message">Opening ${topic} - ${level} level...</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate the toast in
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    // Try to navigate to the module
    try {
      // Add a small delay to show the loading message
      setTimeout(() => {
        window.location.href = moduleUrl;
      }, 500);
    } catch (error) {
      // Remove loading toast
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 500);
      }, 1000);
      
      // Show error message
      setTimeout(() => {
        const errorToast = document.createElement('div');
        errorToast.className = 'toast-notification';
        errorToast.innerHTML = `
          <div class="toast-icon">❌</div>
          <div class="toast-content">
            <div class="toast-title">Module Not Found</div>
            <div class="toast-message">The ${topic} - ${level} module is not available yet.<br>URL: ${moduleUrl}</div>
          </div>
        `;
        
        document.body.appendChild(errorToast);
        
        setTimeout(() => {
          errorToast.classList.add('show');
        }, 100);
        
        setTimeout(() => {
          errorToast.classList.remove('show');
          setTimeout(() => {
            if (document.body.contains(errorToast)) {
              document.body.removeChild(errorToast);
            }
          }, 500);
        }, 5000); // Show error longer for debugging
      }, 1500);
      
      console.error("Error navigating to module:", error);
      console.error("Attempted URL:", moduleUrl);
    }
  };

  // Direct navigation function for Linear Approximation modules (for testing)
  window.directNavigateLinearApprox = function(level) {
    const urls = {
      'Novice': 'linear-approximation-and-differentials-novice.html',
      'Intermediate': 'linear-approximation-and-differentials-intermediate.html',
      'Advanced': 'linear-approximation-and-differentials-advanced.html'
    };
    
    const url = urls[level];
    if (url) {
      console.log(`Direct navigation to: ${url}`);
      window.location.href = url;
    } else {
      alert(`No URL found for level: ${level}`);
    }
  };

  // Global variable to track open dropdown
  let currentOpenDropdown = null;
  let currentDropdownButton = null;

  // Function to close all dropdowns
  window.closeAllDropdowns = function() {
    document.querySelectorAll('.module-options.show').forEach(dropdown => {
      dropdown.classList.remove('show');
    });
    currentOpenDropdown = null;
    currentDropdownButton = null;
    
    // Remove any existing event listeners
    document.removeEventListener('click', handleOutsideClick);
    window.removeEventListener('scroll', closeAllDropdowns);
    window.removeEventListener('resize', closeAllDropdowns);
  };

  // Close dropdowns on scroll or resize
  function attachGlobalListeners() {
    window.addEventListener('scroll', closeAllDropdowns);
    window.addEventListener('resize', closeAllDropdowns);
  }

  // Handle clicks outside dropdown
  function handleOutsideClick(e) {
    // Check if click is outside both button and dropdown
    if (currentDropdownButton && currentOpenDropdown) {
      const isClickOnButton = currentDropdownButton.contains(e.target);
      const isClickInDropdown = currentOpenDropdown.contains(e.target);
      
      if (!isClickOnButton && !isClickInDropdown) {
        closeAllDropdowns();
      }
    }
  }

  // Function to toggle module dropdown
  window.toggleModuleDropdown = function(button) {
    const dropdown = button.nextElementSibling;
    
    // If clicking the same button that's already open, close it
    if (currentOpenDropdown === dropdown) {
      closeAllDropdowns();
      return;
    }
    
    // Close any other open dropdown first
    closeAllDropdowns();
    
    // Open the new dropdown
    dropdown.classList.add('show');
    currentOpenDropdown = dropdown;
    currentDropdownButton = button;
    
    // Add event listeners
    setTimeout(() => {
      document.addEventListener('click', handleOutsideClick);
      attachGlobalListeners();
    }, 10); // Small delay to prevent immediate closing
  };

  async function fetchUserData(user) {
    try {
      console.log("Fetching user data for:", user.uid);
      const userDocRef = doc(db, 'users', user.uid);
      const userDocSnap = await getDoc(userDocRef);

      if (userDocSnap.exists()) {
        const userData = userDocSnap.data();
        console.log("User data from Firebase:", userData);
        
        // Make a username from email if username is missing or "Guest"
        let displayName = userData.username;
        if (!displayName || displayName === 'Guest') {
          // Extract username from email (remove @domain.com)
          displayName = user.email ? user.email.split('@')[0] : 'Guest';
          // Capitalize first letter
          displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
          
          // Save this username back to Firebase
          await updateDoc(userDocRef, {
            username: displayName
          });
        }
        
        // Update session storage
        sessionStorage.setItem('username', displayName);
        sessionStorage.setItem('userName', displayName);
        sessionStorage.setItem('userEmail', user.email || '');
        sessionStorage.setItem('level', userData.level || 'Beginner');
        
        // Restore all user data from Firebase
        if (userData.weakTopics) {
          sessionStorage.setItem('weakTopics', JSON.stringify(userData.weakTopics));
        }
        if (userData.recommendations) {
          sessionStorage.setItem('recommendations', JSON.stringify(userData.recommendations));
        }
        if (userData.moduleProgress) {
          sessionStorage.setItem('moduleProgress', JSON.stringify(userData.moduleProgress));
        }
        if (userData.practiceAttempts) {
          sessionStorage.setItem('practiceAttempts', JSON.stringify(userData.practiceAttempts));
        }
        if (userData.correctAnswers) {
          sessionStorage.setItem('correctAnswers', JSON.stringify(userData.correctAnswers));
        }
        
        // Use saved mastery data if available, otherwise generate fresh
        let masteryData = userData.masteryData;
        let learningPath = userData.learningPath;
        let achievements = userData.achievements;
        
        if (!masteryData) {
          console.log("No saved mastery data found, generating fresh...");
          masteryData = generateMasteryData({
            username: displayName,
            level: userData.level || 'Beginner'
          });
        } else {
          console.log("Using saved mastery data from Firebase");
        }
        
        if (!learningPath) {
          learningPath = generateLearningPath({
            username: displayName,
            level: userData.level || 'Beginner'
          });
        }
        
        if (!achievements) {
          achievements = generateAchievements({
            username: displayName,
            level: userData.level || 'Beginner'
          });
        }
        
        // Store learning analytics data in session storage
        sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
        sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
        sessionStorage.setItem('achievements', JSON.stringify(achievements));
        
        // Sync the data to UI
        syncUserData({
          username: displayName,
          level: userData.level || 'Beginner',
          moduleProgress: userData.moduleProgress || {},
          overallProgress: userData.overallProgress || 0,
          masteryData: masteryData,
          learningPath: learningPath,
          achievements: achievements,
          practiceAttempts: userData.practiceAttempts || {},
          correctAnswers: userData.correctAnswers || {}
        });
        
        console.log("User data restoration complete");
      } else {
        console.log("No user document found, creating new one");
        // Create a new user document
        let displayName = user.email ? user.email.split('@')[0] : 'Guest';
        displayName = displayName.charAt(0).toUpperCase() + displayName.slice(1);
        
        // Generate initial learning analytics data
        const masteryData = generateMasteryData({
          username: displayName,
          level: 'Beginner'
        });
        
        const learningPath = generateLearningPath({
          username: displayName,
          level: 'Beginner'
        });
        
        const achievements = generateAchievements({
          username: displayName,
          level: 'Beginner'
        });
        
        const practiceAttempts = {};
        
        const newUserData = {
          username: displayName,
          level: 'Beginner',
          moduleProgress: {},
          overallProgress: 0,
          email: user.email,
          createdAt: new Date().toISOString(),
          weakTopics: [],
          recommendations: [],
          masteryData: masteryData,
          learningPath: learningPath,
          achievements: achievements,
          practiceAttempts: practiceAttempts,
          correctAnswers: {}
        };
        
        // Save the new user data
        await setDoc(userDocRef, newUserData);
        
        // Update session storage
        sessionStorage.setItem('username', displayName);
        sessionStorage.setItem('userName', displayName);
        sessionStorage.setItem('userEmail', user.email || '');
        sessionStorage.setItem('level', 'Beginner');
        sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
        sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
        sessionStorage.setItem('achievements', JSON.stringify(achievements));
        sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
        
        syncUserData(newUserData);
      }
    } catch (error) {
      console.error("Error fetching user data:", error);
      alert("Error loading profile. Please try again.");
    }
  }

  // ✅ Save User Data before Logout
  async function saveUserData(user) {
    const userDocRef = doc(db, 'users', user.uid);
    await setDoc(userDocRef, {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level'),
      moduleProgress: JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'),
      weakTopics: JSON.parse(sessionStorage.getItem('weakTopics') || '[]'),
      recommendations: JSON.parse(sessionStorage.getItem('recommendations') || '[]'),
      masteryData: JSON.parse(sessionStorage.getItem('masteryData') || 'null'),
      learningPath: JSON.parse(sessionStorage.getItem('learningPath') || 'null'),
      achievements: JSON.parse(sessionStorage.getItem('achievements') || 'null'),
      practiceAttempts: JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}'),
      correctAnswers: JSON.parse(sessionStorage.getItem('correctAnswers') || '{}'),
      lastUpdated: new Date().toISOString()
    });
  }

  // ✅ Authentication State Listener
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Profile page loaded, checking authentication...');
    
    // Check Firebase authentication state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        console.log('User is authenticated:', user.uid);
        // User is signed in, fetch their data from Firestore
        await fetchUserData(user);
        
        // Force another progress update after Firebase data is loaded
        setTimeout(() => {
          console.log('Post-Firebase progress update...');
          recalculateOverallProgress();
        }, 2000);
        
        // Auto-detect completed modules after Firebase data is loaded
        setTimeout(() => {
          console.log('Auto-detecting module completions from Firebase data...');
          autoDetectModuleCompletions();
        }, 3000);
        
        // Auto-refresh mastery data to ensure it's up to date
        setTimeout(() => {
          console.log('Auto-refreshing mastery data...');
          autoRefreshMasteryData();
        }, 3500);
        
        // ENHANCED: Immediate refresh to pick up practice session data
        setTimeout(() => {
          console.log('Immediate practice data refresh...');
          refreshPracticeSessionData();
        }, 1000);
        
        // Auto-detect and fix any mastery issues
        setTimeout(() => {
          console.log('Auto-detecting and fixing mastery issues...');
          autoFixMasteryIssues();
        }, 4000);
        
        // Check data restoration after Firebase load
        setTimeout(() => {
          console.log('Checking data restoration...');
          const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
          const masteryData = JSON.parse(sessionStorage.getItem('masteryData') || '[]');
          
          if (Object.keys(correctAnswers).length > 0) {
            console.log('✅ Correct answers data restored successfully');
          } else {
            console.log('⚠️ No correct answers data found - user may be new or data was lost');
          }
          
          const hasNonZeroMastery = masteryData.some(item => item.mastery > 0);
          if (hasNonZeroMastery) {
            console.log('✅ Mastery data with progress restored successfully');
          } else {
            console.log('ℹ️ All mastery at 0% - this is correct for new users');
          }
        }, 4500);
        
        // Check for level upgrades after all data is loaded
        setTimeout(() => {
          console.log('Checking for automatic level upgrades...');
          checkForLevelUpgrade();
        }, 5000);
        
        // Set up periodic auto-refresh every 2 minutes
        setInterval(() => {
          autoRefreshMasteryData();
          autoDetectModuleCompletions();
          recalculateOverallProgress();
          // Check for level upgrades every refresh cycle
          checkForLevelUpgrade();
        }, 120000);
        
        // Check if this page load is from practicing a topic
        checkTopicVisit();
      } else {
        console.log('No authenticated user, using session storage data...');
        // No user signed in, check session storage for fallback
        const storedUsername = sessionStorage.getItem('username');
        const storedLevel = sessionStorage.getItem('level');
        const storedModuleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
        
        // Debug: Log current progress data
        console.log('Profile loaded - Current progress data:');
        console.log('Username:', storedUsername);
        console.log('Level:', storedLevel);
        console.log('Module Progress:', storedModuleProgress);
        
        // Load learning analytics data from session storage if available
        const storedMasteryData = JSON.parse(sessionStorage.getItem('masteryData') || 'null');
        const storedLearningPath = JSON.parse(sessionStorage.getItem('learningPath') || 'null');  
        const storedAchievements = JSON.parse(sessionStorage.getItem('achievements') || 'null');

        if (storedUsername && storedLevel) {
          updateUI(storedUsername, storedLevel, storedModuleProgress, 0);
          
          // Update learning analytics if data is available
          if (storedMasteryData && storedLearningPath && storedAchievements) {
            updateLearningAnalytics(storedMasteryData, storedLearningPath, storedAchievements);
          }
          
          // Force progress bar updates with a longer delay to ensure DOM is ready
          setTimeout(() => {
            console.log('Forcing progress bar recalculation...');
            recalculateOverallProgress();
          }, 1000);
          
          // Also force a UI refresh after another delay
          setTimeout(() => {
            console.log('Forcing UI refresh...');
            updateUI(storedUsername, storedLevel, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
          }, 1500);
          
          // Auto-detect completed modules and update progress automatically
          setTimeout(() => {
            console.log('Auto-detecting module completions...');
            autoDetectModuleCompletions();
          }, 2500);
        } else {
          // No session data found, redirect to sign-in
          console.log('No user data found, redirecting to sign-in...');
          window.location.href = "index.html";
        }
      }
    });
  });

  // ✅ Navigation Functions
  // goToModules function removed - View Modules button no longer needed

  // Practice Topic Function
  window.practiceTopic = function(topic) {
    let pageUrl = '';
    
    // Map topics to their specific practice HTML pages
    switch(topic) {
      case "Introduction to derivatives":
        pageUrl = "practice-intro-derivatives.html";
        break;
      case "The definition of Derivative":
        pageUrl = "practice-definition-derivative.html";
        break;
      case "Rules of Differentiation":
        pageUrl = "practice-rules-differentiation.html";
        break;
      case "Equation of Tangent":
        pageUrl = "practice-equation-tangent.html";
        break;
      case "Second Derivative":
        pageUrl = "practice-second-derivative.html";
        break;
      case "Implicit Differentiations":
        pageUrl = "practice-implicit-differentiation.html";
        break;
      case "Linear Approximation & Differentials":
        pageUrl = "practice-linear-approx-differentials.html";
        break;
      default:
        // Default to quiz if specific page isn't found
        pageUrl = "quiz.html";
    }
    
    // Track practice attempt in session storage (for learning path tracking only)
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    practiceAttempts[topic] = (practiceAttempts[topic] || 0) + 1;
    sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
    
    // NOTE: Mastery is no longer updated here - only correct answers will increase mastery
    // Navigate to the practice page
    window.location.href = pageUrl;
  };

  // Function to specifically reset Linear Approximation & Differentials topic
  window.resetLinearApproxTopic = function() {
    const topicName = 'Linear Approximation & Differentials';
    
    // Remove from weak topics
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const updatedWeakTopics = weakTopics.filter(topic => topic !== topicName);
    sessionStorage.setItem('weakTopics', JSON.stringify(updatedWeakTopics));
    
    // Clear module progress for this topic
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const levels = ['Novice', 'Intermediate', 'Advanced'];
    levels.forEach(level => {
      const moduleKey = `${topicName} - ${level}`;
      delete moduleProgress[moduleKey];
    });
    sessionStorage.setItem('moduleProgress', JSON.stringify(moduleProgress));
    
    // Clear practice attempts for this topic
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    delete practiceAttempts[topicName];
    sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
    
    // Regenerate mastery data
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
      sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
      
    // Update UI
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    updateUI(userData.username, userData.level, moduleProgress, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Find the specific topic mastery
    const topicMastery = masteryData.find(item => item.topic === topicName);
    const masteryValue = topicMastery ? topicMastery.mastery : 'Unknown';
    
    // Show notification
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.innerHTML = `
      <div class="toast-icon">🔧</div>
        <div class="toast-content">
        <div class="toast-title">Linear Approximation Topic Reset</div>
        <div class="toast-message">Linear Approximation & Differentials reset to ${masteryValue}% mastery.</div>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 4000);
    
    console.log(`${topicName} reset complete. New mastery:`, masteryValue + '%');
  };

  // Function to fix Linear Approximation mastery to 0%
  window.forceFixLinearApproxMastery = function() {
    const topicName = 'Linear Approximation & Differentials';
    
    // Get current mastery data
    const masteryData = JSON.parse(sessionStorage.getItem('masteryData') || '[]');
    const topicMastery = masteryData.find(item => item.topic === topicName);
    
    if (topicMastery) {
      topicMastery.mastery = 0;
      topicMastery.badge = null;
      
      // Update session storage
      sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
      
      // Update UI
      const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
      const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
      updateLearningAnalytics(masteryData, learningPath, achievements);
      
      // Show notification
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.innerHTML = `
        <div class="toast-icon">🔧</div>
        <div class="toast-content">
          <div class="toast-title">Linear Approximation Fixed</div>
          <div class="toast-message">Mastery reset to 0% successfully!</div>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (document.body.contains(toast)) {
            document.body.removeChild(toast);
          }
        }, 500);
      }, 3000);
      
      console.log('Linear Approximation mastery fixed to 0%');
    }
  };

  // Function to refresh practice session data specifically
  window.refreshPracticeSessionData = function() {
    console.log('=== REFRESHING PRACTICE SESSION DATA ===');
    
    // Define all topics
    const topics = [
      'Introduction to derivatives',
      'The definition of Derivative',
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    let totalUpdated = 0;
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    
    console.log('Current correctAnswers before refresh:', correctAnswers);
    
    topics.forEach(topic => {
      const sessionKey = `practice_session_${topic}`;
      const practiceSessionData = JSON.parse(sessionStorage.getItem(sessionKey) || '{}');
      const localPracticeSessionData = JSON.parse(localStorage.getItem(sessionKey) || '{}');
      
      console.log(`\n--- Checking ${topic} ---`);
      console.log('SessionStorage data:', practiceSessionData);
      console.log('LocalStorage data:', localPracticeSessionData);
      
      // Use the most recent session data
      const useSessionStorage = !localPracticeSessionData.lastSaved || 
        (practiceSessionData.lastSaved && practiceSessionData.lastSaved > localPracticeSessionData.lastSaved);
      
      const sessionData = useSessionStorage ? practiceSessionData : localPracticeSessionData;
      const currentCorrect = correctAnswers[topic] || 0;
      
      console.log(`Using ${useSessionStorage ? 'sessionStorage' : 'localStorage'} data`);
      console.log(`Session correct answers: ${sessionData.correctAnswers || 0}`);
      console.log(`Current stored correct answers: ${currentCorrect}`);
      
      if (sessionData.correctAnswers && sessionData.correctAnswers > currentCorrect) {
        console.log(`✅ Updated ${topic}: ${currentCorrect} -> ${sessionData.correctAnswers} correct answers`);
        correctAnswers[topic] = sessionData.correctAnswers;
        totalUpdated++;
      } else if (sessionData.correctAnswers) {
        console.log(`ℹ️ ${topic}: No update needed (${sessionData.correctAnswers} <= ${currentCorrect})`);
      } else {
        console.log(`❌ ${topic}: No practice session data found`);
      }
    });
    
    if (totalUpdated > 0) {
      // Save updated correct answers
      sessionStorage.setItem('correctAnswers', JSON.stringify(correctAnswers));
      console.log(`Updated correct answers for ${totalUpdated} topics`);
      
      // Regenerate mastery data with updated practice session data
      const userData = {
        username: sessionStorage.getItem('username'),
        level: sessionStorage.getItem('level')
      };
      
      const masteryData = generateMasteryData(userData);
      sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
      
      // Update UI
      const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
      const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
      updateLearningAnalytics(masteryData, learningPath, achievements);
      
      console.log('Practice session data refresh complete');
      
      // Show success notification
      showToastNotification('🔄 Data Updated', `Progress updated for ${totalUpdated} topic${totalUpdated > 1 ? 's' : ''}!`, 'success');
    } else {
      console.log('No practice session updates needed');
      
      // Show info notification
      showToastNotification('ℹ️ Already Updated', 'Your progress is already up to date!', 'info');
    }
    
    console.log('=== PRACTICE SESSION DATA REFRESH COMPLETE ===');
  }

  // Debug function to check practice session data
  window.debugPracticeData = function() {
    console.log('=== PRACTICE DATA DEBUG ===');
    
    const topics = [
      'Introduction to derivatives',
      'The definition of Derivative',
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    console.log('Checking all practice session data...');
    
    topics.forEach(topic => {
      console.log(`\n--- ${topic} ---`);
      
      const sessionKey = `practice_session_${topic}`;
      const sessionData = JSON.parse(sessionStorage.getItem(sessionKey) || '{}');
      const localData = JSON.parse(localStorage.getItem(sessionKey) || '{}');
      
      console.log('SessionStorage data:', sessionData);
      console.log('LocalStorage data:', localData);
      
      if (sessionData.correctAnswers || localData.correctAnswers) {
        console.log('✅ Has practice data');
      } else {
        console.log('❌ No practice data found');
      }
    });
    
    console.log('\nCurrent correctAnswers storage:');
    console.log(JSON.parse(sessionStorage.getItem('correctAnswers') || '{}'));
    
    console.log('\nCurrent masteryData:');
    console.log(JSON.parse(sessionStorage.getItem('masteryData') || '[]'));
    
    console.log('=== END DEBUG ===');
  };

  // Test function to create sample practice data
  window.createTestPracticeData = function() {
    console.log('Creating test practice data...');
    
    const testData = {
      startTime: Date.now() - 300000, // 5 minutes ago
      totalQuestions: 5,
      correctAnswers: 3,
      attempts: {
        0: { count: 1, timeSpent: 30000, correct: true, answers: ['rate of change'] },
        1: { count: 2, timeSpent: 45000, correct: true, answers: ['speed', 'velocity'] },
        2: { count: 1, timeSpent: 25000, correct: true, answers: ['acceleration'] },
        3: { count: 3, timeSpent: 60000, correct: false, answers: ['dy', 'dx', 'dy/dx'] },
        4: { count: 2, timeSpent: 40000, correct: false, answers: ['gradient', 'slope'] }
      },
      timeSpent: 200000, // 3 minutes 20 seconds
      questionStartTime: Date.now(),
      sessionId: 'test_session_' + Date.now(),
      lastSaved: Date.now()
    };
    
    // Save test data for "Introduction to derivatives"
    const sessionKey = 'practice_session_Introduction to derivatives';
    sessionStorage.setItem(sessionKey, JSON.stringify(testData));
    localStorage.setItem(sessionKey, JSON.stringify(testData));
    
    console.log('Test data created for "Introduction to derivatives"');
    console.log('Test data:', testData);
    
    // Also update correctAnswers directly
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    correctAnswers['Introduction to derivatives'] = 3;
    sessionStorage.setItem('correctAnswers', JSON.stringify(correctAnswers));
    
    console.log('Updated correctAnswers:', correctAnswers);
    
    showToastNotification('🧪 Test Data Created', 'Sample practice data created for Introduction to derivatives', 'info');
  };

  // Function to force reset all progress bars to 0%
  // Reset progress functionality removed

  // Function to directly update progress bars without going through complex logic
  window.directUpdateProgressBars = function() {
    console.log('=== DIRECT PROGRESS BAR UPDATE ===');
    
    // Get current correct answers
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    console.log('Current correctAnswers:', correctAnswers);
    
    // Find all mastery items and update them directly
    const masteryItems = document.querySelectorAll('.mastery-item');
    
    masteryItems.forEach(item => {
      const titleElement = item.querySelector('.mastery-title');
      if (titleElement) {
        const topicName = titleElement.textContent.trim();
        const correctCount = correctAnswers[topicName] || 0;
        const masteryPercentage = Math.min(correctCount * 5, 75); // 5% per correct answer, max 75%
        
        // Progress bars have been removed - mastery is now shown in analytics section only
        
        // Update badge
        const badgeElement = item.querySelector('.mastery-badge');
        let newBadge = null;
        if (masteryPercentage >= 80) newBadge = 'M';
        else if (masteryPercentage >= 60) newBadge = 'P';
        else if (masteryPercentage >= 30) newBadge = 'L';
        else if (masteryPercentage > 0) newBadge = 'B';
        
        if (badgeElement) {
          if (newBadge) {
            badgeElement.textContent = newBadge;
            badgeElement.style.display = 'flex';
          } else {
            badgeElement.style.display = 'none';
          }
        }
        
        console.log(`Updated ${topicName}: ${correctCount} correct → ${masteryPercentage}% mastery`);
      }
    });
    
    console.log('Direct progress bar update complete');
    showToastNotification('📊 Bars Updated', 'Progress bars updated directly', 'success');
  };

  // Function to show toast notifications
  function showToastNotification(title, message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    
    let bgColor = '#17a2b8'; // info
    if (type === 'success') bgColor = '#28a745';
    if (type === 'warning') bgColor = '#ffc107';
    if (type === 'error') bgColor = '#dc3545';
    
    toast.style.backgroundColor = bgColor;
    toast.innerHTML = `
      <div class="toast-content">
        <div class="toast-title" style="color: white; font-weight: 700;">${title}</div>
        <div class="toast-message" style="color: #f8f9fa; font-size: 14px;">${message}</div>
      </div>
    `;
    
    // Add toast styles
    toast.style.cssText += `
      position: fixed;
      bottom: 30px;
      right: 30px;
      color: white;
      border: 2px solid var(--main-color);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 4px 4px var(--main-color);
      z-index: 1000;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.5s ease;
      max-width: 300px;
    `;
    
    document.body.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
      toast.style.transform = 'translateY(0)';
      toast.style.opacity = '1';
    }, 100);
    
    // Animate out after 3 seconds
    setTimeout(() => {
      toast.style.transform = 'translateY(100px)';
      toast.style.opacity = '0';
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 3000);
  }

  // Function to auto-refresh mastery data without notifications
  function autoRefreshMasteryData() {
    // Get current data
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    // Skip if no user data
    if (!userData.username || !userData.level) {
      console.log('Skipping auto-refresh - no user data');
      return;
    }
    
    // Regenerate mastery data
    const masteryData = generateMasteryData(userData);
    
    // Update session storage
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI quietly
    const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
    const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
    
    updateLearningAnalytics(masteryData, learningPath, achievements);
    
    console.log('Mastery data auto-refreshed successfully');
    
    // Save to Firebase if user is logged in (silently)
      const user = auth.currentUser;
      if (user) {
        saveUserData(user).then(() => {
        console.log("Auto-refreshed mastery data saved to Firebase");
        }).catch(error => {
        console.error("Error saving auto-refreshed mastery data:", error);
        });
      }
    }
    
  // Function to enable correct answers only mode
  window.enableCorrectAnswersOnlyMode = function() {
    // Clear all existing progress data
    sessionStorage.removeItem('weakTopics');
    sessionStorage.removeItem('recommendations');
    sessionStorage.removeItem('moduleProgress');
    sessionStorage.removeItem('practiceAttempts');
    sessionStorage.removeItem('correctAnswers');
    sessionStorage.removeItem('masteryData');
    sessionStorage.removeItem('learningPath');
    sessionStorage.removeItem('achievements');
    
    // Set empty data
    sessionStorage.setItem('weakTopics', '[]');
    sessionStorage.setItem('recommendations', '[]');
    sessionStorage.setItem('moduleProgress', '{}');
    sessionStorage.setItem('practiceAttempts', '{}');
    sessionStorage.setItem('correctAnswers', '{}');
    
    // Reset to beginner level
    const currentUsername = sessionStorage.getItem('username') || 'Guest';
    sessionStorage.setItem('level', 'Beginner');
    
    // Clear all existing mastery data and create fresh 0% mastery
    const masteryData = [
      { topic: 'Introduction to derivatives', mastery: 0, badge: null, description: 'Understanding what derivatives represent and their basic applications' },
      { topic: 'The definition of Derivative', mastery: 0, badge: null, description: 'Formal limit definition and identifying non-differentiable points' },
      { topic: 'Rules of Differentiation', mastery: 0, badge: null, description: 'Power rule, product rule, quotient rule, and other differentiation techniques' },
      { topic: 'Equation of Tangent', mastery: 0, badge: null, description: 'Finding and interpreting tangent lines to curves' },
      { topic: 'Second Derivative', mastery: 0, badge: null, description: 'Measuring rates of change of rates of change and analyzing concavity' },
      { topic: 'Implicit Differentiations', mastery: 0, badge: null, description: 'Differentiating equations where y is not isolated' },
      { topic: 'Linear Approximation & Differentials', mastery: 0, badge: null, description: 'Using derivatives to approximate function values' }
    ];
    
    // Generate fresh learning path and achievements
    const userData = { username: currentUsername, level: 'Beginner' };
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    // Save all data
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    sessionStorage.setItem('correctAnswersOnlyMode', 'true');
    
    // Update UI
    updateUI(currentUsername, 'Beginner', {}, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">🎯</div>
      <div class="toast-content">
        <div class="toast-title">Progress Reset Complete</div>
        <div class="toast-message">All progress reset to 0%. Mastery now increases only from correct answers!</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 5000);
    
    console.log('Progress reset complete - starting fresh with correct answers only mode');
  };

  // Function to test the correct answer system
  window.testCorrectAnswerSystem = function() {
    // Simulate a correct answer for Linear Approximation
    updateMasteryFromCorrectAnswer('Linear Approximation & Differentials', 1);
    
    console.log('Test: Added 1 correct answer for Linear Approximation & Differentials');
  };

  // Function to force reset to new user (0%)
  window.forceResetToNewUser = function() {
    // Clear all existing data that could affect mastery
    sessionStorage.removeItem('weakTopics');
    sessionStorage.removeItem('recommendations');
    sessionStorage.removeItem('moduleProgress');
    sessionStorage.removeItem('practiceAttempts');
    sessionStorage.removeItem('correctAnswers');
    sessionStorage.removeItem('masteryData');
    sessionStorage.removeItem('learningPath');
    sessionStorage.removeItem('achievements');
    
    // Set empty data
    sessionStorage.setItem('weakTopics', '[]');
    sessionStorage.setItem('recommendations', '[]');
    sessionStorage.setItem('moduleProgress', '{}');
    sessionStorage.setItem('practiceAttempts', '{}');
    sessionStorage.setItem('correctAnswers', '{}');
    
    // Keep user info but reset to beginner if needed
    const currentUsername = sessionStorage.getItem('username') || 'Guest';
    sessionStorage.setItem('level', 'Beginner');
    
    // Generate fresh mastery data (should be all 0%)
    const userData = {
      username: currentUsername,
      level: 'Beginner'
    };
    
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Update UI
    updateUI(currentUsername, 'Beginner', {}, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Debug: Show what mastery was generated
    console.log('=== FORCE RESET DEBUG ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">🔄</div>
      <div class="toast-content">
        <div class="toast-title">Reset to New User Complete</div>
        <div class="toast-message">All mastery reset to 0%. All topics should now show 0% mastery.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 5000);
    
    console.log('=== USER DATA RESET TO NEW USER STATE ===');
    console.log('All mastery should now be 0%');
  };

  // Function to clear all practice attempts
  window.clearAllPracticeAttempts = function() {
    // Clear all practice attempts
    sessionStorage.setItem('practiceAttempts', '{}');
    
    // Regenerate mastery data without practice attempts
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    
    // Update UI with fresh data
    const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
    const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
    updateLearningAnalytics(masteryData, learningPath, achievements);
    updateUI(userData.username, userData.level, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
    
    // Debug output
    console.log('=== PRACTICE ATTEMPTS CLEARED ===');
    masteryData.forEach(item => {
      console.log(`${item.topic}: ${item.mastery}%`);
    });
    
    // Show notification
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon">🗑️</div>
      <div class="toast-content">
        <div class="toast-title">Practice Attempts Cleared</div>
        <div class="toast-message">All practice attempts cleared. Mastery regenerated from correct answers only.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 4000);
  };

  // Function to automatically detect and fix mastery issues
  function autoFixMasteryIssues() {
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    // Skip if no user data
    if (!userData.username || !userData.level) {
      return;
    }
    
    // Check for new users and ensure 0% mastery
    const weakTopics = JSON.parse(sessionStorage.getItem('weakTopics') || '[]');
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    
    const hasQuizData = weakTopics.length > 0;
    const hasAnyModuleProgress = Object.keys(moduleProgress).length > 0 && Object.values(moduleProgress).some(progress => progress > 0);
    const hasAnyPracticeAttempts = Object.keys(practiceAttempts).length > 0 && Object.values(practiceAttempts).some(attempts => attempts > 0);
    const hasAnyCorrectAnswers = Object.keys(correctAnswers).length > 0;
    
    const isTrulyNewUser = !hasQuizData && !hasAnyModuleProgress && !hasAnyPracticeAttempts && !hasAnyCorrectAnswers;
    const isBeginnerWithoutData = userData.level === 'Beginner' && !hasQuizData && !hasAnyCorrectAnswers;
    
    if (isTrulyNewUser || isBeginnerWithoutData) {
      console.log('Auto-fixing: New user detected, ensuring all mastery is 0%');
      
      // Force regenerate mastery data
      const masteryData = generateMasteryData(userData);
      sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
      
      // Update UI silently
      const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
      const achievements = JSON.parse(sessionStorage.getItem('achievements') || '[]');
      updateLearningAnalytics(masteryData, learningPath, achievements);
      
      console.log('Auto-fix completed: All mastery set to 0% for new user');
    }
    
    // Clear any practice attempts that might be causing issues
    if (hasAnyPracticeAttempts && !hasAnyCorrectAnswers && !hasQuizData) {
      console.log('Auto-fixing: Clearing practice attempts for user with no actual progress');
      sessionStorage.setItem('practiceAttempts', '{}');
      
      // Regenerate mastery data
      const masteryData = generateMasteryData(userData);
      sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
      
      console.log('Auto-fix completed: Practice attempts cleared');
    }
  }

  // Function to reset user progress
  function resetUserProgress() {
    // Clear all existing progress data
    sessionStorage.removeItem('weakTopics');
    sessionStorage.removeItem('recommendations');
    sessionStorage.removeItem('moduleProgress');
    sessionStorage.removeItem('practiceAttempts');
    sessionStorage.removeItem('correctAnswers');
    sessionStorage.removeItem('masteryData');
    sessionStorage.removeItem('learningPath');
    sessionStorage.removeItem('achievements');
    
    // Set empty data
    sessionStorage.setItem('progress', '0');
    sessionStorage.setItem('moduleProgress', '{}');
    sessionStorage.setItem('correctAnswers', '{}');
    
    alert('✅ Progress reset successfully! Page will refresh.');
    window.location.reload();
  }

  // Test function to verify mastery tracking is working
  function testMasteryTracking() {
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    console.log('Current correct answers:', correctAnswers);
    
    // Simulate a correct answer for Introduction to derivatives
    correctAnswers['Introduction to derivatives'] = (correctAnswers['Introduction to derivatives'] || 0) + 1;
    sessionStorage.setItem('correctAnswers', JSON.stringify(correctAnswers));
    
    console.log('Added test correct answer. New data:', correctAnswers);
    
    // Force refresh of mastery data
    autoDetectModuleCompletions();
    autoFixMasteryIssues();
    
    alert(`✅ Test complete! Added 1 correct answer to "Introduction to derivatives". Total: ${correctAnswers['Introduction to derivatives']}`);
  }

  // Test function to verify data persistence after logout/login
  window.testDataPersistence = function() {
    const currentData = {
      correctAnswers: JSON.parse(sessionStorage.getItem('correctAnswers') || '{}'),
      masteryData: JSON.parse(sessionStorage.getItem('masteryData') || '[]'),
      moduleProgress: JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'),
      practiceAttempts: JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}')
    };
    
    console.log('=== CURRENT DATA BEFORE SAVE ===');
    console.log('Correct Answers:', currentData.correctAnswers);
    console.log('Mastery Data:', currentData.masteryData.map(item => `${item.topic}: ${item.mastery}%`));
    
    // Force save to Firebase
    autoSaveUserData().then(() => {
      alert('✅ Data saved to Firebase! You can now logout and login to test persistence.');
    }).catch(error => {
      alert('❌ Error saving data: ' + error.message);
    });
  };

  // Function to check if data was properly restored after login
  window.checkDataRestoration = function() {
    const restoredData = {
      correctAnswers: JSON.parse(sessionStorage.getItem('correctAnswers') || '{}'),
      masteryData: JSON.parse(sessionStorage.getItem('masteryData') || '[]'),
      moduleProgress: JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'),
      practiceAttempts: JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}')
    };
    
    console.log('=== DATA RESTORATION CHECK ===');
    console.log('Correct Answers restored:', restoredData.correctAnswers);
    console.log('Mastery Data restored:', restoredData.masteryData.map(item => `${item.topic}: ${item.mastery}%`));
    
    const hasCorrectAnswers = Object.keys(restoredData.correctAnswers).length > 0;
    const hasMasteryData = restoredData.masteryData.length > 0;
    const hasNonZeroMastery = restoredData.masteryData.some(item => item.mastery > 0);
    
    let status = '✅ Data restoration successful!\n\n';
    status += `Correct Answers: ${hasCorrectAnswers ? 'Found' : 'Missing'}\n`;
    status += `Mastery Data: ${hasMasteryData ? 'Found' : 'Missing'}\n`;
    status += `Non-zero Mastery: ${hasNonZeroMastery ? 'Found' : 'All Zero'}\n\n`;
    
    if (hasCorrectAnswers && hasMasteryData && hasNonZeroMastery) {
      status += '🎉 All data restored correctly!';
    } else {
      status += '⚠️ Some data may be missing or reset.';
    }
    
    alert(status);
    console.log(status);
  };

  // Function to auto-save user data to Firebase
  async function autoSaveUserData() {
      const user = auth.currentUser;
    if (user) {
      try {
        await saveUserData(user);
        console.log("Auto-save to Firebase completed");
    } catch (error) {
        console.error("Auto-save to Firebase failed:", error);
      }
    }
  }

  // Function to generate module options for dropdown with level-based access control
  window.generateModuleOptions = function(topic, userLevel, moduleProgress) {
    const levels = ['Novice', 'Intermediate', 'Advanced'];
    
    // Define level hierarchy
    const levelHierarchy = {
      'Beginner': 0,
      'Novice': 0,
      'Intermediate': 1,
      'Advanced': 2
    };
    
    const userLevelIndex = levelHierarchy[userLevel] || 0;
    
    // Create array of module options with priority scoring
    const moduleOptions = [];
    
    levels.forEach((level, levelIndex) => {
      const moduleKey = `${topic} - ${level}`;
      const progress = moduleProgress[moduleKey] || 0;
      const isCompleted = progress >= 80;
      
      // Lock modules that are above user's current level
      const isLocked = levelIndex > userLevelIndex;
      
      let statusClass = '';
      let statusText = '';
      let lockReason = '';
      let priority = 0;
      
      if (isCompleted) {
        statusClass = 'completed';
        statusText = '✓ Completed';
        priority = 1; // Completed modules have low priority
      } else if (isLocked) {
        statusClass = 'locked';
        // Determine what level user needs to unlock this module
        const requiredLevel = levels[levelIndex];
        const currentLevel = userLevel === 'Beginner' ? 'Novice' : userLevel;
        
        if (levelIndex === 1) { // Intermediate
          statusText = '🔒 Requires Intermediate Level';
          lockReason = `Complete more Novice modules to unlock Intermediate level`;
        } else if (levelIndex === 2) { // Advanced
          statusText = '🔒 Requires Advanced Level';
          lockReason = `Complete Intermediate modules to unlock Advanced level`;
        }
        priority = 0; // Locked modules have lowest priority
      } else {
        statusClass = 'available';
        statusText = `${progress}% Complete`;
        
        // Set priority based on user level and progress
        if (levelIndex === userLevelIndex) {
          // Current user level gets highest priority
          priority = 10;
          if (progress > 0 && progress < 80) {
            // In-progress modules get even higher priority
            priority = 15;
            statusClass = 'suggested';
            statusText = `📚 Continue: ${progress}% Complete`;
          } else if (progress === 0) {
            // New modules at user level get high priority  
            priority = 12;
            statusClass = 'suggested';
            statusText = '⭐ Recommended for you';
          }
        } else if (levelIndex < userLevelIndex) {
          // Lower levels get medium priority
          priority = 5;
        }
      }
      
      const moduleUrl = getModuleUrl(topic, level);
      
      // Create different behavior for locked vs unlocked modules
      const clickHandler = isLocked ? 'onclick="showLevelRequirementAlert(\'' + level + '\', \'' + userLevel + '\'); return false;"' : '';
      const href = isLocked ? '#' : moduleUrl;
      
      moduleOptions.push({
        priority,
        html: `
          <a href="${href}" class="module-option ${statusClass}" ${clickHandler}>
            <div class="module-option-content">
              <span class="level-badge ${level.toLowerCase()}">${level}</span>
              <div class="module-option-text">
                <div class="module-option-title">${topic} - ${level}</div>
                <div class="module-option-desc" title="${isLocked ? lockReason : statusText}">${statusText}</div>
              </div>
              ${isCompleted ? '<div class="completion-indicator"><span class="completion-checkmark">✓</span><span class="completion-text">DONE</span></div>' : ''}
              ${isLocked ? '<div class="lock-indicator"><span class="lock-icon">🔒</span><span class="lock-text">LOCKED</span></div>' : ''}
            </div>
          </a>
        `
      });
    });
    
    // Sort by priority (highest first), then by level index
    moduleOptions.sort((a, b) => {
      if (b.priority !== a.priority) {
        return b.priority - a.priority;
      }
      // If same priority, maintain original order (Novice -> Intermediate -> Advanced)
      return 0;
    });
    
    // Return the sorted HTML
    return moduleOptions.map(option => option.html).join('');
  };

  // Function to get recommendation class based on level
  window.getRecommendationClass = function(level) {
    switch(level) {
      case 'Novice': return 'novice-rec';
      case 'Intermediate': return 'intermediate-rec';
      case 'Advanced': return 'advanced-rec';
      default: return 'novice-rec';
    }
  };

  // Function to show level requirement alert when trying to access locked modules
  window.showLevelRequirementAlert = function(requiredLevel, currentLevel) {
    // Create custom alert modal
    const alertModal = document.createElement('div');
    alertModal.className = 'custom-alert';
    
    alertModal.innerHTML = `
      <div class="alert-overlay">
        <div class="alert-content">
          <div class="alert-header">
            <span class="alert-icon">🔒</span>
            <h3>Module Locked</h3>
            <button class="alert-close" onclick="this.closest('.custom-alert').remove()">×</button>
          </div>
          <div class="alert-body">
            <p><strong>${requiredLevel} Level Required</strong></p>
            <p>This module requires <strong>${requiredLevel}</strong> level access. You are currently at <strong>${currentLevel}</strong> level.</p>
            
            <div class="alert-details">
              <h4>How to unlock ${requiredLevel} modules:</h4>
              ${getUnlockInstructions(requiredLevel, currentLevel)}
            </div>
          </div>
          <div class="alert-footer">
            ${requiredLevel === 'Intermediate' ? '<button class="alert-btn quiz-btn" onclick="window.location.href=\'quiz.html\'">Take Assessment Quiz</button>' : ''}
            <button class="alert-btn close-btn" onclick="this.closest(\'.custom-alert\').remove()">Close</button>
          </div>
        </div>
      </div>
    `;
    
    document.body.appendChild(alertModal);
    
    // Animate in
    setTimeout(() => {
      alertModal.style.opacity = '1';
    }, 10);
  };

  // Function to get unlock instructions based on required level
  function getUnlockInstructions(requiredLevel, currentLevel) {
    if (requiredLevel === 'Intermediate') {
      return `
        <p>• Complete more <strong>Novice</strong> level modules</p>
        <p>• Take the assessment quiz to evaluate your progress</p>
        <p>• Achieve good scores in practice sessions</p>
        <p>• Your level will automatically upgrade when you're ready</p>
      `;
    } else if (requiredLevel === 'Advanced') {
      return `
        <p>• Complete several <strong>Intermediate</strong> level modules</p>
        <p>• Demonstrate mastery in calculus concepts</p>
        <p>• Score well in quizzes and practice sessions</p>
        <p>• Your level will automatically upgrade to Advanced</p>
      `;
    }
    return '<p>Continue learning and your level will upgrade automatically!</p>';
  }

  // Function to manually mark a topic as completed
  window.markTopicCompleted = function(topicName) {
    // Update practice attempts to mark as visited
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    practiceAttempts[topicName] = Math.max(practiceAttempts[topicName] || 0, 1);
    sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
    
    // Regenerate learning path and mastery data
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    // Update session storage
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Update UI
    updateLearningAnalytics(masteryData, learningPath, achievements);
    updateUI(userData.username, userData.level, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
    
    // Show completion notification
    showTopicCompletionNotification(topicName);
    
    // Auto-save to Firebase
    autoSaveUserData();
  };

  // Function to show topic completion notification
  function showTopicCompletionNotification(topicName) {
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.innerHTML = `
      <div class="toast-icon" style="color: var(--tertiary-color); font-size: 28px;">✅</div>
      <div class="toast-content">
        <div class="toast-title" style="color: var(--tertiary-color);">Topic Completed!</div>
        <div class="toast-message">"${topicName}" has been marked as completed in your learning path.</div>
      </div>
    `;
    
    document.body.appendChild(toast);
    
    // Animate the toast in
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    // Animate the toast out after 4 seconds
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
      }, 500);
    }, 4000);
  }

  // Test function to demonstrate completion styling
  window.testTopicCompletion = function() {
    // Mark "Introduction to derivatives" as completed for demonstration
    const topicName = 'Introduction to derivatives';
    
    // Update practice attempts to mark as visited
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    practiceAttempts[topicName] = 5; // Mark as visited multiple times
    sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
    
    // Also add some module progress to ensure completion detection
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    moduleProgress[`${topicName} - Novice`] = 85; // Mark novice level as completed
    sessionStorage.setItem('moduleProgress', JSON.stringify(moduleProgress));
    
    // Add some correct answers
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    correctAnswers[topicName] = 3;
    sessionStorage.setItem('correctAnswers', JSON.stringify(correctAnswers));
    
    // Regenerate all data
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    // Update session storage
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Force complete UI update
    updateUI(userData.username, userData.level, moduleProgress, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Show completion notification
    showTopicCompletionNotification(topicName);
    
    console.log('✅ Test completion applied to "Introduction to derivatives"');
    console.log('Learning path data:', learningPath);
    
    // Auto-save to Firebase
    autoSaveUserData();
  };

  // Function to check current completion status
  window.checkCompletionStatus = function() {
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    const learningPath = JSON.parse(sessionStorage.getItem('learningPath') || '[]');
    
    console.log('=== COMPLETION STATUS CHECK ===');
    console.log('Practice attempts:', practiceAttempts);
    console.log('Module progress:', moduleProgress);
    console.log('Correct answers:', correctAnswers);
    console.log('Learning path completion status:');
    
    learningPath.forEach(step => {
      console.log(`${step.title}: ${step.status} (completed: ${step.isCompleted})`);
    });
    
    return {
      practiceAttempts,
      moduleProgress,
      correctAnswers,
      learningPath
    };
  };

  // Function to check if user came from a topic page and mark it as completed automatically
  function checkTopicVisit() {
    // Get the previous page URL
    const referrer = document.referrer;
    if (!referrer) return;
    
    // Extract the filename from the referrer
    const filename = referrer.substring(referrer.lastIndexOf('/') + 1);
    
    // Map filenames to topics
    const filenameToTopic = {
      'Introduction_to_derivatives.html': 'Introduction to derivatives',
      'The_definition_of_derivative.html': 'The definition of Derivative',
      'rule.html': 'Rules of Differentiation',
      'Equation-of-tangent.html': 'Equation of Tangent',
      'Second-derivative.html': 'Second Derivative',
      'Implicit-differentiation.html': 'Implicit Differentiations',
      'linear-approx-differentials.html': 'Linear Approximation & Differentials'
    };
    
    const topic = filenameToTopic[filename];
    
    // If we came from a topic page, update the completion data
    if (topic) {
      console.log(`✅ Detected visit from topic page: ${topic}`);
      
      // Update practice attempts (this tracks theory page visits)
      const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
      practiceAttempts[topic] = (practiceAttempts[topic] || 0) + 1;
      sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
      
      // Regenerate all learning data to reflect the visit
      const userData = {
        username: sessionStorage.getItem('username'),
        level: sessionStorage.getItem('level')
      };
      
      const masteryData = generateMasteryData(userData);
      const learningPath = generateLearningPath(userData);
      const achievements = generateAchievements(userData);
      
      sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
      sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
      sessionStorage.setItem('achievements', JSON.stringify(achievements));
      
      // Update UI immediately
      updateLearningAnalytics(masteryData, learningPath, achievements);
      updateUI(userData.username, userData.level, JSON.parse(sessionStorage.getItem('moduleProgress') || '{}'), 0);
      
      // Show subtle completion notification
      showTopicCompletionNotification(topic);
      
      // Auto-save to Firebase
      autoSaveUserData();
      
      console.log(`✅ Topic "${topic}" marked as completed automatically`);
    }
  }

  // Enhanced function to automatically detect and refresh completion status
  function autoDetectModuleCompletions() {
    const practiceAttempts = JSON.parse(sessionStorage.getItem('practiceAttempts') || '{}');
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const correctAnswers = JSON.parse(sessionStorage.getItem('correctAnswers') || '{}');
    
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    let hasNewCompletions = false;
    
    // Check each topic for completion criteria
    browseTopics.forEach(topic => {
      const visits = practiceAttempts[topic] || 0;
      const topicCorrectAnswers = correctAnswers[topic] || 0;
      
      // Check if any module for this topic is completed (80%+)
      const noviceProgress = moduleProgress[`${topic} - Novice`] || 0;
      const intermediateProgress = moduleProgress[`${topic} - Intermediate`] || 0;
      const advancedProgress = moduleProgress[`${topic} - Advanced`] || 0;
      const hasCompletedModule = noviceProgress >= 80 || intermediateProgress >= 80 || advancedProgress >= 80;
      
      // If topic should be marked as completed but isn't tracked yet
      if ((hasCompletedModule || topicCorrectAnswers > 0) && visits === 0) {
        practiceAttempts[topic] = 1; // Mark as visited
        hasNewCompletions = true;
        console.log(`✅ Auto-detected completion for: ${topic}`);
      }
    });
    
    if (hasNewCompletions) {
      sessionStorage.setItem('practiceAttempts', JSON.stringify(practiceAttempts));
      
      // Regenerate all data
      const userData = {
        username: sessionStorage.getItem('username'),
        level: sessionStorage.getItem('level')
      };
      
      const masteryData = generateMasteryData(userData);
      const learningPath = generateLearningPath(userData);
      const achievements = generateAchievements(userData);
      
        sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
      sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
      sessionStorage.setItem('achievements', JSON.stringify(achievements));
      
      // Update UI
      updateLearningAnalytics(masteryData, learningPath, achievements);
      updateUI(userData.username, userData.level, moduleProgress, 0);
      
      console.log('✅ Auto-detection completed - UI updated');
    }
    
    // Check for level upgrade after detection
    checkForLevelUpgrade();
  }

  // Function to check if user should be upgraded to next level
  function checkForLevelUpgrade() {
    const currentLevel = sessionStorage.getItem('level') || 'Beginner';
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    // Check completion for current level
    let shouldUpgrade = false;
    let newLevel = currentLevel;
    
    if (currentLevel === 'Beginner' || currentLevel === 'Novice') {
      // Check if all Novice modules are completed (80%+)
      const noviceCompletedCount = browseTopics.filter(topic => {
        const moduleKey = `${topic} - Novice`;
        return (moduleProgress[moduleKey] || 0) >= 80;
      }).length;
      
      // Require at least 5 out of 7 topics to be completed for upgrade
      if (noviceCompletedCount >= 5) {
        shouldUpgrade = true;
        newLevel = 'Intermediate';
        console.log(`🎉 Sufficient Novice modules completed (${noviceCompletedCount}/${browseTopics.length})! Upgrading to Intermediate level`);
      }
    } else if (currentLevel === 'Intermediate') {
      // Check if all Intermediate modules are completed
      const intermediateCompletedCount = browseTopics.filter(topic => {
        const moduleKey = `${topic} - Intermediate`;
        return (moduleProgress[moduleKey] || 0) >= 80;
      }).length;
      
      // Require at least 5 out of 7 topics to be completed for upgrade
      if (intermediateCompletedCount >= 5) {
        shouldUpgrade = true;
        newLevel = 'Advanced';
        console.log(`🎉 Sufficient Intermediate modules completed (${intermediateCompletedCount}/${browseTopics.length})! Upgrading to Advanced level`);
      }
    }
    
    if (shouldUpgrade && newLevel !== currentLevel) {
      performLevelUpgrade(currentLevel, newLevel);
    }
    
    return { shouldUpgrade, newLevel, currentLevel };
  }

  // Function to perform the actual level upgrade
  function performLevelUpgrade(oldLevel, newLevel) {
    // Update level in session storage
    sessionStorage.setItem('level', newLevel);
    
    // Regenerate all learning data with new level
    const userData = {
      username: sessionStorage.getItem('username'),
      level: newLevel
    };
    
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    const achievements = generateAchievements(userData);
    
    // Update session storage
    sessionStorage.setItem('masteryData', JSON.stringify(masteryData));
    sessionStorage.setItem('learningPath', JSON.stringify(learningPath));
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Update UI immediately
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    updateUI(userData.username, newLevel, moduleProgress, 0);
    updateLearningAnalytics(masteryData, learningPath, achievements);
    recalculateOverallProgress();
    
    // Show level upgrade celebration
    showLevelUpgradeNotification(oldLevel, newLevel);
    
    // Auto-save to Firebase
    autoSaveUserData();
    
    console.log(`✅ Level upgrade complete: ${oldLevel} → ${newLevel}`);
  }

  // Function to show level upgrade celebration notification
  function showLevelUpgradeNotification(oldLevel, newLevel) {
    const toast = document.createElement('div');
    toast.className = 'toast-notification';
    toast.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
    toast.style.border = '3px solid #ff6b6b';
    toast.style.boxShadow = '0 8px 25px rgba(255, 215, 0, 0.4), 0 0 30px rgba(255, 107, 107, 0.3)';
    
    toast.innerHTML = `
      <div class="toast-icon" style="color: #ff6b6b; font-size: 32px; animation: bounce 1s infinite;">🎉</div>
      <div class="toast-content">
        <div class="toast-title" style="color: #ff6b6b; font-size: 18px; font-weight: 700;">LEVEL UP!</div>
        <div class="toast-message" style="color: #333; font-weight: 600;">
          Congratulations! You've been upgraded from <strong>${oldLevel}</strong> to <strong>${newLevel}</strong> level!<br>
          <small style="color: #666;">New modules are now unlocked for you to explore!</small>
            </div>
          </div>
    `;
    
    document.body.appendChild(toast);
    
    // Add bounce animation
    const style = document.createElement('style');
    style.textContent = `
      @keyframes bounce {
        0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
        40% { transform: translateY(-10px); }
        60% { transform: translateY(-5px); }
      }
    `;
    document.head.appendChild(style);
    
    // Animate the toast in
    setTimeout(() => {
      toast.classList.add('show');
    }, 100);
    
    // Keep it visible longer for celebration
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => {
        if (document.body.contains(toast)) {
          document.body.removeChild(toast);
        }
        if (document.head.contains(style)) {
          document.head.removeChild(style);
        }
      }, 500);
    }, 8000); // Show for 8 seconds
  }

  // Function to get level completion statistics
  window.getLevelCompletionStats = function() {
    const currentLevel = sessionStorage.getItem('level') || 'Beginner';
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    const levels = ['Novice', 'Intermediate', 'Advanced'];
    const stats = {};
    
    levels.forEach(level => {
      const completedCount = browseTopics.filter(topic => {
        const moduleKey = `${topic} - ${level}`;
        return (moduleProgress[moduleKey] || 0) >= 80;
      }).length;
      
      stats[level] = {
        completed: completedCount,
        total: browseTopics.length,
        percentage: Math.round((completedCount / browseTopics.length) * 100)
      };
    });
    
    return {
      currentLevel,
      stats,
      readyForUpgrade: checkForLevelUpgrade()
    };
  };

  // ✅ Logout Function
  window.logout = async function() {
    try {
      const user = auth.currentUser;
      if (user) {
        // Save user data before logging out
        await saveUserData(user);
        console.log("User data saved before logout");
      }
      
      // Sign out from Firebase
      await signOut(auth);
      console.log("User signed out successfully");
      
      // Clear session storage
      sessionStorage.clear();
      
      // Show logout notification
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.innerHTML = `
        <div class="toast-icon">👋</div>
        <div class="toast-content">
          <div class="toast-title">Logged Out</div>
          <div class="toast-message">You have been successfully logged out!</div>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.classList.add('show');
      }, 100);
      
      // Redirect to sign-in page after a short delay
      setTimeout(() => {
        window.location.href = "index.html";
      }, 1500);
      
    } catch (error) {
      console.error("Error during logout:", error);
      alert("Error logging out. Please try again.");
    }
  };

  // Function to show loading animation
  window.showLoadingAnimation = function() {
    // Remove any existing loader
    const existingLoader = document.getElementById('loading-overlay');
    if (existingLoader) {
      existingLoader.remove();
    }
    
    // Create overlay
    const overlay = document.createElement('div');
    overlay.id = 'loading-overlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 10000;
      backdrop-filter: blur(5px);
    `;
    
    // Create loader container
    const loaderContainer = document.createElement('div');
    loaderContainer.innerHTML = `
      <div class="loader">
        <span class="l">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 11 18" height="18" width="11" class="letter">
            <path fill="white" d="M0.28 16.14V0.94L3.7 0.64L5.7 1.64V12.3L8.5 12.06L10.5 13.06V16.44L2.28 17.14L0.28 16.14ZM3.5 12.7V0.859999L0.48 1.12V15.94L8.3 15.26V12.28L3.5 12.7Z"></path>
          </svg>
        </span>
        <span class="o">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 16 18" height="18" width="16" class="letter">
            <path fill="white" d="M8.94 17.24C8.84667 17.2533 8.74667 17.26 8.64 17.26C8.54667 17.26 8.45333 17.26 8.36 17.26C7.66667 17.26 7.02667 17.16 6.44 16.96C5.86667 16.7733 5.30667 16.5533 4.76 16.3C3.33333 15.5933 2.28667 14.6 1.62 13.32C0.966667 12.0267 0.64 10.4933 0.64 8.72C0.64 7.68 0.766667 6.67333 1.02 5.7C1.28667 4.71333 1.68 3.82667 2.2 3.04C2.72 2.24 3.36667 1.58667 4.14 1.08C4.92667 0.573332 5.84667 0.273333 6.9 0.18C7.00667 0.166666 7.10667 0.159999 7.2 0.159999C7.29333 0.159999 7.38667 0.159999 7.48 0.159999C8.14667 0.159999 8.74 0.246666 9.26 0.419999C9.78 0.579999 10.3067 0.766666 10.84 0.979999C11.8 1.36667 12.6 1.94 13.24 2.7C13.88 3.46 14.36 4.35333 14.68 5.38C15 6.39333 15.16 7.48 15.16 8.64C15.16 9.72 15.0333 10.7533 14.78 11.74C14.5267 12.7267 14.14 13.62 13.62 14.42C13.1133 15.2067 12.4667 15.8467 11.68 16.34C10.9067 16.8467 9.99333 17.1467 8.94 17.24ZM6.92 16.04C7.94667 15.96 8.84 15.68 9.6 15.2C10.36 14.7067 10.9867 14.0733 11.48 13.3C11.9733 12.5133 12.34 11.64 12.58 10.68C12.8333 9.70667 12.96 8.69333 12.96 7.64C12.96 6.68 12.8467 5.76667 12.62 4.9C12.4067 4.02 12.0733 3.24 11.62 2.56C11.1667 1.88 10.5933 1.34667 9.9 0.959999C9.22 0.559999 8.41333 0.359999 7.48 0.359999C7.38667 0.359999 7.29333 0.359999 7.2 0.359999C7.12 0.359999 7.02667 0.366666 6.92 0.38C5.89333 0.473333 5 0.766666 4.24 1.26C3.48 1.74 2.84667 2.37333 2.34 3.16C1.83333 3.93333 1.45333 4.8 1.2 5.76C0.96 6.70667 0.84 7.69333 0.84 8.72C0.84 9.72 0.953333 10.6667 1.18 11.56C1.40667 12.44 1.74667 13.22 2.2 13.9C2.65333 14.5667 3.22667 15.0933 3.92 15.48C4.61333 15.8667 5.42 16.06 6.34 16.06C6.44667 16.06 6.54667 16.06 6.64 16.06C6.73333 16.06 6.82667 16.0533 6.92 16.04ZM6.92 12.94C6.86667 12.94 6.81333 12.9467 6.76 12.96C6.72 12.96 6.67333 12.96 6.62 12.96C5.82 12.96 5.18667 12.6133 4.72 11.92C4.26667 11.2267 4.04 10.0667 4.04 8.44C4.04 7.28 4.16667 6.34667 4.42 5.64C4.67333 4.93333 5.02 4.41333 5.46 4.08C5.9 3.73333 6.38667 3.54 6.92 3.5C6.97333 3.5 7.02667 3.5 7.08 3.5C7.13333 3.48667 7.18667 3.48 7.24 3.48C8.02667 3.48 8.64 3.82 9.08 4.5C9.52 5.16667 9.74 6.31333 9.74 7.94C9.74 9.67333 9.47333 10.9267 8.94 11.7C8.42 12.46 7.74667 12.8733 6.92 12.94ZM6.86 12.74C7.64667 12.6733 8.28667 12.2733 8.78 11.54C9.28667 10.8067 9.54 9.60667 9.54 7.94C9.54 7.18 9.49333 6.53333 9.4 6C9.30667 5.46667 9.16667 5.03333 8.98 4.7C8.91333 4.68667 8.84667 4.68 8.78 4.68C8.71333 4.66667 8.64667 4.66 8.58 4.66C7.79333 4.66 7.20667 5.07333 6.82 5.9C6.43333 6.71333 6.24 7.89333 6.24 9.44C6.24 10.2133 6.29333 10.8733 6.4 11.42C6.50667 11.9533 6.66 12.3933 6.86 12.74Z"></path>
          </svg>
        </span>
        <span class="a">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 15 18" height="18" width="15" class="letter">
            <path fill="white" d="M9.28 15.76L8.54 13.38L6.96 13.52L5.98 17.02L2.58 17.32L0.58 16.32L4.96 0.699999L8.26 0.419999L10.26 1.42L14.72 16.48L11.28 16.76L9.28 15.76ZM5.12 0.899999L0.88 16.08L3.8 15.84L4.8 12.34L8.36 12.02L9.42 15.56L12.44 15.3L8.1 0.64L5.12 0.899999ZM5.5 9.42C5.75333 8.59333 5.96 7.80667 6.12 7.06C6.29333 6.31333 6.44 5.56667 6.56 4.82H6.64C6.74667 5.55333 6.88 6.27333 7.04 6.98C7.21333 7.67333 7.42 8.42 7.66 9.22L5.5 9.42Z"></path>
          </svg>
        </span>
        <span class="d">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 18" height="18" width="14" class="letter">
            <path fill="white" d="M0.28 16.24V1.04L4.44 0.679999C4.61333 0.666666 4.78 0.66 4.94 0.66C5.1 0.646666 5.24667 0.64 5.38 0.64C6.11333 0.64 6.76667 0.726666 7.34 0.899999C7.92667 1.07333 8.56667 1.32667 9.26 1.66C10.1933 2.08667 10.9533 2.61333 11.54 3.24C12.1267 3.85333 12.56 4.61333 12.84 5.52C13.12 6.41333 13.26 7.50667 13.26 8.8C13.26 10.4933 12.9733 11.92 12.4 13.08C11.84 14.24 11.0667 15.1333 10.08 15.76C9.09333 16.3733 7.95333 16.74 6.66 16.86L2.28 17.24L0.28 16.24ZM4.64 15.68C5.89333 15.5733 7 15.2133 7.96 14.6C8.93333 13.9867 9.69333 13.1133 10.24 11.98C10.7867 10.8467 11.06 9.45333 11.06 7.8C11.06 5.53333 10.5733 3.80667 9.6 2.62C8.64 1.43333 7.21333 0.84 5.32 0.84C5.18667 0.84 5.04667 0.846666 4.9 0.859999C4.75333 0.859999 4.60667 0.866666 4.46 0.879999L0.48 1.22V16.02L4.64 15.68ZM3.5 3.9L4.08 3.86C4.22667 3.84667 4.36 3.84 4.48 3.84C4.61333 3.82667 4.74667 3.82 4.88 3.82C5.57333 3.82 6.14 3.94667 6.58 4.2C7.03333 4.45333 7.36667 4.88667 7.58 5.5C7.80667 6.11333 7.92 6.97333 7.92 8.08C7.92 9.65333 7.59333 10.8067 6.94 11.54C6.28667 12.26 5.4 12.6667 4.28 12.76L3.5 12.82V3.9ZM5.7 12.2C6.38 11.9067 6.88667 11.4333 7.22 10.78C7.55333 10.1133 7.72 9.21333 7.72 8.08C7.72 6.66667 7.52 5.65333 7.12 5.04C7.06667 5.02667 7.01333 5.02 6.96 5.02C6.90667 5.02 6.85333 5.02 6.8 5.02C6.68 5.02 6.56 5.02667 6.44 5.04C6.33333 5.04 6.22 5.04667 6.1 5.06L5.7 5.08V12.2Z"></path>
          </svg>
        </span>
        <span class="ispan">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 6 17" height="18" width="6" class="letter i">
            <path fill="white" d="M0.38 15.96V0.76L3.86 0.439999L5.86 1.44V16.64L2.38 16.94L0.38 15.96ZM0.58 0.94V15.74L3.66 15.46V0.66L0.58 0.94Z"></path>
          </svg>
        </span>
        <span class="n">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 13 18" height="18" width="13" class="letter">
            <path fill="white" d="M7.22 15.82L5.72 12.44V16.92L2.28 17.22L0.28 16.22V1.02L3.52 0.74L5.52 1.74L7 4.94V0.64L10.48 0.319999L12.48 1.32V16.54L9.22 16.82L7.22 15.82ZM7.2 0.819999V6.42C7.2 6.56667 7.20667 6.80667 7.22 7.14C7.23333 7.46 7.24667 7.8 7.26 8.16C7.28667 8.50667 7.30667 8.80667 7.32 9.06C7.33333 9.3 7.34 9.42 7.34 9.42L7.28 9.46C7.28 9.46 7.26 9.38667 7.22 9.24C7.19333 9.09333 7.14667 8.92 7.08 8.72C7.01333 8.50667 6.94 8.31333 6.86 8.14L3.4 0.959999L0.48 1.2V16L3.52 15.76V10.52C3.52 10.36 3.51333 10.0867 3.5 9.7C3.48667 9.31333 3.47333 8.90667 3.46 8.48C3.46 8.05333 3.45333 7.69333 3.44 7.4C3.42667 7.09333 3.42 6.94 3.42 6.94L3.48 6.92C3.48 6.92 3.51333 7.05333 3.58 7.32C3.66 7.57333 3.76667 7.84 3.9 8.12L7.4 15.62L10.28 15.36V0.539999L7.2 0.819999Z"></path>
          </svg>
        </span>
        <span class="g">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 15 18" height="18" width="15" class="letter">
            <path fill="white" d="M14.04 13.72C13.64 14.6533 12.9933 15.44 12.1 16.08C11.22 16.72 10.1333 17.0933 8.84 17.2C8.72 17.2133 8.6 17.22 8.48 17.22C8.36 17.22 8.24 17.22 8.12 17.22C7.12 17.22 6.16667 17.0467 5.26 16.7C4.36667 16.3533 3.57333 15.8333 2.88 15.14C2.18667 14.4333 1.64 13.54 1.24 12.46C0.84 11.38 0.64 10.1 0.64 8.62C0.64 7.48667 0.78 6.42667 1.06 5.44C1.34 4.44 1.74667 3.55333 2.28 2.78C2.82667 2.00667 3.48667 1.38667 4.26 0.92C5.03333 0.453333 5.90667 0.179999 6.88 0.0999997C6.96 0.0866657 7.04 0.0799987 7.12 0.0799987C7.2 0.0799987 7.28 0.0799987 7.36 0.0799987C8.33333 0.0799987 9.28 0.299999 10.2 0.74C11.1333 1.18 11.9467 1.78 12.64 2.54C13.3467 3.3 13.8467 4.16 14.14 5.12L11.76 6.46L12.04 6.44L14.04 7.44V13.72ZM5.9 7.16V10L8.98 9.74V11.46C8.80667 11.8067 8.52667 12.1067 8.14 12.36C7.76667 12.6 7.37333 12.7333 6.96 12.76C6.90667 12.7733 6.84667 12.78 6.78 12.78C6.72667 12.78 6.66667 12.78 6.6 12.78C5.73333 12.78 5.08 12.4333 4.64 11.74C4.2 11.0467 3.98 9.92 3.98 8.36C3.98 6.94667 4.20667 5.82 4.66 4.98C5.11333 4.14 5.84 3.68 6.84 3.6H7.06C7.60667 3.6 8.07333 3.76 8.46 4.08C8.86 4.4 9.14667 4.86667 9.32 5.48L11.9 4.02C11.6733 3.38 11.36 2.78 10.96 2.22C10.5733 1.64667 10.0867 1.18 9.5 0.819999C8.91333 0.459999 8.2 0.28 7.36 0.28C7.29333 0.28 7.22 0.28 7.14 0.28C7.06 0.28 6.98 0.286666 6.9 0.299999C5.63333 0.406666 4.54667 0.846666 3.64 1.62C2.73333 2.38 2.04 3.37333 1.56 4.6C1.08 5.81333 0.84 7.15333 0.84 8.62C0.84 10.14 1.06 11.4533 1.5 12.56C1.94 13.6667 2.56667 14.52 3.38 15.12C4.19333 15.72 5.16 16.02 6.28 16.02C6.37333 16.02 6.46 16.02 6.54 16.02C6.63333 16.02 6.72667 16.0133 6.82 16C8.07333 15.8933 9.12667 15.54 9.98 14.94C10.8467 14.3267 11.4733 13.5733 11.86 12.68V6.66L5.9 7.16ZM9.2 5.78C9.14667 5.59333 9.08667 5.42 9.02 5.26C8.95333 5.08667 8.88 4.93333 8.8 4.8C8.2 4.85333 7.70667 5.06667 7.32 5.44C6.94667 5.8 6.66667 6.29333 6.48 6.92L10.8 6.56L9.2 5.78ZM7.8 11.26L6.24 10.46C6.26667 10.9933 6.32 11.4133 6.4 11.72C6.49333 12.0133 6.62667 12.3 6.8 12.58C6.84 12.5667 6.88667 12.56 6.94 12.56C7.28667 12.5333 7.63333 12.4267 7.98 12.24C8.32667 12.04 8.59333 11.8067 8.78 11.54V11.14L7.8 11.26Z"></path>
          </svg>
        </span>
      </div>
    `;
    
    overlay.appendChild(loaderContainer);
    document.body.appendChild(overlay);
    
    // Add click to close
    overlay.addEventListener('click', function() {
      overlay.remove();
    });
    
    // Auto close after 3 seconds
    setTimeout(() => {
      if (document.body.contains(overlay)) {
        overlay.remove();
      }
    }, 3000);
  };

  // DEBUG FUNCTION: Force refresh achievements and check Novice Master status
  window.debugNoviceMasterAchievement = function() {
    console.log('🔍 DEBUGGING NOVICE MASTER ACHIEVEMENT - MANUAL TRIGGER');
    
    // Get current data
    const moduleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
    const userData = {
      username: sessionStorage.getItem('username'),
      level: sessionStorage.getItem('level')
    };
    
    console.log('Current user data:', userData);
    console.log('Current module progress:', moduleProgress);
    
    // Create debug summary for alert
    let debugSummary = '=== NOVICE MASTER DEBUG SUMMARY ===\n';
    debugSummary += `User: ${userData.username}, Level: ${userData.level}\n\n`;
    debugSummary += 'NOVICE MODULE PROGRESS:\n';
    
    const browseTopics = [
      'Introduction to derivatives',
      'The definition of Derivative', 
      'Rules of Differentiation',
      'Equation of Tangent',
      'Second Derivative',
      'Implicit Differentiations',
      'Linear Approximation & Differentials'
    ];
    
    let allComplete = true;
    browseTopics.forEach(topic => {
      const moduleKey = `${topic} - Novice`;
      const progress = moduleProgress[moduleKey] || 0;
      const isComplete = progress >= 80;
      debugSummary += `• ${moduleKey}: ${progress}% ${isComplete ? '✓' : '✗'}\n`;
      if (!isComplete) allComplete = false;
    });
    
    debugSummary += `\nAll Novice modules ≥80%: ${allComplete ? 'YES ✓' : 'NO ✗'}\n`;
    debugSummary += `Novice Master should unlock: ${allComplete ? 'YES' : 'NO'}\n`;
    
    // Regenerate achievements with debug info
    const achievements = generateAchievements(userData);
    
    // Find Novice Master achievement
    const noviceMaster = achievements.find(a => a.title === 'Novice Master');
    debugSummary += `\nActual achievement status: ${noviceMaster?.unlocked ? 'UNLOCKED ✓' : 'LOCKED ✗'}\n`;
    
    // Show loading animation instead of debug summary
    showLoadingAnimation();
    
    // Also log to console
    console.log(debugSummary);
    console.log('Novice Master Achievement Object:', noviceMaster);
    
    // Update achievements in storage and UI
    sessionStorage.setItem('achievements', JSON.stringify(achievements));
    
    // Regenerate all UI components
    const masteryData = generateMasteryData(userData);
    const learningPath = generateLearningPath(userData);
    
    updateLearningAnalytics(masteryData, learningPath, achievements);
    
    // Force a complete UI refresh
    const overallProgress = recalculateOverallProgress();
    updateUI(userData.username, userData.level, moduleProgress, overallProgress);
    
    console.log('✅ Achievement debug complete - UI refreshed');
  };

  // Auto-trigger debug when page loads
  window.addEventListener('load', function() {
    // Automatically run debug after a short delay to ensure all data is loaded
    setTimeout(() => {
      console.log('🔄 Auto-triggering Novice Master achievement debug...');
      debugNoviceMasterAchievement();
    }, 1000);
  });
</script>
</body>
</html>







