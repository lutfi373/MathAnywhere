<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduction to Derivatives - Intermediate | MathAnywhere</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- MathQuill resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
    
    <!-- MathJax for rendering mathematical expressions -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Plotly for interactive visualizations -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                packages: {'[+]': ['color']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };
    </script>
    <style>
        :root {
            --input-focus: #2d8cf0;
            --font-color: #323232;
            --font-color-sub: #666;
            --bg-color: #f7f9fc;
            --main-color: black;
            --accent-color: #1dd1a1;
            --secondary-color: #54a0ff;
            --tertiary-color: #5f27cd;
            --light-blue: #74b9ff;
            --pink: #fd79a8;
            --purple: #6c5ce7;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fira Code', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--font-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(29, 209, 161, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(84, 160, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(95, 39, 205, 0.15) 0%, transparent 50%);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            box-shadow: 
                20px 20px 60px rgba(0, 0, 0, 0.1),
                -20px -20px 60px rgba(255, 255, 255, 0.8),
                inset 5px 5px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 2px solid var(--main-color);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid var(--main-color);
        }

        .header h1 {
            margin: 0;
            font-size: 3em;
            font-weight: 900;
            position: relative;
            z-index: 1;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        }

        .difficulty-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.25);
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 700;
            margin-top: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            position: relative;
            z-index: 1;
            font-size: 1.1em;
        }

        .content {
            padding: 50px;
        }

        .question-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid var(--main-color);
            box-shadow: 
                8px 8px 20px rgba(0, 0, 0, 0.1),
                -8px -8px 20px rgba(255, 255, 255, 0.7);
            transition: all 0.4s ease;
        }

        .question-number {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-bottom: 20px;
            font-size: 1.3em;
            border: 3px solid var(--main-color);
        }

        .question-text {
            font-size: 1.2em;
            margin-bottom: 25px;
            line-height: 1.7;
            color: var(--font-color);
            font-weight: 600;
        }

        .math-expression {
            background: linear-gradient(135deg, #e8f8f5, #d1ecf1);
            padding: 20px;
            border-radius: 15px;
            font-family: 'Times New Roman', serif;
            font-size: 1.4em;
            text-align: center;
            margin: 20px 0;
            border: 2px solid var(--main-color);
            color: var(--accent-color);
            font-weight: 700;
        }

        .math-input-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid var(--main-color);
            box-shadow: 
                inset 2px 2px 5px rgba(0, 0, 0, 0.1),
                inset -2px -2px 5px rgba(255, 255, 255, 0.8);
        }

        .math-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            font-size: 1.2em;
            font-family: 'Times New Roman', serif;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .math-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(29, 209, 161, 0.3);
            transform: scale(1.02);
        }

        .math-preview {
            background: linear-gradient(135deg, #e8f8f5, #d1ecf1);
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
        }

        .input-label {
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 10px;
            display: block;
            font-size: 1.1em;
        }

        .math-hint {
            background: rgba(29, 209, 161, 0.1);
            border-left: 4px solid var(--accent-color);
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9em;
        }

        .answer-feedback {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(-10px);
        }

        .answer-feedback.show {
            opacity: 1;
            transform: translateY(0);
        }

        .answer-feedback.correct {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            color: white;
        }

        .answer-feedback.incorrect {
            background: linear-gradient(135deg, var(--danger-color), #fd7e14);
            color: white;
        }

        .check-answer-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: 2px solid var(--main-color);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .check-answer-btn:hover {
            transform: translateY(-2px) scale(1.05);
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: 3px solid var(--main-color);
            padding: 18px 50px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s ease;
            margin: 40px auto;
            display: block;
        }

        .results {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-top: 40px;
            text-align: center;
            border: 3px solid var(--main-color);
            backdrop-filter: blur(10px);
        }

        .score {
            font-size: 4em;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .score.pass {
            color: var(--success-color);
        }

        .score.fail {
            color: var(--danger-color);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 20px;
        }

        .nav-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: 3px solid var(--main-color);
            padding: 15px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 700;
            transition: all 0.4s ease;
            flex: 1;
            text-align: center;
            font-size: 1.1em;
        }

        .nav-btn:hover {
            color: white;
            transform: translateY(-3px);
            text-decoration: none;
        }

        /* MathQuill styling */
        .mathquill-field {
            width: 100%;
            margin: 15px 0;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            padding: 15px;
            font-size: 18px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.95);
            min-height: 50px;
            box-shadow: 
                2px 2px 5px rgba(0, 0, 0, 0.1),
                -2px -2px 5px rgba(255, 255, 255, 0.8);
        }

        .mathquill-field:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(29, 209, 161, 0.3);
            transform: scale(1.02);
        }
        
        /* Enhanced Mathematical Toolbar Styling */
        .math-toolbar {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
            border: 2px solid var(--main-color);
            border-radius: 15px;
            padding: 15px;
            margin: 15px 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.6);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .math-toolbar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
            transition: left 0.5s ease;
        }

        .math-toolbar:hover::before {
            left: 100%;
        }

        .math-btn {
            background: linear-gradient(145deg, #ffffff, #f1f5f9);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 10px 14px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #334155;
            min-width: 45px;
            text-align: center;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.8);
            overflow: hidden;
        }

        /* Variable button styling */
        .math-btn[onclick*="'x'"], .math-btn[onclick*="'y'"], .math-btn[onclick*="'h'"] {
            background: linear-gradient(145deg, #3b82f6, #1d4ed8);
            color: white;
            border-color: #1e40af;
        }

        /* Operator button styling */
        .math-btn[onclick*="'+'"], .math-btn[onclick*="'-'"], .math-btn[onclick*="'*'"], .math-btn[onclick*="'/"], .math-btn[onclick*="'="], .math-btn[onclick*="'^'"] {
            background: linear-gradient(145deg, #10b981, #047857);
            color: white;
            border-color: #065f46;
        }

        /* Function button styling */
        .math-btn.function-btn {
            background: linear-gradient(145deg, #8b5cf6, #7c3aed);
            color: white;
            border-color: #6d28d9;
            font-size: 14px;
            padding: 8px 12px;
            min-width: 55px;
            font-weight: 600;
        }

        /* Parentheses and brackets styling */
        .math-btn[onclick*="'("], .math-btn[onclick*="')'"] {
            background: linear-gradient(145deg, #f59e0b, #d97706);
            color: white;
            border-color: #b45309;
        }

        /* Special symbols styling */
        .math-btn[onclick*="'\to'"], .math-btn[onclick*="'\infty'"], .math-btn[onclick*="'\Delta'"], .math-btn[onclick*="'\partial'"] {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            color: white;
            border-color: #b91c1c;
        }

        .math-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.2),
                0 0 20px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }

        .math-btn:active {
            transform: translateY(-1px) scale(1.02);
            box-shadow: 
                0 4px 15px rgba(0, 0, 0, 0.2),
                inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .math-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.4s ease;
        }

        .math-btn:hover::before {
            left: 100%;
        }

        /* Pulse animation for important buttons */
        .math-btn.function-btn:hover {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(139, 92, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0); }
        }

        /* Responsive design for smaller screens */
        @media (max-width: 768px) {
            .math-toolbar {
                padding: 12px;
                gap: 6px;
            }

            .math-btn {
                padding: 8px 10px;
                font-size: 14px;
                min-width: 35px;
            }

            .math-btn.function-btn {
                font-size: 12px;
                padding: 6px 8px;
                min-width: 45px;
            }
        }

        /* Interactive Animation Container */
        .animation-container {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .derivative-visualization {
            width: 100%;
            height: 300px;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        /* Text input field styling */
        .text-input-field-wrapper {
            width: 100%;
            margin: 15px 0;
        }

        .text-input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--main-color);
            border-radius: 10px;
                font-size: 1.2em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease;
            box-shadow: 
                2px 2px 5px rgba(0, 0, 0, 0.1),
                -2px -2px 5px rgba(255, 255, 255, 0.8);
        }
        
        .text-input-field:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(29, 209, 161, 0.3);
            transform: scale(1.02);
        }

        /* Style for the answer format guides */
        .answer-format {
            margin-top: 10px;
            padding: 10px;
            background: rgba(52, 152, 219, 0.05);
            border: 1px dashed #3498db;
            border-radius: 8px;
            color: #333;
            font-family: 'Courier New', monospace;
                font-size: 18px;
            text-align: center;
            font-weight: normal;
            position: relative;
        }
        
        .answer-format::before {
            content: "📝 Answer Format Guide";
            position: absolute;
            top: -12px;
            left: 10px;
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Additional styles for functionality */
        .drag-drop-container {
            display: flex;
            gap: 30px;
            margin: 20px 0;
            justify-content: space-between;
        }

        .functions-column, .derivatives-column {
            flex: 1;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            border: 2px solid var(--main-color);
        }

        .drag-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            user-select: none;
            position: relative;
        }

        .drag-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
            border-color: var(--secondary-color);
        }

        .drag-item:active {
            cursor: grabbing;
        }

        .drag-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .drop-zone {
            background: rgba(255, 255, 255, 0.8);
            border: 2px dashed var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            min-height: 80px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.0em;
            position: relative;
        }

        .drop-zone.drag-over {
            background: rgba(29, 209, 161, 0.1);
            border-color: var(--accent-color);
            border-style: solid;
            transform: scale(1.02);
        }

        .drop-zone.matched {
            background: rgba(40, 167, 69, 0.1);
            border-color: var(--success-color);
            border-style: solid;
        }

        .drop-zone.incorrect {
            background: rgba(220, 53, 69, 0.1);
            border-color: var(--danger-color);
            border-style: solid;
        }

        .flashcard-hint-btn {
            background: linear-gradient(135deg, #a29bfe, #6c5ce7);
            color: white;
            border: 2px solid #333;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .flashcard-hint-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 6px 15px rgba(162, 155, 254, 0.3);
        }

        /* Flashcard Modal Styles */
        .flashcard-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .flashcard-content {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            margin: 5% auto;
            padding: 30px;
            border: 3px solid var(--main-color);
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            position: relative;
            animation: flashcardSlideIn 0.3s ease-out;
        }

        @keyframes flashcardSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .flashcard-close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 15px;
            right: 20px;
        }

        .flashcard-close:hover {
            color: var(--danger-color);
        }

        .flashcard-title {
            color: var(--accent-color);
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .flashcard-body {
            font-size: 1.1em;
            line-height: 1.6;
            color: var(--font-color);
        }

        .flashcard-section {
            background: rgba(29, 209, 161, 0.05);
            border-left: 4px solid var(--accent-color);
            padding: 15px;
            margin: 15px 0;
            border-radius: 0 8px 8px 0;
        }

        .flashcard-formula {
            background: linear-gradient(135deg, #e8f8f5, #d1ecf1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
            text-align: center;
            font-size: 1.2em;
            border: 2px solid var(--accent-color);
        }

        .step-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: 2px solid var(--main-color);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Introduction to Derivatives</h1>
            <p>Master advanced differentiation techniques and applications</p>
            <div class="difficulty-badge">Intermediate Level</div>
        </div>

        <div class="content">
            <div id="questionsContainer">
                <!-- Question 1 - Product Rule Understanding (Theory) -->
                <div class="question-container">
                    <div class="question-number">1</div>
                    <div class="question-text">
                        When do you use the Product Rule in differentiation?
                    </div>
                    <div class="math-expression">
                        Product Rule: $$\frac{d}{dx}[f(x) \cdot g(x)] = f'(x) \cdot g(x) + f(x) \cdot g'(x)$$
                    </div>
                    
                    <div class="math-input-container">
                        <label class="input-label">Complete the sentence: "The Product Rule is used when you need to differentiate a function that is the _______ of two functions."</label>
                        
                        <div class="text-input-field-wrapper">
                            <input type="text" class="text-input-field" id="question0" placeholder="Type your answer here...">
                            <div class="answer-format" id="format-0">Hint: Think about what operation combines two functions to create one</div>
                        </div>
                        <button class="check-answer-btn" onclick="checkMathAnswer(0)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-0"></div>
                        <div class="math-hint">
                            💡 Hint: If you have f(x) × g(x), what operation is being performed?
                        </div>
                    </div>
                </div>

                <!-- Question 2 - Quotient Rule Application (Multiple Choice) -->
                <div class="question-container">
                    <div class="question-number">2</div>
                    <div class="question-text">
                        Which function would require the Quotient Rule to differentiate?
                    </div>
                    
                    <div class="math-input-container">
                        <label class="input-label">Choose the function that needs the Quotient Rule:</label>
                        
                        <div style="margin: 20px 0;">
                            <div style="margin: 10px 0;">
                                <input type="radio" id="option2a" name="question2" value="a">
                                <label for="option2a" style="margin-left: 10px; font-size: 1.1em;">$$f(x) = x^2 + 3x$$</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="radio" id="option2b" name="question2" value="b">
                                <label for="option2b" style="margin-left: 10px; font-size: 1.1em;">$$f(x) = \frac{x^2 + 1}{x - 1}$$</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="radio" id="option2c" name="question2" value="c">
                                <label for="option2c" style="margin-left: 10px; font-size: 1.1em;">$$f(x) = (2x + 3)^5$$</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="radio" id="option2d" name="question2" value="d">
                                <label for="option2d" style="margin-left: 10px; font-size: 1.1em;">$$f(x) = x^3 \cdot e^x$$</label>
                            </div>
                        </div>
                        
                        <button class="check-answer-btn" onclick="checkMathAnswer(1)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-1"></div>
                        <div class="math-hint">
                            💡 Hint: Look for a function that has one expression divided by another!
                        </div>
                    </div>
                </div>

                <!-- Question 3 - Chain Rule Identification (Theory) -->
                <div class="question-container">
                    <div class="question-number">3</div>
                    <div class="question-text">
                        Describe when you would use the Chain Rule and what it helps you find.
                    </div>
                    
                    <div class="math-expression">
                        Chain Rule: $$\frac{d}{dx}[f(g(x))] = f'(g(x)) \cdot g'(x)$$
                    </div>
                    
                    <div class="math-input-container">
                        <label class="input-label">Explain what the Chain Rule is used for:</label>
                        
                        <div class="text-input-field-wrapper">
                            <input type="text" class="text-input-field" id="question2" placeholder="Describe when to use the Chain Rule...">
                            <div class="answer-format" id="format-2">Think about: composite functions, functions inside functions</div>
                        </div>
                        <button class="check-answer-btn" onclick="checkMathAnswer(2)">Check Understanding</button>
                        <div class="answer-feedback" id="feedback-2"></div>
                        <div class="math-hint">
                            💡 Hint: Think about functions like sin(x²) or (3x+1)⁵ - what do they have in common?
                        </div>
                    </div>
                </div>

                <!-- Question 4 - Advanced Derivative Rules (Multiple Select) -->
                <div class="question-container">
                    <div class="question-number">4</div>
                    <div class="question-text">
                        Which of these are valid differentiation rules for intermediate calculus?
                    </div>
                    
                    <div class="math-expression">
                        Select all correct differentiation rules
                    </div>
                    
                    <div class="math-input-container">
                        <label class="input-label">Which rules are correct? (Select all that apply)</label>
                        
                        <div style="margin: 20px 0;">
                            <div style="margin: 10px 0;">
                                <input type="checkbox" id="option4a" name="question4" value="a">
                                <label for="option4a" style="margin-left: 10px; font-size: 1.1em;">$$\frac{d}{dx}[f(x) \cdot g(x)] = f'(x) \cdot g'(x)$$</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="checkbox" id="option4b" name="question4" value="b">
                                <label for="option4b" style="margin-left: 10px; font-size: 1.1em;">$$\frac{d}{dx}\left[\frac{f(x)}{g(x)}\right] = \frac{f'(x)g(x) - f(x)g'(x)}{[g(x)]^2}$$</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="checkbox" id="option4c" name="question4" value="c">
                                <label for="option4c" style="margin-left: 10px; font-size: 1.1em;">$$\frac{d}{dx}[f(g(x))] = f'(g(x)) \cdot g'(x)$$</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="checkbox" id="option4d" name="question4" value="d">
                                <label for="option4d" style="margin-left: 10px; font-size: 1.1em;">$$\frac{d}{dx}[e^x] = xe^{x-1}$$</label>
                            </div>
                        </div>
                        
                        <button class="check-answer-btn" onclick="checkMathAnswer(3)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-3"></div>
                        <div class="math-hint">
                            💡 Hint: Check each rule carefully - some have subtle errors!
                        </div>
                    </div>
                </div>

                <!-- Question 5 - Real-World Intermediate Applications (Theory) -->
                <div class="question-container">
                    <div class="question-number">5</div>
                    <div class="question-text">
                        Give an example of a real-world problem where you would need to use advanced differentiation rules.
                    </div>
                    <div class="math-expression">Advanced rules help solve complex rate problems</div>
                    
                    <div class="math-input-container">
                        <label class="input-label">Describe a situation where you might need the Product Rule, Quotient Rule, or Chain Rule:</label>
                        <div class="text-input-field-wrapper">
                            <input type="text" class="text-input-field" id="question4" placeholder="Describe a complex real-world scenario...">
                            <div class="answer-format" id="format-4">Examples: compound interest, related rates, optimization problems, etc.</div>
                        </div>
                        <button class="check-answer-btn" onclick="checkMathAnswer(4)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-4"></div>
                        <div class="math-hint">
                            💡 Hint: Think about situations with multiple changing quantities that interact with each other
                        </div>
                    </div>
                </div>

                <!-- Question 6 - Drag and Drop: Match Functions with Derivatives -->
                <div class="question-container">
                    <div class="question-number">6</div>
                    <div class="question-text">
                        Match each function with its correct derivative using the appropriate differentiation rule.
                    </div>
                    
                    <div class="drag-drop-container">
                        <div class="functions-column">
                            <h4 style="text-align: center; color: var(--accent-color); margin-bottom: 20px;">📋 Functions</h4>
                            <div class="drag-item" draggable="true" data-function="product-rule">
                                $$f(x) = x^2 \cdot e^x$$
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">↕️ Drag me!</div>
                            </div>
                            <div class="drag-item" draggable="true" data-function="quotient-rule">
                                $$f(x) = \frac{2x + 1}{x^2 - 1}$$
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">↕️ Drag me!</div>
                            </div>
                            <div class="drag-item" draggable="true" data-function="chain-rule">
                                $$f(x) = (3x^2 + 2x)^4$$
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">↕️ Drag me!</div>
                            </div>
                            <div class="drag-item" draggable="true" data-function="power-rule">
                                $$f(x) = 5x^3 - 2x + 7$$
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">↕️ Drag me!</div>
                            </div>
                        </div>
                        
                        <div class="derivatives-column">
                            <h4 style="text-align: center; color: var(--secondary-color); margin-bottom: 20px;">🎯 Derivatives</h4>
                            <div class="drop-zone" data-derivative="product-rule">
                                $$f'(x) = 2x \cdot e^x + x^2 \cdot e^x$$
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Drop function here</div>
                            </div>
                            <div class="drop-zone" data-derivative="quotient-rule">
                                $$f'(x) = \frac{2(x^2-1) - (2x+1)(2x)}{(x^2-1)^2}$$
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Drop function here</div>
                            </div>
                            <div class="drop-zone" data-derivative="chain-rule">
                                $$f'(x) = 4(3x^2 + 2x)^3 \cdot (6x + 2)$$
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Drop function here</div>
                            </div>
                            <div class="drop-zone" data-derivative="power-rule">
                                $$f'(x) = 15x^2 - 2$$
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Drop function here</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="check-answer-btn" onclick="checkDragDrop()">Check Matches</button>
                        <button class="check-answer-btn" onclick="resetDragDrop(6)" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                            🔄 Reset
                        </button>
                    </div>
                    <div class="answer-feedback" id="feedback-dragdrop"></div>
                    <button class="flashcard-hint-btn" onclick="showFlashcard('differentiation-rules')" style="background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; border: 2px solid #333; padding: 10px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 10px;">
                        🔍 Differentiation Rules Flash Card
                    </button>
                </div>

                <!-- Question 7 - Drag and Drop: Match Rules with Applications -->
                <div class="question-container">
                    <div class="question-number">7</div>
                    <div class="question-text">
                        Match each differentiation rule with its typical application scenario.
                    </div>
                    
                    <div class="drag-drop-container">
                        <div class="functions-column">
                            <h4 style="text-align: center; color: var(--accent-color); margin-bottom: 20px;">📜 Rules</h4>
                            <div class="drag-item" draggable="true" data-function="product-rule-app">
                                <strong>Product Rule</strong>
                                <div style="font-size: 0.9em; margin-top: 5px;">$$(uv)' = u'v + uv'$$</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">↕️ Drag me!</div>
                            </div>
                            <div class="drag-item" draggable="true" data-function="quotient-rule-app">
                                <strong>Quotient Rule</strong>
                                <div style="font-size: 0.9em; margin-top: 5px;">$$\left(\frac{u}{v}\right)' = \frac{u'v - uv'}{v^2}$$</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">↕️ Drag me!</div>
                            </div>
                            <div class="drag-item" draggable="true" data-function="chain-rule-app">
                                <strong>Chain Rule</strong>
                                <div style="font-size: 0.9em; margin-top: 5px;">$$[f(g(x))]' = f'(g(x)) \cdot g'(x)$$</div>
                                <div style="font-size: 0.9em; color: #666; margin-top: 5px;">↕️ Drag me!</div>
                            </div>
                        </div>
                        
                        <div class="derivatives-column">
                            <h4 style="text-align: center; color: var(--secondary-color); margin-bottom: 20px;">🎯 Applications</h4>
                            <div class="drop-zone" data-derivative="product-rule-app">
                                <strong>Functions multiplied together</strong>
                                <div style="font-size: 0.9em; margin-top: 5px;">Example: $$x^2 \sin(x)$$</div>
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Drop rule here</div>
                            </div>
                            <div class="drop-zone" data-derivative="quotient-rule-app">
                                <strong>One function divided by another</strong>
                                <div style="font-size: 0.9em; margin-top: 5px;">Example: $$\frac{\ln(x)}{x^2}$$</div>
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Drop rule here</div>
                            </div>
                            <div class="drop-zone" data-derivative="chain-rule-app">
                                <strong>Composite functions (function inside function)</strong>
                                <div style="font-size: 0.9em; margin-top: 5px;">Example: $$\sin(x^2)$$</div>
                                <div style="font-size: 0.8em; color: #666; margin-top: 5px;">Drop rule here</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="check-answer-btn" onclick="checkRuleApplicationDragDrop()">Check Matches</button>
                        <button class="check-answer-btn" onclick="resetDragDrop(7)" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                            🔄 Reset
                        </button>
                    </div>
                    <div class="answer-feedback" id="feedback-rule-application"></div>
                    <button class="flashcard-hint-btn" onclick="showFlashcard('rule-applications')" style="background: linear-gradient(135deg, #a29bfe, #6c5ce7); color: white; border: 2px solid #333; padding: 10px 20px; border-radius: 20px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; margin-top: 10px;">
                        📚 Rule Applications Flash Card
                    </button>
                </div>

                <!-- Interactive Graph Section -->
                <div class="question-container">
                    <div class="question-number">📊</div>
                    <div class="question-text">
                        Interactive Visualization: Understanding Intermediate Derivatives
                    </div>
                    
                    <div class="animation-container">
                        <h4>Explore: $$f(x) = x^3 - 2x^2 + x$$ and its derivatives</h4>
                        <div class="derivative-visualization" id="derivativeGraph"></div>
                        
                        <div style="margin: 20px 0; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="showOriginal" checked onchange="updateIntermediateGraph()">
                                <span style="color: blue; font-weight: 600;">f(x) - Original</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="showFirstDerivative" checked onchange="updateIntermediateGraph()">
                                <span style="color: red; font-weight: 600;">f'(x) - First Derivative</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="showSecondDerivative" onchange="updateIntermediateGraph()">
                                <span style="color: green; font-weight: 600;">f''(x) - Second Derivative</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; margin: 15px 0;">
                            <button class="check-answer-btn" onclick="animateIntermediateDerivativeEvolution()">🎬 Animate Evolution</button>
                            <button class="check-answer-btn" onclick="showIntermediateCriticalPoints()">📍 Critical Points</button>
                            <button class="check-answer-btn" onclick="resetIntermediateAnimation()">🔄 Reset</button>
                        </div>
                        
                        <div class="math-expression">
                            $$f(x) = x^3 - 2x^2 + x$$
                            $$f'(x) = 3x^2 - 4x + 1$$
                            $$f''(x) = 6x - 4$$
                        </div>
                    </div>
                </div>
                    









            </div>

            <button class="submit-btn" id="submitBtn" onclick="submitQuiz()">Submit Quiz</button>
            
            <div style="text-align: center; margin: 20px 0;">
                <button id="toggleAnswerGuide" class="nav-btn" style="background: linear-gradient(135deg, #ff7e5f, #feb47b); border: 2px solid #333; padding: 12px 25px; font-size: 16px;">
                    📝 Show Answer Guide
                </button>
            </div>

            <div id="results" class="results" style="display: none;">
                <div class="score" id="scoreDisplay"></div>
                <div id="resultMessage"></div>
                <div class="navigation">
                    <a href="profile.html" class="nav-btn">← Back to Profile</a>
                    <a href="introduction-to-derivatives-advanced-enhanced.html" class="nav-btn">Next Level →</a>
                </div>
            </div>

            <!-- Answer Guide Section -->
            <div id="answerGuide" style="margin-top: 30px; padding: 20px; background: #f0f8ff; border: 2px solid #1e90ff; border-radius: 10px; display: none;">
                <h4 style="color: #0066cc; margin-bottom: 15px;">📝 Answer Guide</h4>
                <p style="font-size: 14px; color: #333; margin-bottom: 15px;">
                    Use this guide if you're having trouble with the intermediate-level questions:
                </p>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 1: When to use Product Rule?</h5>
                    <p><strong>Answer:</strong> "The Product Rule is used when you need to differentiate a function that is the <strong>product</strong> of two functions."</p>
                    <p>Other acceptable words: multiplication, times, multiply</p>
                    <p><strong>Explanation:</strong> When you have f(x) × g(x), you can't just differentiate each part separately - you need the Product Rule!</p>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 2: Quotient Rule function</h5>
                    <p><strong>Correct Answer:</strong> B) $f(x) = \frac{x^2 + 1}{x - 1}$</p>
                    <p><strong>Explanation:</strong> This is a fraction with one function divided by another, requiring the Quotient Rule!</p>
                    <p>The other options require:</p>
                    <ul style="margin-left: 20px;">
                        <li>A) Power Rule only</li>
                        <li>C) Chain Rule (function inside function)</li>
                        <li>D) Product Rule (multiplication of functions)</li>
                    </ul>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 3: Chain Rule usage</h5>
                    <p><strong>Answer:</strong> "The Chain Rule is used for composite functions" (or similar)</p>
                    <p>Key concepts to include:</p>
                    <ul style="margin-left: 20px;">
                        <li><strong>Composite functions</strong> (functions inside functions)</li>
                        <li><strong>Nested functions</strong> (one function contains another)</li>
                        <li>Functions like sin(x²), (3x+1)⁵, e^(2x), etc.</li>
                    </ul>
                    <p><strong>Explanation:</strong> When you have a function inside another function, use the Chain Rule!</p>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 4: Valid differentiation rules</h5>
                    <p><strong>Correct Answers:</strong> B and C</p>
                    <ul style="margin-left: 20px;">
                        <li>❌ A) Wrong Product Rule (missing f(x)g'(x) term)</li>
                        <li>✅ B) Correct Quotient Rule</li>
                        <li>✅ C) Correct Chain Rule</li>
                        <li>❌ D) Wrong exponential rule (should be e^x, not xe^(x-1))</li>
                    </ul>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 5: Real-world advanced applications</h5>
                    <p><strong>Sample Answers:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>Compound interest calculations (exponential functions)</li>
                        <li>Related rates problems (multiple changing quantities)</li>
                        <li>Optimization in business (revenue/cost functions)</li>
                        <li>Physics problems with complex motion</li>
                        <li>Population dynamics with limiting factors</li>
                        <li>Chemical reaction rates with multiple reactants</li>
                    </ul>
                    <p><strong>Key idea:</strong> Complex real-world problems often involve functions that are products, quotients, or compositions of simpler functions.</p>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 6: Function-Derivative Matching (Drag & Drop)</h5>
                    <p><strong>Correct Matches:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li><strong>$f(x) = x^2 \cdot e^x$</strong> → $f'(x) = 2x \cdot e^x + x^2 \cdot e^x$ (Product Rule)</li>
                        <li><strong>$f(x) = \frac{2x + 1}{x^2 - 1}$</strong> → $f'(x) = \frac{2(x^2-1) - (2x+1)(2x)}{(x^2-1)^2}$ (Quotient Rule)</li>
                        <li><strong>$f(x) = (3x^2 + 2x)^4$</strong> → $f'(x) = 4(3x^2 + 2x)^3 \cdot (6x + 2)$ (Chain Rule)</li>
                        <li><strong>$f(x) = 5x^3 - 2x + 7$</strong> → $f'(x) = 15x^2 - 2$ (Power Rule)</li>
                    </ul>
                    <p><strong>Tip:</strong> Identify the structure of the function first, then apply the appropriate rule.</p>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 7: Rule Applications (Drag & Drop)</h5>
                    <p><strong>Correct Matches:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li><strong>Product Rule</strong> → Functions multiplied together (e.g., $x^2 \sin(x)$)</li>
                        <li><strong>Quotient Rule</strong> → One function divided by another (e.g., $\frac{\ln(x)}{x^2}$)</li>
                        <li><strong>Chain Rule</strong> → Composite functions (e.g., $\sin(x^2)$)</li>
                    </ul>
                    <p><strong>Quick identification:</strong> Look for ×, ÷, or functions inside other functions.</p>
                </div>
            </div>
            
            <!-- Debug Panel for Troubleshooting -->
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px;">
                <h4 style="color: #495057; margin-bottom: 15px;">🛠️ Debug Panel</h4>
                <p style="font-size: 14px; color: #6c757d; margin-bottom: 15px;">
                    If your module completion isn't saving properly, or drag and drop isn't working, use these tools:
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="checkModuleProgress()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px;">
                        📊 Check Progress
                    </button>
                    <button onclick="forceCompleteModule()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px;">
                        ✅ Force Complete
                    </button>
                    <button onclick="testDragDrop()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px; background: linear-gradient(135deg, #f39c12, #e67e22);">
                        🎮 Test Drag & Drop
                    </button>
                    <button onclick="window.initializeDragDrop()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px; background: linear-gradient(135deg, #27ae60, #2ecc71);">
                        🔧 Init Drag & Drop
                    </button>
                </div>
                <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                    Use "Check Progress" to see debug info in console, "Force Complete" to manually mark as done, or test/initialize drag and drop functionality.
                </p>
            </div>
        </div>
    </div>

    <!-- Flashcard Modals -->
    <div id="flashcard-differentiation-rules" class="flashcard-modal">
        <div class="flashcard-content">
            <span class="flashcard-close" onclick="closeFlashcard('differentiation-rules')">&times;</span>
            <div class="flashcard-title">🔍 Differentiation Rules Reference</div>
            <div class="flashcard-body">
                <div class="flashcard-section">
                    <h4>Product Rule</h4>
                    <div class="flashcard-formula">$$\frac{d}{dx}[f(x) \cdot g(x)] = f'(x) \cdot g(x) + f(x) \cdot g'(x)$$</div>
                    <p><strong>When to use:</strong> When you have two functions multiplied together</p>
                    <p><strong>Example:</strong> $f(x) = x^2 \cdot e^x$</p>
                    <p><strong>Solution:</strong> $f'(x) = 2x \cdot e^x + x^2 \cdot e^x$</p>
                </div>
                
                <div class="flashcard-section">
                    <h4>Quotient Rule</h4>
                    <div class="flashcard-formula">$$\frac{d}{dx}\left[\frac{f(x)}{g(x)}\right] = \frac{f'(x)g(x) - f(x)g'(x)}{[g(x)]^2}$$</div>
                    <p><strong>When to use:</strong> When you have one function divided by another</p>
                    <p><strong>Example:</strong> $f(x) = \frac{2x + 1}{x^2 - 1}$</p>
                    <p><strong>Remember:</strong> "Low d-high minus high d-low, over low squared"</p>
                </div>
                
                <div class="flashcard-section">
                    <h4>Chain Rule</h4>
                    <div class="flashcard-formula">$$\frac{d}{dx}[f(g(x))] = f'(g(x)) \cdot g'(x)$$</div>
                    <p><strong>When to use:</strong> When you have a composite function (function inside function)</p>
                    <p><strong>Example:</strong> $f(x) = (3x^2 + 2x)^4$</p>
                    <p><strong>Solution:</strong> $f'(x) = 4(3x^2 + 2x)^3 \cdot (6x + 2)$</p>
                </div>
                
                <div class="flashcard-section">
                    <h4>Power Rule</h4>
                    <div class="flashcard-formula">$$\frac{d}{dx}[x^n] = nx^{n-1}$$</div>
                    <p><strong>When to use:</strong> For simple polynomial terms</p>
                    <p><strong>Example:</strong> $f(x) = 5x^3 - 2x + 7$</p>
                    <p><strong>Solution:</strong> $f'(x) = 15x^2 - 2$</p>
                </div>
            </div>
        </div>
    </div>

    <div id="flashcard-rule-applications" class="flashcard-modal">
        <div class="flashcard-content">
            <span class="flashcard-close" onclick="closeFlashcard('rule-applications')">&times;</span>
            <div class="flashcard-title">📚 Rule Applications Guide</div>
            <div class="flashcard-body">
                <div class="flashcard-section">
                    <h4>🔄 Product Rule Applications</h4>
                    <p><strong>Use when:</strong> Functions are multiplied together</p>
                    <div class="flashcard-formula">$$(uv)' = u'v + uv'$$</div>
                    <p><strong>Common examples:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>$x^2 \sin(x)$ - polynomial × trigonometric</li>
                        <li>$e^x \ln(x)$ - exponential × logarithmic</li>
                        <li>$(x+1)(x^2-3)$ - polynomial × polynomial</li>
                    </ul>
                </div>
                
                <div class="flashcard-section">
                    <h4>➗ Quotient Rule Applications</h4>
                    <p><strong>Use when:</strong> One function is divided by another</p>
                    <div class="flashcard-formula">$$\left(\frac{u}{v}\right)' = \frac{u'v - uv'}{v^2}$$</div>
                    <p><strong>Common examples:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>$\frac{\ln(x)}{x^2}$ - logarithmic ÷ polynomial</li>
                        <li>$\frac{\sin(x)}{x}$ - trigonometric ÷ polynomial</li>
                        <li>$\frac{x+1}{x-1}$ - rational functions</li>
                    </ul>
                </div>
                
                <div class="flashcard-section">
                    <h4>🔗 Chain Rule Applications</h4>
                    <p><strong>Use when:</strong> You have composite functions (function inside function)</p>
                    <div class="flashcard-formula">$$[f(g(x))]' = f'(g(x)) \cdot g'(x)$$</div>
                    <p><strong>Common examples:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>$\sin(x^2)$ - trig function of polynomial</li>
                        <li>$(3x+1)^5$ - polynomial raised to power</li>
                        <li>$e^{2x}$ - exponential with linear argument</li>
                        <li>$\ln(x^2+1)$ - logarithm of polynomial</li>
                    </ul>
                </div>
                
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-top: 20px; border: 2px solid #ffc107;">
                    <h4 style="color: #856404;">💡 Quick Identification Tips</h4>
                    <ul style="margin-left: 20px; color: #856404;">
                        <li><strong>Look for × symbols or multiplication:</strong> Product Rule</li>
                        <li><strong>Look for fraction bars:</strong> Quotient Rule</li>
                        <li><strong>Look for functions inside parentheses:</strong> Chain Rule</li>
                        <li><strong>Simple powers of x:</strong> Power Rule</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBUfSOSpmCdWUGTVbSQsMCH-JVmrjpfdPY",
            authDomain: "fyp-lutfi-naim.firebaseapp.com",
            projectId: "fyp-lutfi-naim",
            storageBucket: "fyp-lutfi-naim.firebasestorage.app",
            messagingSenderId: "231274529807",
            appId: "1:231274529807:web:c4ea279f9e7581bd674f7a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let mathAnswers = {};
        let currentUser = null;
        
        // Drag and Drop Variables
        window.dragDropMatches = {};
        window.ruleApplicationMatches = {};
        let draggedElement = null;

        const mathCorrectAnswers = {
            0: "product", // Text input - Product Rule usage
            1: "b",       // Radio - Quotient Rule function
            2: "composite", // Text input - Chain Rule usage  
            3: ["b", "c"], // Checkboxes - Valid rules (Quotient Rule and Chain Rule)
            4: "compound", // Text input - Real-world applications
            5: "dragdrop", // Drag and drop - Function-derivative matching
            6: "ruleapp"   // Drag and drop - Rule applications
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadProgress();
            } else {
                window.location.href = 'index.html';
            }
        });

        function loadProgress() {
            const saved = sessionStorage.getItem('introduction-to-derivatives-intermediate-progress');
            if (saved) {
                mathAnswers = JSON.parse(saved);
                restoreAnswers();
            }
        }

        function restoreAnswers() {
            Object.keys(mathAnswers).forEach(questionNum => {
                const answer = mathAnswers[questionNum];
                
                if (questionNum == 0 || questionNum == 2 || questionNum == 4) {
                    // Text input fields
                    const textField = document.getElementById(`question${questionNum}`);
                    if (textField) {
                        textField.value = answer;
                    }
                } else if (questionNum == 1) {
                    // Radio button
                    const radioButton = document.querySelector(`input[name="question2"][value="${answer}"]`);
                    if (radioButton) {
                        radioButton.checked = true;
                    }
                } else if (questionNum == 3) {
                    // Checkboxes
                    if (Array.isArray(answer)) {
                        answer.forEach(value => {
                            const checkbox = document.querySelector(`input[name="question4"][value="${value}"]`);
                            if (checkbox) {
                                checkbox.checked = true;
                            }
                        });
                    }
                }
            });
        }

        // Initialize event listeners for radio buttons and checkboxes
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for radio buttons (Question 2)
            const radioButtons = document.querySelectorAll('input[name="question2"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        mathAnswers[1] = this.value;
                        sessionStorage.setItem('introduction-to-derivatives-intermediate-progress', JSON.stringify(mathAnswers));
                    }
                });
            });

            // Add event listeners for checkboxes (Question 4)
            const checkboxes = document.querySelectorAll('input[name="question4"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedValues = Array.from(document.querySelectorAll('input[name="question4"]:checked')).map(cb => cb.value);
                    mathAnswers[3] = checkedValues;
                    sessionStorage.setItem('introduction-to-derivatives-intermediate-progress', JSON.stringify(mathAnswers));
                });
            });

            // Add event listeners for text inputs
            [0, 2, 4].forEach(questionNum => {
                const textField = document.getElementById(`question${questionNum}`);
                if (textField) {
                    textField.addEventListener('input', function() {
                        mathAnswers[questionNum] = this.value;
                        sessionStorage.setItem('introduction-to-derivatives-intermediate-progress', JSON.stringify(mathAnswers));
                    });
                }
            });

            // Initialize interactive graph
            setTimeout(() => {
                initializeIntermediateAnimation();
            }, 500);

            // Initialize drag and drop system
            setTimeout(() => {
                try {
                    if (typeof window.initializeDragDrop === 'function') {
                        window.initializeDragDrop();
                        console.log('✅ Drag and drop system initialized');
                    } else {
                        console.warn('⚠️ initializeDragDrop function not found, initializing now...');
                        initializeDragDropSystem();
                    }
                } catch (error) {
                    console.error('❌ Error initializing drag and drop:', error);
                }
            }, 1000);

            // Initialize answer guide toggle
            const toggleBtn = document.getElementById('toggleAnswerGuide');
            const answerGuide = document.getElementById('answerGuide');
            
            if (toggleBtn && answerGuide) {
                toggleBtn.addEventListener('click', function() {
                    if (answerGuide.style.display === 'none' || answerGuide.style.display === '') {
                        answerGuide.style.display = 'block';
                        toggleBtn.innerHTML = '📝 Hide Answer Guide';
                    } else {
                        answerGuide.style.display = 'none';
                        toggleBtn.innerHTML = '📝 Show Answer Guide';
                    }
                });
            }

            // Trigger MathJax rendering for all mathematical expressions
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise().catch((err) => console.log('MathJax typeset error:', err));
            }
        });

        // Answer checking function for intermediate level questions
        window.checkMathAnswer = function(questionNum) {
            const feedback = document.getElementById(`feedback-${questionNum}`);
            let userAnswer = '';
            let isCorrect = false;
            
            // Get user answer based on question type
            if (questionNum == 0 || questionNum == 2 || questionNum == 4) {
                // Text input questions
                const textField = document.getElementById(`question${questionNum}`);
                userAnswer = textField ? textField.value.toLowerCase().trim() : '';
            } else if (questionNum == 1) {
                // Radio button question
                const selectedRadio = document.querySelector('input[name="question2"]:checked');
                userAnswer = selectedRadio ? selectedRadio.value : '';
            } else if (questionNum == 3) {
                // Checkbox question
                const checkedBoxes = Array.from(document.querySelectorAll('input[name="question4"]:checked')).map(cb => cb.value);
                userAnswer = checkedBoxes;
            }
            
            // Store answer
            mathAnswers[questionNum] = userAnswer;
                sessionStorage.setItem('introduction-to-derivatives-intermediate-progress', JSON.stringify(mathAnswers));
                
            // Validate answer
            if (questionNum == 0) {
                // Product Rule usage
                isCorrect = userAnswer.includes('product') || userAnswer.includes('multiplication') || 
                           userAnswer.includes('multiply') || userAnswer.includes('times');
            } else if (questionNum == 1) {
                // Quotient Rule function
                isCorrect = userAnswer === 'b';
            } else if (questionNum == 2) {
                // Chain Rule usage
                isCorrect = userAnswer.includes('composite') || userAnswer.includes('nested') || 
                           userAnswer.includes('inside') || userAnswer.includes('function of function') ||
                           userAnswer.includes('composition');
            } else if (questionNum == 3) {
                // Valid differentiation rules
                const correctAnswers = ['b', 'c'];
                isCorrect = Array.isArray(userAnswer) && 
                           userAnswer.length === correctAnswers.length &&
                           correctAnswers.every(answer => userAnswer.includes(answer));
            } else if (questionNum == 4) {
                // Real-world applications
                isCorrect = userAnswer.includes('compound') || userAnswer.includes('interest') || 
                           userAnswer.includes('related') || userAnswer.includes('rate') ||
                           userAnswer.includes('optimization') || userAnswer.includes('physics') ||
                           userAnswer.includes('population') || userAnswer.includes('chemical') ||
                           userAnswer.includes('business') || userAnswer.includes('revenue') ||
                           userAnswer.includes('cost') || userAnswer.includes('motion');
            }
            
            // Show feedback
            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');
            
            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = '✅ Excellent! Your understanding is correct!';
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = '❌ Not quite right. Check the answer guide for help!';
            }
            
            console.log(`Question ${questionNum} validation:`, {
                userAnswer: userAnswer,
                isCorrect: isCorrect,
                questionType: questionNum == 0 || questionNum == 2 || questionNum == 4 ? 'text' : 
                             questionNum == 1 ? 'radio' : 'checkbox'
            });
        };

        // Enhanced answer validation function
        function normalizeAnswer(answer) {
            return answer.toLowerCase()
                .replace(/\s+/g, '') // Remove all spaces
                .replace(/\$+/g, '') // Remove $ symbols
                .replace(/\\cdot/g, '*') // Replace LaTeX multiplication
                .replace(/\\times/g, '*') // Replace LaTeX multiplication
                .replace(/\\frac\{([^}]*)\}\{([^}]*)\}/g, '($1)/($2)') // Convert fractions
                .replace(/\{([^}]*)\}/g, '$1') // Remove braces
                .replace(/\^(\d+)/g, '^$1') // Normalize exponents
                .replace(/²/g, '^2') // Convert superscript 2
                .replace(/³/g, '^3') // Convert superscript 3
                .replace(/⁴/g, '^4') // Convert superscript 4
                .replace(/⁵/g, '^5') // Convert superscript 5
                .replace(/√/g, 'sqrt') // Convert square root symbol
                .replace(/\\sin/g, 'sin') // Convert LaTeX sin
                .replace(/\\cos/g, 'cos') // Convert LaTeX cos
                .replace(/\\tan/g, 'tan') // Convert LaTeX tan
                .replace(/π/g, 'pi') // Convert pi symbol
                .replace(/∞/g, 'infinity') // Convert infinity symbol
                .replace(/±/g, '+-') // Convert plus-minus
                .replace(/≈/g, '=') // Convert approximately equal
                .replace(/≠/g, '!=') // Convert not equal
                .replace(/≤/g, '<=') // Convert less than or equal
                .replace(/≥/g, '>=') // Convert greater than or equal
                .replace(/∂/g, 'd') // Convert partial derivative symbol
                .replace(/∫/g, 'integral') // Convert integral symbol
                .replace(/∑/g, 'sum') // Convert summation symbol
                .replace(/∏/g, 'product') // Convert product symbol
                .replace(/∆/g, 'delta') // Convert delta symbol
                .replace(/α/g, 'alpha') // Convert alpha
                .replace(/β/g, 'beta') // Convert beta
                .replace(/γ/g, 'gamma') // Convert gamma
                .replace(/θ/g, 'theta') // Convert theta
                .replace(/λ/g, 'lambda') // Convert lambda
                .replace(/μ/g, 'mu') // Convert mu
                .replace(/σ/g, 'sigma') // Convert sigma
                .replace(/φ/g, 'phi') // Convert phi
                .replace(/ω/g, 'omega'); // Convert omega
        }

        // Check if two mathematical expressions are equivalent
        function areEquivalent(userAnswer, correctAnswer) {
            const normalizedUser = normalizeAnswer(userAnswer);
            const normalizedCorrect = normalizeAnswer(correctAnswer);
            
            // Direct match
            if (normalizedUser === normalizedCorrect) return true;
            
            // Check if user answer contains correct answer or vice versa
            if (normalizedUser.includes(normalizedCorrect) || normalizedCorrect.includes(normalizedUser)) return true;
            
            // Check for common mathematical equivalencies
            const equivalencies = [
                [normalizedUser, normalizedCorrect],
                [normalizedUser.replace(/\*/g, ''), normalizedCorrect.replace(/\*/g, '')], // Remove multiplication signs
                [normalizedUser.replace(/\(/g, '').replace(/\)/g, ''), normalizedCorrect.replace(/\(/g, '').replace(/\)/g, '')], // Remove parentheses
            ];
            
            return equivalencies.some(([a, b]) => a === b);
        }

        function updateProgress() {
            const totalQuestions = 5;
            const answeredQuestions = Object.keys(mathAnswers).length;
            const progress = (answeredQuestions / totalQuestions) * 100;
            console.log(`Progress: ${answeredQuestions}/${totalQuestions} (${progress}%)`);
        }

        // Drag and Drop Functionality - REMOVED (not working properly)
        
        // Step-by-step navigation - REMOVED (not needed for current 5-question format)

        window.submitQuiz = async function() {
            if (Object.keys(mathAnswers).length < 7) {
                alert('Please answer all questions before submitting.');
                return;
            }

            let score = 0;
            
            // Validate each answer
            for (let questionNum = 0; questionNum < 7; questionNum++) {
                const userAnswer = mathAnswers[questionNum];
                let isCorrect = false;
                
                if (questionNum == 0) {
                    // Product Rule usage
                    const answer = typeof userAnswer === 'string' ? userAnswer.toLowerCase().trim() : '';
                    isCorrect = answer.includes('product') || answer.includes('multiplication') || 
                               answer.includes('multiply') || answer.includes('times');
                } else if (questionNum == 1) {
                    // Quotient Rule function
                    isCorrect = userAnswer === 'b';
                } else if (questionNum == 2) {
                    // Chain Rule usage
                    const answer = typeof userAnswer === 'string' ? userAnswer.toLowerCase().trim() : '';
                    isCorrect = answer.includes('composite') || answer.includes('nested') || 
                               answer.includes('inside') || answer.includes('function of function') ||
                               answer.includes('composition');
                } else if (questionNum == 3) {
                    // Valid differentiation rules
                    const correctAnswers = ['b', 'c'];
                    isCorrect = Array.isArray(userAnswer) && 
                               userAnswer.length === correctAnswers.length &&
                               correctAnswers.every(answer => userAnswer.includes(answer));
                } else if (questionNum == 4) {
                    // Real-world applications
                    const answer = typeof userAnswer === 'string' ? userAnswer.toLowerCase().trim() : '';
                    isCorrect = answer.includes('compound') || answer.includes('interest') || 
                               answer.includes('related') || answer.includes('rate') ||
                               answer.includes('optimization') || answer.includes('physics') ||
                               answer.includes('population') || answer.includes('chemical') ||
                               answer.includes('business') || answer.includes('revenue') ||
                               answer.includes('cost') || answer.includes('motion');
                } else if (questionNum == 5) {
                    // Drag and drop - Function-derivative matching
                    isCorrect = userAnswer === 'correct';
                } else if (questionNum == 6) {
                    // Drag and drop - Rule applications
                    isCorrect = userAnswer === 'correct';
                }
                
                if (isCorrect) score++;
            }

            const percentage = Math.round((score / 7) * 100);
            const passed = score >= 5; // 5 out of 7 to pass

            document.getElementById('scoreDisplay').textContent = `${score}/7 (${percentage}%)`;
            document.getElementById('scoreDisplay').className = `score ${passed ? 'pass' : 'fail'}`;
            document.getElementById('resultMessage').innerHTML = passed 
                ? '<h3 style="color: var(--success-color);">🎉 Excellent! You understand intermediate derivative concepts!</h3><p>You can now proceed to the advanced level.</p>'
                : '<h3 style="color: var(--danger-color);">Keep studying!</h3><p>You need at least 5 correct answers to pass. Review the answer guide and try again.</p>';

            document.getElementById('results').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'none';

            if (currentUser) {
                try {
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    
                    // Update module progress with multiple key formats for compatibility
                    const updateData = {
                        moduleProgress: {
                            [`Introduction to Derivatives - Intermediate`]: percentage,
                            [`Introduction to derivatives - Intermediate`]: percentage,
                            [`introduction-to-derivatives-intermediate`]: percentage
                        }
                    };
                    
                    // If passed, mark as completed
                    if (passed) {
                        const moduleKey = `Introduction to Derivatives - Intermediate`;
                        const userData = await getDoc(userDocRef);
                        const existingData = userData.exists() ? userData.data() : {};
                        const completedModules = existingData.completedModules || [];
                        
                        if (!completedModules.includes(moduleKey)) {
                            updateData.completedModules = [...completedModules, moduleKey];
                        }
                    }
                    
                    await setDoc(userDocRef, updateData, { merge: true });
                    
                    // Also update sessionStorage for immediate profile page update
                    const currentModuleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
                    currentModuleProgress[`Introduction to Derivatives - Intermediate`] = percentage;
                    currentModuleProgress[`Introduction to derivatives - Intermediate`] = percentage;
                    currentModuleProgress[`introduction-to-derivatives-intermediate`] = percentage;
                    sessionStorage.setItem('moduleProgress', JSON.stringify(currentModuleProgress));
                    
                    // Also update completedModules in sessionStorage
                    if (passed) {
                        const completedModulesSession = JSON.parse(sessionStorage.getItem('completedModules') || '[]');
                        const moduleKey = `Introduction to Derivatives - Intermediate`;
                        if (!completedModulesSession.includes(moduleKey)) {
                            completedModulesSession.push(moduleKey);
                            sessionStorage.setItem('completedModules', JSON.stringify(completedModulesSession));
                        }
                    }
                    
                    sessionStorage.removeItem('introduction-to-derivatives-intermediate-progress');
                    console.log('Progress successfully saved to Firebase');
                
                } catch (error) {
                    console.error('Error saving progress:', error);
                }
            }

            // Add automatic redirection to profile after 3 seconds
            let countdown = 3;
            const redirectMessage = document.createElement('div');
            redirectMessage.style.cssText = 'margin-top: 20px; padding: 15px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; color: #856404; font-weight: 600; text-align: center;';
            redirectMessage.innerHTML = `<p>🔄 Redirecting to Profile in <span id="countdown">${countdown}</span> seconds to show your updated progress...</p><p><a href="profile.html" style="color: #856404; text-decoration: underline;">Click here to go immediately</a></p>`;
            document.getElementById('results').appendChild(redirectMessage);

            const countdownInterval = setInterval(() => {
                countdown--;
                const countdownElement = document.getElementById('countdown');
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = 'profile.html';
                }
            }, 1000);
        };

        // ===== DRAG AND DROP FUNCTIONALITY =====
        
        // Initialize drag and drop system
        function initializeDragDropSystem() {
            console.log('🎮 Initializing drag and drop system...');
            const dragItems = document.querySelectorAll('.drag-item');
            const dropZones = document.querySelectorAll('.drop-zone');
            
            console.log(`Found ${dragItems.length} drag items and ${dropZones.length} drop zones`);
            
            dragItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                
                // Touch support
                item.addEventListener('touchstart', handleTouchStart, {passive: false});
                item.addEventListener('touchmove', handleTouchMove, {passive: false});
                item.addEventListener('touchend', handleTouchEnd, {passive: false});
            });
            
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
            });
        }

        window.initializeDragDrop = initializeDragDropSystem;

        function handleDragStart(e) {
            console.log('🚀 Drag started:', e.target.dataset.function);
            draggedElement = e.target;
            e.dataTransfer.setData('text/plain', e.target.dataset.function);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            console.log('🏁 Drag ended');
            e.target.classList.remove('dragging');
            draggedElement = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            console.log('🎯 Drag enter:', e.target.dataset.derivative);
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            const functionType = e.dataTransfer.getData('text/plain');
            const derivativeType = e.target.dataset.derivative;
            
            console.log('📦 Drop:', functionType, '→', derivativeType);
            
            // Store the match based on which question this is
            const container = e.target.closest('.question-container');
            const questionNumber = container.querySelector('.question-number').textContent;
            
            if (questionNumber === '6') {
                window.dragDropMatches[functionType] = derivativeType;
            } else if (questionNumber === '7') {
                window.ruleApplicationMatches[functionType] = derivativeType;
            }
            
            // Clear previous content and add visual feedback
            const originalContent = e.target.innerHTML.split('<br>')[0];
            e.target.innerHTML = originalContent + `<br><small style="background: rgba(29, 209, 161, 0.8); color: white; padding: 5px 10px; border-radius: 15px; margin-top: 10px; display: inline-block; font-weight: 600;">✓ ${functionType.replace('-', ' ').toUpperCase()}</small>`;
        }

        // Touch support for drag and drop
        let touchItem = null;
        let touchOffset = { x: 0, y: 0 };

        function handleTouchStart(e) {
            touchItem = e.target;
            const touch = e.touches[0];
            const rect = touchItem.getBoundingClientRect();
            touchOffset.x = touch.clientX - rect.left;
            touchOffset.y = touch.clientY - rect.top;
            touchItem.style.position = 'fixed';
            touchItem.style.zIndex = '1000';
            touchItem.classList.add('dragging');
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!touchItem) return;
            
            const touch = e.touches[0];
            touchItem.style.left = (touch.clientX - touchOffset.x) + 'px';
            touchItem.style.top = (touch.clientY - touchOffset.y) + 'px';
        }

        function handleTouchEnd(e) {
            if (!touchItem) return;
            
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (elementBelow && elementBelow.classList.contains('drop-zone')) {
                const functionType = touchItem.dataset.function;
                const derivativeType = elementBelow.dataset.derivative;
                
                // Store based on question number
                const container = elementBelow.closest('.question-container');
                const questionNumber = container.querySelector('.question-number').textContent;
                
                if (questionNumber === '6') {
                    window.dragDropMatches[functionType] = derivativeType;
                } else if (questionNumber === '7') {
                    window.ruleApplicationMatches[functionType] = derivativeType;
                }
                
                const originalContent = elementBelow.innerHTML.split('<br>')[0];
                elementBelow.innerHTML = originalContent + `<br><small style="background: rgba(29, 209, 161, 0.8); color: white; padding: 5px 10px; border-radius: 15px; margin-top: 10px; display: inline-block; font-weight: 600;">✓ ${functionType.replace('-', ' ').toUpperCase()}</small>`;
            }
            
            // Reset position
            touchItem.style.position = '';
            touchItem.style.left = '';
            touchItem.style.top = '';
            touchItem.style.zIndex = '';
            touchItem.classList.remove('dragging');
            touchItem = null;
        }

        // ===== DRAG AND DROP CHECKING FUNCTIONS =====
        
        window.checkDragDrop = function() {
            console.log('🔍 Checking drag and drop matches:', window.dragDropMatches);
            const feedback = document.getElementById('feedback-dragdrop');
            const correctMatches = {
                'product-rule': 'product-rule',
                'quotient-rule': 'quotient-rule', 
                'chain-rule': 'chain-rule',
                'power-rule': 'power-rule'
            };
            
            let score = 0;
            let total = Object.keys(correctMatches).length;
            
            Object.keys(correctMatches).forEach(func => {
                if (window.dragDropMatches[func] === correctMatches[func]) {
                    score++;
                    const dropZone = document.querySelector(`[data-derivative="${correctMatches[func]}"]`);
                    if (dropZone) dropZone.classList.add('matched');
                } else {
                    const userMatch = window.dragDropMatches[func];
                    if (userMatch) {
                        const dropZone = document.querySelector(`[data-derivative="${userMatch}"]`);
                        if (dropZone) dropZone.classList.add('incorrect');
                    }
                }
            });
            
            // Store answer for submission
            mathAnswers[5] = score === total ? 'correct' : 'incorrect';
            sessionStorage.setItem('introduction-to-derivatives-intermediate-progress', JSON.stringify(mathAnswers));
            
            feedback.classList.add('show');
            if (score === total) {
                feedback.classList.add('correct');
                feedback.innerHTML = `✅ Perfect! All ${score} matches are correct!`;
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `❌ ${score}/${total} correct. Review the differentiation rules and try again.`;
            }
        };

        window.checkRuleApplicationDragDrop = function() {
            console.log('🔍 Checking rule application matches:', window.ruleApplicationMatches);
            const feedback = document.getElementById('feedback-rule-application');
            const correctMatches = {
                'product-rule-app': 'product-rule-app',
                'quotient-rule-app': 'quotient-rule-app',
                'chain-rule-app': 'chain-rule-app'
            };
            
            let score = 0;
            let total = Object.keys(correctMatches).length;
            
            Object.keys(correctMatches).forEach(func => {
                if (window.ruleApplicationMatches[func] === correctMatches[func]) {
                    score++;
                    const dropZone = document.querySelector(`[data-derivative="${correctMatches[func]}"]`);
                    if (dropZone) dropZone.classList.add('matched');
                } else {
                    const userMatch = window.ruleApplicationMatches[func];
                    if (userMatch) {
                        const dropZone = document.querySelector(`[data-derivative="${userMatch}"]`);
                        if (dropZone) dropZone.classList.add('incorrect');
                    }
                }
            });
            
            // Store answer for submission
            mathAnswers[6] = score === total ? 'correct' : 'incorrect';
            sessionStorage.setItem('introduction-to-derivatives-intermediate-progress', JSON.stringify(mathAnswers));
            
            feedback.classList.add('show');
            if (score === total) {
                feedback.classList.add('correct');
                feedback.innerHTML = `✅ Excellent! All ${score} rule applications are correct!`;
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `❌ ${score}/${total} correct. Review when to use each rule.`;
            }
        };

        // Reset function for drag and drop
        window.resetDragDrop = function(questionNumber) {
            console.log(`🔄 Resetting drag and drop for question ${questionNumber}`);
            
            // Clear the stored matches
            if (questionNumber === 6) {
                window.dragDropMatches = {};
                delete mathAnswers[5];
            } else if (questionNumber === 7) {
                window.ruleApplicationMatches = {};
                delete mathAnswers[6];
            }
            
            // Find the question container and reset drop zones
            const questionContainers = document.querySelectorAll('.question-container');
            questionContainers.forEach(container => {
                const questionNum = container.querySelector('.question-number').textContent;
                if (questionNum === questionNumber.toString()) {
                    const dropZones = container.querySelectorAll('.drop-zone');
                    dropZones.forEach(zone => {
                        // Reset visual state
                        zone.classList.remove('matched', 'incorrect', 'drag-over');
                        
                        // Reset content to original (remove the matched indicator)
                        const originalContent = zone.innerHTML.split('<br>')[0];
                        zone.innerHTML = originalContent + '<div style="font-size: 0.8em; color: #666; margin-top: 5px;">Drop function here</div>';
                    });
                    
                    // Clear feedback
                    const feedbackId = questionNumber === 6 ? 'feedback-dragdrop' : 'feedback-rule-application';
                    const feedback = document.getElementById(feedbackId);
                    if (feedback) {
                        feedback.classList.remove('show', 'correct', 'incorrect');
                        feedback.innerHTML = '';
                    }
                }
            });
            
            // Update session storage
            sessionStorage.setItem('introduction-to-derivatives-intermediate-progress', JSON.stringify(mathAnswers));
            
            console.log('✅ Reset complete');
        };

        // ===== FLASHCARD SYSTEM =====
        
        window.showFlashcard = function(cardType) {
            console.log('📚 Showing flashcard:', cardType);
            const modal = document.getElementById(`flashcard-${cardType}`);
            if (modal) {
                modal.style.display = 'block';
                
                // Re-render MathJax for the flashcard content
                if (typeof MathJax !== 'undefined') {
                    MathJax.typesetPromise([modal]).catch((err) => 
                        console.log('MathJax flashcard error:', err)
                    );
                }
            } else {
                console.warn('Flashcard not found:', cardType);
            }
        };

        window.closeFlashcard = function(cardType) {
            console.log('❌ Closing flashcard:', cardType);
            const modal = document.getElementById(`flashcard-${cardType}`);
            if (modal) {
                modal.style.display = 'none';
            }
        };

        // Close flashcard when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('flashcard-modal')) {
                event.target.style.display = 'none';
            }
        });

        // Intermediate Animation Functions
        window.initializeIntermediateAnimation = function() {
            console.log('Initializing intermediate animation...');
            const graphDiv = document.getElementById('derivativeGraph');
            if (!graphDiv) {
                console.warn('Intermediate graph div not found');
                return;
            }
            
            // Wait for Plotly to be available
            if (typeof Plotly !== 'undefined') {
                console.log('Plotly is available, updating intermediate graph');
                updateIntermediateGraph();
            } else {
                console.log('Plotly not yet available, using fallback');
                createIntermediateFallbackVisualization(graphDiv);
            }
        };

        window.updateIntermediateGraph = function() {
            console.log('Updating intermediate graph...');
            const graphDiv = document.getElementById('derivativeGraph');
            if (!graphDiv) {
                console.warn('Graph div not found in updateIntermediateGraph');
                return;
            }
            
            if (typeof Plotly === 'undefined') {
                console.warn('Plotly not loaded, using fallback visualization');
                createIntermediateFallbackVisualization(graphDiv);
                return;
            }
            
            const showOriginal = document.getElementById('showOriginal')?.checked ?? true;
            const showFirst = document.getElementById('showFirstDerivative')?.checked ?? true;
            const showSecond = document.getElementById('showSecondDerivative')?.checked ?? false;
            
            const f = (x) => x*x*x - 2*x*x + x;          // Original function
            const f1 = (x) => 3*x*x - 4*x + 1;          // First derivative
            const f2 = (x) => 6*x - 4;                  // Second derivative
            
            const xValues = [];
            for (let x = -1; x <= 3; x += 0.1) {
                xValues.push(x);
            }
            
            const data = [];
            
            if (showOriginal) {
                data.push({
                    x: xValues,
                    y: xValues.map(f),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'f(x) = x³ - 2x² + x',
                    line: { color: 'blue', width: 3 }
                });
            }
            
            if (showFirst) {
                data.push({
                    x: xValues,
                    y: xValues.map(f1),
                    type: 'scatter',
                    mode: 'lines',
                    name: "f'(x) = 3x² - 4x + 1",
                    line: { color: 'red', width: 3 }
                });
            }
            
            if (showSecond) {
                data.push({
                    x: xValues,
                    y: xValues.map(f2),
                    type: 'scatter',
                    mode: 'lines',
                    name: "f''(x) = 6x - 4",
                    line: { color: 'green', width: 3 }
                });
            }
            
            const layout = {
                title: 'Intermediate Derivative Analysis',
                xaxis: { title: 'x', range: [-1, 3] },
                yaxis: { title: 'y', range: [-3, 5] },
                showlegend: true,
                margin: { t: 50, r: 50, b: 50, l: 50 }
            };
            
            try {
                Plotly.newPlot(graphDiv, data, layout, {responsive: true});
                console.log('Intermediate graph plotted successfully');
            } catch (error) {
                console.error('Error plotting intermediate graph:', error);
                createIntermediateFallbackVisualization(graphDiv);
            }
        };

        // Fallback visualization using HTML5 Canvas for intermediate
        function createIntermediateFallbackVisualization(container) {
            console.log('Creating intermediate fallback canvas visualization');
            
            // Clear container and add canvas
            container.innerHTML = '';
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 350;
            canvas.style.width = '100%';
            canvas.style.height = '350px';
            canvas.style.border = '2px solid var(--secondary-color)';
            canvas.style.borderRadius = '10px';
            container.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            
            // Set up coordinate system
            const width = canvas.width;
            const height = canvas.height;
            const margin = 60;
            const graphWidth = width - 2 * margin;
            const graphHeight = height - 2 * margin;
            
            // Clear canvas
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, width, height);
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            // X-axis
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            // Y-axis
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw grid
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = margin + (i / 10) * graphWidth;
                const y = margin + (i / 10) * graphHeight;
                
                ctx.beginPath();
                ctx.moveTo(x, margin);
                ctx.lineTo(x, height - margin);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(width - margin, y);
                ctx.stroke();
            }
            
            // Functions
            const f = (x) => x*x*x - 2*x*x + x;
            const f1 = (x) => 3*x*x - 4*x + 1;
            
            // Convert mathematical coordinates to canvas coordinates
            function toCanvasX(x) {
                return margin + ((x + 1) / 4) * graphWidth;
            }
            
            function toCanvasY(y) {
                return height - margin - ((y + 3) / 8) * graphHeight;
            }
            
            // Draw original function
            const showOriginal = document.getElementById('showOriginal')?.checked ?? true;
            const showFirst = document.getElementById('showFirstDerivative')?.checked ?? true;
            
            if (showOriginal) {
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 3;
                ctx.beginPath();
                let firstPoint = true;
                for (let x = -1; x <= 3; x += 0.1) {
                    const y = f(x);
                    const canvasX = toCanvasX(x);
                    const canvasY = toCanvasY(y);
                    
                    if (firstPoint) {
                        ctx.moveTo(canvasX, canvasY);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(canvasX, canvasY);
                    }
                }
                ctx.stroke();
            }
            
            // Draw first derivative
            if (showFirst) {
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 3;
                ctx.beginPath();
                let firstPoint = true;
                for (let x = -1; x <= 3; x += 0.1) {
                    const y = f1(x);
                    const canvasX = toCanvasX(x);
                    const canvasY = toCanvasY(y);
                    
                    if (firstPoint) {
                        ctx.moveTo(canvasX, canvasY);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(canvasX, canvasY);
                    }
                }
                ctx.stroke();
            }
            
            // Add labels
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.fillText('Intermediate Derivative Visualization', margin, 30);
            
            if (showOriginal) {
                ctx.fillStyle = 'blue';
                ctx.fillText('f(x) = x³ - 2x² + x', margin, height - 10);
            }
            
            if (showFirst) {
                ctx.fillStyle = 'red';
                ctx.fillText("f'(x) = 3x² - 4x + 1", margin + 200, height - 10);
            }
        }

        window.animateIntermediateDerivativeEvolution = function() {
            console.log('Starting intermediate derivative evolution animation...');
            const checkboxes = ['showOriginal', 'showFirstDerivative', 'showSecondDerivative'];
            let currentIndex = 0;
            
            // Reset all checkboxes
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            const animate = () => {
                if (currentIndex < checkboxes.length) {
                    const checkbox = document.getElementById(checkboxes[currentIndex]);
                    if (checkbox) {
                        console.log(`Showing ${checkboxes[currentIndex]}`);
                        checkbox.checked = true;
                        updateIntermediateGraph();
                    }
                    currentIndex++;
                    setTimeout(animate, 1500);
                } else {
                    console.log('Intermediate animation complete');
                }
            };
            
            animate();
        };

        window.showIntermediateCriticalPoints = function() {
            console.log('Showing intermediate critical points...');
            // Critical points where f'(x) = 0: 3x² - 4x + 1 = 0
            // Using quadratic formula: x = (4 ± √(16-12))/6 = (4 ± 2)/6
            const criticalX1 = (4 + 2) / 6; // x = 1
            const criticalX2 = (4 - 2) / 6; // x = 1/3
            
            console.log(`Critical points at x = ${criticalX1.toFixed(3)} and x = ${criticalX2.toFixed(3)}`);
            
            const f = (x) => x*x*x - 2*x*x + x;
            const criticalY1 = f(criticalX1);
            const criticalY2 = f(criticalX2);
            
            const graphDiv = document.getElementById('derivativeGraph');
            if (graphDiv && typeof Plotly !== 'undefined') {
                try {
                    const criticalData = {
                        x: [criticalX1, criticalX2],
                        y: [criticalY1, criticalY2],
                        type: 'scatter',
                        mode: 'markers',
                        name: 'Critical Points',
                        marker: { color: 'orange', size: 12, symbol: 'star' }
                    };
                    
                    Plotly.addTraces(graphDiv, criticalData);
                    console.log('Critical points added to intermediate Plotly graph');
                } catch (error) {
                    console.error('Error adding critical points to intermediate Plotly:', error);
                }
            } else {
                console.log('Using canvas fallback for critical points');
            }
        };

        window.showIntermediateInflectionPoints = function() {
            console.log('Showing intermediate inflection points...');
            // Inflection point where f''(x) = 0: 6x - 4 = 0, so x = 2/3
            const inflectionX = 2/3;
            const f = (x) => x*x*x - 2*x*x + x;
            const inflectionY = f(inflectionX);
            
            console.log(`Inflection point at (${inflectionX.toFixed(3)}, ${inflectionY.toFixed(3)})`);
            
            const graphDiv = document.getElementById('derivativeGraph');
            if (graphDiv && typeof Plotly !== 'undefined') {
                try {
                    const inflectionData = {
                        x: [inflectionX],
                        y: [inflectionY],
                        type: 'scatter',
                        mode: 'markers',
                        name: 'Inflection Point',
                        marker: { color: 'magenta', size: 12, symbol: 'diamond' }
                    };
                    
                    Plotly.addTraces(graphDiv, inflectionData);
                    console.log('Inflection point added to intermediate Plotly graph');
                } catch (error) {
                    console.error('Error adding inflection point to intermediate Plotly:', error);
                }
            } else {
                console.log('Using canvas fallback for inflection point');
            }
        };

        window.resetIntermediateAnimation = function() {
            console.log('Resetting intermediate animation...');
            const checkboxes = ['showOriginal', 'showFirstDerivative', 'showSecondDerivative'];
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = id === 'showOriginal' || id === 'showFirstDerivative';
            });
            updateIntermediateGraph();
        };

        // Step-by-step navigation
        let currentStep = 1;
        let maxSteps = 3;
        let wrongAttempts = {};

        const stepByStepContent = {
            1: {
                title: "Step 1: Identify u and v",
                content: "For the quotient rule $\\frac{d}{dx}\\left[\\frac{u}{v}\\right] = \\frac{u'v - uv'}{v^2}$: $$u = x^2 + 1, \\quad v = x - 1$$ First, find the derivatives $u'$ and $v'$.",
                label: "Find $u' = \\frac{d}{dx}[x^2 + 1]$ and $v' = \\frac{d}{dx}[x - 1]$:",
                answer: "u' = 2x, v' = 1"
            },
            2: {
                title: "Step 2: Apply the quotient rule formula",
                content: "Now substitute into the quotient rule: $$\\frac{d}{dx}\\left[\\frac{x^2 + 1}{x - 1}\\right] = \\frac{(2x)(x - 1) - (x^2 + 1)(1)}{(x - 1)^2}$$",
                label: "Substitute into the formula:",
                answer: "\\frac{2x(x-1) - (x^2+1)}{(x-1)^2}"
            },
            3: {
                title: "Step 3: Simplify the result",
                content: "Expand and simplify the numerator: $$\\frac{2x^2 - 2x - x^2 - 1}{(x - 1)^2} = \\frac{x^2 - 2x - 1}{(x - 1)^2}$$",
                label: "Final simplified answer:",
                answer: "\\frac{x^2 - 2x - 1}{(x - 1)^2}"
            }
        };

        window.nextStep = function() {
            if (currentStep < maxSteps) {
                currentStep++;
                updateStepContent();
            }
        };

        window.previousStep = function() {
            if (currentStep > 1) {
                currentStep--;
                updateStepContent();
            }
        };

        function updateStepContent() {
            const stepContent = document.getElementById('stepContent');
            const stepIndicator = document.getElementById('stepIndicator');
            const stepLabel = document.getElementById('stepLabel');
            const prevBtn = document.getElementById('prevStep');
            const nextBtn = document.getElementById('nextStep');
            
            const step = stepByStepContent[currentStep];
            
            stepContent.innerHTML = `
                <h4>${step.title}</h4>
                <div>${step.content}</div>
            `;
            
            stepIndicator.textContent = `Step ${currentStep} of ${maxSteps}`;
            stepLabel.innerHTML = step.label;
            
            prevBtn.disabled = currentStep === 1;
            nextBtn.disabled = currentStep === maxSteps;
            
            // Re-render MathJax
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise();
            }
        }

        window.checkStepAnswer = function(questionNum) {
            const fieldId = `question${questionNum}`;
            const mathField = window.mathFields[fieldId];
            const feedback = document.getElementById(`feedback-${questionNum}`);
            const hint = document.getElementById(`hint-${questionNum}`);
            const userAnswer = mathField ? mathField.latex() : '';
            
            const step = stepByStepContent[currentStep];
            let isCorrect = false;
            
            if (currentStep === 1) {
                isCorrect = userAnswer.includes('2x') && userAnswer.includes('1');
            } else if (currentStep === 2) {
                isCorrect = userAnswer.includes('2x') && userAnswer.includes('x-1') && userAnswer.includes('x^2+1');
            } else if (currentStep === 3) {
                isCorrect = userAnswer.includes('x^2-2x-1') && userAnswer.includes('(x-1)^2');
            }
            
            if (!isCorrect) {
                wrongAttempts[questionNum] = (wrongAttempts[questionNum] || 0) + 1;
                if (wrongAttempts[questionNum] >= 2 && hint) {
                    hint.classList.add('show');
                }
            }
            
            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');
            
            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = '✅ Excellent! This step is correct!';
                mathAnswers[questionNum] = userAnswer;
                
                // Auto-advance to next step after correct answer
                setTimeout(() => {
                    if (currentStep < maxSteps) {
                        nextStep();
                    }
                }, 1500);
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = '❌ Not quite right. Check your work for this step.';
            }
        };

        // Debug function to test drag and drop
        window.testDragDrop = function() {
            console.log('🧪 Testing drag and drop system...');
            
            // Check if elements exist
            const dragItems = document.querySelectorAll('.drag-item');
            const dropZones = document.querySelectorAll('.drop-zone');
            
            console.log(`Found ${dragItems.length} drag items:`, dragItems);
            dragItems.forEach((item, index) => {
                console.log(`  ${index + 1}: ${item.textContent.trim()} (data-function: ${item.dataset.function})`);
            });
            
            console.log(`Found ${dropZones.length} drop zones:`, dropZones);
            dropZones.forEach((zone, index) => {
                console.log(`  ${index + 1}: ${zone.textContent.trim()} (data-derivative: ${zone.dataset.derivative})`);
            });
            
            console.log('Current matches:');
            console.log('  Function-Derivative matches:', window.dragDropMatches);
            console.log('  Rule-Application matches:', window.ruleApplicationMatches);
            
            // Test if event listeners are attached
            const testItem = dragItems[0];
            if (testItem) {
                console.log('Testing event listeners on first drag item...');
                const events = ['dragstart', 'dragend', 'touchstart', 'touchmove', 'touchend'];
                events.forEach(eventType => {
                    const hasListener = testItem.hasAttribute(`on${eventType}`) || 
                                       testItem.addEventListener.toString().includes(eventType);
                    console.log(`  ${eventType}: ${hasListener ? '✅' : '❌'}`);
                });
            }
            
            alert('Check console for detailed drag and drop test results!');
        };

        // Debug functions
        window.forceCompleteModule = async function() {
            if (!currentUser) {
                alert('Please log in first');
                return;
            }
            
            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const completionPercentage = 100;
                
                // Update module progress with multiple key formats for compatibility
                const updateData = {
                    moduleProgress: {
                        [`Introduction to Derivatives - Intermediate`]: completionPercentage,
                        [`Introduction to derivatives - Intermediate`]: completionPercentage,
                        [`introduction-to-derivatives-intermediate`]: completionPercentage
                    }
                };
                
                // Also mark as completed
                const userData = await getDoc(userDocRef);
                const existingData = userData.exists() ? userData.data() : {};
                const completedModules = existingData.completedModules || [];
                const moduleKey = `Introduction to Derivatives - Intermediate`;
                
                if (!completedModules.includes(moduleKey)) {
                    updateData.completedModules = [...completedModules, moduleKey];
                }
                
                await setDoc(userDocRef, updateData, { merge: true });
                
                // Update sessionStorage
                const currentModuleProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
                currentModuleProgress[`Introduction to Derivatives - Intermediate`] = completionPercentage;
                currentModuleProgress[`Introduction to derivatives - Intermediate`] = completionPercentage;
                currentModuleProgress[`introduction-to-derivatives-intermediate`] = completionPercentage;
                sessionStorage.setItem('moduleProgress', JSON.stringify(currentModuleProgress));
                
                // Update completedModules in sessionStorage
                const completedModulesSession = JSON.parse(sessionStorage.getItem('completedModules') || '[]');
                if (!completedModulesSession.includes(moduleKey)) {
                    completedModulesSession.push(moduleKey);
                    sessionStorage.setItem('completedModules', JSON.stringify(completedModulesSession));
                }
                
                alert('✅ Module manually marked as complete! Check your profile page.');
                console.log('✅ Module force completed:', updateData);
                
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 1000);
                
            } catch (error) {
                console.error('❌ Error force completing module:', error);
                alert('Error marking module as complete: ' + error.message);
            }
        };

        window.checkModuleProgress = function() {
            const sessionProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
            const currentAnswers = Object.keys(mathAnswers).length;
            
            console.log('=== INTERMEDIATE MODULE PROGRESS DEBUG ===');
            console.log('Current user:', currentUser?.email || 'Not logged in');
            console.log('Questions answered:', currentAnswers + '/5');
            console.log('Session storage progress:', sessionProgress);
            console.log('Math answers:', mathAnswers);
            
            const possibleKeys = [
                'Introduction to Derivatives - Intermediate', 
                'Introduction to derivatives - Intermediate', 
                'introduction-to-derivatives-intermediate'
            ];
            
            console.log('Checking possible module keys:');
            possibleKeys.forEach(key => {
                const progress = sessionProgress[key];
                console.log(`  "${key}": ${progress || 'Not found'}`);
            });
            
            alert('Check console for detailed progress information');
        };
    </script>
</body>
</html> 







