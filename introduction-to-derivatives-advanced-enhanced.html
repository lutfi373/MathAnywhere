<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Introduction to Derivatives</title>
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/bootstrap-icons.css">
    <link rel="stylesheet" href="css/styles.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.css">
    <style>
        :root {
            --input-focus: #2d8cf0;
            --font-color: #323232;
            --font-color-sub: #666;
            --bg-color: #f7f9fc;
            --main-color: black;
            --accent-color: #1dd1a1;
            --secondary-color: #54a0ff;
            --tertiary-color: #5f27cd;
            --light-blue: #74b9ff;
            --pink: #fd79a8;
            --purple: #6c5ce7;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fira Code', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--font-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(29, 209, 161, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(84, 160, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(95, 39, 205, 0.15) 0%, transparent 50%);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            box-shadow: 
                20px 20px 60px rgba(0, 0, 0, 0.1),
                -20px -20px 60px rgba(255, 255, 255, 0.8),
                inset 5px 5px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 2px solid var(--main-color);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid var(--main-color);
        }

        .header h1 {
            margin: 0;
            font-size: 3em;
            font-weight: 900;
            position: relative;
            z-index: 1;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        }

        .difficulty-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.25);
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 700;
            margin-top: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            position: relative;
            z-index: 1;
            font-size: 1.1em;
        }

        .content {
            padding: 50px;
        }

        .question-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid var(--main-color);
            box-shadow: 
                8px 8px 20px rgba(0, 0, 0, 0.1),
                -8px -8px 20px rgba(255, 255, 255, 0.7);
            transition: all 0.4s ease;
        }

        .question-number {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-bottom: 20px;
            font-size: 1.3em;
            border: 3px solid var(--main-color);
        }

        .question-text {
            font-size: 1.2em;
            margin-bottom: 25px;
            line-height: 1.7;
            color: var(--font-color);
            font-weight: 600;
        }

        .math-expression {
            background: linear-gradient(135deg, #e8f8f5, #d1ecf1);
            padding: 20px;
            border-radius: 15px;
            font-family: 'Times New Roman', serif;
            font-size: 1.4em;
            text-align: center;
            margin: 20px 0;
            border: 2px solid var(--main-color);
            color: var(--accent-color);
            font-weight: 700;
        }

        .math-input-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid var(--main-color);
            box-shadow: 
                inset 2px 2px 5px rgba(0, 0, 0, 0.1),
                inset -2px -2px 5px rgba(255, 255, 255, 0.8);
        }

        .input-label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            color: var(--font-color);
            font-size: 1.1em;
        }

        .mathquill-field {
            width: 100%;
            margin: 15px 0;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            padding: 15px;
            font-size: 1.2em;
            font-family: 'Times New Roman', serif;
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease;
            box-shadow: 
                2px 2px 5px rgba(0, 0, 0, 0.1),
                -2px -2px 5px rgba(255, 255, 255, 0.8);
        }

        .mathquill-field:focus-within {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(29, 209, 161, 0.3);
            transform: scale(1.02);
        }

        .check-answer-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: 2px solid var(--main-color);
            padding: 12px 25px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 15px 0;
        }

        /* Flashcard styles */
        .flashcard-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .flashcard-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid var(--main-color);
        }

        .flashcard-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(29, 209, 161, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            width: 80%;
            max-width: 700px;
            border-radius: 15px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 30px;
            cursor: pointer;
            color: var(--font-color);
        }

        .close:hover {
            color: var(--accent-color);
        }

        .flashcard {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .flashcard h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .flashcard-content {
            font-size: 1.1em;
            line-height: 1.6;
        }

        .example {
            background: rgba(29, 209, 161, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .check-answer-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(29, 209, 161, 0.3);
        }

        .answer-feedback {
            margin: 15px 0;
            padding: 15px;
            border-radius: 10px;
            font-weight: 600;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .answer-feedback.show {
            display: block;
        }

        .answer-feedback.correct {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border: 2px solid var(--success-color);
            color: #155724;
        }

        .answer-feedback.incorrect {
            background: linear-gradient(135deg, #f8d7da, #f5c6cb);
            border: 2px solid var(--danger-color);
            color: #721c24;
        }

        .math-hint {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid var(--warning-color);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #856404;
            font-weight: 600;
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: 2px solid var(--main-color);
            padding: 15px 40px;
            border-radius: 25px;
            font-size: 1.2em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 30px auto;
            display: block;
            box-shadow: 
                8px 8px 20px rgba(0, 0, 0, 0.1),
                -8px -8px 20px rgba(255, 255, 255, 0.7);
        }

        .submit-btn:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 15px 35px rgba(29, 209, 161, 0.4);
        }

        .nav-btn {
            background: linear-gradient(135deg, var(--tertiary-color), var(--purple));
            color: white;
            border: 2px solid var(--main-color);
            padding: 12px 25px;
            border-radius: 20px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-block;
            margin: 10px;
        }

        .nav-btn:hover {
            transform: translateY(-3px) scale(1.05);
            text-decoration: none;
            color: white;
        }

        .results {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            border: 2px solid var(--main-color);
            text-align: center;
            box-shadow: 
                8px 8px 20px rgba(0, 0, 0, 0.1),
                -8px -8px 20px rgba(255, 255, 255, 0.7);
        }

        .score {
            font-size: 2em;
            font-weight: 900;
            margin-bottom: 20px;
        }

        .score.pass {
            color: var(--success-color);
        }

        .score.fail {
            color: var(--danger-color);
        }

        .navigation {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Touch-friendly enhancements */
        @media (max-width: 768px) {
            .content {
                padding: 20px;
            }
            
            .question-container {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .mathquill-field {
                padding: 12px;
                font-size: 1.1em;
            }
            
            .check-answer-btn, .submit-btn {
                padding: 12px 20px;
                font-size: 1em;
            }
        }





        /* Drag and Drop Styling for Advanced Level */
        .drag-drop-container {
            display: flex;
            gap: 30px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            border: 2px solid var(--main-color);
        }

        .functions-column, .derivatives-column {
            flex: 1;
            padding: 20px;
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-radius: 12px;
            border: 2px solid var(--accent-color);
        }

        .functions-column h4, .derivatives-column h4 {
            text-align: center;
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 700;
        }

        .drag-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .drag-item:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-color: var(--tertiary-color);
        }

        .drag-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            cursor: grabbing;
        }

        .drop-zone {
            background: linear-gradient(135deg, #fff5f5, #fed7d7);
            border: 2px dashed var(--accent-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            background: linear-gradient(135deg, var(--accent-color), var(--tertiary-color));
            color: white;
            border-color: var(--main-color);
            transform: scale(1.05);
        }

        .drop-zone.matched {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            color: white;
            border-color: var(--success-color);
            animation: pulse-success 0.6s ease;
        }

        .drop-zone.incorrect {
            background: linear-gradient(135deg, var(--danger-color), #fd7e14);
            color: white;
            border-color: var(--danger-color);
            animation: shake 0.5s ease;
        }

        @keyframes pulse-success {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Interactive Animation Container */
        .animation-container {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
        }

        .derivative-visualization {
            width: 100%;
            height: 350px;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .step-by-step-container {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .step-navigation {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
        }

        .step-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--tertiary-color));
            color: white;
            border: 2px solid var(--main-color);
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
        }

        .step-btn:hover:not(:disabled) {
            transform: translateY(-2px) scale(1.05);
        }

        .step-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .step-content {
            min-height: 100px;
            padding: 20px;
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-radius: 10px;
            border: 2px solid var(--accent-color);
        }

        /* Adaptive Hints Styling */
        .adaptive-hint {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border: 2px solid var(--warning-color);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .adaptive-hint.show {
            display: block;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Advanced Level Specific Enhancements */
        .advanced-challenge {
            background: linear-gradient(135deg, #fff0f5, #fce4ec);
            border: 3px solid var(--accent-color);
            border-radius: 15px;
            padding: 25px;
            margin: 25px 0;
            position: relative;
        }

        .advanced-challenge::before {
            content: 'üöÄ Advanced Challenge';
            position: absolute;
            top: -15px;
            left: 20px;
            background: linear-gradient(135deg, var(--accent-color), var(--tertiary-color));
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            font-weight: 700;
            font-size: 0.9em;
        }

        /* Answer Format Guide Styling */
        .answer-guide {
            background: linear-gradient(135deg, #f0f8ff, #e6f3ff);
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .answer-guide h3 {
            color: var(--accent-color);
            margin-bottom: 20px;
            font-size: 1.4em;
            text-align: center;
        }

        .format-examples {
            display: grid;
            gap: 15px;
        }

        .format-item {
            background: rgba(255, 255, 255, 0.8);
            padding: 15px;
            border-radius: 10px;
            border-left: 4px solid var(--accent-color);
        }

        .format-item strong {
            color: var(--accent-color);
            display: block;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .format-item span {
            color: var(--font-color);
            font-size: 0.95em;
            line-height: 1.4;
        }

        .toggle-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: 2px solid var(--main-color);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .toggle-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 20px rgba(29, 209, 161, 0.3);
        }

        /* Math Toolbar Styling */
        .math-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            border: 2px solid var(--accent-color);
        }

        .math-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: 2px solid var(--main-color);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 40px;
        }

        .math-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 4px 12px rgba(29, 209, 161, 0.3);
        }

        .function-btn {
            background: linear-gradient(135deg, var(--tertiary-color), var(--purple));
        }

        /* Style for the answer format guides - EXACT COPY from novice */
        .answer-format {
            margin-top: 10px;
            padding: 10px;
            background: rgba(52, 152, 219, 0.05);
            border: 1px dashed #3498db;
            border-radius: 8px;
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            text-align: center;
            font-weight: normal;
            position: relative;
        }
        
        .answer-format::before {
            content: "üìù Answer Format Guide";
            position: absolute;
            top: -12px;
            left: 10px;
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }

        

        /* Text Input Field Styling */
        .text-input-field-wrapper {
            margin: 20px 0;
        }

        .text-input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            font-size: 1.1em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease;
            box-shadow: 
                2px 2px 5px rgba(0, 0, 0, 0.1),
                -2px -2px 5px rgba(255, 255, 255, 0.8);
        }

        .text-input-field:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(29, 209, 161, 0.3);
            transform: scale(1.02);
        }

        .answer-format {
            font-size: 0.9em;
            color: var(--font-color-sub);
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 6px;
            border-left: 3px solid var(--accent-color);
        }

        /* Touch-friendly enhancements */
        @media (max-width: 768px) {
            .drag-drop-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .drag-item, .drop-zone {
                padding: 20px;
                font-size: 1.2em;
            }
            
            .math-toolbar {
                gap: 12px;
            }
            
            .math-btn {
                padding: 12px 16px;
                font-size: 18px;
                min-width: 50px;
            }
            
            .guide-examples {
                flex-direction: column;
            }
            
            .guide-example {
                font-size: 1em;
                padding: 12px;
            }

            .text-input-field {
                padding: 12px;
                font-size: 1em;
            }
        }

        /* Add these styles for flashcards */
        .flashcard-buttons {
            display: flex;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
            justify-content: center;
        }

        .flashcard-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 2px solid var(--main-color);
        }

        .flashcard-btn:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 8px 20px rgba(29, 209, 161, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }

        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 30px;
            width: 80%;
            max-width: 700px;
            border-radius: 15px;
            position: relative;
            animation: slideIn 0.3s ease;
        }

        .close {
            position: absolute;
            right: 20px;
            top: 10px;
            font-size: 30px;
            cursor: pointer;
            color: var(--font-color);
        }

        .close:hover {
            color: var(--accent-color);
        }

        .flashcard {
            background: linear-gradient(135deg, #fff, #f8f9fa);
            border: 2px solid var(--accent-color);
            border-radius: 15px;
            padding: 25px;
            margin: 20px 0;
        }

        .flashcard h3 {
            color: var(--accent-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .flashcard-content {
            font-size: 1.1em;
            line-height: 1.6;
        }

        .example {
            background: rgba(29, 209, 161, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin: 10px 0;
        }

        @keyframes slideIn {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>
    <main>
        <div class="content">
            <!-- Flashcard Buttons -->
            <div class="flashcard-buttons">
                <button class="flashcard-btn" onclick="showFlashcard('derivatives')">üìö Derivative Rules</button>
                <button class="flashcard-btn" onclick="showFlashcard('implicit')">üìù Implicit Differentiation</button>
                <button class="flashcard-btn" onclick="showFlashcard('chain')">üîó Chain Rule</button>
            </div>

            <!-- Flashcard Modal -->
            <div id="flashcardModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <div id="flashcardContent"></div>
                </div>
            </div>

            <div id="questionsContainer">
                <!-- Question 1 -->
                <div class="question-container">
                    <div class="question-number">1</div>
                    <div class="question-text">
                        Find the second derivative of the function f(x) = x¬≥ + 2x¬≤ - 3x + 1
                    </div>
                    <div class="math-expression">
                        $$f''(x) = \_\_\_\_\_\_\_$$
                    </div>
                    <div class="math-input-container">
                        <label class="input-label">Enter your answer:</label>
                        <div class="mathquill-field" id="mq-field-1"></div>
                        <div class="math-toolbar">
                            <button class="math-btn" onclick="insertMath(1, '^')">x^n</button>
                            <button class="math-btn" onclick="insertMath(1, '+')">+</button>
                            <button class="math-btn" onclick="insertMath(1, '-')">-</button>
                        </div>
                        <button class="check-answer-btn" onclick="checkMathAnswer(1)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-1"></div>
                        <div class="math-hint">
                            üí° Hint: Take the derivative twice and check the Derivative Rules flashcard!
                        </div>
                    </div>
                </div>

                <!-- Question 2 -->
                <div class="question-container">
                    <div class="question-number">2</div>
                    <div class="question-text">
                        Find dy/dx by implicit differentiation: x¬≤ + y¬≤ = 25
                    </div>
                    <div class="math-expression">
                        $$\frac{dy}{dx} = \_\_\_\_\_\_\_$$
                    </div>
                    <div class="math-input-container">
                        <label class="input-label">Enter your answer:</label>
                        <div class="mathquill-field" id="mq-field-2"></div>
                        <div class="math-toolbar">
                            <button class="math-btn" onclick="insertMath(2, '\\frac{}{}')">√∑</button>
                            <button class="math-btn" onclick="insertMath(2, '-')">-</button>
                        </div>
                        <button class="check-answer-btn" onclick="checkMathAnswer(2)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-2"></div>
                        <div class="math-hint">
                            üí° Hint: Check the Implicit Differentiation flashcard for help!
                        </div>
                    </div>
                </div>

                <!-- Question 3 -->
                <div class="question-container">
                    <div class="question-number">3</div>
                    <div class="question-text">
                        Find the derivative of f(x) = sin(x¬≤)
                    </div>
                    <div class="math-expression">
                        $$f'(x) = \_\_\_\_\_\_\_$$
                    </div>
                    <div class="math-input-container">
                        <label class="input-label">Enter your answer:</label>
                        <div class="mathquill-field" id="mq-field-3"></div>
                        <div class="math-toolbar">
                            <button class="math-btn" onclick="insertMath(3, '\\sin')">sin</button>
                            <button class="math-btn" onclick="insertMath(3, '\\cos')">cos</button>
                            <button class="math-btn" onclick="insertMath(3, '^')">x^n</button>
                            <button class="math-btn" onclick="insertMath(3, '*')">√ó</button>
                            <button class="math-btn" onclick="insertMath(3, '(')">(</button>
                            <button class="math-btn" onclick="insertMath(3, ')')">)</button>
                        </div>
                        
                        <button class="check-answer-btn" onclick="checkMathAnswer(3)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-3"></div>
                        <div class="math-hint">
                            üí° Hint: Use the Chain Rule! Check the Chain Rule flashcard for help.
                        </div>
                    </div>
                </div>

                <!-- Question 4 - Drag and Drop: Match Functions with Their Derivatives -->
                <div class="question-container">
                    <div class="question-number">4</div>
                    <div class="question-text">
                        Match each function with its derivative
                    </div>
                    
                    <div class="drag-drop-container">
                        <div class="functions-column">
                            <h4>Functions</h4>
                            <div class="drag-item" draggable="true" data-function="sin(x)">sin(x)</div>
                            <div class="drag-item" draggable="true" data-function="e^x">e^x</div>
                            <div class="drag-item" draggable="true" data-function="ln(x)">ln(x)</div>
                            <div class="drag-item" draggable="true" data-function="x^2">x^2</div>
                        </div>
                        
                        <div class="derivatives-column">
                            <h4>Derivatives</h4>
                            <div class="drop-zone" data-derivative="cos(x)">cos(x)</div>
                            <div class="drop-zone" data-derivative="e^x">e^x</div>
                            <div class="drop-zone" data-derivative="1/x">1/x</div>
                            <div class="drop-zone" data-derivative="2x">2x</div>
                        </div>
                    </div>
                    
                    <button class="check-answer-btn" onclick="checkDragDrop(4)">Check Matches</button>
                    <div class="answer-feedback" id="feedback-4"></div>
                </div>

                <!-- Interactive Graph Section -->
                <div class="question-container">
                    <div class="question-number">üìä</div>
                    <div class="question-text">
                        Interactive Visualization: Advanced Derivative Analysis
                    </div>
                    
                    <div class="animation-container">
                        <h4>Explore: $$f(x) = x^4 - 3x^3 + 2x^2$$ and its derivatives</h4>
                        <div class="derivative-visualization" id="advancedGraph"></div>
                        
                        <div style="margin: 20px 0; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="showOriginal" checked onchange="updateAdvancedGraph()">
                                <span style="color: blue; font-weight: 600;">f(x) - Original</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="showFirstDerivative" checked onchange="updateAdvancedGraph()">
                                <span style="color: red; font-weight: 600;">f'(x) - First Derivative</span>
                            </label>
                            <label style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="showSecondDerivative" onchange="updateAdvancedGraph()">
                                <span style="color: green; font-weight: 600;">f''(x) - Second Derivative</span>
                            </label>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: center; margin: 15px 0;">
                            <button class="check-answer-btn" onclick="animateAdvancedDerivativeEvolution()">üé¨ Animate Evolution</button>
                            <button class="check-answer-btn" onclick="showAdvancedCriticalPoints()">üìç Critical Points</button>
                            <button class="check-answer-btn" onclick="resetAdvancedAnimation()">üîÑ Reset</button>
                        </div>
                        
                        <div class="math-expression">
                            $$f(x) = x^4 - 3x^3 + 2x^2$$
                            $$f'(x) = 4x^3 - 9x^2 + 4x$$
                            $$f''(x) = 12x^2 - 18x + 4$$
                        </div>
                    </div>
                </div>
            </div>

            <button class="submit-btn" id="submitBtn" onclick="submitQuiz()">Submit Quiz</button>

            <div id="results" class="results" style="display: none;">
                <div class="score" id="scoreDisplay"></div>
                <div id="resultMessage"></div>
                <div class="navigation">
                    <a href="profile.html" class="nav-btn">‚Üê Back to Profile</a>
                    <a href="profile.html" class="nav-btn">üéâ Complete! ‚Üí</a>
                </div>
            </div>
            
            <!-- Debug Panel for Troubleshooting -->
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px;">
                <h4 style="color: #495057; margin-bottom: 15px;">üõ†Ô∏è Debug Panel</h4>
                <p style="font-size: 14px; color: #6c757d; margin-bottom: 15px;">
                    If your module completion isn't saving properly, use these tools:
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="checkModuleProgress()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px;">
                        üìä Check Progress
                    </button>
                    <button onclick="forceCompleteModule()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px;">
                        ‚úÖ Force Complete
                    </button>
                </div>
                <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                    Use "Check Progress" to see debug info in console, or "Force Complete" to manually mark as done.
                </p>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, doc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBUfSOSpmCdWUGTVbSQsMCH-JVmrjpfdPY",
            authDomain: "fyp-lutfi-naim.firebaseapp.com",
            projectId: "fyp-lutfi-naim",
            storageBucket: "fyp-lutfi-naim.firebasestorage.app",
            messagingSenderId: "231274529807",
            appId: "1:231274529807:web:c4ea279f9e7581bd674f7a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let mathAnswers = {};
        let currentUser = null;
        let mathFields = {};
        let dragDropMatches = {};

        const mathCorrectAnswers = {
            0: "increasing_rapidly", // Theory - steep positive slope
            1: "average_vs_instantaneous", // Theory - rate differences  
            2: "limits_avoid_zero_division", // Theory - why limits needed
            3: "secant_vs_tangent", // Theory - line differences
            4: "real_world_application" // Theory - practical uses
        };

        // Enhanced normalization function for flexible answer checking
        function normalizeExpression(expr) {
            if (!expr) return '';
            
            return expr.toLowerCase()
                .replace(/\s+/g, '') // Remove spaces
                .replace(/\*/g, '') // Remove multiplication symbols
                .replace(/\\\\/g, '\\') // Normalize backslashes
                
                // Handle common mathematical expressions
                .replace(/ln\(x\)/g, 'ln(x)')
                .replace(/\^/g, '^')
                .replace(/\(/g, '(')
                .replace(/\)/g, ')')
                .replace(/\+/g, '+')
                .replace(/\-/g, '-')
                
                // Handle specific patterns for this module
                .replace(/7\*\(3x\^2\+5x\-1\)\^6\*\(6x\+5\)/g, '7*(3x^2+5x-1)^6*(6x+5)')
                .replace(/3x\^2\*ln\(x\)\+x\^2/g, '3x^2*ln(x)+x^2')
                .replace(/x\^2\*\(3\*ln\(x\)\+1\)/g, '3x^2*ln(x)+x^2');
        }

        // Check if two expressions are mathematically equivalent
        function checkEquivalence(userExpr, correctExpr) {
            const normalizedUser = normalizeExpression(userExpr);
            const normalizedCorrect = normalizeExpression(correctExpr);
            
            console.log('Checking:', normalizedUser, '===', normalizedCorrect);
            
            // Direct match
            if (normalizedUser === normalizedCorrect) return true;
            
            // Check if one contains the other
            if (normalizedUser.includes(normalizedCorrect) || normalizedCorrect.includes(normalizedUser)) {
                return true;
            }
            
            return false;
        }

        // Initialize event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Add event listeners for all text inputs (Questions 0-4)
            [0, 1, 2, 3, 4].forEach(questionNum => {
                const textField = document.getElementById(`question${questionNum}`);
                if (textField) {
                    textField.addEventListener('input', function() {
                        mathAnswers[questionNum] = this.value;
                        sessionStorage.setItem('introduction-to-derivatives-advanced-progress', JSON.stringify(mathAnswers));
                    });
                }
            });
        });

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadProgress();
            } else {
                window.location.href = 'index.html';
            }
        });

        function loadProgress() {
            const saved = sessionStorage.getItem('introduction-to-derivatives-advanced-progress');
            if (saved) {
                mathAnswers = JSON.parse(saved);
                restoreAnswers();
            }
        }

        function restoreAnswers() {
            Object.keys(mathAnswers).forEach(questionNum => {
                const answer = mathAnswers[questionNum];
                
                // All questions are now text input fields
                const textField = document.getElementById(`question${questionNum}`);
                if (textField && answer) {
                    textField.value = answer;
                }
            });
            updateProgress();
        }

        window.checkMathAnswer = function(questionNum) {
            const feedback = document.getElementById(`feedback-${questionNum}`);
            const textField = document.getElementById(`question${questionNum}`);
            const userAnswer = textField ? textField.value.toLowerCase().trim() : '';
            let isCorrect = false;
            
            // Debug logging
            console.log(`Question ${questionNum}: User answered "${userAnswer}"`);
            console.log(`Question ${questionNum}: Original answer: "${textField ? textField.value : 'No input found'}"`);
            
            // Check answers based on advanced calculus content - FLEXIBLE VALIDATION
            if (questionNum === 0) {
                // Question 1: Second derivative and concavity - Accept any mention of concave up/upward concavity
                isCorrect = (userAnswer.includes('concave up') || 
                           userAnswer.includes('upward concav') || 
                           userAnswer.includes('concave') && userAnswer.includes('up') ||
                           userAnswer.includes('positive concav') ||
                           userAnswer.includes('upward') ||
                           userAnswer.includes('concav') ||
                           userAnswer.includes('up'));
            } else if (questionNum === 1) {
                // Question 2: Implicit differentiation - Accept any mention of dy/dx or chain rule
                isCorrect = (userAnswer.includes('dy/dx') || 
                           userAnswer.includes('chain rule') || 
                           userAnswer.includes('derivative') || 
                           userAnswer.includes('chain') || 
                           userAnswer.includes('multiply') ||
                           userAnswer.includes('dy') ||
                           userAnswer.includes('dx'));
            } else if (questionNum === 2) {
                // Question 3: Related rates - Accept any mention of differentiation with respect to time
                isCorrect = (userAnswer.includes('differentiate') || 
                           userAnswer.includes('derivative') || 
                           userAnswer.includes('time') || 
                           userAnswer.includes('respect') || 
                           userAnswer.includes('substitute') ||
                           userAnswer.includes('both sides') ||
                           userAnswer.includes('values'));
            } else if (questionNum === 3) {
                // Question 4: Optimization - Accept any mention of critical points or min/max
                isCorrect = (userAnswer.includes('0') || 
                           userAnswer.includes('zero') || 
                           userAnswer.includes('minimum') || 
                           userAnswer.includes('maximum') || 
                           userAnswer.includes('min') || 
                           userAnswer.includes('max') ||
                           userAnswer.includes('critical') ||
                           userAnswer.includes('f\'(x)'));
            }
            
            // Debug logging for validation result
            console.log(`Question ${questionNum}: Validation result: ${isCorrect}`);
            
            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');
            
            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = '‚úÖ Excellent! Your advanced calculus understanding is correct!';
                mathAnswers[questionNum] = textField.value; // Store original case
                sessionStorage.setItem('introduction-to-derivatives-advanced-progress', JSON.stringify(mathAnswers));
            } else {
                feedback.classList.add('incorrect');
                if (questionNum === 0) {
                    feedback.innerHTML = '‚ùå Think about concavity: f\'\'(x) > 0 means the function is concave up (upward concavity).';
                } else if (questionNum === 1) {
                    feedback.innerHTML = '‚ùå In implicit differentiation, multiply by dy/dx when differentiating y terms (chain rule).';
                } else if (questionNum === 2) {
                    feedback.innerHTML = '‚ùå Related rates: differentiate both sides with respect to time, then substitute known values.';
                } else if (questionNum === 3) {
                    feedback.innerHTML = '‚ùå Critical points occur when f\'(x) = 0. Use f\'\'(x) > 0 for minimum, f\'\'(x) < 0 for maximum.';
                }
            }
            
            updateProgress();
        };

        function updateProgress() {
            const totalQuestions = 4;
            const progress = (Object.keys(mathAnswers).length / totalQuestions) * 100;
            if (document.getElementById('progressFill')) {
                document.getElementById('progressFill').style.width = progress + '%';
            }
        }

        // Toggle answer guide
        window.toggleAnswerGuide = function() {
            const guide = document.getElementById('answerGuide');
            const button = document.getElementById('toggleAnswerGuide');
            
            if (guide.style.display === 'none' || guide.style.display === '') {
                guide.style.display = 'block';
                button.textContent = 'üìù Hide Answer Guide';
            } else {
                guide.style.display = 'none';
                button.textContent = 'üìù Show Answer Guide';
            }
        };

        // Advanced Graph Functions
        window.updateAdvancedGraph = function() {
            console.log('Updating advanced graph...');
            const graphDiv = document.getElementById('advancedGraph');
            if (!graphDiv) {
                console.warn('Graph div not found');
                return;
            }
            
            if (typeof Plotly === 'undefined') {
                console.warn('Plotly not loaded, using fallback');
                createAdvancedFallbackVisualization(graphDiv);
                return;
            }
            
            const showOriginal = document.getElementById('showOriginal')?.checked ?? true;
            const showFirst = document.getElementById('showFirstDerivative')?.checked ?? true;
            const showSecond = document.getElementById('showSecondDerivative')?.checked ?? false;
            
            // Advanced function: f(x) = x^4 - 3x^3 + 2x^2
            const f = (x) => x*x*x*x - 3*x*x*x + 2*x*x;
            const f1 = (x) => 4*x*x*x - 9*x*x + 4*x;
            const f2 = (x) => 12*x*x - 18*x + 4;
            
            const xValues = [];
            for (let x = -1; x <= 3; x += 0.1) {
                xValues.push(x);
            }
            
            const data = [];
            
            if (showOriginal) {
                data.push({
                    x: xValues,
                    y: xValues.map(f),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'f(x) = x‚Å¥ - 3x¬≥ + 2x¬≤',
                    line: { color: 'blue', width: 3 }
                });
            }
            
            if (showFirst) {
                data.push({
                    x: xValues,
                    y: xValues.map(f1),
                    type: 'scatter',
                    mode: 'lines',
                    name: "f'(x) = 4x¬≥ - 9x¬≤ + 4x",
                    line: { color: 'red', width: 3 }
                });
            }
            
            if (showSecond) {
                data.push({
                    x: xValues,
                    y: xValues.map(f2),
                    type: 'scatter',
                    mode: 'lines',
                    name: "f''(x) = 12x¬≤ - 18x + 4",
                    line: { color: 'green', width: 3 }
                });
            }
            
            const layout = {
                title: 'Advanced Derivative Analysis',
                xaxis: { title: 'x', range: [-1, 3] },
                yaxis: { title: 'y', range: [-5, 10] },
                showlegend: true,
                margin: { t: 50, r: 50, b: 50, l: 50 }
            };
            
            try {
                Plotly.newPlot(graphDiv, data, layout, {responsive: true});
            } catch (error) {
                console.error('Error plotting graph:', error);
                createAdvancedFallbackVisualization(graphDiv);
            }
        };

        function createAdvancedFallbackVisualization(container) {
            container.innerHTML = '<div style="padding: 50px; text-align: center; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px;"><h4>Interactive Graph</h4><p>Advanced derivative visualization for f(x) = x‚Å¥ - 3x¬≥ + 2x¬≤</p><p style="color: blue;">‚ñ† Original Function</p><p style="color: red;">‚ñ† First Derivative</p><p style="color: green;">‚ñ† Second Derivative</p></div>';
        }

        window.animateAdvancedDerivativeEvolution = function() {
            console.log('Starting advanced animation...');
            const checkboxes = ['showOriginal', 'showFirstDerivative', 'showSecondDerivative'];
            let currentIndex = 0;
            
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            const animate = () => {
                if (currentIndex < checkboxes.length) {
                    const checkbox = document.getElementById(checkboxes[currentIndex]);
                    if (checkbox) {
                        checkbox.checked = true;
                        updateAdvancedGraph();
                    }
                    currentIndex++;
                    setTimeout(animate, 1500);
                }
            };
            
            animate();
        };

        window.showAdvancedCriticalPoints = function() {
            console.log('Showing advanced critical points...');
            alert('Critical points analysis:\n\nf\'(x) = 4x¬≥ - 9x¬≤ + 4x = x(4x¬≤ - 9x + 4)\n\nCritical points occur when f\'(x) = 0\nSolving: x = 0 and 4x¬≤ - 9x + 4 = 0\n\nThis gives us critical points that can be analyzed for local maxima and minima.');
        };

        window.resetAdvancedAnimation = function() {
            const checkboxes = ['showOriginal', 'showFirstDerivative', 'showSecondDerivative'];
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = id === 'showOriginal' || id === 'showFirstDerivative';
            });
            updateAdvancedGraph();
        };

        // Initialize graph on page load
        setTimeout(() => {
            updateAdvancedGraph();
        }, 1000);

        // Debug functions
        window.checkModuleProgress = function() {
            console.log('Current answers:', mathAnswers);
            console.log('Progress:', Object.keys(mathAnswers).length + '/6 questions');
            console.log('User:', currentUser ? currentUser.email : 'Not logged in');
            alert('Check console for debug information');
        };

        window.forceCompleteModule = function() {
            if (confirm('Force complete this module? This will mark it as completed.')) {
                saveModuleCompletion(true);
                alert('Module marked as complete!');
            }
        };

        window.submitQuiz = async function() {
            if (Object.keys(mathAnswers).length < 3) {
                alert('Please answer at least 3 questions before submitting.');
                return;
            }

            let score = 0;
            
            // Check each question using the same logic as checkMathAnswer
            for (let questionNum = 0; questionNum < 4; questionNum++) {
                let userAnswer = (mathAnswers[questionNum] || '').toLowerCase().trim();
                let isCorrect = false;
                
                if (questionNum === 0) {
                    // Question 1: Second derivative and concavity - FLEXIBLE VALIDATION
                    isCorrect = (userAnswer.includes('concave up') || 
                               userAnswer.includes('upward concav') || 
                               userAnswer.includes('concave') && userAnswer.includes('up') ||
                               userAnswer.includes('positive concav') ||
                               userAnswer.includes('upward') ||
                               userAnswer.includes('concav') ||
                               userAnswer.includes('up'));
                } else if (questionNum === 1) {
                    // Question 2: Implicit differentiation - FLEXIBLE VALIDATION
                    isCorrect = (userAnswer.includes('dy/dx') || 
                               userAnswer.includes('chain rule') || 
                               userAnswer.includes('derivative') || 
                               userAnswer.includes('chain') || 
                               userAnswer.includes('multiply') ||
                               userAnswer.includes('dy') ||
                               userAnswer.includes('dx'));
                } else if (questionNum === 2) {
                    // Question 3: Related rates - FLEXIBLE VALIDATION
                    isCorrect = (userAnswer.includes('differentiate') || 
                               userAnswer.includes('derivative') || 
                               userAnswer.includes('time') || 
                               userAnswer.includes('respect') || 
                               userAnswer.includes('substitute') ||
                               userAnswer.includes('both sides') ||
                               userAnswer.includes('values'));
                } else if (questionNum === 3) {
                    // Question 4: Optimization - FLEXIBLE VALIDATION
                    isCorrect = (userAnswer.includes('0') || 
                               userAnswer.includes('zero') || 
                               userAnswer.includes('minimum') || 
                               userAnswer.includes('maximum') || 
                               userAnswer.includes('min') || 
                               userAnswer.includes('max') ||
                               userAnswer.includes('critical') ||
                               userAnswer.includes('f\'(x)'));
                }
                
                if (isCorrect) score++;
            }

            const percentage = Math.round((score / 4) * 100);
            const passed = score >= 2;  // Adjusted passing threshold for 4 questions

            document.getElementById('scoreDisplay').textContent = `${score}/4 (${percentage}%)`;
            document.getElementById('scoreDisplay').className = `score ${passed ? 'pass' : 'fail'}`;
            document.getElementById('resultMessage').innerHTML = passed 
                ? '<h3 style="color: var(--success-color);">üéâ Outstanding! You\'ve mastered advanced calculus concepts!</h3><p>You\'ve successfully completed the Advanced Introduction to Derivatives module with deep understanding of higher-order derivatives, implicit differentiation, related rates, and optimization!</p>'
                : '<h3 style="color: var(--danger-color);">Keep practicing!</h3><p>You need at least 2 correct answers to pass. Review the advanced calculus concepts: concavity, implicit differentiation, related rates, and optimization techniques.</p>';

            document.getElementById('results').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'none';

            if (currentUser) {
                try {
                    // Save progress with the EXACT keys that profile.html expects
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    const updateData = {
                        moduleProgress: {
                            [`Introduction to derivatives - Advanced`]: percentage,  // Exact match for profile.html
                            [`Introduction to Derivatives - Advanced`]: percentage,   // Backup with capital D
                            [`introduction-to-derivatives-advanced`]: percentage      // URL-friendly version
                        }
                    };
                    
                    await setDoc(userDocRef, updateData, { merge: true });
                    
                    // Also save to session storage for immediate access
                    const existingProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
                    existingProgress[`Introduction to derivatives - Advanced`] = percentage;  // Primary key
                    existingProgress[`Introduction to Derivatives - Advanced`] = percentage;   // Backup
                    existingProgress[`introduction-to-derivatives-advanced`] = percentage;     // URL version
                    sessionStorage.setItem('moduleProgress', JSON.stringify(existingProgress));
                    
                    // Clear the quiz progress
                    sessionStorage.removeItem('introduction-to-derivatives-advanced-progress');
                    
                    console.log('‚úÖ Progress saved successfully:', {
                        percentage: percentage,
                        passed: passed,
                        score: score,
                        moduleKeys: ['Introduction to derivatives - Advanced', 'Introduction to Derivatives - Advanced', 'introduction-to-derivatives-advanced']
                    });
                    
                } catch (error) {
                    console.error('‚ùå Error saving progress:', error);
                    alert('There was an error saving your progress. Please try again or contact support.');
                }
            }

            // Add automatic redirection to profile after 3 seconds
            let countdown = 3;
            const redirectMessage = document.createElement('div');
            redirectMessage.style.cssText = 'margin-top: 20px; padding: 15px; background: #f8d7da; border: 2px solid #dc3545; border-radius: 8px; color: #721c24; font-weight: 600; text-align: center;';
            redirectMessage.innerHTML = `<p>üîÑ Redirecting to Profile in <span id="countdown">${countdown}</span> seconds to show your updated progress...</p><p><a href="profile.html" style="color: #721c24; text-decoration: underline;">Click here to go immediately</a></p>`;
            document.getElementById('results').appendChild(redirectMessage);

            const countdownInterval = setInterval(() => {
                countdown--;
                const countdownElement = document.getElementById('countdown');
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = 'profile.html';
                }
            }, 1000);
        };

        // Debug function to manually mark module as complete
        window.forceCompleteModule = async function() {
            if (!currentUser) {
                alert('Please log in first');
                return;
            }
            
            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const completionPercentage = 100;
                
                const updateData = {
                    moduleProgress: {
                        [`Introduction to derivatives - Advanced`]: completionPercentage,  // Primary key that profile.html uses
                        [`Introduction to Derivatives - Advanced`]: completionPercentage,   // Backup
                        [`introduction-to-derivatives-advanced`]: completionPercentage      // URL version
                    }
                };
                
                await setDoc(userDocRef, updateData, { merge: true });
                
                // Also update session storage with exact keys
                const existingProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
                existingProgress[`Introduction to derivatives - Advanced`] = completionPercentage;  // PRIMARY KEY
                existingProgress[`Introduction to Derivatives - Advanced`] = completionPercentage;   // Backup
                existingProgress[`introduction-to-derivatives-advanced`] = completionPercentage;     // URL version
                sessionStorage.setItem('moduleProgress', JSON.stringify(existingProgress));
                
                alert('‚úÖ Module manually marked as complete! Check your profile page.');
                console.log('‚úÖ Module force completed:', updateData);
                
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 1000);
                
            } catch (error) {
                console.error('‚ùå Error force completing module:', error);
                alert('Error marking module as complete: ' + error.message);
            }
        };

        // Debug function to check current progress
        window.checkModuleProgress = function() {
            const sessionProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
            const currentAnswers = Object.keys(mathAnswers).length;
            
            console.log('=== MODULE PROGRESS DEBUG ===');
            console.log('Current user:', currentUser?.email || 'Not logged in');
            console.log('Questions answered:', currentAnswers + '/5');
            console.log('Session storage progress:', sessionProgress);
            console.log('Math answers:', mathAnswers);
            
            // Check all possible module key variations
            const possibleKeys = [
                'Introduction to derivatives - Advanced',
                'Introduction to Derivatives - Advanced', 
                'introduction-to-derivatives-advanced',
                'Introduction to derivatives',
                'Introduction to Derivatives'
            ];
            
            console.log('Checking possible module keys:');
            possibleKeys.forEach(key => {
                const progress = sessionProgress[key];
                console.log(`  "${key}": ${progress || 'Not found'}`);
            });
            
            alert('Check console for detailed progress information');
        };

        // Enhanced Mathematical toolbar function for advanced level
        window.insertMath = function(questionNum, symbol) {
            try {
                if (!mathFields || !mathFields[questionNum]) {
                    console.warn('MathField not properly initialized for question', questionNum);
                    return;
                }
                
                const field = mathFields[questionNum];
                field.focus();
                
                switch(symbol) {
                    case '\\frac{}{}':
                        field.write('\\frac{}{}');
                        field.keystroke('Left Left Left');
                        break;
                    case '\\sqrt{}':
                        field.write('\\sqrt{}');
                        field.keystroke('Left');
                        break;
                    case 'e^{}':
                        field.write('e^{}');
                        field.keystroke('Left');
                        break;
                    case 'f\\\\\\\\\\\\(x)':
                        field.write('f\'(x)');
                        break;
                    case 'f(x)':
                        field.write('f(x)');
                        break;
                    case '\\frac{dy}{dx}':
                        field.write('\\frac{dy}{dx}');
                        break;
                    case '\\lim':
                        field.write('\\lim_{x \\to 0}');
                        field.keystroke('Right');
                        break;
                    case '\\ln':
                        field.write('\\ln\\left(\\right)');
                        field.keystroke('Left Left Left Left Left Left Left');
                        break;
                    case '\\sin':
                        field.write('\\sin\\left(\\right)');
                        field.keystroke('Left Left Left Left Left Left Left Left');
                        break;
                    case '\\cos':
                        field.write('\\cos\\left(\\right)');
                        field.keystroke('Left Left Left Left Left Left Left Left');
                        break;
                    case '\\tan':
                        field.write('\\tan\\left(\\right)');
                        field.keystroke('Left Left Left Left Left Left Left Left');
                        break;
                    case '\\sec':
                        field.write('\\sec\\left(\\right)');
                        field.keystroke('Left Left Left Left Left Left Left Left');
                        break;
                    case '\\to':
                        field.write('\\to ');
                        break;
                    case '*':
                        field.write('\\cdot ');
                        break;
                    case '^':
                        field.write('^{}');
                        field.keystroke('Left');
                        break;
                    case '(':
                        field.write('\\left(\\right)');
                        field.keystroke('Left Left Left Left Left Left Left');
                        break;
                    case ')':
                        field.write('\\right)');
                        break;
                    case '/':
                        field.write('\\frac{}{}');
                        field.keystroke('Left Left Left');
                        break;
                    default:
                        field.write(symbol + ' ');
                        break;
                }
                
                // Update stored answer
                const latex = field.latex();
                mathAnswers[questionNum] = latex;
                sessionStorage.setItem('introduction-to-derivatives-advanced-progress', JSON.stringify(mathAnswers));
                
                field.blur();
                field.focus();
                
            } catch (error) {
                console.error('Error inserting math symbol:', error);
            }
        };

        // Drag and Drop Functionality for Advanced Functions

        window.initializeDragDrop = function() {
            const dragItems = document.querySelectorAll('.drag-item');
            const dropZones = document.querySelectorAll('.drop-zone');
            
            dragItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                
                // Touch support
                item.addEventListener('touchstart', handleTouchStart, {passive: false});
                item.addEventListener('touchmove', handleTouchMove, {passive: false});
                item.addEventListener('touchend', handleTouchEnd, {passive: false});
            });
            
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
            });
        };

        function handleDragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.dataset.function);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            const functionType = e.dataTransfer.getData('text/plain');
            const derivativeType = e.target.dataset.derivative;
            
            dragDropMatches[functionType] = derivativeType;
            
            // Visual feedback
            e.target.innerHTML += `<br><small style="background: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; margin-top: 10px; display: inline-block;">Matched with: ${functionType}</small>`;
        }

        // Touch support for drag and drop
        let touchItem = null;
        let touchOffset = { x: 0, y: 0 };

        function handleTouchStart(e) {
            touchItem = e.target;
            const touch = e.touches[0];
            const rect = touchItem.getBoundingClientRect();
            touchOffset.x = touch.clientX - rect.left;
            touchOffset.y = touch.clientY - rect.top;
            touchItem.style.position = 'fixed';
            touchItem.style.zIndex = '1000';
            touchItem.classList.add('dragging');
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!touchItem) return;
            
            const touch = e.touches[0];
            touchItem.style.left = (touch.clientX - touchOffset.x) + 'px';
            touchItem.style.top = (touch.clientY - touchOffset.y) + 'px';
        }

        function handleTouchEnd(e) {
            if (!touchItem) return;
            
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (elementBelow && elementBelow.classList.contains('drop-zone')) {
                const functionType = touchItem.dataset.function;
                const derivativeType = elementBelow.dataset.derivative;
                dragDropMatches[functionType] = derivativeType;
                
                elementBelow.innerHTML += `<br><small style="background: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; margin-top: 10px; display: inline-block;">Matched with: ${functionType}</small>`;
            }
            
            // Reset position
            touchItem.style.position = '';
            touchItem.style.left = '';
            touchItem.style.top = '';
            touchItem.style.zIndex = '';
            touchItem.classList.remove('dragging');
            touchItem = null;
        }

        window.checkDragDrop = function() {
            const feedback = document.getElementById('feedback-4');
            const correctMatches = {
                'e^(2x)': 'e^(2x)',
                'ln(x^2+1)': 'ln(x^2+1)',
                'x*sin(x)': 'x*sin(x)',
                'arctan(x)': 'arctan(x)'
            };
            
            let score = 0;
            let total = Object.keys(correctMatches).length;
            
            Object.keys(correctMatches).forEach(func => {
                if (dragDropMatches[func] === correctMatches[func]) {
                    score++;
                    const dropZone = document.querySelector(`[data-derivative="${correctMatches[func]}"]`);
                    if (dropZone) dropZone.classList.add('matched');
                } else {
                    const dropZone = document.querySelector(`[data-derivative="${dragDropMatches[func]}"]`);
                    if (dropZone) dropZone.classList.add('incorrect');
                }
            });
            
            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');
            
            if (score === total) {
                feedback.classList.add('correct');
                feedback.innerHTML = `‚úÖ Perfect! All ${score} advanced matches are correct!`;
                mathAnswers[4] = 'drag_drop_complete';
                sessionStorage.setItem('introduction-to-derivatives-advanced-progress', JSON.stringify(mathAnswers));
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `‚ùå ${score}/${total} correct. Review advanced differentiation rules and try again.`;
            }
            
            updateProgress();
        };

        // Advanced Animation Functions
        window.initializeAdvancedAnimation = function() {
            console.log('Initializing advanced animation...');
            const graphDiv = document.getElementById('advancedGraph');
            if (!graphDiv) {
                console.warn('Advanced graph div not found');
                return;
            }
            
            // Wait for Plotly to be available
            if (typeof Plotly !== 'undefined') {
                console.log('Plotly is available, updating graph');
                updateAdvancedGraph();
            } else {
                console.log('Plotly not yet available, will retry');
                setTimeout(() => {
                    if (typeof Plotly !== 'undefined') {
                        updateAdvancedGraph();
                    }
                }, 1000);
            }
        };

        window.updateAdvancedGraph = function() {
            console.log('Updating advanced graph...');
            const graphDiv = document.getElementById('advancedGraph');
            if (!graphDiv) {
                console.warn('Graph div not found in updateAdvancedGraph');
                return;
            }
            
            if (typeof Plotly === 'undefined') {
                console.warn('Plotly not loaded, using fallback visualization');
                createFallbackVisualization(graphDiv);
                return;
            }
            
            const showOriginal = document.getElementById('showOriginal')?.checked ?? true;
            const showFirst = document.getElementById('showFirstDerivative')?.checked ?? true;
            const showSecond = document.getElementById('showSecondDerivative')?.checked ?? false;
            const showThird = document.getElementById('showThirdDerivative')?.checked ?? false;
            
            const f = (x) => x*x*x - 3*x*x + 2*x + 1;      // Original function
            const f1 = (x) => 3*x*x - 6*x + 2;              // First derivative
            const f2 = (x) => 6*x - 6;                      // Second derivative
            const f3 = (x) => 6;                            // Third derivative
            
            const xValues = [];
            for (let x = -1; x <= 4; x += 0.1) {
                xValues.push(x);
            }
            
            const data = [];
            
            if (showOriginal) {
                data.push({
                    x: xValues,
                    y: xValues.map(f),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'f(x) = x¬≥ - 3x¬≤ + 2x + 1',
                    line: { color: 'blue', width: 3 }
                });
            }
            
            if (showFirst) {
                data.push({
                    x: xValues,
                    y: xValues.map(f1),
                    type: 'scatter',
                    mode: 'lines',
                    name: "f'(x) = 3x¬≤ - 6x + 2",
                    line: { color: 'red', width: 3 }
                });
            }
            
            if (showSecond) {
                data.push({
                    x: xValues,
                    y: xValues.map(f2),
                    type: 'scatter',
                    mode: 'lines',
                    name: "f''(x) = 6x - 6",
                    line: { color: 'green', width: 3 }
                });
            }
            
            if (showThird) {
                data.push({
                    x: xValues,
                    y: xValues.map(f3),
                    type: 'scatter',
                    mode: 'lines',
                    name: "f'''(x) = 6",
                    line: { color: 'purple', width: 3 }
                });
            }
            
            const layout = {
                title: 'Advanced Derivative Analysis',
                xaxis: { title: 'x', range: [-1, 4] },
                yaxis: { title: 'y', range: [-10, 15] },
                showlegend: true,
                margin: { t: 50, r: 50, b: 50, l: 50 }
            };
            
            try {
                Plotly.newPlot(graphDiv, data, layout, {responsive: true});
                console.log('Graph plotted successfully');
            } catch (error) {
                console.error('Error plotting graph:', error);
                createFallbackVisualization(graphDiv);
            }
        };

        // Fallback visualization using HTML5 Canvas
        function createFallbackVisualization(container) {
            console.log('Creating fallback canvas visualization');
            
            // Clear container and add canvas
            container.innerHTML = '';
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 350;
            canvas.style.width = '100%';
            canvas.style.height = '350px';
            canvas.style.border = '2px solid var(--accent-color)';
            canvas.style.borderRadius = '10px';
            container.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            
            // Set up coordinate system
            const width = canvas.width;
            const height = canvas.height;
            const margin = 60;
            const graphWidth = width - 2 * margin;
            const graphHeight = height - 2 * margin;
            
            // Clear canvas
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, width, height);
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            // X-axis
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            // Y-axis
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw grid
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = margin + (i / 10) * graphWidth;
                const y = margin + (i / 10) * graphHeight;
                
                ctx.beginPath();
                ctx.moveTo(x, margin);
                ctx.lineTo(x, height - margin);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(width - margin, y);
                ctx.stroke();
            }
            
            // Functions
            const f = (x) => x*x*x - 3*x*x + 2*x + 1;
            const f1 = (x) => 3*x*x - 6*x + 2;
            
            // Convert mathematical coordinates to canvas coordinates
            function toCanvasX(x) {
                return margin + ((x + 1) / 5) * graphWidth;
            }
            
            function toCanvasY(y) {
                return height - margin - ((y + 10) / 25) * graphHeight;
            }
            
            // Draw original function
            const showOriginal = document.getElementById('showOriginal')?.checked ?? true;
            const showFirst = document.getElementById('showFirstDerivative')?.checked ?? true;
            
            if (showOriginal) {
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 3;
                ctx.beginPath();
                let firstPoint = true;
                for (let x = -1; x <= 4; x += 0.1) {
                    const y = f(x);
                    const canvasX = toCanvasX(x);
                    const canvasY = toCanvasY(y);
                    
                    if (firstPoint) {
                        ctx.moveTo(canvasX, canvasY);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(canvasX, canvasY);
                    }
                }
                ctx.stroke();
            }
            
            // Draw first derivative
            if (showFirst) {
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 3;
                ctx.beginPath();
                let firstPoint = true;
                for (let x = -1; x <= 4; x += 0.1) {
                    const y = f1(x);
                    const canvasX = toCanvasX(x);
                    const canvasY = toCanvasY(y);
                    
                    if (firstPoint) {
                        ctx.moveTo(canvasX, canvasY);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(canvasX, canvasY);
                    }
                }
                ctx.stroke();
            }
            
            // Add labels
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.fillText('Advanced Derivative Visualization (Fallback)', margin, 30);
            
            if (showOriginal) {
                ctx.fillStyle = 'blue';
                ctx.fillText('f(x) = x¬≥ - 3x¬≤ + 2x + 1', margin, height - 10);
            }
            
                         if (showFirst) {
                 ctx.fillStyle = 'red';
                 ctx.fillText("f'(x) = 3x¬≤ - 6x + 2", margin + 200, height - 10);
             }
         }

         // Add critical points to canvas visualization
         function addCriticalPointsToCanvas(x1, y1, x2, y2) {
             console.log('Adding critical points to canvas...');
             const graphDiv = document.getElementById('advancedGraph');
             const canvas = graphDiv.querySelector('canvas');
             if (!canvas) {
                 console.warn('Canvas not found for critical points');
                 return;
             }
             
             const ctx = canvas.getContext('2d');
             const width = canvas.width;
             const height = canvas.height;
             const margin = 60;
             const graphWidth = width - 2 * margin;
             const graphHeight = height - 2 * margin;
             
             function toCanvasX(x) {
                 return margin + ((x + 1) / 5) * graphWidth;
             }
             
             function toCanvasY(y) {
                 return height - margin - ((y + 10) / 25) * graphHeight;
             }
             
             // Draw critical points as orange stars
             ctx.fillStyle = 'orange';
             ctx.strokeStyle = 'orange';
             ctx.lineWidth = 3;
             
             // Point 1
             const canvasX1 = toCanvasX(x1);
             const canvasY1 = toCanvasY(y1);
             drawStar(ctx, canvasX1, canvasY1, 8);
             
             // Point 2
             const canvasX2 = toCanvasX(x2);
             const canvasY2 = toCanvasY(y2);
             drawStar(ctx, canvasX2, canvasY2, 8);
             
             // Add labels
             ctx.fillStyle = 'orange';
             ctx.font = '12px Arial';
             ctx.fillText(`Critical (${x1.toFixed(2)}, ${y1.toFixed(2)})`, canvasX1 + 10, canvasY1 - 10);
             ctx.fillText(`Critical (${x2.toFixed(2)}, ${y2.toFixed(2)})`, canvasX2 + 10, canvasY2 - 10);
         }

         // Add inflection point to canvas visualization
         function addInflectionPointToCanvas(x, y) {
             console.log('Adding inflection point to canvas...');
             const graphDiv = document.getElementById('advancedGraph');
             const canvas = graphDiv.querySelector('canvas');
             if (!canvas) {
                 console.warn('Canvas not found for inflection point');
                 return;
             }
             
             const ctx = canvas.getContext('2d');
             const width = canvas.width;
             const height = canvas.height;
             const margin = 60;
             const graphWidth = width - 2 * margin;
             const graphHeight = height - 2 * margin;
             
             function toCanvasX(x) {
                 return margin + ((x + 1) / 5) * graphWidth;
             }
             
             function toCanvasY(y) {
                 return height - margin - ((y + 10) / 25) * graphHeight;
             }
             
             // Draw inflection point as magenta diamond
             const canvasX = toCanvasX(x);
             const canvasY = toCanvasY(y);
             
             ctx.fillStyle = 'magenta';
             ctx.strokeStyle = 'magenta';
             ctx.lineWidth = 3;
             drawDiamond(ctx, canvasX, canvasY, 8);
             
             // Add label
             ctx.fillStyle = 'magenta';
             ctx.font = '12px Arial';
             ctx.fillText(`Inflection (${x}, ${y})`, canvasX + 10, canvasY - 10);
         }

         // Helper function to draw a star
         function drawStar(ctx, x, y, radius) {
             ctx.beginPath();
             for (let i = 0; i < 5; i++) {
                 const angle = (i * 4 * Math.PI) / 5;
                 const x1 = x + Math.cos(angle) * radius;
                 const y1 = y + Math.sin(angle) * radius;
                 if (i === 0) ctx.moveTo(x1, y1);
                 else ctx.lineTo(x1, y1);
             }
             ctx.closePath();
             ctx.fill();
         }

         // Helper function to draw a diamond
         function drawDiamond(ctx, x, y, size) {
             ctx.beginPath();
             ctx.moveTo(x, y - size);
             ctx.lineTo(x + size, y);
             ctx.lineTo(x, y + size);
             ctx.lineTo(x - size, y);
             ctx.closePath();
             ctx.fill();
         }

        window.animateDerivativeEvolution = function() {
            console.log('Starting derivative evolution animation...');
            const checkboxes = ['showOriginal', 'showFirstDerivative', 'showSecondDerivative', 'showThirdDerivative'];
            let currentIndex = 0;
            
            // Reset all checkboxes
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            const animate = () => {
                if (currentIndex < checkboxes.length) {
                    const checkbox = document.getElementById(checkboxes[currentIndex]);
                    if (checkbox) {
                        console.log(`Showing ${checkboxes[currentIndex]}`);
                        checkbox.checked = true;
                        updateAdvancedGraph();
                    }
                    currentIndex++;
                    setTimeout(animate, 1500);
                } else {
                    console.log('Animation complete');
                }
            };
            
            animate();
        };

        window.showCriticalPoints = function() {
            console.log('Showing critical points...');
            // Critical points where f'(x) = 0: 3x¬≤ - 6x + 2 = 0
            // Using quadratic formula: x = (6 ¬± ‚àö(36-24))/6 = (6 ¬± ‚àö12)/6 = (6 ¬± 2‚àö3)/6 = (3 ¬± ‚àö3)/3
            const criticalX1 = (3 + Math.sqrt(3)) / 3;
            const criticalX2 = (3 - Math.sqrt(3)) / 3;
            
            console.log(`Critical points at x = ${criticalX1.toFixed(3)} and x = ${criticalX2.toFixed(3)}`);
            
            const f = (x) => x*x*x - 3*x*x + 2*x + 1;
            const criticalY1 = f(criticalX1);
            const criticalY2 = f(criticalX2);
            
            const graphDiv = document.getElementById('advancedGraph');
            if (graphDiv && typeof Plotly !== 'undefined') {
                try {
                    const criticalData = {
                        x: [criticalX1, criticalX2],
                        y: [criticalY1, criticalY2],
                        type: 'scatter',
                        mode: 'markers',
                        name: 'Critical Points',
                        marker: { color: 'orange', size: 12, symbol: 'star' }
                    };
                    
                    Plotly.addTraces(graphDiv, criticalData);
                    console.log('Critical points added to Plotly graph');
                } catch (error) {
                    console.error('Error adding critical points to Plotly:', error);
                }
            } else {
                // Add critical points to canvas fallback
                addCriticalPointsToCanvas(criticalX1, criticalY1, criticalX2, criticalY2);
            }
        };

        window.showInflectionPoints = function() {
            console.log('Showing inflection points...');
            // Inflection point where f''(x) = 0: 6x - 6 = 0, so x = 1
            const inflectionX = 1;
            const f = (x) => x*x*x - 3*x*x + 2*x + 1;
            const inflectionY = f(inflectionX);
            
            console.log(`Inflection point at (${inflectionX}, ${inflectionY})`);
            
            const graphDiv = document.getElementById('advancedGraph');
            if (graphDiv && typeof Plotly !== 'undefined') {
                try {
                    const inflectionData = {
                        x: [inflectionX],
                        y: [inflectionY],
                        type: 'scatter',
                        mode: 'markers',
                        name: 'Inflection Point',
                        marker: { color: 'magenta', size: 12, symbol: 'diamond' }
                    };
                    
                    Plotly.addTraces(graphDiv, inflectionData);
                    console.log('Inflection point added to Plotly graph');
                } catch (error) {
                    console.error('Error adding inflection point to Plotly:', error);
                }
            } else {
                // Add inflection point to canvas fallback
                addInflectionPointToCanvas(inflectionX, inflectionY);
            }
        };

        window.resetAdvancedAnimation = function() {
            console.log('Resetting advanced animation...');
            const checkboxes = ['showOriginal', 'showFirstDerivative', 'showSecondDerivative', 'showThirdDerivative'];
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = id === 'showOriginal' || id === 'showFirstDerivative';
            });
            updateAdvancedGraph();
        };

        // Step-by-step navigation for implicit differentiation
        let currentStep = 1;
        let maxSteps = 4;

        const stepByStepContent = {
            1: {
                title: "Step 1: Differentiate both sides with respect to x",
                content: "Apply the product rule to x¬≤y and the chain rule to y¬≥: $$\\frac{d}{dx}[x^2y + y^3] = \\frac{d}{dx}[x + 1]$$ Remember: when differentiating y terms, multiply by dy/dx",
                label: "Differentiate the left side: $\\frac{d}{dx}[x^2y + y^3] =$",
                answer: "2xy + x^2\\frac{dy}{dx} + 3y^2\\frac{dy}{dx}"
            },
            2: {
                title: "Step 2: Set up the equation",
                content: "From step 1, we have: $$2xy + x^2\\frac{dy}{dx} + 3y^2\\frac{dy}{dx} = 1$$ Now collect all terms with dy/dx on one side.",
                label: "Factor out dy/dx:",
                answer: "x^2\\frac{dy}{dx} + 3y^2\\frac{dy}{dx} = 1 - 2xy"
            },
            3: {
                title: "Step 3: Factor out dy/dx",
                content: "Factor dy/dx from the left side: $$(x^2 + 3y^2)\\frac{dy}{dx} = 1 - 2xy$$",
                label: "Write the factored form:",
                answer: "(x^2 + 3y^2)\\frac{dy}{dx} = 1 - 2xy"
            },
            4: {
                title: "Step 4: Solve for dy/dx",
                content: "Divide both sides by (x¬≤ + 3y¬≤): $$\\frac{dy}{dx} = \\frac{1 - 2xy}{x^2 + 3y^2}$$",
                label: "Final answer: $\\frac{dy}{dx} =$",
                answer: "\\frac{1 - 2xy}{x^2 + 3y^2}"
            }
        };

        window.nextStep = function() {
            if (currentStep < maxSteps) {
                currentStep++;
                updateStepContent();
            }
        };

        window.previousStep = function() {
            if (currentStep > 1) {
                currentStep--;
                updateStepContent();
            }
        };

        function updateStepContent() {
            const stepContent = document.getElementById('stepContent');
            const stepIndicator = document.getElementById('stepIndicator');
            const stepLabel = document.getElementById('stepLabel');
            const prevBtn = document.getElementById('prevStep');
            const nextBtn = document.getElementById('nextStep');
            
            const step = stepByStepContent[currentStep];
            
            stepContent.innerHTML = `
                <h4>${step.title}</h4>
                <div>${step.content}</div>
            `;
            
            stepIndicator.textContent = `Step ${currentStep} of ${maxSteps}`;
            stepLabel.innerHTML = step.label;
            
            prevBtn.disabled = currentStep === 1;
            nextBtn.disabled = currentStep === maxSteps;
            
            // Re-render MathJax
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise();
            }
        }

        window.checkStepAnswer = function(questionNum) {
            const fieldId = `question${questionNum}`;
            const mathField = window.mathFields[fieldId];
            const feedback = document.getElementById(`feedback-${questionNum}`);
            const hint = document.getElementById(`hint-${questionNum}`);
            const userAnswer = mathField ? mathField.latex() : '';
            
            const step = stepByStepContent[currentStep];
            const isCorrect = normalizeExpression(userAnswer).includes(normalizeExpression(step.answer)) ||
                             checkEquivalence(userAnswer, step.answer);
            
            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');
            
            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = '‚úÖ Excellent! This advanced step is correct!';
                mathAnswers[questionNum] = userAnswer;
                
                // Auto-advance to next step after correct answer
                setTimeout(() => {
                    if (currentStep < maxSteps) {
                        nextStep();
                    }
                }, 1500);
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = '‚ùå Not quite right. Check your advanced calculus work.';
                
                if (hint) {
                    hint.classList.add('show');
                }
            }
        };

        // Make sure all window functions are properly declared
        window.mathFields = mathFields;
        
        // Ensure drag and drop initialization is available
        window.initializeDragDrop = function() {
            console.log('Initializing drag and drop...');
            const dragItems = document.querySelectorAll('.drag-item');
            const dropZones = document.querySelectorAll('.drop-zone');
            
            console.log('Found drag items:', dragItems.length);
            console.log('Found drop zones:', dropZones.length);
            
            dragItems.forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                
                // Touch support
                item.addEventListener('touchstart', handleTouchStart, {passive: false});
                item.addEventListener('touchmove', handleTouchMove, {passive: false});
                item.addEventListener('touchend', handleTouchEnd, {passive: false});
            });
            
            dropZones.forEach(zone => {
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
            });
        };



        // Save module completion function
        async function saveModuleCompletion(forceComplete = false) {
            if (!currentUser) {
                console.log('No user logged in');
                return;
            }

            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const completionPercentage = forceComplete ? 100 : Math.round((Object.keys(mathAnswers).length / 5) * 100);
                
                const updateData = {
                    moduleProgress: {
                        [`Introduction to derivatives - Advanced`]: completionPercentage,
                        [`Introduction to Derivatives - Advanced`]: completionPercentage,
                        [`introduction-to-derivatives-advanced`]: completionPercentage
                    }
                };
                
                await setDoc(userDocRef, updateData, { merge: true });
                
                const existingProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
                existingProgress[`Introduction to derivatives - Advanced`] = completionPercentage;
                existingProgress[`Introduction to Derivatives - Advanced`] = completionPercentage;
                existingProgress[`introduction-to-derivatives-advanced`] = completionPercentage;
                sessionStorage.setItem('moduleProgress', JSON.stringify(existingProgress));
                
                console.log('‚úÖ Module progress saved:', completionPercentage + '%');
                
            } catch (error) {
                console.error('‚ùå Error saving module completion:', error);
            }
        }

        // Initialize everything immediately after MathQuill is ready
        setTimeout(() => {
            console.log('Initializing advanced features...');
            console.log('Advanced module initialization complete');
        }, 2000);

        // Add this to your existing JavaScript
        window.onload = function() {
            // Initialize MathQuill fields
            // Flashcard content and functionality
            const flashcardContent = {
                derivatives: {
                    title: "Common Derivative Rules",
                    content: `
                        <div class="flashcard">
                            <h3>Power Rule</h3>
                            <p>If f(x) = x^n, then f'(x) = nx^(n-1)</p>
                            <div class="example">Example: d/dx(x¬≥) = 3x¬≤</div>
                        </div>
                        <div class="flashcard">
                            <h3>Common Functions</h3>
                            <p>‚Ä¢ d/dx(sin x) = cos x</p>
                            <p>‚Ä¢ d/dx(e^x) = e^x</p>
                            <p>‚Ä¢ d/dx(ln x) = 1/x</p>
                        </div>
                    `
                },
                implicit: {
                    title: "Implicit Differentiation Guide",
                    content: `
                        <div class="flashcard">
                            <h3>Steps</h3>
                            <p>1. Differentiate both sides with respect to x</p>
                            <p>2. When differentiating y terms, multiply by dy/dx</p>
                            <p>3. Solve for dy/dx</p>
                            <div class="example">
                                Example: x¬≤ + y¬≤ = 25<br>
                                2x + 2y(dy/dx) = 0<br>
                                dy/dx = -x/y
                            </div>
                        </div>
                    `
                },
                chain: {
                    title: "Chain Rule Explained",
                    content: `
                        <div class="flashcard">
                            <h3>Chain Rule</h3>
                            <p>If y = f(u) and u = g(x), then:</p>
                            <p>dy/dx = f'(u) √ó du/dx</p>
                            <div class="example">
                                Example: d/dx(sin(x¬≤))<br>
                                = cos(x¬≤) √ó d/dx(x¬≤)<br>
                                = 2x cos(x¬≤)
                            </div>
                        </div>
                    `
                }
            };

            function showFlashcard(type) {
                const modal = document.getElementById('flashcardModal');
                const content = document.getElementById('flashcardContent');
                const data = flashcardContent[type];
                
                content.innerHTML = `
                    <h2>${data.title}</h2>
                    ${data.content}
                `;
                
                modal.style.display = 'block';
            }

            // Close modal when clicking X or outside
            document.querySelector('.close').onclick = function() {
                document.getElementById('flashcardModal').style.display = 'none';
            }

            window.onclick = function(event) {
                const modal = document.getElementById('flashcardModal');
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            }

            var MQ = MathQuill.getInterface(2);
            mathFields = {
                'mq-field-1': MQ.MathField(document.getElementById('mq-field-1'), {
                    handlers: {
                        edit: function() {
                            mathAnswers[1] = this.latex();
                        }
                    }
                }),
                'mq-field-2': MQ.MathField(document.getElementById('mq-field-2'), {
                    handlers: {
                        edit: function() {
                            mathAnswers[2] = this.latex();
                        }
                    }
                }),
                'mq-field-3': MQ.MathField(document.getElementById('mq-field-3'), {
                    handlers: {
                        edit: function() {
                            mathAnswers[3] = this.latex();
                        }
                    }
                })
            };

            // Initialize drag and drop
            initializeDragDrop();
        };

        // Update the checkMathAnswer function
        window.checkMathAnswer = function(questionNum) {
            const feedback = document.getElementById(`feedback-${questionNum}`);
            let userAnswer = '';
            let isCorrect = false;

            if (questionNum <= 3) {
                userAnswer = mathFields[`mq-field-${questionNum}`].latex();
                
                if (questionNum === 1) {
                    // Second derivative of x¬≥ + 2x¬≤ - 3x + 1
                    isCorrect = checkEquivalence(userAnswer, '6x + 4');
                } else if (questionNum === 2) {
                    // Implicit differentiation of x¬≤ + y¬≤ = 25
                    isCorrect = checkEquivalence(userAnswer, '-x/y');
                } else if (questionNum === 3) {
                    // Chain rule: d/dx(sin(x¬≤))
                    isCorrect = checkEquivalence(userAnswer, '2x\\cos(x^2)');
                }
            }

            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');

            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = '‚úÖ Excellent! Your answer is correct!';
                mathAnswers[questionNum] = userAnswer;
            } else {
                feedback.classList.add('incorrect');
                if (questionNum === 1) {
                    feedback.innerHTML = '‚ùå Not quite. Remember to take the derivative twice: f\'(x) = 3x¬≤ + 4x - 3, then f\'\'(x) = 6x + 4';
                } else if (questionNum === 2) {
                    feedback.innerHTML = '‚ùå Try again. Differentiate both sides: 2x + 2y(dy/dx) = 0, then solve for dy/dx';
                } else if (questionNum === 3) {
                    feedback.innerHTML = '‚ùå Use the chain rule: f\'(x) = cos(x¬≤) √ó d/dx(x¬≤) = 2x cos(x¬≤)';
                }
            }
            
            updateProgress();
        };

        // Update drag and drop checking
        window.checkDragDrop = function(questionNum) {
            const feedback = document.getElementById(`feedback-${questionNum}`);
            let correctMatches;

            if (questionNum === 3) {
                correctMatches = {
                    'sin(x)': 'cos(x)',
                    'e^x': 'e^x',
                    'ln(x)': '1/x',
                    'x^2': '2x'
                };
            } else if (questionNum === 4) {
                correctMatches = {
                    'Product Rule': 'd/dx[x¬≤sin(x)]',
                    'Chain Rule': 'd/dx[sin(x¬≤)]',
                    'Quotient Rule': 'd/dx[sin(x)/x]',
                    'Power Rule': 'd/dx[x^n]'
                };
            }

            let score = 0;
            let total = Object.keys(correctMatches).length;

            Object.keys(correctMatches).forEach(func => {
                if (dragDropMatches[func] === correctMatches[func]) {
                    score++;
                    const dropZone = document.querySelector(`[data-derivative="${correctMatches[func]}"]`);
                    if (dropZone) dropZone.classList.add('matched');
                } else {
                    const dropZone = document.querySelector(`[data-derivative="${dragDropMatches[func]}"]`);
                    if (dropZone) dropZone.classList.add('incorrect');
                }
            });

            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');

            if (score === total) {
                feedback.classList.add('correct');
                feedback.innerHTML = `‚úÖ Perfect! All ${score} matches are correct!`;
                mathAnswers[questionNum] = 'complete';
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `‚ùå ${score}/${total} correct. Try again!`;
            }

            updateProgress();
        };

        // Add these functions for flashcard functionality
        const flashcardContent = {
            derivatives: {
                title: "Common Derivative Rules",
                content: `
                    <div class="flashcard">
                        <h3>Power Rule</h3>
                        <div class="flashcard-content">
                            <p>If f(x) = x^n, then f'(x) = nx^(n-1)</p>
                            <div class="example">Example: d/dx(x¬≥) = 3x¬≤</div>
                        </div>
                    </div>
                    <div class="flashcard">
                        <h3>Trigonometric Functions</h3>
                        <div class="flashcard-content">
                            <p>‚Ä¢ d/dx(sin x) = cos x</p>
                            <p>‚Ä¢ d/dx(cos x) = -sin x</p>
                            <p>‚Ä¢ d/dx(tan x) = sec¬≤ x</p>
                        </div>
                    </div>
                    <div class="flashcard">
                        <h3>Exponential & Logarithmic</h3>
                        <div class="flashcard-content">
                            <p>‚Ä¢ d/dx(e^x) = e^x</p>
                            <p>‚Ä¢ d/dx(ln x) = 1/x</p>
                        </div>
                    </div>
                `
            },
            implicit: {
                title: "Implicit Differentiation Guide",
                content: `
                    <div class="flashcard">
                        <h3>Steps for Implicit Differentiation</h3>
                        <div class="flashcard-content">
                            <p>1. Differentiate both sides with respect to x</p>
                            <p>2. When differentiating y terms, multiply by dy/dx</p>
                            <p>3. Group dy/dx terms on one side</p>
                            <p>4. Solve for dy/dx</p>
                            <div class="example">
                                Example: x¬≤ + y¬≤ = 25<br>
                                2x + 2y(dy/dx) = 0<br>
                                2y(dy/dx) = -2x<br>
                                dy/dx = -x/y
                            </div>
                        </div>
                    </div>
                `
            },
            chain: {
                title: "Chain Rule Explained",
                content: `
                    <div class="flashcard">
                        <h3>The Chain Rule</h3>
                        <div class="flashcard-content">
                            <p>If y = f(u) and u = g(x), then:</p>
                            <p>dy/dx = f'(u) √ó du/dx</p>
                            <div class="example">
                                Example: d/dx(sin(x¬≤))<br>
                                = cos(x¬≤) √ó d/dx(x¬≤)<br>
                                = cos(x¬≤) √ó 2x<br>
                                = 2x cos(x¬≤)
                            </div>
                        </div>
                    </div>
                `
            }
        };

        function showFlashcard(type) {
            const modal = document.getElementById('flashcardModal');
            const content = document.getElementById('flashcardContent');
            const data = flashcardContent[type];
            
            content.innerHTML = `
                <h2>${data.title}</h2>
                ${data.content}
            `;
            
            modal.style.display = 'block';
        }

        // Close modal when clicking the X or outside the modal
        document.querySelector('.close').onclick = function() {
            document.getElementById('flashcardModal').style.display = 'none';
        }

        window.onclick = function(event) {
            const modal = document.getElementById('flashcardModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

    </script>
</body>
</html> 







