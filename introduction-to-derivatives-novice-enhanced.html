<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Introduction to Derivatives - Novice | MathAnywhere</title>
    <link rel="stylesheet" href="styles.css">
    
    <!-- MathQuill resources -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathquill/0.10.1/mathquill.min.js"></script>
    
    <!-- MathJax for rendering mathematical expressions -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Plotly for interactive visualizations -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                packages: {'[+]': ['color']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            }
        };
    </script>
    <style>
        :root {
            --input-focus: #2d8cf0;
            --font-color: #323232;
            --font-color-sub: #666;
            --bg-color: #f7f9fc;
            --main-color: black;
            --accent-color: #1dd1a1;
            --secondary-color: #54a0ff;
            --tertiary-color: #5f27cd;
            --light-blue: #74b9ff;
            --pink: #fd79a8;
            --purple: #6c5ce7;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Fira Code', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-color);
            color: var(--font-color);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(29, 209, 161, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(84, 160, 255, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(95, 39, 205, 0.15) 0%, transparent 50%);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 25px;
            box-shadow: 
                20px 20px 60px rgba(0, 0, 0, 0.1),
                -20px -20px 60px rgba(255, 255, 255, 0.8),
                inset 5px 5px 10px rgba(0, 0, 0, 0.05);
            overflow: hidden;
            border: 2px solid var(--main-color);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border-bottom: 3px solid var(--main-color);
        }

        .header h1 {
            margin: 0;
            font-size: 3em;
            font-weight: 900;
            position: relative;
            z-index: 1;
            text-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        }

        .difficulty-badge {
            display: inline-block;
            background: rgba(255, 255, 255, 0.25);
            padding: 12px 30px;
            border-radius: 50px;
            font-weight: 700;
            margin-top: 20px;
            border: 2px solid rgba(255, 255, 255, 0.4);
            position: relative;
            z-index: 1;
            font-size: 1.1em;
        }

        .content {
            padding: 50px;
        }

        .question-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            border: 2px solid var(--main-color);
            box-shadow: 
                8px 8px 20px rgba(0, 0, 0, 0.1),
                -8px -8px 20px rgba(255, 255, 255, 0.7);
            transition: all 0.4s ease;
        }

        .question-number {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            margin-bottom: 20px;
            font-size: 1.3em;
            border: 3px solid var(--main-color);
        }

        .question-text {
            font-size: 1.2em;
            margin-bottom: 25px;
            line-height: 1.7;
            color: var(--font-color);
            font-weight: 600;
        }

        .math-expression {
            background: linear-gradient(135deg, #e8f8f5, #d1ecf1);
            padding: 20px;
            border-radius: 15px;
            font-family: 'Times New Roman', serif;
            font-size: 1.4em;
            text-align: center;
            margin: 20px 0;
            border: 2px solid var(--main-color);
            color: var(--accent-color);
            font-weight: 700;
        }

        .math-input-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border: 2px solid var(--main-color);
            box-shadow: 
                inset 2px 2px 5px rgba(0, 0, 0, 0.1),
                inset -2px -2px 5px rgba(255, 255, 255, 0.8);
        }

        .math-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            font-size: 1.2em;
            font-family: 'Times New Roman', serif;
            background: rgba(255, 255, 255, 0.9);
            transition: all 0.3s ease;
        }

        .math-input:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(29, 209, 161, 0.3);
            transform: scale(1.02);
        }

        .math-preview {
            background: linear-gradient(135deg, #e8f8f5, #d1ecf1);
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3em;
        }

        .input-label {
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 10px;
            display: block;
            font-size: 1.1em;
        }

        .math-hint {
            background: rgba(29, 209, 161, 0.1);
            border-left: 4px solid var(--accent-color);
            padding: 10px 15px;
            margin-top: 10px;
            border-radius: 0 8px 8px 0;
            font-size: 0.9em;
        }

        .answer-feedback {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
            opacity: 0;
            transform: translateY(-10px);
        }

        .answer-feedback.show {
            opacity: 1;
            transform: translateY(0);
        }

        .answer-feedback.correct {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            color: white;
        }

        .answer-feedback.incorrect {
            background: linear-gradient(135deg, var(--danger-color), #fd7e14);
            color: white;
        }

        .check-answer-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: 2px solid var(--main-color);
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .check-answer-btn:hover {
            transform: translateY(-2px) scale(1.05);
        }

        .submit-btn {
            background: linear-gradient(135deg, var(--accent-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: 3px solid var(--main-color);
            padding: 18px 50px;
            border-radius: 50px;
            font-size: 1.3em;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s ease;
            margin: 40px auto;
            display: block;
        }

        .results {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 40px;
            margin-top: 40px;
            text-align: center;
            border: 3px solid var(--main-color);
            backdrop-filter: blur(10px);
        }

        .score {
            font-size: 4em;
            font-weight: 900;
            margin-bottom: 15px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .score.pass {
            color: var(--success-color);
        }

        .score.fail {
            color: var(--danger-color);
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 40px;
            gap: 20px;
        }

        .nav-btn {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border: 3px solid var(--main-color);
            padding: 15px 30px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 700;
            transition: all 0.4s ease;
            flex: 1;
            text-align: center;
            font-size: 1.1em;
        }

        .nav-btn:hover {
            color: white;
            transform: translateY(-3px);
            text-decoration: none;
        }

        /* Progress bar removed as requested */

        /* MathQuill styling */
        .mathquill-field {
            width: 100%;
            margin: 15px 0;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            padding: 15px;
            font-size: 18px;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.9);
            min-height: 50px;
            box-shadow: 
                2px 2px 5px rgba(0, 0, 0, 0.1),
                -2px -2px 5px rgba(255, 255, 255, 0.8);
        }

        .mathquill-field:focus-within {
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(29, 209, 161, 0.3);
            transform: scale(1.02);
        }

        .mathquill-placeholder {
            color: #aaa;
            font-style: italic;
            position: absolute;
            pointer-events: none;
        }
        
        /* Enhanced Mathematical Toolbar Styling */
        .math-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--main-color);
            border-radius: 15px;
            box-shadow: 
                2px 2px 8px rgba(0, 0, 0, 0.1),
                -2px -2px 8px rgba(255, 255, 255, 0.8);
            position: relative;
        }

        .math-toolbar::before {
            content: "📐 Math Toolbar";
            position: absolute;
            top: -12px;
            left: 20px;
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .math-toolbar:hover::before {
            transform: scale(1.05);
        }

        .math-btn {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid var(--main-color);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 40px;
            text-align: center;
            color: var(--main-color);
            box-shadow: 
                2px 2px 4px rgba(0, 0, 0, 0.1),
                -1px -1px 3px rgba(255, 255, 255, 0.8);
        }

        .math-btn:hover {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            transform: translateY(-2px) scale(1.05);
            box-shadow: 
                3px 3px 8px rgba(0, 0, 0, 0.2),
                -2px -2px 6px rgba(255, 255, 255, 0.9);
        }

        .math-btn:active {
            transform: translateY(1px) scale(0.98);
        }
        
        .show-answer-btn {
            background: linear-gradient(135deg, #ff9a9e, #fad0c4);
            color: #333;
            border: 1px solid #ccc;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: block;
        }
        
        .show-answer-btn:hover {
            background: linear-gradient(135deg, #fad0c4, #ff9a9e);
            transform: translateY(-2px);
        }
        
        .try-again-btn {
            background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
            color: #333;
            border: none;
            padding: 5px 10px;
            border-radius: 10px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .try-again-btn:hover {
            background: linear-gradient(135deg, #c2e9fb, #a1c4fd);
            transform: translateY(-1px);
        }

        .function-btn {
            background: linear-gradient(135deg, var(--tertiary-color), var(--accent-color));
            color: white;
            font-weight: 700;
        }

        .function-btn:hover {
            background: linear-gradient(135deg, var(--accent-color), var(--main-color));
        }

        /* Operator button styling */
        .math-btn[onclick*="'+'"], .math-btn[onclick*="'-'"], .math-btn[onclick*="'*'"], .math-btn[onclick*="'="], .math-btn[onclick*="'^'"] {
            background: linear-gradient(145deg, #10b981, #047857);
            color: white;
            border-color: #047857;
        }

        /* Number button styling */
        .math-btn[onclick*="'0'"], .math-btn[onclick*="'1'"], .math-btn[onclick*="'2'"], .math-btn[onclick*="'3'"], .math-btn[onclick*="'4'"], .math-btn[onclick*="'5'"], .math-btn[onclick*="'6'"], .math-btn[onclick*="'7'"], .math-btn[onclick*="'8'"], .math-btn[onclick*="'9'"] {
            background: linear-gradient(145deg, #3b82f6, #1d4ed8);
            color: white;
            border-color: #1d4ed8;
        }

        /* Parentheses and brackets styling */
        .math-btn[onclick*="'('"], .math-btn[onclick*="')'"] {
            background: linear-gradient(145deg, #f59e0b, #d97706);
            color: white;
            border-color: #d97706;
        }

        /* Special symbols styling */
        .math-btn[onclick*="'\\to'"], .math-btn[onclick*="'\\infty'"], .math-btn[onclick*="'\\Delta'"], .math-btn[onclick*="'\\partial'"] {
            background: linear-gradient(145deg, #ef4444, #dc2626);
            color: white;
            border-color: #b91c1c;
        }

        /* Drag and Drop Styling */
        .drag-drop-container {
            display: flex;
            gap: 30px;
            margin: 20px 0;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            border: 2px solid var(--main-color);
        }

        .functions-column, .derivatives-column {
            flex: 1;
            padding: 20px;
            background: linear-gradient(135deg, #e8f8f5, #d1ecf1);
            border-radius: 12px;
            border: 2px solid var(--accent-color);
        }

        .functions-column h4, .derivatives-column h4 {
            text-align: center;
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.2em;
            font-weight: 700;
        }

        .drag-item {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border: 2px solid var(--accent-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            cursor: grab;
            transition: all 0.3s ease;
            text-align: center;
            font-size: 1.1em;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            user-select: none;
            position: relative;
        }
        
        .drag-item::before {
            content: "↕️";
            position: absolute;
            top: 5px;
            right: 8px;
            font-size: 0.8em;
            opacity: 0.6;
        }

        .drag-item:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            border-color: var(--secondary-color);
        }

        .drag-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            cursor: grabbing;
        }

        .drop-zone {
            background: linear-gradient(135deg, #fff3e0, #ffe0b2);
            border: 2px dashed var(--secondary-color);
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 1.1em;
            transition: all 0.3s ease;
        }

        .drop-zone.drag-over {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            border-color: var(--main-color);
            transform: scale(1.05);
        }

        .drop-zone.matched {
            background: linear-gradient(135deg, var(--success-color), #20c997);
            color: white;
            border-color: var(--success-color);
            animation: pulse-success 0.6s ease;
        }

        .drop-zone.incorrect {
            background: linear-gradient(135deg, var(--danger-color), #fd7e14);
            color: white;
            border-color: var(--danger-color);
            animation: shake 0.5s ease;
        }

        @keyframes pulse-success {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* Flashcard Styling */
        .flashcard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .flashcard-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .flashcard {
            background: linear-gradient(135deg, #ffffff, #f8f9fa);
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 3px solid var(--accent-color);
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(255, 255, 255, 0.1);
            transform: scale(0.8) rotateY(180deg);
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .flashcard-overlay.show .flashcard {
            transform: scale(1) rotateY(0deg);
        }

        .flashcard-header {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
            color: white;
            padding: 20px;
            margin: -40px -40px 30px -40px;
            border-radius: 20px 20px 0 0;
            text-align: center;
            position: relative;
        }

        .flashcard-title {
            font-size: 1.8em;
            font-weight: 900;
            margin: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .flashcard-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flashcard-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .flashcard-content {
            line-height: 1.6;
            color: var(--font-color);
        }

        .flashcard-section {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            border-left: 5px solid var(--accent-color);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .flashcard-section h4 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.3em;
            font-weight: 700;
        }

        .flashcard-section p {
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .flashcard-section ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .flashcard-section li {
            margin-bottom: 8px;
            font-size: 1.05em;
        }

        .flashcard-example {
            background: linear-gradient(135deg, #e8f5e8, #d4edda);
            border-left-color: var(--success-color);
        }

        .flashcard-tip {
            background: linear-gradient(135deg, #fff3cd, #ffeaa7);
            border-left-color: var(--warning-color);
        }

        .flashcard-hint-btn {
            background: linear-gradient(135deg, var(--purple), var(--pink));
            color: white;
            border: 2px solid var(--main-color);
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: inline-block;
        }

        .flashcard-hint-btn:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }

        /* Touch-friendly enhancements */
        @media (max-width: 768px) {
            .drag-drop-container {
                flex-direction: column;
                gap: 20px;
            }
            
            .drag-item, .drop-zone {
                padding: 20px;
                font-size: 1.2em;
            }
            
            .flashcard {
                padding: 30px;
                width: 95%;
            }
            
            .flashcard-header {
                margin: -30px -30px 20px -30px;
            }
        }

        /* Animation for drag and drop success */
        @keyframes celebration {
            0% { transform: scale(1); }
            25% { transform: scale(1.1) rotate(5deg); }
            50% { transform: scale(1.2) rotate(-5deg); }
            75% { transform: scale(1.1) rotate(5deg); }
            100% { transform: scale(1) rotate(0deg); }
        }

        .celebration {
            animation: celebration 0.8s ease;
        }
        
        .answer-hint {
            margin-top: 15px;
            padding: 10px;
            background: #e8f4ff;
            border: 1px solid #4a86e8;
            border-radius: 8px;
            font-family: monospace;
            font-size: 1.2em;
            letter-spacing: 1px;
        }
        
        .hint-btn {
            background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
            color: #333;
            border: 1px solid #ccc;
            padding: 8px 15px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            display: block;
        }
        
        .hint-btn:hover {
            background: linear-gradient(135deg, #c2e9fb, #a1c4fd);
            transform: translateY(-2px);
        }
        
        /* Remove the format display and button styles */
        .format-display, .format-btn {
            display: none;
        }
        
        /* Style for the answer format guides */
        .answer-format {
            margin-top: 10px;
            padding: 10px;
            background: rgba(52, 152, 219, 0.05);
            border: 1px dashed #3498db;
            border-radius: 8px;
            color: #333;
            font-family: 'Courier New', monospace;
            font-size: 18px;
            text-align: center;
            font-weight: normal;
            position: relative;
        }
        
        .answer-format::before {
            content: "📝 Answer Format Guide";
            position: absolute;
            top: -12px;
            left: 10px;
            background: #3498db;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* Style for blank spaces in cloze format */
        .blank {
            display: inline-block;
            min-width: 30px;
            margin: 0 2px;
            position: relative;
        }
        
        /* Style for the underscores in blanks */
        .blank-line {
            color: #3498db;
            font-weight: bold;
            font-size: 18px;
            display: inline;
        }
        
        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }
        
        /* Remove unused styles */
        .answer-format .brace {
            display: none;
        }
        
        /* Container for mathquill fields */
        .mathquill-field-wrapper {
            width: 100%;
            margin: 15px 0;
        }
        
        /* Make mathquill field background opaque */
        .mathquill-field {
            background: rgba(255, 255, 255, 0.95) !important;
        }
        
        /* Text input field styling */
        .text-input-field-wrapper {
            width: 100%;
            margin: 15px 0;
        }
        
        .text-input-field {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--main-color);
            border-radius: 10px;
            font-size: 1.2em;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: rgba(255, 255, 255, 0.95);
            transition: all 0.3s ease;
            box-shadow: 
                2px 2px 5px rgba(0, 0, 0, 0.1),
                -2px -2px 5px rgba(255, 255, 255, 0.8);
        }
        
        .text-input-field:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 15px rgba(29, 209, 161, 0.3);
            transform: scale(1.02);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Introduction to Derivatives</h1>
            <p>Master the fundamental concepts of calculus</p>
            <div class="difficulty-badge">Novice Level</div>
        </div>

        <div class="content">
            <div id="questionsContainer">
                <!-- Question 1 - What is a Derivative? (Theory) -->
                <div class="question-container">
                    <div class="question-number">1</div>
                    <div class="question-text">
                        What does a derivative represent in simple terms?
                    </div>
                    <div class="math-expression">
                        A derivative tells us how fast something is changing
                    </div>
                    
                    <div class="math-input-container">
                        <label class="input-label">Complete the sentence: "A derivative measures the _______ of change of a function."</label>
                        
                        <div class="text-input-field-wrapper">
                            <input type="text" class="text-input-field" id="question0" placeholder="Type your answer here...">
                            <div class="answer-format" id="format-0">Hint: Think about speed vs. velocity - what's the difference?</div>
                        </div>
                        <button class="check-answer-btn" onclick="checkMathAnswer(0)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-0"></div>
                        <button class="flashcard-hint-btn" onclick="showFlashcard('rate-of-change')">
                            💡 Rate of Change Flash Card
                        </button>
                    </div>
                </div>

                <!-- Question 2 - Real-World Applications (Theory) -->
                <div class="question-container">
                    <div class="question-number">2</div>
                    <div class="question-text">
                        In which real-world situation would you most likely use a derivative?
                    </div>
                    
                    <div class="math-input-container">
                        <label class="input-label">Choose the best example:</label>
                        
                        <div style="margin: 20px 0;">
                            <div style="margin: 10px 0;">
                                <input type="radio" id="option2a" name="question2" value="a">
                                <label for="option2a" style="margin-left: 10px; font-size: 1.1em;">Finding how fast a company's profit is growing</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="radio" id="option2b" name="question2" value="b">
                                <label for="option2b" style="margin-left: 10px; font-size: 1.1em;">Calculating the total profit over a year</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="radio" id="option2c" name="question2" value="c">
                                <label for="option2c" style="margin-left: 10px; font-size: 1.1em;">Finding the area under a curve</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="radio" id="option2d" name="question2" value="d">
                                <label for="option2d" style="margin-left: 10px; font-size: 1.1em;">Counting the number of products sold</label>
                            </div>
                        </div>
                        
                        <button class="check-answer-btn" onclick="checkMathAnswer(1)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-1"></div>
                        <button class="flashcard-hint-btn" onclick="showFlashcard('real-world-applications')">
                            🌍 Real World Applications Flash Card
                        </button>
                    </div>
                </div>

                <!-- Question 3 - Slope and Tangent Lines (Theory) -->
                <div class="question-container">
                    <div class="question-number">3</div>
                    <div class="question-text">
                        What does the slope of a tangent line tell us about a function?
                    </div>
                    
                    <div class="math-expression">
                        The slope of a tangent line = the derivative at that point
                    </div>
                    
                    <div class="math-input-container">
                        <label class="input-label">If a tangent line has a steep positive slope, what does this tell us about the function at that point?</label>
                        
                        <div class="text-input-field-wrapper">
                            <input type="text" class="text-input-field" id="question2" placeholder="Describe what's happening to the function...">
                            <div class="answer-format" id="format-2">Think about: Is the function increasing or decreasing? How fast?</div>
                        </div>
                        <button class="check-answer-btn" onclick="checkMathAnswer(2)">Check Understanding</button>
                        <div class="answer-feedback" id="feedback-2"></div>
                        <button class="flashcard-hint-btn" onclick="showFlashcard('slope-meaning')">
                            📈 Slope Meaning Flash Card
                        </button>
                    </div>
                </div>

                <!-- Question 4 - Derivative Notation (Theory) -->
                <div class="question-container">
                    <div class="question-number">4</div>
                    <div class="question-text">
                        What are the different ways to write "the derivative of f(x)"?
                    </div>
                    
                    <div class="math-expression">
                        There are several common notations for derivatives
                    </div>
                    
                    <div class="math-input-container">
                        <label class="input-label">Which of these symbols represent the derivative of f(x)? (Select all that apply)</label>
                        
                        <div style="margin: 20px 0;">
                            <div style="margin: 10px 0;">
                                <input type="checkbox" id="option4a" name="question4" value="a">
                                <label for="option4a" style="margin-left: 10px; font-size: 1.1em;">$f'(x)$</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="checkbox" id="option4b" name="question4" value="b">
                                <label for="option4b" style="margin-left: 10px; font-size: 1.1em;">$\frac{df}{dx}$</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="checkbox" id="option4c" name="question4" value="c">
                                <label for="option4c" style="margin-left: 10px; font-size: 1.1em;">$\int f(x) dx$</label>
                            </div>
                            <div style="margin: 10px 0;">
                                <input type="checkbox" id="option4d" name="question4" value="d">
                                <label for="option4d" style="margin-left: 10px; font-size: 1.1em;">$\frac{d}{dx}[f(x)]$</label>
                            </div>
                        </div>
                        
                        <button class="check-answer-btn" onclick="checkMathAnswer(3)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-3"></div>
                        <button class="flashcard-hint-btn" onclick="showFlashcard('derivative-notation')">
                            📝 Derivative Notation Flash Card
                        </button>
                    </div>
                </div>

                <!-- Question 5 - When are Derivatives Useful? (Theory) -->
                <div class="question-container">
                    <div class="question-number">5</div>
                    <div class="question-text">
                        When would knowing the derivative of a function be most useful?
                    </div>
                    <div class="math-expression">Derivatives help us understand how things change</div>
                    
                    <div class="math-input-container">
                        <label class="input-label">Give an example of when you might want to know how fast something is changing:</label>
                        <div class="text-input-field-wrapper">
                            <input type="text" class="text-input-field" id="question4" placeholder="Describe a real-world situation...">
                            <div class="answer-format" id="format-4">Examples: growth of plants, temperature changes, population growth, stock prices, etc.</div>
                        </div>
                        <button class="check-answer-btn" onclick="checkMathAnswer(4)">Check Answer</button>
                        <div class="answer-feedback" id="feedback-4"></div>
                        <button class="flashcard-hint-btn" onclick="showFlashcard('concept-understanding')">
                            🎯 Concept Flash Card
                        </button>
                        </div>
                    </div>

                <!-- Question 6 - Interactive Drag & Drop: Match Functions with Their Meanings -->
                <div class="question-container">
                    <div class="question-number">6</div>
                    <div class="question-text">
                        🎮 Interactive Challenge: Match each function with what it represents!
                    </div>
                    <div class="math-expression">
                        Drag and drop to match functions with their real-world meanings
                    </div>
                    
                    <div class="drag-drop-container">
                        <div class="functions-column">
                            <h4>📊 Functions</h4>
                            <div class="drag-item" draggable="true" data-function="height">
                                h(t) = Plant height over time
                            </div>
                            <div class="drag-item" draggable="true" data-function="cost">
                                C(x) = Cost to produce x items
                            </div>
                            <div class="drag-item" draggable="true" data-function="temperature">
                                T(t) = Temperature over time
                            </div>
                            <div class="drag-item" draggable="true" data-function="population">
                                P(t) = Population over time
                            </div>
                        </div>
                        
                        <div class="derivatives-column">
                            <h4>📈 Their Derivatives Represent</h4>
                            <div class="drop-zone" data-derivative="growth-speed">
                                Growth rate (how fast height increases)
                            </div>
                            <div class="drop-zone" data-derivative="marginal-cost">
                                Marginal cost (cost of one more item)
                            </div>
                            <div class="drop-zone" data-derivative="temp-rate">
                                Rate of temperature change
                            </div>
                            <div class="drop-zone" data-derivative="population-rate">
                                Population growth rate
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="check-answer-btn" onclick="checkDragDrop()">Check Matches</button>
                        <button class="check-answer-btn" onclick="resetDragDrop(6)" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                            🔄 Reset
                        </button>
                    </div>
                    <div class="answer-feedback" id="feedback-dragdrop"></div>
                    <button class="flashcard-hint-btn" onclick="showFlashcard('derivative-meanings')">
                        🔍 Derivative Meanings Flash Card
                    </button>
                </div>

                <!-- Question 7 - Interactive Drag & Drop: Derivative Notation Matching -->
                <div class="question-container">
                    <div class="question-number">7</div>
                    <div class="question-text">
                        🎯 Notation Challenge: Match the derivative notations!
                    </div>
                    <div class="math-expression">
                        All of these mean the same thing - the derivative of f(x)
                    </div>
                    
                    <div class="drag-drop-container">
                        <div class="functions-column">
                            <h4>📝 Notation Types</h4>
                            <div class="drag-item" draggable="true" data-function="lagrange">
                                f'(x) - Lagrange Notation
                            </div>
                            <div class="drag-item" draggable="true" data-function="leibniz">
                                df/dx - Leibniz Notation
                            </div>
                            <div class="drag-item" draggable="true" data-function="operator">
                                d/dx[f(x)] - Operator Notation
                            </div>
                            <div class="drag-item" draggable="true" data-function="newton">
                                ḟ(x) - Newton's Dot Notation
                            </div>
                        </div>
                        
                        <div class="derivatives-column">
                            <h4>🎓 When to Use</h4>
                            <div class="drop-zone" data-derivative="simple">
                                Simple functions, quick calculations
                            </div>
                            <div class="drop-zone" data-derivative="calculus">
                                Formal calculus, chain rule
                            </div>
                            <div class="drop-zone" data-derivative="operations">
                                When applying derivative operations
                            </div>
                            <div class="drop-zone" data-derivative="physics">
                                Physics, time derivatives
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="check-answer-btn" onclick="checkNotationDragDrop()">Check Matches</button>
                        <button class="check-answer-btn" onclick="resetDragDrop(7)" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                            🔄 Reset
                        </button>
                    </div>
                    <div class="answer-feedback" id="feedback-notation"></div>
                    <button class="flashcard-hint-btn" onclick="showFlashcard('notation-guide')">
                        📚 Notation Guide Flash Card
                    </button>
                </div>

                <!-- Question 8 - Interactive Drag & Drop: Slope Interpretation -->
                <div class="question-container">
                    <div class="question-number">8</div>
                    <div class="question-text">
                        📊 Slope Challenge: What does each slope tell us?
                    </div>
                    <div class="math-expression">
                        The slope of a tangent line = the derivative value
                    </div>
                    
                    <div class="drag-drop-container">
                        <div class="functions-column">
                            <h4>📐 Slope Types</h4>
                            <div class="drag-item" draggable="true" data-function="positive-steep">
                                Steep Positive Slope
                            </div>
                            <div class="drag-item" draggable="true" data-function="positive-gentle">
                                Gentle Positive Slope
                            </div>
                            <div class="drag-item" draggable="true" data-function="zero">
                                Zero Slope (Horizontal)
                            </div>
                            <div class="drag-item" draggable="true" data-function="negative">
                                Negative Slope
                            </div>
                        </div>
                        
                        <div class="derivatives-column">
                            <h4>📈 Function Behavior</h4>
                            <div class="drop-zone" data-derivative="increasing-fast">
                                Function increasing rapidly
                            </div>
                            <div class="drop-zone" data-derivative="increasing-slow">
                                Function increasing slowly
                            </div>
                            <div class="drop-zone" data-derivative="constant">
                                Function has maximum/minimum
                            </div>
                            <div class="drop-zone" data-derivative="decreasing">
                                Function is decreasing
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px; flex-wrap: wrap;">
                        <button class="check-answer-btn" onclick="checkSlopeDragDrop()">Check Matches</button>
                        <button class="check-answer-btn" onclick="resetDragDrop(8)" style="background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                            🔄 Reset
                        </button>
                    </div>
                    <div class="answer-feedback" id="feedback-slope"></div>
                    <button class="flashcard-hint-btn" onclick="showFlashcard('slope-interpretation')">
                        📊 Slope Interpretation Flash Card
                    </button>
                </div>
            </div>

            <button class="submit-btn" id="submitBtn" onclick="submitQuiz()">Submit Quiz</button>
            
            <div style="text-align: center; margin: 20px 0;">
                <button id="toggleAnswerGuide" class="nav-btn" style="background: linear-gradient(135deg, #ff7e5f, #feb47b); border: 2px solid #333; padding: 12px 25px; font-size: 16px;">
                    📝 Show Answer Guide
                </button>
            </div>

            <div id="results" class="results" style="display: none;">
                <div class="score" id="scoreDisplay"></div>
                <div id="resultMessage"></div>
                <div class="navigation">
                    <a href="profile.html" class="nav-btn">← Back to Profile</a>
                    <a href="introduction-to-derivatives-intermediate-enhanced.html" class="nav-btn">Next Level →</a>
                </div>
            </div>

            <!-- Answer Guide Section -->
            <div id="answerGuide" style="margin-top: 30px; padding: 20px; background: #f0f8ff; border: 2px solid #1e90ff; border-radius: 10px; display: none;">
                <h4 style="color: #0066cc; margin-bottom: 15px;">📝 Answer Guide</h4>
                <p style="font-size: 14px; color: #333; margin-bottom: 15px;">
                    Use this guide if you're having trouble with the questions:
                </p>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 1: What does a derivative represent?</h5>
                    <p><strong>Answer:</strong> "A derivative measures the <strong>rate</strong> of change of a function."</p>
                    <p>Other acceptable words: speed, instantaneous rate, pace</p>
                    <p><strong>Explanation:</strong> Just like a speedometer shows how fast your position is changing, a derivative shows how fast a function's output is changing.</p>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 2: Real-world applications</h5>
                    <p><strong>Correct Answer:</strong> A) Finding how fast a company's profit is growing</p>
                    <p><strong>Explanation:</strong> Growth rate is the rate of change of profit over time, which is exactly what derivatives measure!</p>
                    <p>The other options involve:</p>
                    <ul style="margin-left: 20px;">
                        <li>B) Total profit over a year (integration, not differentiation)</li>
                        <li>C) Area under curve (integration)</li>
                        <li>D) Counting products sold (not related to rates of change)</li>
                    </ul>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 3: Steep positive slope meaning</h5>
                    <p><strong>Answer:</strong> "The function is increasing rapidly" (or similar)</p>
                    <p>Key concepts to include:</p>
                    <ul style="margin-left: 20px;">
                        <li>The function is <strong>increasing</strong> (rising, growing, going up)</li>
                        <li>It's happening <strong>rapidly</strong> (fast, quickly, steeply)</li>
                    </ul>
                    <p><strong>Explanation:</strong> A steep positive slope means the function value is rising quickly as x increases.</p>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 4: Derivative notation</h5>
                    <p><strong>Correct Answers:</strong> A, B, and D</p>
                    <ul style="margin-left: 20px;">
                        <li>✅ A) f'(x) - Lagrange notation</li>
                        <li>✅ B) df/dx - Leibniz notation</li>
                        <li>❌ C) ∫f(x)dx - This is an integral (opposite of derivative)</li>
                        <li>✅ D) d/dx[f(x)] - Operator notation</li>
                    </ul>
                </div>
                
                <div style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ccc;">
                    <h5 style="color: #0066cc; margin-bottom: 10px;">Question 5: Real-world examples of rate of change</h5>
                    <p><strong>Sample Answers:</strong></p>
                    <ul style="margin-left: 20px;">
                        <li>Plant growth (how fast height increases)</li>
                        <li>Temperature change (how fast temperature rises/falls)</li>
                        <li>Population growth (how fast population increases)</li>
                        <li>Stock prices (how fast value changes)</li>
                        <li>Water level rising (how fast height changes)</li>
                        <li>Company profits (how fast earnings change)</li>
                    </ul>
                    <p><strong>Key idea:</strong> Any situation where you want to know "how fast" something is changing.</p>
                </div>
            </div>
            
            <!-- Debug Panel for Troubleshooting -->
            <div style="margin-top: 30px; padding: 20px; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 10px;">
                <h4 style="color: #495057; margin-bottom: 15px;">🛠️ Debug Panel</h4>
                <p style="font-size: 14px; color: #6c757d; margin-bottom: 15px;">
                    If your module completion isn't saving properly, use these tools:
                </p>
                <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                    <button onclick="checkModuleProgress()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px;">
                        📊 Check Progress
                    </button>
                    <button onclick="forceCompleteModule()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px;">
                        ✅ Force Complete
                    </button>
                    <button onclick="testFlashcard()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px; background: linear-gradient(135deg, #ff6b6b, #ee5a24);">
                        🎯 Test Flashcard
                    </button>
                    <button onclick="testCheckAnswer()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px; background: linear-gradient(135deg, #4834d4, #686de0);">
                        ✅ Test Check Answer
                    </button>
                    <button onclick="testDragDrop()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px; background: linear-gradient(135deg, #f39c12, #e67e22);">
                        🎮 Test Drag & Drop
                    </button>
                    <button onclick="window.initializeDragDrop()" class="nav-btn" style="flex: none; padding: 10px 15px; font-size: 14px; background: linear-gradient(135deg, #27ae60, #2ecc71);">
                        🔧 Init Drag & Drop
                    </button>
                </div>
                <p style="font-size: 12px; color: #6c757d; margin-top: 10px;">
                    Use "Check Progress" to see debug info in console, or "Force Complete" to manually mark as done. Use test buttons to debug specific features. Each drag-and-drop question now has a Reset button. Open test-drag-drop.html for isolated testing.
                </p>
            </div>
        </div>
    </div>

    <!-- Flashcard Overlay -->
    <div id="flashcard-overlay" class="flashcard-overlay">
        <div class="flashcard">
            <div class="flashcard-header">
                <h2 class="flashcard-title" id="flashcard-title">Flash Card Title</h2>
                <button class="flashcard-close" onclick="hideFlashcard()">&times;</button>
            </div>
            <div class="flashcard-content" id="flashcard-content">
                <!-- Content will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Global Functions Script - Must come BEFORE module script -->
    <script>
        // ===== GLOBAL VARIABLES AND FUNCTIONS FOR HTML INTERACTION =====
        let mathAnswers = {};
        
        // Initialize drag and drop variables globally
        window.dragDropMatches = {};
        window.notationMatches = {};
        window.slopeMatches = {};
        
        // Legacy variables for compatibility
        let dragDropMatches = window.dragDropMatches;
        let notationMatches = window.notationMatches;
        let slopeMatches = window.slopeMatches;
        
        // Flashcard content data
        const flashcardContent = {
            'rate-of-change': {
                title: '🚗 Understanding Rate of Change',
                content: `
                    <div class="flashcard-section">
                        <h4>🎯 What is Rate of Change?</h4>
                        <p>Rate of change tells us <strong>how fast</strong> something is changing compared to something else.</p>
                        <p>Think of it like this: If you're driving, your speedometer shows the rate at which your position is changing over time!</p>
                    </div>
                    
                    <div class="flashcard-section flashcard-example">
                        <h4>🌟 Real-World Examples</h4>
                        <ul>
                            <li><strong>Speed:</strong> How fast distance changes over time</li>
                            <li><strong>Temperature:</strong> How fast temperature rises or falls</li>
                            <li><strong>Growth:</strong> How fast a plant grows each day</li>
                            <li><strong>Profit:</strong> How fast a business makes money</li>
                        </ul>
                    </div>
                    
                    <div class="flashcard-section flashcard-tip">
                        <h4>💡 Key Insight</h4>
                        <p>A derivative measures the <strong>instantaneous rate of change</strong> - like looking at your speedometer at one exact moment, not your average speed for the whole trip!</p>
                    </div>
                `
            },
            'real-world-applications': {
                title: '🌍 Real-World Applications of Derivatives',
                content: `
                    <div class="flashcard-section">
                        <h4>🎯 Why Derivatives Matter</h4>
                        <p>Derivatives help us understand <strong>how things change</strong> in the real world. They're everywhere!</p>
                    </div>
                    
                    <div class="flashcard-section flashcard-example">
                        <h4>🌱 Nature & Biology</h4>
                        <ul>
                            <li><strong>Plant Growth:</strong> How fast a plant's height increases over time</li>
                            <li><strong>Population Growth:</strong> How fast animal populations are changing</li>
                            <li><strong>Temperature:</strong> How fast the weather is warming or cooling</li>
                        </ul>
                    </div>
                    
                    <div class="flashcard-section flashcard-example">
                        <h4>💰 Business & Economics</h4>
                        <ul>
                            <li><strong>Marginal Cost:</strong> How much one more item costs to produce</li>
                            <li><strong>Growth Rate:</strong> How fast profits or sales are changing</li>
                            <li><strong>Optimization:</strong> Finding maximum profit or minimum cost</li>
                        </ul>
                    </div>
                    
                    <div class="flashcard-section flashcard-tip">
                        <h4>🔍 Remember</h4>
                        <p>When you see "how fast", "rate of", or "change in" - think derivatives!</p>
                    </div>
                `
            },
            'slope-meaning': {
                title: '📈 Understanding Slope and Derivatives',
                content: `
                    <div class="flashcard-section">
                        <h4>🎯 Slope = Derivative</h4>
                        <p>The slope of a tangent line at any point equals the derivative at that point!</p>
                    </div>
                    
                    <div class="flashcard-section flashcard-example">
                        <h4>⛰️ Think of Hiking</h4>
                        <ul>
                            <li><strong>Steep uphill:</strong> Large positive slope → function increasing rapidly</li>
                            <li><strong>Gentle uphill:</strong> Small positive slope → function increasing slowly</li>
                            <li><strong>Flat ground:</strong> Zero slope → function has maximum/minimum</li>
                            <li><strong>Downhill:</strong> Negative slope → function decreasing</li>
                        </ul>
                    </div>
                    
                    <div class="flashcard-section flashcard-tip">
                        <h4>💡 Visual Tip</h4>
                        <p>Imagine you're walking along the curve. The steeper it feels under your feet, the larger the derivative value!</p>
                    </div>
                `
            },
            'derivative-notation': {
                title: '📝 Derivative Notation Guide',
                content: `
                    <div class="flashcard-section">
                        <h4>🎯 Different Ways to Write the Same Thing</h4>
                        <p>All these notations mean "the derivative of f(x)":</p>
                    </div>
                    
                    <div class="flashcard-section flashcard-example">
                        <h4>📚 Common Notations</h4>
                        <ul>
                            <li><strong>f'(x)</strong> - Lagrange notation (easiest to write)</li>
                            <li><strong>df/dx</strong> - Leibniz notation (shows what we're differentiating)</li>
                            <li><strong>d/dx[f(x)]</strong> - Operator notation (clear about the operation)</li>
                        </ul>
                    </div>
                    
                    <div class="flashcard-section flashcard-tip">
                        <h4>⚠️ Watch Out!</h4>
                        <p><strong>∫f(x)dx</strong> is an <em>integral</em>, not a derivative! It's the opposite operation.</p>
                    </div>
                `
            },
            'concept-understanding': {
                title: '🎯 When Do We Use Derivatives?',
                content: `
                    <div class="flashcard-section">
                        <h4>🎯 Key Question</h4>
                        <p>When do you care more about <strong>how fast</strong> something changes rather than its actual value?</p>
                    </div>
                    
                    <div class="flashcard-section flashcard-example">
                        <h4>🌟 Perfect Examples</h4>
                        <ul>
                            <li><strong>Stock Market:</strong> How fast prices are rising/falling</li>
                            <li><strong>Medicine:</strong> How fast a fever is breaking</li>
                            <li><strong>Gardening:</strong> How fast plants are growing</li>
                            <li><strong>Weather:</strong> How fast temperature is changing</li>
                        </ul>
                    </div>
                    
                    <div class="flashcard-section flashcard-tip">
                        <h4>💡 The Big Idea</h4>
                        <p>Derivatives help us predict the future and optimize the present by understanding rates of change!</p>
                    </div>
                `
            },
            'derivative-meanings': {
                title: '🔍 What Derivatives Actually Represent',
                content: `
                    <div class="flashcard-section">
                        <h4>🎯 Function → Derivative Meaning</h4>
                        <p>Every function's derivative tells us something specific!</p>
                    </div>
                    
                    <div class="flashcard-section flashcard-example">
                        <h4>📊 The Connections</h4>
                        <ul>
                            <li><strong>Height h(t)</strong> → h'(t) = growth rate</li>
                            <li><strong>Cost C(x)</strong> → C'(x) = marginal cost</li>
                            <li><strong>Temperature T(t)</strong> → T'(t) = rate of heating/cooling</li>
                            <li><strong>Population P(t)</strong> → P'(t) = population growth rate</li>
                        </ul>
                    </div>
                    
                    <div class="flashcard-section flashcard-tip">
                        <h4>🧠 Memory Trick</h4>
                        <p>The derivative always tells you "how fast the original function is changing"!</p>
                    </div>
                `
            },
            'notation-guide': {
                title: '📚 Complete Notation Guide',
                content: `
                    <div class="flashcard-section">
                        <h4>🎯 When to Use Each Notation</h4>
                        <p>Different situations call for different notations!</p>
                    </div>
                    
                    <div class="flashcard-section flashcard-example">
                        <h4>🎓 Usage Guide</h4>
                        <ul>
                            <li><strong>f'(x):</strong> Quick calculations, simple functions</li>
                            <li><strong>df/dx:</strong> Formal calculus, chain rule problems</li>
                            <li><strong>d/dx[f(x)]:</strong> When applying derivative operations</li>
                            <li><strong>ḟ(x):</strong> Physics, especially time derivatives</li>
                        </ul>
                    </div>
                    
                    <div class="flashcard-section flashcard-tip">
                        <h4>💡 Pro Tip</h4>
                        <p>All notations mean the same thing - pick the one that makes your work clearest!</p>
                    </div>
                `
            },
            'slope-interpretation': {
                title: '📊 Reading Slopes Like a Pro',
                content: `
                    <div class="flashcard-section">
                        <h4>🎯 Slope → Function Behavior</h4>
                        <p>The slope of the tangent line tells the whole story!</p>
                    </div>
                    
                    <div class="flashcard-section flashcard-example">
                        <h4>📈 The Complete Guide</h4>
                        <ul>
                            <li><strong>Steep Positive:</strong> Function shooting up rapidly</li>
                            <li><strong>Gentle Positive:</strong> Function rising slowly</li>
                            <li><strong>Zero (Horizontal):</strong> Function at a peak or valley</li>
                            <li><strong>Negative:</strong> Function decreasing</li>
                        </ul>
                    </div>
                    
                    <div class="flashcard-section flashcard-tip">
                        <h4>🎢 Roller Coaster Analogy</h4>
                        <p>Imagine riding the function like a roller coaster - steep slopes feel fast, gentle slopes feel slow!</p>
                    </div>
                `
            }
        };

        // ===== FLASHCARD FUNCTIONS =====
        function showFlashcard(cardId) {
            console.log(`🎯 showFlashcard called with cardId: "${cardId}"`);
            
            const overlay = document.getElementById('flashcard-overlay');
            const title = document.getElementById('flashcard-title');
            const content = document.getElementById('flashcard-content');
            
            console.log('Flashcard elements found:');
            console.log('- overlay:', !!overlay);
            console.log('- title:', !!title);
            console.log('- content:', !!content);
            
            if (!overlay || !title || !content) {
                console.error('❌ One or more flashcard elements not found!');
                alert('Error: Flashcard elements not found in the page!');
                return;
            }
            
            const card = flashcardContent[cardId];
            if (!card) {
                console.error('❌ Flashcard content not found for cardId:', cardId);
                console.log('Available cards:', Object.keys(flashcardContent));
                alert(`Error: Flashcard content not found for "${cardId}"`);
                return;
            }
            
            console.log('✅ Setting flashcard content:', card.title);
            title.textContent = card.title;
            content.innerHTML = card.content;
            
            overlay.classList.add('show');
            console.log('✅ Flashcard should now be visible');
            
            // Re-render MathJax if present
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([content]);
                console.log('✅ MathJax re-rendering initiated');
            }
        }

        function hideFlashcard() {
            const overlay = document.getElementById('flashcard-overlay');
            overlay.classList.remove('show');
        }

        // ===== ANSWER CHECKING FUNCTIONS =====
        function checkMathAnswer(questionNum) {
            console.log(`🔍 checkMathAnswer called for question ${questionNum}`);
            let userAnswer = '';
            const feedback = document.getElementById(`feedback-${questionNum}`);
            
            if (!feedback) {
                console.error(`❌ Feedback element not found for question ${questionNum}`);
                alert(`Error: Feedback element not found for question ${questionNum}`);
                return;
            }
            
            // Get user answer based on question type
            if (questionNum === 0 || questionNum === 2 || questionNum === 4) {
                // Text input questions
                const textInput = document.getElementById(`question${questionNum}`);
                userAnswer = textInput ? textInput.value.toLowerCase().trim() : '';
                console.log(`Text input found: ${!!textInput}, value: "${userAnswer}"`);
            } else if (questionNum === 1) {
                // Radio button question
                const selectedRadio = document.querySelector('input[name="question2"]:checked');
                userAnswer = selectedRadio ? selectedRadio.value : '';
                console.log(`Radio button found: ${!!selectedRadio}, value: "${userAnswer}"`);
            } else if (questionNum === 3) {
                // Checkbox question
                const selectedCheckboxes = document.querySelectorAll('input[name="question4"]:checked');
                userAnswer = Array.from(selectedCheckboxes).map(cb => cb.value).sort();
                console.log(`Checkboxes found: ${selectedCheckboxes.length}, values: ${userAnswer}`);
            }
            
            // Check for blank answers
            if (!userAnswer || (Array.isArray(userAnswer) && userAnswer.length === 0) || 
                (typeof userAnswer === 'string' && userAnswer.trim() === '')) {
                feedback.classList.remove('correct', 'incorrect');
                feedback.classList.add('show', 'incorrect');
                feedback.innerHTML = '❌ Please provide an answer before checking.';
                return;
            }
            
            mathAnswers[questionNum] = userAnswer;
            sessionStorage.setItem('introduction-to-derivatives-novice-progress', JSON.stringify(mathAnswers));
            
            let isCorrect = false;
            
            // Validation logic for theory-based questions
            if (questionNum === 0) {
                // Question 1: "A derivative measures the _____ of change"
                isCorrect = userAnswer.includes('rate') || userAnswer.includes('speed') || 
                           userAnswer.includes('instantaneous') || userAnswer.includes('pace');
            } else if (questionNum === 1) {
                // Question 2: Real-world applications (multiple choice)
                isCorrect = userAnswer === 'a'; // Finding how fast a car is accelerating
            } else if (questionNum === 2) {
                // Question 3: Steep positive slope meaning
                isCorrect = (userAnswer.includes('increasing') || userAnswer.includes('rising') || 
                           userAnswer.includes('growing') || userAnswer.includes('going up')) &&
                           (userAnswer.includes('fast') || userAnswer.includes('rapid') || 
                           userAnswer.includes('quick') || userAnswer.includes('steep'));
            } else if (questionNum === 3) {
                // Question 4: Derivative notation (checkboxes)
                const correctAnswers = ['a', 'b', 'd'];
                isCorrect = userAnswer.length === correctAnswers.length && 
                           correctAnswers.every(ans => userAnswer.includes(ans));
            } else if (questionNum === 4) {
                // Question 5: Real-world examples of rate of change
                isCorrect = userAnswer.includes('speed') || userAnswer.includes('velocity') || 
                           userAnswer.includes('acceleration') || userAnswer.includes('temperature') ||
                           userAnswer.includes('growth') || userAnswer.includes('population') ||
                           userAnswer.includes('profit') || userAnswer.includes('cost') ||
                           userAnswer.includes('height') || userAnswer.includes('distance') ||
                           userAnswer.includes('time') || userAnswer.includes('change');
            }
            
            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');
            
            console.log(`Question ${questionNum} validation result: ${isCorrect ? 'CORRECT' : 'INCORRECT'}`);
            
            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = '✅ Excellent! You understand this concept!';
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `❌ Not quite right. ${getHintForQuestion(questionNum)}`;
            }
        }

        // Helper function to provide specific hints
        function getHintForQuestion(questionNum) {
            const hints = {
                0: "Think about what tells us how quickly something is changing over time.",
                1: "Derivatives measure how fast things change, like growth rates in business.",
                2: "A steep positive slope means the function is increasing rapidly at that point.",
                3: "f'(x) and df/dx are derivatives, but ∫f(x)dx is an integral (opposite of derivative).",
                4: "Think of everyday situations: plant growth, temperature changes, population growth, etc."
            };
            return hints[questionNum] || "Think about the concept and try again.";
        }

        // ===== DEBUG FUNCTIONS =====
        function testFlashcard() {
            console.log('🧪 Testing flashcard system...');
            try {
                showFlashcard('rate-of-change');
            } catch (error) {
                console.error('❌ Error testing flashcard:', error);
                alert('Error testing flashcard: ' + error.message);
            }
        }

        function testCheckAnswer() {
            console.log('🧪 Testing checkMathAnswer system...');
            try {
                checkMathAnswer(0);
            } catch (error) {
                console.error('❌ Error testing checkMathAnswer:', error);
                alert('Error testing checkMathAnswer: ' + error.message);
            }
        }

        function checkModuleProgress() {
            const sessionProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
            const currentAnswers = Object.keys(mathAnswers).length;
            
            console.log('=== NOVICE MODULE PROGRESS DEBUG ===');
            console.log('Questions answered:', currentAnswers + '/8');
            console.log('Session storage progress:', sessionProgress);
            console.log('Math answers:', mathAnswers);
            console.log('Available functions:');
            console.log('- checkMathAnswer:', typeof window.checkMathAnswer);
            console.log('- showFlashcard:', typeof window.showFlashcard);
            console.log('- hideFlashcard:', typeof window.hideFlashcard);
            
            alert('Check console for detailed progress information');
        }

        // Toggle answer guide visibility
        function toggleAnswerGuide() {
            const answerGuide = document.getElementById('answerGuide');
            const toggleBtn = document.getElementById('toggleAnswerGuide');
            
            if (answerGuide.style.display === 'none') {
                answerGuide.style.display = 'block';
                toggleBtn.textContent = '📝 Hide Answer Guide';
                answerGuide.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                answerGuide.style.display = 'none';
                toggleBtn.textContent = '📝 Show Answer Guide';
            }
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📚 Global functions initialized');
            console.log('Available functions:');
            console.log('- checkMathAnswer:', typeof checkMathAnswer);
            console.log('- showFlashcard:', typeof showFlashcard);
            console.log('- hideFlashcard:', typeof hideFlashcard);
            
            // Set up answer guide toggle button
            const toggleBtn = document.getElementById('toggleAnswerGuide');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleAnswerGuide);
                console.log('✅ Answer guide toggle button setup');
            }
            
            // Set up event listeners for inputs
            const textInputs = document.querySelectorAll('.text-input-field');
            console.log(`Found ${textInputs.length} text input fields`);
            textInputs.forEach((input) => {
                input.addEventListener('input', function() {
                    const questionNum = parseInt(this.id.replace('question', ''));
                    mathAnswers[questionNum] = this.value;
                    sessionStorage.setItem('introduction-to-derivatives-novice-progress', JSON.stringify(mathAnswers));
                });
                
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const questionNum = parseInt(this.id.replace('question', ''));
                        checkMathAnswer(questionNum);
                    }
                });
            });

            // Set up radio button listeners
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.name === 'question2') {
                        mathAnswers[1] = this.value;
                        sessionStorage.setItem('introduction-to-derivatives-novice-progress', JSON.stringify(mathAnswers));
                    }
                });
            });
            
            // Set up checkbox listeners
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.name === 'question4') {
                        const selectedCheckboxes = document.querySelectorAll('input[name="question4"]:checked');
                        mathAnswers[3] = Array.from(selectedCheckboxes).map(cb => cb.value).sort();
                        sessionStorage.setItem('introduction-to-derivatives-novice-progress', JSON.stringify(mathAnswers));
                    }
                });
            });

            // Close flashcard when clicking outside
            document.addEventListener('click', function(e) {
                const overlay = document.getElementById('flashcard-overlay');
                if (e.target === overlay) {
                    hideFlashcard();
                }
            });

            // Close flashcard with Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideFlashcard();
                }
            });
        });
    </script>

    <!-- Firebase Module Script -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, doc, setDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyBUfSOSpmCdWUGTVbSQsMCH-JVmrjpfdPY",
            authDomain: "fyp-lutfi-naim.firebaseapp.com",
            projectId: "fyp-lutfi-naim",
            storageBucket: "fyp-lutfi-naim.firebasestorage.app",
            messagingSenderId: "231274529807",
            appId: "1:231274529807:web:c4ea279f9e7581bd674f7a"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Module-scoped variables
        let currentUser = null;
        let currentStep = 1;
        let maxSteps = 4;
        let wrongAttempts = {};

        const mathCorrectAnswers = {
            0: "rate", // "A derivative measures the RATE of change"
            1: "a", // Finding how fast a company's profit is growing
            2: "increasing rapidly", // Steep positive slope means function is increasing rapidly
            3: ["a", "b", "d"], // f'(x), df/dx, and d/dx[f(x)] are all derivative notations
            4: "growth" // Any example involving rate of change
        };

        // Flashcard content moved to global script to avoid module scope issues

        // Step-by-step content for Tutorial 7 problems
        const stepByStepContent = {
            1: {
                title: "Step 1: Write the definition of derivative",
                content: "For any function f(x), the derivative is defined as: $$f'(x) = \\lim_{h \\to 0} \\frac{f(x+h) - f(x)}{h}$$ For our function $f(x) = \\sqrt{5x - 1}$, we need to find $f(x+h)$.",
                label: "Write $f(x+h)$ for $f(x) = \\sqrt{5x - 1}$:",
                answer: "\\sqrt{5(x+h) - 1}"
            },
            2: {
                title: "Step 2: Set up the difference quotient",
                content: "Now substitute into the definition: $$\\frac{f(x+h) - f(x)}{h} = \\frac{\\sqrt{5(x+h) - 1} - \\sqrt{5x - 1}}{h}$$ This creates an indeterminate form when h→0, so we need to rationalize.",
                label: "Write the difference quotient:",
                answer: "\\frac{\\sqrt{5(x+h) - 1} - \\sqrt{5x - 1}}{h}"
            },
            3: {
                title: "Step 3: Rationalize the numerator",
                content: "Multiply by the conjugate: $$\\frac{\\sqrt{5(x+h) - 1} - \\sqrt{5x - 1}}{h} \\cdot \\frac{\\sqrt{5(x+h) - 1} + \\sqrt{5x - 1}}{\\sqrt{5(x+h) - 1} + \\sqrt{5x - 1}}$$ This gives us: $$\\frac{(5(x+h) - 1) - (5x - 1)}{h(\\sqrt{5(x+h) - 1} + \\sqrt{5x - 1})} = \\frac{5h}{h(\\sqrt{5(x+h) - 1} + \\sqrt{5x - 1})}$$",
                label: "Simplify after rationalization:",
                answer: "\\frac{5}{\\sqrt{5(x+h) - 1} + \\sqrt{5x - 1}}"
            },
            4: {
                title: "Step 4: Take the limit as h approaches 0",
                content: "Now we can take the limit: $$\\lim_{h \\to 0} \\frac{5}{\\sqrt{5(x+h) - 1} + \\sqrt{5x - 1}} = \\frac{5}{\\sqrt{5x - 1} + \\sqrt{5x - 1}} = \\frac{5}{2\\sqrt{5x - 1}}$$",
                label: "Final answer $f'(x) =$:",
                answer: "\\frac{5}{2\\sqrt{5x - 1}}"
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadProgress();
            } else {
                window.location.href = 'index.html';
            }
        });

        function loadProgress() {
            const saved = sessionStorage.getItem('introduction-to-derivatives-novice-progress');
            if (saved) {
                // Use global mathAnswers variable
                window.mathAnswers = JSON.parse(saved);
                restoreAnswers();
            }
        }

        function restoreAnswers() {
            Object.keys(window.mathAnswers || {}).forEach(questionNum => {
                const input = document.querySelector(`[data-question="${questionNum}"]`);
                if (input) {
                    input.value = window.mathAnswers[questionNum];
                    updateMathPreview(input);
                }
            });
            updateProgress();
        }

        // MathQuill initialization is handled in the main DOMContentLoaded event below

        // Enhanced answer validation function
        function normalizeAnswer(answer) {
            return answer.toLowerCase()
                .replace(/\s+/g, '') // Remove all spaces
                .replace(/\$+/g, '') // Remove $ symbols
                .replace(/\\cdot/g, '*') // Replace LaTeX multiplication
                .replace(/\\times/g, '*') // Replace LaTeX multiplication
                .replace(/\\frac\{([^}]*)\}\{([^}]*)\}/g, '($1)/($2)') // Convert fractions
                .replace(/\{([^}]*)\}/g, '$1') // Remove braces
                .replace(/\^(\d+)/g, '^$1') // Normalize exponents
                .replace(/²/g, '^2') // Convert superscript 2
                .replace(/³/g, '^3') // Convert superscript 3
                .replace(/⁴/g, '^4') // Convert superscript 4
                .replace(/⁵/g, '^5') // Convert superscript 5
                .replace(/√/g, 'sqrt') // Convert square root symbol
                .replace(/\\sin/g, 'sin') // Convert LaTeX sin
                .replace(/\\cos/g, 'cos') // Convert LaTeX cos
                .replace(/\\tan/g, 'tan') // Convert LaTeX tan
                .replace(/π/g, 'pi') // Convert pi symbol
                .replace(/∞/g, 'infinity') // Convert infinity symbol
                .replace(/±/g, '+-') // Convert plus-minus
                .replace(/≈/g, '=') // Convert approximately equal
                .replace(/≠/g, '!=') // Convert not equal
                .replace(/≤/g, '<=') // Convert less than or equal
                .replace(/≥/g, '>=') // Convert greater than or equal
                .replace(/∂/g, 'd') // Convert partial derivative symbol
                .replace(/∫/g, 'integral') // Convert integral symbol
                .replace(/∑/g, 'sum') // Convert summation symbol
                .replace(/∏/g, 'product') // Convert product symbol
                .replace(/∆/g, 'delta') // Convert delta symbol
                .replace(/α/g, 'alpha') // Convert alpha
                .replace(/β/g, 'beta') // Convert beta
                .replace(/γ/g, 'gamma') // Convert gamma
                .replace(/θ/g, 'theta') // Convert theta
                .replace(/λ/g, 'lambda') // Convert lambda
                .replace(/μ/g, 'mu') // Convert mu
                .replace(/σ/g, 'sigma') // Convert sigma
                .replace(/φ/g, 'phi') // Convert phi
                .replace(/ω/g, 'omega'); // Convert omega
        }

        // Check if two mathematical expressions are equivalent
        function areEquivalent(userAnswer, correctAnswer) {
            // Don't allow empty answers
            if (!userAnswer || userAnswer.trim() === '') return false;
            
            const normalizedUser = normalizeAnswer(userAnswer);
            const normalizedCorrect = normalizeAnswer(correctAnswer);
            
            console.log('Comparing answers:', { 
                original: { user: userAnswer, correct: correctAnswer },
                normalized: { user: normalizedUser, correct: normalizedCorrect }
            });
            
            // Direct match
            if (normalizedUser === normalizedCorrect) return true;
            
            // For more strict matching, we'll only check specific equivalencies
            // rather than general substring inclusion which can lead to false positives
            
            // Check for common mathematical equivalencies
            const equivalencies = [
                [normalizedUser, normalizedCorrect],
                [normalizedUser.replace(/\*/g, ''), normalizedCorrect.replace(/\*/g, '')], // Remove multiplication signs
                [normalizedUser.replace(/\s+/g, ''), normalizedCorrect.replace(/\s+/g, '')] // Remove all spaces
            ];
            
            // Special case for fraction answers (like 1/√x)
            if (correctAnswer.includes('\\frac') && userAnswer.includes('\\frac')) {
                // Extract numerator and denominator from fractions
                const userFracMatch = userAnswer.match(/\\frac\s*\{([^}]*)\}\s*\{([^}]*)\}/);
                const correctFracMatch = correctAnswer.match(/\\frac\s*\{([^}]*)\}\s*\{([^}]*)\}/);
                
                if (userFracMatch && correctFracMatch) {
                    const userNum = normalizeAnswer(userFracMatch[1]);
                    const userDenom = normalizeAnswer(userFracMatch[2]);
                    const correctNum = normalizeAnswer(correctFracMatch[1]);
                    const correctDenom = normalizeAnswer(correctFracMatch[2]);
                    
                    // Check if numerator and denominator match independently
                    if ((userNum === correctNum || userNum.replace(/\s+/g, '') === correctNum.replace(/\s+/g, '')) && 
                        (userDenom === correctDenom || userDenom.replace(/\s+/g, '') === correctDenom.replace(/\s+/g, ''))) {
                        return true;
                    }
                }
                
            }
            
            // Special case for square roots
            if (correctAnswer.includes('\\sqrt') && userAnswer.includes('\\sqrt')) {
                const userSqrtMatch = userAnswer.match(/\\sqrt\s*\{([^}]*)\}/);
                const correctSqrtMatch = correctAnswer.match(/\\sqrt\s*\{([^}]*)\}/);
                
                if (userSqrtMatch && correctSqrtMatch) {
                    const userSqrtContent = normalizeAnswer(userSqrtMatch[1]);
                    const correctSqrtContent = normalizeAnswer(correctSqrtMatch[1]);
                    
                    if (userSqrtContent === correctSqrtContent || 
                        userSqrtContent.replace(/\s+/g, '') === correctSqrtContent.replace(/\s+/g, '')) {
                        return true;
                    }
                }
            }
            
            return equivalencies.some(([a, b]) => a === b);
        }

        window.checkMathAnswer = function(questionNum) {
            console.log(`🔍 checkMathAnswer called for question ${questionNum}`);
            let userAnswer = '';
            const feedback = document.getElementById(`feedback-${questionNum}`);
            
            if (!feedback) {
                console.error(`❌ Feedback element not found for question ${questionNum}`);
                alert(`Error: Feedback element not found for question ${questionNum}`);
                return;
            }
            
            // Get user answer based on question type
            if (questionNum === 0 || questionNum === 2 || questionNum === 4) {
                // Text input questions
                const textInput = document.getElementById(`question${questionNum}`);
                userAnswer = textInput ? textInput.value.toLowerCase().trim() : '';
                console.log(`Text input found: ${!!textInput}, value: "${userAnswer}"`);
            } else if (questionNum === 1) {
                // Radio button question
                const selectedRadio = document.querySelector('input[name="question2"]:checked');
                userAnswer = selectedRadio ? selectedRadio.value : '';
                console.log(`Radio button found: ${!!selectedRadio}, value: "${userAnswer}"`);
            } else if (questionNum === 3) {
                // Checkbox question
                const selectedCheckboxes = document.querySelectorAll('input[name="question4"]:checked');
                userAnswer = Array.from(selectedCheckboxes).map(cb => cb.value).sort();
                console.log(`Checkboxes found: ${selectedCheckboxes.length}, values: ${userAnswer}`);
            }
            
            // Check for blank answers
            if (!userAnswer || (Array.isArray(userAnswer) && userAnswer.length === 0) || 
                (typeof userAnswer === 'string' && userAnswer.trim() === '')) {
                feedback.classList.remove('correct', 'incorrect');
                feedback.classList.add('show', 'incorrect');
                feedback.innerHTML = '❌ Please provide an answer before checking.';
                return;
            }
            
            mathAnswers[questionNum] = userAnswer;
            sessionStorage.setItem('introduction-to-derivatives-novice-progress', JSON.stringify(mathAnswers));
            
            let isCorrect = false;
            const correctAnswer = mathCorrectAnswers[questionNum];
            
            console.log(`Question ${questionNum}: User answer: "${userAnswer}", Correct answer: "${correctAnswer}"`);
            
            // Validation logic for theory-based questions
            if (questionNum === 0) {
                // Question 1: "A derivative measures the _____ of change"
                isCorrect = userAnswer.includes('rate') || userAnswer.includes('speed') || 
                           userAnswer.includes('instantaneous') || userAnswer.includes('pace');
            } else if (questionNum === 1) {
                // Question 2: Real-world applications (multiple choice)
                isCorrect = userAnswer === 'a'; // Finding how fast a car is accelerating
            } else if (questionNum === 2) {
                // Question 3: Steep positive slope meaning
                isCorrect = (userAnswer.includes('increasing') || userAnswer.includes('rising') || 
                           userAnswer.includes('growing') || userAnswer.includes('going up')) &&
                           (userAnswer.includes('fast') || userAnswer.includes('rapid') || 
                           userAnswer.includes('quick') || userAnswer.includes('steep'));
            } else if (questionNum === 3) {
                // Question 4: Derivative notation (checkboxes)
                const correctAnswers = ['a', 'b', 'd'];
                isCorrect = userAnswer.length === correctAnswers.length && 
                           correctAnswers.every(ans => userAnswer.includes(ans));
            } else if (questionNum === 4) {
                // Question 5: Real-world examples of rate of change
                isCorrect = userAnswer.includes('speed') || userAnswer.includes('velocity') || 
                           userAnswer.includes('acceleration') || userAnswer.includes('temperature') ||
                           userAnswer.includes('growth') || userAnswer.includes('population') ||
                           userAnswer.includes('profit') || userAnswer.includes('cost') ||
                           userAnswer.includes('height') || userAnswer.includes('distance') ||
                           userAnswer.includes('time') || userAnswer.includes('change');
            }
            
            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');
            
            console.log(`Question ${questionNum} validation result: ${isCorrect ? 'CORRECT' : 'INCORRECT'}`);
            
            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = '✅ Excellent! You understand this concept!';
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `❌ Not quite right. ${getHintForQuestion(questionNum)}`;
            }
        };

        // Helper function to provide specific hints
        function getHintForQuestion(questionNum) {
            const hints = {
                0: "Think about what tells us how quickly something is changing over time.",
                1: "Derivatives measure how fast things change, like growth rates in business.",
                2: "A steep positive slope means the function is increasing rapidly at that point.",
                3: "f'(x) and df/dx are derivatives, but ∫f(x)dx is an integral (opposite of derivative).",
                4: "Think of everyday situations: plant growth, temperature changes, population growth, etc."
            };
            return hints[questionNum] || "Think about the concept and try again.";
        }

        // Helper function to normalize LaTeX expressions for comparison
        function normalizeLatex(latex) {
            return latex
                .replace(/\s+/g, '') // Remove spaces
                .replace(/\{([^}]*)\}/g, '$1') // Remove unnecessary braces
                .replace(/\\cdot/g, '*') // Replace multiplication
                .replace(/\\times/g, '*')
                .toLowerCase();
        }

        // Progress tracking removed as requested

        window.submitQuiz = async function() {
            // Check if all questions have been answered (including drag-drop)
            const requiredQuestions = [0, 1, 2, 3, 4]; // Questions 0-4 (5 questions total)
            const unansweredQuestions = requiredQuestions.filter(q => 
                !window.mathAnswers[q] || (Array.isArray(window.mathAnswers[q]) && window.mathAnswers[q].length === 0) ||
                (typeof window.mathAnswers[q] === 'string' && window.mathAnswers[q].trim() === ''));
                
            // Check drag-drop questions
            const dragDropComplete = Object.keys(window.dragDropMatches || {}).length >= 3 && 
                                   Object.keys(window.notationMatches || {}).length >= 3 && 
                                   Object.keys(window.slopeMatches || {}).length >= 3;
                
            if (unansweredQuestions.length > 0 || !dragDropComplete) {
                let message = 'Please complete all questions before submitting.';
            if (unansweredQuestions.length > 0) {
                    message += ` Missing text answers for questions: ${unansweredQuestions.map(q => q + 1).join(', ')}.`;
                }
                if (!dragDropComplete) {
                    message += ' Please complete all drag-and-drop activities.';
                }
                alert(message);
                return;
            }

            let score = 0;
            // Check each question using the same validation logic as checkMathAnswer
            requiredQuestions.forEach(questionNum => {
                const userAnswer = window.mathAnswers[questionNum] || '';
                let isCorrect = false;
                
                // Use the same validation logic as checkMathAnswer
                if (questionNum === 0) {
                    // Question 1: "A derivative measures the _____ of change"
                    const lowerAnswer = typeof userAnswer === 'string' ? userAnswer.toLowerCase() : '';
                    isCorrect = lowerAnswer.includes('rate') || lowerAnswer.includes('speed') || 
                               lowerAnswer.includes('instantaneous') || lowerAnswer.includes('pace');
                } else if (questionNum === 1) {
                    // Question 2: Real-world applications (multiple choice)
                    isCorrect = userAnswer === 'a'; // Finding how fast a company's profit is growing
                } else if (questionNum === 2) {
                    // Question 3: Steep positive slope meaning
                    const lowerAnswer = typeof userAnswer === 'string' ? userAnswer.toLowerCase() : '';
                    isCorrect = (lowerAnswer.includes('increasing') || lowerAnswer.includes('rising') || 
                               lowerAnswer.includes('growing') || lowerAnswer.includes('going up')) &&
                               (lowerAnswer.includes('fast') || lowerAnswer.includes('rapid') || 
                               lowerAnswer.includes('quick') || lowerAnswer.includes('steep'));
                } else if (questionNum === 3) {
                    // Question 4: Derivative notation (checkboxes)
                    const correctAnswers = ['a', 'b', 'd'];
                    const userAnswerArray = Array.isArray(userAnswer) ? userAnswer : [];
                    isCorrect = userAnswerArray.length === correctAnswers.length && 
                               correctAnswers.every(ans => userAnswerArray.includes(ans));
                } else if (questionNum === 4) {
                    // Question 5: Real-world examples of rate of change
                    const lowerAnswer = typeof userAnswer === 'string' ? userAnswer.toLowerCase() : '';
                    isCorrect = lowerAnswer.includes('speed') || lowerAnswer.includes('velocity') || 
                               lowerAnswer.includes('acceleration') || lowerAnswer.includes('temperature') ||
                               lowerAnswer.includes('growth') || lowerAnswer.includes('population') ||
                               lowerAnswer.includes('profit') || lowerAnswer.includes('cost') ||
                               lowerAnswer.includes('height') || lowerAnswer.includes('distance') ||
                               lowerAnswer.includes('time') || lowerAnswer.includes('change');
                }
                
                // Log validation results for debugging
                console.log(`Quiz submission - Question ${questionNum}: ${isCorrect ? 'CORRECT' : 'INCORRECT'}`, {
                    userAnswer: userAnswer,
                    isCorrect: isCorrect
                });
                
                if (isCorrect) score++;
            });

            // Check drag-drop questions
            let dragDropScore = 0;
            if (checkDragDropAnswers()) dragDropScore++;
            if (checkNotationAnswers()) dragDropScore++;
            if (checkSlopeAnswers()) dragDropScore++;

            const totalScore = score + dragDropScore;
            const totalQuestions = 8;
            const percentage = Math.round((totalScore / totalQuestions) * 100);
            const passed = totalScore >= 5; // Need 5/8 to pass

            document.getElementById('scoreDisplay').textContent = `${totalScore}/${totalQuestions} (${percentage}%)`;
            document.getElementById('scoreDisplay').className = `score ${passed ? 'pass' : 'fail'}`;
            document.getElementById('resultMessage').innerHTML = passed 
                ? '<h3 style="color: var(--success-color);">🎉 Amazing! You understand derivatives and can use interactive tools!</h3><p>You can now proceed to the intermediate level.</p>'
                : '<h3 style="color: var(--danger-color);">Keep learning!</h3><p>You need at least 5 correct answers to pass. Review the concepts and try the interactive activities again.</p>';

            document.getElementById('results').style.display = 'block';
            document.getElementById('submitBtn').style.display = 'none';

            if (currentUser) {
                try {
                    // Save progress with the EXACT keys that profile.html expects
                    const userDocRef = doc(db, 'users', currentUser.uid);
                    const updateData = {
                        moduleProgress: {
                            [`Introduction to derivatives - Novice`]: percentage,  // Exact match for profile.html
                            [`Introduction to Derivatives - Novice`]: percentage,   // Backup with capital D
                            [`introduction-to-derivatives-novice`]: percentage      // URL-friendly version
                        }
                    };
                    
                    await setDoc(userDocRef, updateData, { merge: true });
                    
                    // Also save to session storage for immediate access
                    const existingProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
                    existingProgress[`Introduction to derivatives - Novice`] = percentage;  // Primary key
                    existingProgress[`Introduction to Derivatives - Novice`] = percentage;   // Backup
                    existingProgress[`introduction-to-derivatives-novice`] = percentage;     // URL version
                    sessionStorage.setItem('moduleProgress', JSON.stringify(existingProgress));
                    
                    // Clear the quiz progress
                    sessionStorage.removeItem('introduction-to-derivatives-novice-progress');
                    
                    console.log('✅ Progress saved successfully:', {
                        percentage: percentage,
                        passed: passed,
                        score: totalScore,
                        moduleKeys: ['Introduction to derivatives - Novice', 'Introduction to Derivatives - Novice', 'introduction-to-derivatives-novice']
                    });
                    
                } catch (error) {
                    console.error('❌ Error saving progress:', error);
                    alert('There was an error saving your progress. Please try again or contact support.');
                }
            }

            // Add automatic redirection to profile after 3 seconds
            let countdown = 3;
            const redirectMessage = document.createElement('div');
            redirectMessage.style.cssText = 'margin-top: 20px; padding: 15px; background: #e8f5e8; border: 2px solid #28a745; border-radius: 8px; color: #155724; font-weight: 600; text-align: center;';
            redirectMessage.innerHTML = `<p>🔄 Redirecting to Profile in <span id="countdown">${countdown}</span> seconds to show your updated progress...</p><p><a href="profile.html" style="color: #155724; text-decoration: underline;">Click here to go immediately</a></p>`;
            document.getElementById('results').appendChild(redirectMessage);

            const countdownInterval = setInterval(() => {
                countdown--;
                const countdownElement = document.getElementById('countdown');
                if (countdownElement) {
                    countdownElement.textContent = countdown;
                }
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    window.location.href = 'profile.html';
                }
            }, 1000);
        };

        // Debug function to manually mark module as complete
        window.forceCompleteModule = async function() {
            if (!currentUser) {
                alert('Please log in first');
                return;
            }
            
            try {
                const userDocRef = doc(db, 'users', currentUser.uid);
                const completionPercentage = 100;
                
                const updateData = {
                    moduleProgress: {
                        [`Introduction to derivatives - Novice`]: completionPercentage,  // Primary key that profile.html uses
                        [`Introduction to Derivatives - Novice`]: completionPercentage,   // Backup
                        [`introduction-to-derivatives-novice`]: completionPercentage      // URL version
                    }
                };
                
                await setDoc(userDocRef, updateData, { merge: true });
                
                // Also update session storage with exact keys
                const existingProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
                existingProgress[`Introduction to derivatives - Novice`] = completionPercentage;  // PRIMARY KEY
                existingProgress[`Introduction to Derivatives - Novice`] = completionPercentage;   // Backup
                existingProgress[`introduction-to-derivatives-novice`] = completionPercentage;     // URL version
                sessionStorage.setItem('moduleProgress', JSON.stringify(existingProgress));
                
                alert('✅ Module manually marked as complete! Check your profile page.');
                console.log('✅ Module force completed:', updateData);
                
                setTimeout(() => {
                    window.location.href = 'profile.html';
                }, 1000);
                
            } catch (error) {
                console.error('❌ Error force completing module:', error);
                alert('Error marking module as complete: ' + error.message);
            }
        };

        // Debug function to check current progress
        window.checkModuleProgress = function() {
            const sessionProgress = JSON.parse(sessionStorage.getItem('moduleProgress') || '{}');
            const currentAnswers = Object.keys(window.mathAnswers).length;
            
            console.log('=== NOVICE MODULE PROGRESS DEBUG ===');
            console.log('Current user:', currentUser?.email || 'Not logged in');
            console.log('Questions answered:', currentAnswers + '/6');
            console.log('Session storage progress:', sessionProgress);
            console.log('Math answers:', window.mathAnswers);
            
            // Check all possible module key variations
            const possibleKeys = [
                'Introduction to derivatives - Novice',
                'Introduction to Derivatives - Novice', 
                'introduction-to-derivatives-novice',
                'Introduction to derivatives',
                'Introduction to Derivatives'
            ];
            
            console.log('Checking possible module keys:');
            possibleKeys.forEach(key => {
                const progress = sessionProgress[key];
                console.log(`  "${key}": ${progress || 'Not found'}`);
            });
            
            alert('Check console for detailed progress information');
        };

        // Test function for flashcards
        window.testFlashcard = function() {
            console.log('🧪 Testing flashcard system...');
            try {
                showFlashcard('rate-of-change');
            } catch (error) {
                console.error('❌ Error testing flashcard:', error);
                alert('Error testing flashcard: ' + error.message);
            }
        };

        // Test function for check answer
        window.testCheckAnswer = function() {
            console.log('🧪 Testing checkMathAnswer system...');
            try {
                // Test with question 0
                checkMathAnswer(0);
            } catch (error) {
                console.error('❌ Error testing checkMathAnswer:', error);
                alert('Error testing checkMathAnswer: ' + error.message);
            }
        };

        // Debug function to test drag and drop
        window.testDragDrop = function() {
            console.log('🧪 Testing drag and drop system...');
            
            // Check if elements exist
            const dragItems = document.querySelectorAll('.drag-item');
            const dropZones = document.querySelectorAll('.drop-zone');
            
            console.log(`Found ${dragItems.length} drag items:`);
            dragItems.forEach((item, index) => {
                console.log(`  ${index + 1}: ${item.textContent.trim()} (data-function: ${item.dataset.function})`);
                console.log(`    - draggable: ${item.draggable}`);
                console.log(`    - has dragstart listener: ${item.ondragstart ? 'YES' : 'NO'}`);
            });
            
            console.log(`Found ${dropZones.length} drop zones:`);
            dropZones.forEach((zone, index) => {
                console.log(`  ${index + 1}: ${zone.textContent.trim()} (data-derivative: ${zone.dataset.derivative})`);
                console.log(`    - has drop listener: ${zone.ondrop ? 'YES' : 'NO'}`);
            });
            
            // Check if variables are initialized
            console.log('Drag drop variables:');
            console.log('- dragDropMatches:', window.dragDropMatches);
            console.log('- notationMatches:', window.notationMatches);
            console.log('- slopeMatches:', window.slopeMatches);
            
            // Test if initializeDragDrop function exists
            console.log('- initializeDragDrop function:', typeof window.initializeDragDrop);
            
            // Test if we can manually trigger a match
            console.log('Testing manual match...');
            window.dragDropMatches['height'] = 'growth-speed';
            console.log('After test match:', window.dragDropMatches);
            
            alert('Check console for detailed drag and drop debug information. Try dragging items now!');
        };

        // Enhanced Mathematical toolbar function with error handling
        window.insertMath = function(questionNum, symbol) {
            try {
                if (!window.mathFields || !window.mathFields[`question${questionNum}`]) {
                    console.warn('MathField not properly initialized for question', questionNum);
                    return;
                }
                
                const field = window.mathFields[`question${questionNum}`];
                field.focus();
                
                switch(symbol) {
                    case '\\frac{}{}':
                        field.write('\\frac{}{}');
                        field.keystroke('Left Left Left');
                        break;
                    case '\\sqrt{}':
                        field.write('\\sqrt{}');
                        field.keystroke('Left');
                        break;
                    case 'f(x)':
                        field.write('f(x)');
                        break;
                    case '\\lim':
                        field.write('\\lim_{h \\to 0}');
                        field.keystroke('Right');
                        break;
                    case '\\to':
                        field.write('\\to ');
                        break;
                    case '*':
                        field.write('\\cdot ');
                        break;
                    case '^':
                        field.write('^{}');
                        field.keystroke('Left');
                        break;
                    case '(':
                        field.write('\\left(\\right)');
                        field.keystroke('Left Left Left Left Left Left Left');
                        break;
                    case ')':
                        field.write('\\right)');
                        break;
                    case '/':
                        field.write('\\frac{}{}');
                        field.keystroke('Left Left Left');
                        break;
                    default:
                        field.write(symbol + ' ');
                        break;
                }
                
                // Update stored answer
                const latex = field.latex();
                mathAnswers[questionNum] = latex;
                sessionStorage.setItem('introduction-to-derivatives-novice-progress', JSON.stringify(mathAnswers));
                
                field.blur();
                field.focus();
                
            } catch (error) {
                console.error('Error inserting math symbol:', error);
            }
        };

        // Drag and Drop Functionality will be initialized later in the global script section

        // Step-by-step navigation
        window.nextStep = function() {
            if (currentStep < maxSteps) {
                currentStep++;
                updateStepContent();
            }
        };

        window.previousStep = function() {
            if (currentStep > 1) {
                currentStep--;
                updateStepContent();
            }
        };

        function updateStepContent() {
            const stepContent = document.getElementById('stepContent');
            const stepIndicator = document.getElementById('stepIndicator');
            const stepLabel = document.getElementById('stepLabel');
            const prevBtn = document.getElementById('prevStep');
            const nextBtn = document.getElementById('nextStep');
            
            const step = stepByStepContent[currentStep];
            
            stepContent.innerHTML = `
                <h4>${step.title}</h4>
                <div>${step.content}</div>
            `;
            
            stepIndicator.textContent = `Step ${currentStep} of ${maxSteps}`;
            stepLabel.innerHTML = step.label;
            
            prevBtn.disabled = currentStep === 1;
            nextBtn.disabled = currentStep === maxSteps;
            
            // Re-render MathJax
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise();
            }
        }

        window.checkStepAnswer = function(questionNum) {
            const fieldId = `question${questionNum}`;
            const mathField = window.mathFields[fieldId];
            const feedback = document.getElementById(`feedback-${questionNum}`);
            const hint = document.getElementById(`hint-${questionNum}`);
            const userAnswer = mathField ? mathField.latex() : '';
            
            // Check for blank answers first
            if (!userAnswer || userAnswer.trim() === '') {
                feedback.classList.remove('correct', 'incorrect');
                feedback.classList.add('show', 'incorrect');
                feedback.innerHTML = '❌ Please enter an answer before checking.';
                return;
            }
            
            let isCorrect = false;
            
            // For question 4 (step-by-step), use the same validation as the main quiz
            if (questionNum == 4) {
                // f(x+h) for √(5x-1) - accept both forms: √(5(x+h)-1) or √(5x+5h-1)
                isCorrect = userAnswer.includes('\\sqrt') && userAnswer.includes('5') && 
                           ((userAnswer.includes('x+h') && userAnswer.includes('-1')) || 
                            (userAnswer.includes('5x') && userAnswer.includes('5h') && userAnswer.includes('-1')));
            } else {
                // For other questions, use the step-by-step validation
                const step = stepByStepContent[currentStep];
                isCorrect = normalizeLatex(userAnswer) === normalizeLatex(step.answer) ||
                           userAnswer.includes(step.answer.replace(/\\\\/g, '\\'));
            }
            
            if (!isCorrect) {
                wrongAttempts[questionNum] = (wrongAttempts[questionNum] || 0) + 1;
                if (wrongAttempts[questionNum] >= 2 && hint) {
                    hint.classList.add('show');
                }
            }
            
            feedback.classList.remove('correct', 'incorrect');
            feedback.classList.add('show');
            
            console.log(`Step Answer Question ${questionNum} validation result: ${isCorrect ? 'CORRECT' : 'INCORRECT'}`, {
                userAnswer: userAnswer,
                currentStep: currentStep,
                isCorrect: isCorrect
            });
            
            if (isCorrect) {
                feedback.classList.add('correct');
                feedback.innerHTML = '✅ Excellent! This step is correct!';
                mathAnswers[questionNum] = userAnswer;
                sessionStorage.setItem('introduction-to-derivatives-novice-progress', JSON.stringify(mathAnswers));
                
                // Auto-advance to next step after correct answer
                setTimeout(() => {
                    if (currentStep < maxSteps) {
                        nextStep();
                    }
                }, 1500);
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = '❌ Not quite right. Check your work for this step.';
            }
        };

        // Novice Animation Functions
        window.initializeNoviceAnimation = function() {
            console.log('Initializing novice animation...');
            const graphDiv = document.getElementById('derivativeGraph');
            if (!graphDiv) {
                console.warn('Novice graph div not found');
                return;
            }
            
            // Wait for Plotly to be available
            if (typeof Plotly !== 'undefined') {
                console.log('Plotly is available, updating novice graph');
                updateNoviceGraph();
            } else {
                console.log('Plotly not yet available, using fallback');
                createNoviceFallbackVisualization(graphDiv);
            }
        };

        window.updateNoviceGraph = function() {
            console.log('Updating novice graph...');
            const graphDiv = document.getElementById('derivativeGraph');
            if (!graphDiv) {
                console.warn('Graph div not found in updateNoviceGraph');
                return;
            }
            
            if (typeof Plotly === 'undefined') {
                console.warn('Plotly not loaded, using fallback visualization');
                createNoviceFallbackVisualization(graphDiv);
                return;
            }
            
            const showOriginal = document.getElementById('showOriginal')?.checked ?? true;
            const showFirst = document.getElementById('showFirstDerivative')?.checked ?? true;
            const showSecond = document.getElementById('showSecondDerivative')?.checked ?? false;
            
            const f = (x) => x*x;                       // Original function
            const f1 = (x) => 2*x;                      // First derivative
            const f2 = (x) => 2;                        // Second derivative (constant)
            
            const xValues = [];
            for (let x = -3; x <= 3; x += 0.1) {
                xValues.push(x);
            }
            
            const data = [];
            
            if (showOriginal) {
                data.push({
                    x: xValues,
                    y: xValues.map(f),
                    type: 'scatter',
                    mode: 'lines',
                    name: 'f(x) = x²',
                    line: { color: 'blue', width: 3 }
                });
            }
            
            if (showFirst) {
                data.push({
                    x: xValues,
                    y: xValues.map(f1),
                    type: 'scatter',
                    mode: 'lines',
                    name: "f'(x) = 2x",
                    line: { color: 'red', width: 3 }
                });
            }
            
            if (showSecond) {
                data.push({
                    x: xValues,
                    y: xValues.map(f2),
                    type: 'scatter',
                    mode: 'lines',
                    name: "f''(x) = 2",
                    line: { color: 'green', width: 3 }
                });
            }
            
            const layout = {
                title: 'Novice Derivative Analysis',
                xaxis: { title: 'x', range: [-3, 3] },
                yaxis: { title: 'y', range: [-6, 9] },
                showlegend: true,
                margin: { t: 50, r: 50, b: 50, l: 50 }
            };
            
            try {
                Plotly.newPlot(graphDiv, data, layout, {responsive: true});
                console.log('Novice graph plotted successfully');
            } catch (error) {
                console.error('Error plotting novice graph:', error);
                createNoviceFallbackVisualization(graphDiv);
            }
        };

        // Fallback visualization using HTML5 Canvas for novice
        function createNoviceFallbackVisualization(container) {
            console.log('Creating novice fallback canvas visualization');
            
            // Clear container and add canvas
            container.innerHTML = '';
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 350;
            canvas.style.width = '100%';
            canvas.style.height = '350px';
            canvas.style.border = '2px solid var(--accent-color)';
            canvas.style.borderRadius = '10px';
            container.appendChild(canvas);
            
            const ctx = canvas.getContext('2d');
            
            // Set up coordinate system
            const width = canvas.width;
            const height = canvas.height;
            const margin = 60;
            const graphWidth = width - 2 * margin;
            const graphHeight = height - 2 * margin;
            
            // Clear canvas
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, width, height);
            
            // Draw axes
            ctx.strokeStyle = '#333';
            ctx.lineWidth = 2;
            ctx.beginPath();
            // X-axis
            ctx.moveTo(margin, height - margin);
            ctx.lineTo(width - margin, height - margin);
            // Y-axis
            ctx.moveTo(margin, margin);
            ctx.lineTo(margin, height - margin);
            ctx.stroke();
            
            // Draw grid
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            for (let i = 0; i <= 10; i++) {
                const x = margin + (i / 10) * graphWidth;
                const y = margin + (i / 10) * graphHeight;
                
                ctx.beginPath();
                ctx.moveTo(x, margin);
                ctx.lineTo(x, height - margin);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(margin, y);
                ctx.lineTo(width - margin, y);
                ctx.stroke();
            }
            
            // Functions
            const f = (x) => x*x;
            const f1 = (x) => 2*x;
            
            // Convert mathematical coordinates to canvas coordinates
            function toCanvasX(x) {
                return margin + ((x + 3) / 6) * graphWidth;
            }
            
            function toCanvasY(y) {
                return height - margin - ((y + 6) / 15) * graphHeight;
            }
            
            // Draw original function
            const showOriginal = document.getElementById('showOriginal')?.checked ?? true;
            const showFirst = document.getElementById('showFirstDerivative')?.checked ?? true;
            
            if (showOriginal) {
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 3;
                ctx.beginPath();
                let firstPoint = true;
                for (let x = -3; x <= 3; x += 0.1) {
                    const y = f(x);
                    const canvasX = toCanvasX(x);
                    const canvasY = toCanvasY(y);
                    
                    if (firstPoint) {
                        ctx.moveTo(canvasX, canvasY);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(canvasX, canvasY);
                    }
                }
                ctx.stroke();
            }
            
            // Draw first derivative
            if (showFirst) {
                ctx.strokeStyle = 'red';
                ctx.lineWidth = 3;
                ctx.beginPath();
                let firstPoint = true;
                for (let x = -3; x <= 3; x += 0.1) {
                    const y = f1(x);
                    const canvasX = toCanvasX(x);
                    const canvasY = toCanvasY(y);
                    
                    if (firstPoint) {
                        ctx.moveTo(canvasX, canvasY);
                        firstPoint = false;
                    } else {
                        ctx.lineTo(canvasX, canvasY);
                    }
                }
                ctx.stroke();
            }
            
            // Add labels
            ctx.fillStyle = '#333';
            ctx.font = '14px Arial';
            ctx.fillText('Novice Derivative Visualization', margin, 30);
            
            if (showOriginal) {
                ctx.fillStyle = 'blue';
                ctx.fillText('f(x) = x²', margin, height - 10);
            }
            
            if (showFirst) {
                ctx.fillStyle = 'red';
                ctx.fillText("f'(x) = 2x", margin + 150, height - 10);
            }
        }

        window.animateNoviceDerivativeEvolution = function() {
            console.log('Starting novice derivative evolution animation...');
            const checkboxes = ['showOriginal', 'showFirstDerivative', 'showSecondDerivative'];
            let currentIndex = 0;
            
            // Reset all checkboxes
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = false;
            });
            
            const animate = () => {
                if (currentIndex < checkboxes.length) {
                    const checkbox = document.getElementById(checkboxes[currentIndex]);
                    if (checkbox) {
                        console.log(`Showing ${checkboxes[currentIndex]}`);
                        checkbox.checked = true;
                        updateNoviceGraph();
                    }
                    currentIndex++;
                    setTimeout(animate, 1500);
                } else {
                    console.log('Novice animation complete');
                }
            };
            
            animate();
        };

        window.showNoviceCriticalPoints = function() {
            console.log('Showing novice critical points...');
            // Critical point where f'(x) = 0: 2x = 0, so x = 0
            const criticalX = 0;
            const f = (x) => x*x;
            const criticalY = f(criticalX);
            
            console.log(`Critical point at (${criticalX}, ${criticalY})`);
            
            const graphDiv = document.getElementById('derivativeGraph');
            if (graphDiv && typeof Plotly !== 'undefined') {
                try {
                    const criticalData = {
                        x: [criticalX],
                        y: [criticalY],
                        type: 'scatter',
                        mode: 'markers',
                        name: 'Critical Point',
                        marker: { color: 'orange', size: 12, symbol: 'star' }
                    };
                    
                    Plotly.addTraces(graphDiv, criticalData);
                    console.log('Critical point added to novice Plotly graph');
                } catch (error) {
                    console.error('Error adding critical point to novice Plotly:', error);
                }
            } else {
                console.log('Using canvas fallback for critical point');
            }
        };

        window.showNoviceInflectionPoints = function() {
            console.log('Showing novice inflection points...');
            // For f(x) = x², f''(x) = 2 (constant), so no inflection points
            alert('For f(x) = x², the second derivative f\'\'(x) = 2 is constant, so there are no inflection points.');
        };

        window.resetNoviceAnimation = function() {
            console.log('Resetting novice animation...');
            const checkboxes = ['showOriginal', 'showFirstDerivative', 'showSecondDerivative'];
            checkboxes.forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) checkbox.checked = id === 'showOriginal' || id === 'showFirstDerivative';
            });
            updateNoviceGraph();
        };

        // Function to clear an answer and let the user try again
        window.clearAnswer = function(questionNum) {
            const fieldId = `question${questionNum}`;
            const mathField = window.mathFields[fieldId];
            const feedback = document.getElementById(`feedback-${questionNum}`);
            
            if (mathField) {
                mathField.latex(''); // Clear the input field
                mathField.focus();
            }
            
            if (feedback) {
                feedback.classList.remove('show', 'correct', 'incorrect');
            }
            
            // Also hide the correct answer if it's showing
            const answerDisplay = document.getElementById(`correct-answer-${questionNum}`);
            if (answerDisplay) {
                answerDisplay.style.display = 'none';
            }
        };
        
        // Function to show correct answer for a specific question
        window.showCorrectAnswer = function(questionNum) {
            const answerDisplay = document.getElementById(`correct-answer-${questionNum}`);
            if (answerDisplay) {
                if (answerDisplay.style.display === 'none') {
                    answerDisplay.style.display = 'block';
                    // Re-render MathJax
                    if (typeof MathJax !== 'undefined') {
                        MathJax.typesetPromise([answerDisplay]);
                    }
                } else {
                    answerDisplay.style.display = 'none';
                }
            }
        };
        
        // Toggle answer guide visibility
        window.toggleAnswerGuide = function() {
            const answerGuide = document.getElementById('answerGuide');
            const toggleBtn = document.getElementById('toggleAnswerGuide');
            
            if (answerGuide.style.display === 'none') {
                answerGuide.style.display = 'block';
                toggleBtn.textContent = '📝 Hide Answer Guide';
                // Smooth scroll to the answer guide
                answerGuide.scrollIntoView({ behavior: 'smooth', block: 'start' });
            } else {
                answerGuide.style.display = 'none';
                toggleBtn.textContent = '📝 Show Answer Guide';
            }
        };

        // Initialize all interactive features when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('📚 Enhanced Novice module with drag-drop and flashcards loading...');
            console.log('Testing function availability:');
            console.log('- checkMathAnswer:', typeof window.checkMathAnswer);
            console.log('- showFlashcard:', typeof window.showFlashcard);
            console.log('- hideFlashcard:', typeof window.hideFlashcard);
            
            // Set up answer guide toggle button
            const toggleBtn = document.getElementById('toggleAnswerGuide');
            if (toggleBtn) {
                toggleBtn.addEventListener('click', toggleAnswerGuide);
                console.log('✅ Answer guide toggle button found and setup');
            } else {
                console.log('❌ Answer guide toggle button not found');
            }
            
            // Initialize drag and drop system with delay to ensure DOM is ready
            setTimeout(() => {
                try {
                    if (typeof window.initializeDragDrop === 'function') {
                        window.initializeDragDrop();
                        console.log('✅ Drag and drop system initialized');
                    } else {
                        console.warn('⚠️ initializeDragDrop function not found');
                    }
                } catch (error) {
                    console.error('❌ Error initializing drag and drop:', error);
                }
            }, 500);
            
            // Set up event listeners for text inputs to save answers
            const textInputs = document.querySelectorAll('.text-input-field');
            console.log(`Found ${textInputs.length} text input fields`);
            textInputs.forEach((input, index) => {
                input.addEventListener('input', function() {
                    const questionNum = parseInt(this.id.replace('question', ''));
                    mathAnswers[questionNum] = this.value;
                    sessionStorage.setItem('introduction-to-derivatives-novice-progress', JSON.stringify(mathAnswers));
                    console.log(`Text input ${questionNum} updated:`, this.value);
                });
                
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        const questionNum = parseInt(this.id.replace('question', ''));
                        console.log(`Enter key pressed for question ${questionNum}`);
                        checkMathAnswer(questionNum);
                    }
                });
            });
            
            // Set up event listeners for radio buttons and checkboxes
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            console.log(`Found ${radioButtons.length} radio buttons`);
            radioButtons.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.name === 'question2') {
                        mathAnswers[1] = this.value;
                        sessionStorage.setItem('introduction-to-derivatives-novice-progress', JSON.stringify(mathAnswers));
                        console.log('Radio button changed:', this.value);
                    }
                });
            });
            
            const checkboxes = document.querySelectorAll('input[type="checkbox"]');
            console.log(`Found ${checkboxes.length} checkboxes`);
            checkboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    if (this.name === 'question4') {
                        const selectedCheckboxes = document.querySelectorAll('input[name="question4"]:checked');
                        mathAnswers[3] = Array.from(selectedCheckboxes).map(cb => cb.value).sort();
                        sessionStorage.setItem('introduction-to-derivatives-novice-progress', JSON.stringify(mathAnswers));
                        console.log('Checkbox changed:', mathAnswers[3]);
                    }
                });
            });
            
            // Test flashcard content availability
            console.log('Flashcard content keys:', Object.keys(flashcardContent));
            
            // Test flashcard overlay
            const overlay = document.getElementById('flashcard-overlay');
            if (overlay) {
                console.log('✅ Flashcard overlay found');
            } else {
                console.log('❌ Flashcard overlay not found');
            }
            
            console.log('✅ Enhanced module with interactive features initialized successfully');
        });

        // Function to show answer hint with underscores
        window.showAnswerHint = function(questionNum) {
            const hintDiv = document.getElementById(`answer-hint-${questionNum}`);
            if (hintDiv) {
                if (hintDiv.style.display === 'none') {
                    hintDiv.style.display = 'block';
                } else {
                    hintDiv.style.display = 'none';
                }
            }
        };
        

        
        // Function to update the format guide with user's input
        window.updateFormatWithUserInput = function(questionNum) {
            const fieldId = `question${questionNum}`;
            const mathField = window.mathFields[fieldId];
            const formatElement = document.getElementById(`format-${questionNum}`);
            const template = window.formatTemplates[questionNum];
            
            if (!mathField || !formatElement || !template) return;
            
            const userInput = mathField.latex();
            
            // Skip if user hasn't entered anything yet
            if (!userInput || userInput.trim() === '') {
                formatElement.innerHTML = template;
                return;
            }
            
            // For simple cases (like question 5 with just "0")
            if (template.indexOf('____') === 0 && template.lastIndexOf('____') === template.length - 4) {
                // Template has just one blank that encompasses the whole answer
                formatElement.innerHTML = `<span class="user-input">${userInput}</span>`;
                return;
            }
            
            // For text answers like question 3
            if (questionNum === 3) {
                let updatedFormat = template;
                const words = userInput.split(/\s+/);
                
                // Try to match words to the blanks in order
                let wordIndex = 0;
                updatedFormat = updatedFormat.replace(/____([^_]+)____/g, function(match, placeholder) {
                    if (wordIndex < words.length) {
                        return `<span class="user-input">${words[wordIndex++]}</span>`;
                    }
                    return match; // Keep original if no more words
                });
                
                formatElement.innerHTML = updatedFormat;
                return;
            }
            
            // For math expressions, we need a more sophisticated approach
            // This is a simplified version - for a real implementation you might need
            // to parse the LaTeX more carefully
            
            // For question 0: 2√(____x+h____)
            if (questionNum === 0) {
                if (userInput.includes('\\sqrt') && userInput.includes('x+h')) {
                    formatElement.innerHTML = userInput.replace(/\\sqrt\s*\{\s*([^}]+)\s*\}/, function(match, content) {
                        return `√(<span class="user-input">${content}</span>)`;
                    });
                } else {
                    formatElement.innerHTML = template;
                }
                return;
            }
            
            // For question 1: fraction
            if (questionNum === 1) {
                if (userInput.includes('\\frac')) {
                    let updated = userInput;
                    // Try to highlight the numerator and denominator
                    updated = updated.replace(/\\frac\s*\{\s*([^}]+)\s*\}\s*\{\s*([^}]+)\s*\}/, function(match, num, denom) {
                        return `\\frac{<span class="user-input">${num}</span>}{<span class="user-input">${denom}</span>}`;
                    });
                    formatElement.innerHTML = updated;
                } else {
                    formatElement.innerHTML = template;
                }
                return;
            }
            
            // For question 2: another fraction
            if (questionNum === 2) {
                if (userInput.includes('\\frac')) {
                    let updated = userInput;
                    updated = updated.replace(/\\frac\s*\{\s*([^}]+)\s*\}\s*\{\s*([^}]+)\s*\}/, function(match, num, denom) {
                        return `\\frac{<span class="user-input">${num}</span>}{<span class="user-input">${denom}</span>}`;
                    });
                    formatElement.innerHTML = updated;
                } else {
                    formatElement.innerHTML = template;
                }
                return;
            }
            
            // For question 4: sqrt with multiple parts
            if (questionNum === 4) {
                if (userInput.includes('\\sqrt') && userInput.includes('5') && 
                    (userInput.includes('x') || userInput.includes('h'))) {
                    let updated = userInput;
                    updated = updated.replace(/\\sqrt\s*\{\s*5\s*\(\s*([^+]+)\s*\+\s*([^)]+)\s*\)\s*-\s*1\s*\}/, 
                        function(match, xPart, hPart) {
                            return `√(5(<span class="user-input">${xPart}</span>+<span class="user-input">${hPart}</span>)-1)`;
                        });
                    formatElement.innerHTML = updated;
                } else {
                    formatElement.innerHTML = template;
                }
                return;
            }
            
            // Default fallback - just show the template
            formatElement.innerHTML = template;
        };

        // ===== FLASHCARD SYSTEM =====
        window.showFlashcard = function(cardId) {
            console.log(`🎯 showFlashcard called with cardId: "${cardId}"`);
            
            const overlay = document.getElementById('flashcard-overlay');
            const title = document.getElementById('flashcard-title');
            const content = document.getElementById('flashcard-content');
            
            console.log('Flashcard elements found:');
            console.log('- overlay:', !!overlay);
            console.log('- title:', !!title);
            console.log('- content:', !!content);
            
            if (!overlay || !title || !content) {
                console.error('❌ One or more flashcard elements not found!');
                alert('Error: Flashcard elements not found in the page!');
                return;
            }
            
            const card = flashcardContent[cardId];
            if (!card) {
                console.error('❌ Flashcard content not found for cardId:', cardId);
                console.log('Available cards:', Object.keys(flashcardContent));
                alert(`Error: Flashcard content not found for "${cardId}"`);
                return;
            }
            
            console.log('✅ Setting flashcard content:', card.title);
            title.textContent = card.title;
            content.innerHTML = card.content;
            
            overlay.classList.add('show');
            console.log('✅ Flashcard should now be visible');
            
            // Re-render MathJax if present
            if (typeof MathJax !== 'undefined') {
                MathJax.typesetPromise([content]);
                console.log('✅ MathJax re-rendering initiated');
            }
        };

        window.hideFlashcard = function() {
            const overlay = document.getElementById('flashcard-overlay');
            overlay.classList.remove('show');
        };

        // Close flashcard when clicking outside
        document.addEventListener('click', function(e) {
            const overlay = document.getElementById('flashcard-overlay');
            if (e.target === overlay) {
                hideFlashcard();
            }
        });

        // Close flashcard with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                hideFlashcard();
            }
        });

        // ===== DRAG AND DROP SYSTEM =====
        let draggedElement = null;

        // Initialize drag and drop when DOM is ready
        window.initializeDragDrop = function() {
            console.log('🎮 Initializing drag and drop system...');
            const dragItems = document.querySelectorAll('.drag-item');
            const dropZones = document.querySelectorAll('.drop-zone');
            
            console.log(`Found ${dragItems.length} drag items and ${dropZones.length} drop zones`);
            
            dragItems.forEach((item, index) => {
                console.log(`Setting up drag item ${index + 1}:`, item.dataset.function);
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                
                // Touch support
                item.addEventListener('touchstart', handleTouchStart, {passive: false});
                item.addEventListener('touchmove', handleTouchMove, {passive: false});
                item.addEventListener('touchend', handleTouchEnd, {passive: false});
            });
            
            dropZones.forEach((zone, index) => {
                console.log(`Setting up drop zone ${index + 1}:`, zone.dataset.derivative);
                zone.addEventListener('dragover', handleDragOver);
                zone.addEventListener('drop', handleDrop);
                zone.addEventListener('dragenter', handleDragEnter);
                zone.addEventListener('dragleave', handleDragLeave);
            });
            
            console.log('✅ Drag and drop event listeners attached');
        };

        function handleDragStart(e) {
            console.log('🚀 Drag started:', e.target.dataset.function, e.target.textContent);
            draggedElement = e.target;
            e.dataTransfer.setData('text/plain', e.target.dataset.function);
            e.target.classList.add('dragging');
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            draggedElement = null;
        }

        function handleDragOver(e) {
            e.preventDefault();
        }

        function handleDragEnter(e) {
            console.log('🎯 Drag enter:', e.target.dataset.derivative);
            e.preventDefault();
            e.target.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.target.classList.remove('drag-over');
        }

        function handleDrop(e) {
            console.log('🎯 Drop event triggered');
            e.preventDefault();
            e.target.classList.remove('drag-over');
            
            const functionType = e.dataTransfer.getData('text/plain');
            const derivativeType = e.target.dataset.derivative;
            
            console.log('Drop details:', { functionType, derivativeType });
            
            // Store the match based on which drag-drop container this is
            const container = e.target.closest('.question-container');
            const questionNumber = container ? container.querySelector('.question-number').textContent : 'unknown';
            
            console.log('Question number:', questionNumber);
            
            if (questionNumber === '6') {
                window.dragDropMatches[functionType] = derivativeType;
                console.log('Stored in dragDropMatches:', functionType, '→', derivativeType);
            } else if (questionNumber === '7') {
                window.notationMatches[functionType] = derivativeType;
                console.log('Stored in notationMatches:', functionType, '→', derivativeType);
            } else if (questionNumber === '8') {
                window.slopeMatches[functionType] = derivativeType;
                console.log('Stored in slopeMatches:', functionType, '→', derivativeType);
            }
            
            // Visual feedback
            const originalText = e.target.textContent;
            e.target.innerHTML = `<div>${originalText}</div><small style="background: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; margin-top: 10px; display: block; font-weight: bold; color: var(--accent-color);">✓ Matched with: ${draggedElement ? draggedElement.textContent : functionType}</small>`;
            
            console.log('✅ Drop completed successfully');
        }

        // Touch support for mobile
        let touchItem = null;
        let touchOffset = { x: 0, y: 0 };

        function handleTouchStart(e) {
            touchItem = e.target;
            const touch = e.touches[0];
            const rect = touchItem.getBoundingClientRect();
            touchOffset.x = touch.clientX - rect.left;
            touchOffset.y = touch.clientY - rect.top;
            touchItem.style.position = 'fixed';
            touchItem.style.zIndex = '1000';
            touchItem.classList.add('dragging');
        }

        function handleTouchMove(e) {
            e.preventDefault();
            if (!touchItem) return;
            
            const touch = e.touches[0];
            touchItem.style.left = (touch.clientX - touchOffset.x) + 'px';
            touchItem.style.top = (touch.clientY - touchOffset.y) + 'px';
        }

        function handleTouchEnd(e) {
            if (!touchItem) return;
            
            const touch = e.changedTouches[0];
            const elementBelow = document.elementFromPoint(touch.clientX, touch.clientY);
            
            if (elementBelow && elementBelow.classList.contains('drop-zone')) {
                const functionType = touchItem.dataset.function;
                const derivativeType = elementBelow.dataset.derivative;
                
                // Store the match based on which drag-drop container this is
                const container = elementBelow.closest('.question-container');
                const questionNumber = container.querySelector('.question-number').textContent;
                
                if (questionNumber === '6') {
                    dragDropMatches[functionType] = derivativeType;
                } else if (questionNumber === '7') {
                    notationMatches[functionType] = derivativeType;
                } else if (questionNumber === '8') {
                    slopeMatches[functionType] = derivativeType;
                }
                
                elementBelow.innerHTML = `<div>${elementBelow.textContent}</div><small style="background: rgba(255,255,255,0.8); padding: 5px; border-radius: 5px; margin-top: 10px; display: block; font-weight: bold; color: var(--accent-color);">✓ Matched with: ${touchItem.textContent}</small>`;
            }
            
            // Reset position
            touchItem.style.position = '';
            touchItem.style.left = '';
            touchItem.style.top = '';
            touchItem.style.zIndex = '';
            touchItem.classList.remove('dragging');
            touchItem = null;
        }

        // ===== DRAG AND DROP VALIDATION =====
        window.checkDragDrop = function() {
            const feedback = document.getElementById('feedback-dragdrop');
            const correctMatches = {
                'height': 'growth-speed',
                'cost': 'marginal-cost',
                'temperature': 'temp-rate',
                'population': 'population-rate'
            };
            
            let score = 0;
            let total = Object.keys(correctMatches).length;
            
            Object.keys(correctMatches).forEach(func => {
                const dropZone = document.querySelector(`[data-derivative="${correctMatches[func]}"]`);
                if (dragDropMatches[func] === correctMatches[func]) {
                    score++;
                    dropZone.classList.add('matched');
                    dropZone.classList.add('celebration');
                } else if (dragDropMatches[func]) {
                    const wrongZone = document.querySelector(`[data-derivative="${dragDropMatches[func]}"]`);
                    if (wrongZone) wrongZone.classList.add('incorrect');
                }
            });
            
            feedback.classList.add('show');
            if (score === total) {
                feedback.classList.add('correct');
                feedback.innerHTML = `✅ Perfect! All ${score} matches are correct! You understand how derivatives represent rates of change!`;
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `❌ ${score}/${total} correct. Remember: derivatives tell us how fast the original function is changing.`;
            }
        };

        window.checkNotationDragDrop = function() {
            const feedback = document.getElementById('feedback-notation');
            const correctMatches = {
                'lagrange': 'simple',
                'leibniz': 'calculus',
                'operator': 'operations',
                'newton': 'physics'
            };
            
            let score = 0;
            let total = Object.keys(correctMatches).length;
            
            Object.keys(correctMatches).forEach(func => {
                const dropZone = document.querySelector(`[data-derivative="${correctMatches[func]}"]`);
                if (notationMatches[func] === correctMatches[func]) {
                    score++;
                    dropZone.classList.add('matched');
                    dropZone.classList.add('celebration');
                } else if (notationMatches[func]) {
                    const wrongZone = document.querySelector(`[data-derivative="${notationMatches[func]}"]`);
                    if (wrongZone) wrongZone.classList.add('incorrect');
                }
            });
            
            feedback.classList.add('show');
            if (score === total) {
                feedback.classList.add('correct');
                feedback.innerHTML = `✅ Excellent! All ${score} notation matches are correct! You know when to use different derivative notations!`;
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `❌ ${score}/${total} correct. Each notation has its best use case - review the flashcard for guidance.`;
            }
        };

        window.checkSlopeDragDrop = function() {
            const feedback = document.getElementById('feedback-slope');
            const correctMatches = {
                'positive-steep': 'increasing-fast',
                'positive-gentle': 'increasing-slow',
                'zero': 'constant',
                'negative': 'decreasing'
            };
            
            let score = 0;
            let total = Object.keys(correctMatches).length;
            
            Object.keys(correctMatches).forEach(func => {
                const dropZone = document.querySelector(`[data-derivative="${correctMatches[func]}"]`);
                if (slopeMatches[func] === correctMatches[func]) {
                    score++;
                    dropZone.classList.add('matched');
                    dropZone.classList.add('celebration');
                } else if (slopeMatches[func]) {
                    const wrongZone = document.querySelector(`[data-derivative="${slopeMatches[func]}"]`);
                    if (wrongZone) wrongZone.classList.add('incorrect');
                }
            });
            
            feedback.classList.add('show');
            if (score === total) {
                feedback.classList.add('correct');
                feedback.innerHTML = `✅ Outstanding! All ${score} slope interpretations are correct! You understand the connection between slope and function behavior!`;
            } else {
                feedback.classList.add('incorrect');
                feedback.innerHTML = `❌ ${score}/${total} correct. Think about how the steepness and direction of slope relates to how the function is changing.`;
            }
        };

        // Helper functions for scoring
        function checkDragDropAnswers() {
            const correctMatches = {
                'height': 'growth-speed',
                'cost': 'marginal-cost',
                'temperature': 'temp-rate',
                'population': 'population-rate'
            };
            
            let score = 0;
            Object.keys(correctMatches).forEach(func => {
                if ((window.dragDropMatches || {})[func] === correctMatches[func]) {
                    score++;
                }
            });
            
            return score >= 3; // Need at least 3/4 correct
        }

        function checkNotationAnswers() {
            const correctMatches = {
                'lagrange': 'simple',
                'leibniz': 'calculus',
                'operator': 'operations',
                'newton': 'physics'
            };
            
            let score = 0;
            Object.keys(correctMatches).forEach(func => {
                if ((window.notationMatches || {})[func] === correctMatches[func]) {
                    score++;
                }
            });
            
            return score >= 3; // Need at least 3/4 correct
        }

        function checkSlopeAnswers() {
            const correctMatches = {
                'positive-steep': 'increasing-fast',
                'positive-gentle': 'increasing-slow',
                'zero': 'constant',
                'negative': 'decreasing'
            };
            
            let score = 0;
            Object.keys(correctMatches).forEach(func => {
                if ((window.slopeMatches || {})[func] === correctMatches[func]) {
                    score++;
                }
            });
            
            return score >= 3; // Need at least 3/4 correct
        }

        // Reset drag and drop for a specific question
        window.resetDragDrop = function(questionNumber) {
            console.log(`🔄 Resetting drag and drop for question ${questionNumber}`);
            
            // Clear the stored matches
            if (questionNumber === 6) {
                window.dragDropMatches = {};
            } else if (questionNumber === 7) {
                window.notationMatches = {};
            } else if (questionNumber === 8) {
                window.slopeMatches = {};
            }
            
            // Find the question container
            const questionContainers = document.querySelectorAll('.question-container');
            let targetContainer = null;
            
            questionContainers.forEach(container => {
                const questionNumElement = container.querySelector('.question-number');
                if (questionNumElement && questionNumElement.textContent === questionNumber.toString()) {
                    targetContainer = container;
                }
            });
            
            if (!targetContainer) {
                console.error(`Question container ${questionNumber} not found`);
                return;
            }
            
            // Reset all drop zones in this question
            const dropZones = targetContainer.querySelectorAll('.drop-zone');
            dropZones.forEach(zone => {
                // Get the original text (before any matches)
                const originalText = zone.dataset.originalText || zone.textContent.split('✓')[0].trim();
                zone.dataset.originalText = originalText; // Store for future resets
                zone.innerHTML = originalText;
                
                // Remove all classes
                zone.classList.remove('matched', 'incorrect', 'celebration', 'drag-over');
            });
            
            // Reset feedback
            const feedbackIds = ['feedback-dragdrop', 'feedback-notation', 'feedback-slope'];
            const feedbackId = feedbackIds[questionNumber - 6];
            const feedback = document.getElementById(feedbackId);
            if (feedback) {
                feedback.classList.remove('show', 'correct', 'incorrect');
                feedback.innerHTML = '';
            }
            
            console.log(`✅ Question ${questionNumber} reset complete`);
        };

        // Placeholder functions to prevent undefined errors
        function updateMathPreview(input) {
            // Placeholder function
        }

        function updateProgress() {
            // Placeholder function
        }
    </script>
</body>
</html> 







